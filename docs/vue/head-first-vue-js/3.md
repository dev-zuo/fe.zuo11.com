# 第二篇 虚拟DOM

Vue.js 2.0 引入了虚拟 DOM，比 Vue.js 1.0 的初始渲染速度提升了 2-4 倍，并大大降低的内存消耗。

- 什么是虚拟 DOM，虚拟 DOM 的原理是什么？
- 为什么 Vue.js 2.0 开始引入了虚拟 DOM？为什么 Vue.js 2.0 开始引入了虚拟 DOM？

## 5. 虚拟 DOM 简介

### 5.1 什么是虚拟 DOM

在 Web 早期页面的交互效果简单，不太需要频繁操作 DOM，用 jQuery 开发就可以满足需求。

随着时代发展，页面上的功能越来越多，需要实现的需求也越来越复杂，程序中需要维护的状态也越来越多，DOM 操作也越来越频繁。

这样会导致代码中有相当多的代码是在操作 DOM，程序中的状态很难管理，代码逻辑混乱，一堆全局变量，不好维护。这是命令式操作 DOM 的问题，虽然简单易用，但不好维护。

现在主流的前端框架 Vue、React 都是声明式操作 DOM。通过描述状态（data）和 DOM 之间的映射关系是怎样的，就可以将状态渲染成视图(View)。状态到视图的过程，框架会帮我们做，不需要我们自己手动去操作 DOM。

在计算机术语中有 声明式编程 declarative 和 命令式编程 imperative 两种编程模式

- 声明式编程：告诉机器，我要做什么（what），具体怎么做（how）由机器自己决定。
- 命令式编程：告诉机器，具体怎么做（how），机器不会管你具体要做什么（what）。

状态可以是 JS 中的任意类型，Object、Array、String、Number、Boolean 等都可以作为状态。

```bash
渲染的过程：将状态作为输入，并生成 DOM 输出到页面上显示出来，这个过程叫渲染。
状态 => DOM
```

通常程序在运行过程中，状态会不断变化（比如 Ajax 异步请求），而每次状态变化都需要重新渲染。如何确定状态中发生了什么变化，以及需要在哪里更新 DOM？

- 最简单粗暴的解决方式是，把全部 DOM 删了，然后重新根据状态生成 DOM, 显示到页面。
  - 这样会带来比较大的开销，照成相当多的性能浪费，因为通常状态只有部分节点需要重新渲染。
- 最好的方式是找到具体需要更新的 DOM，**尽可能减少操作 DOM，当状态发生变化时，只更新与这个状态有关联的 DOM**。

这个问题有很多种解决方案：

- Angular 中是脏检查
- React 中是使用虚拟 DOM
- Vue.js 1.0 中是通过细粒度的绑定。

虚拟 DOM 只是众多解决方案中的一种，可以用，但并不是必须要用。

虚拟 DOM（Virtual DOM）的解决方式是：

```js
根据状态（data）生成一个虚拟节点树（Virtual Node树） =>  使用虚拟节点树进行渲染
在渲染之前，会使用新生成的虚拟节点树和上一次生成的虚拟节点树进行比对，只渲染不同的部分
```

虚拟节点树一般简写为 vnode 树

### 5.2 Vue 2.0 为什么要引入虚拟 DOM

Angular 和 React 的变化侦测有一个共同点，就是不知道哪些状态(data) 变了，就需要进行比较暴力的比对。

- React 是通过虚拟 DOM 进行比对
- Angular 是使用脏检查的流程

Vue 的变化侦测和他们不一样，Vue 可以具体知道是哪些状态发生了变化，完全可以进行细粒度的更新。

这也是 Vue 1.0 的实现。但有个缺点，粒度太细，每一个绑定都会有一个对应的 Watcher 实例来观察状态的变化，如果项目很大，状态会非常多，导致内存开销很大。

Vue 2.0 选择了中等粒度的解决方案，就是引入虚拟 DOM。

- 组件级别是一个 Watcher 实例，**即就算组件内有 10 个节点使用了某个状态，其实只有一个 watcher 在观察这个状态的变化。**
- 这个状态发生变化后，只能通知到组件。组件内部在通过虚拟 DOM 进行比对与渲染，这是比较折中的方案。

Vue 之所以能随意调整绑定的粒度，本质上还要归功于前面章节中讲到的变化侦测。

### 5.3 Vue 中的虚拟 DOM

Vue 中通过模板（template）来描述状态与视图之间的映射关系。

流程如下：

- 1. 将 template 编译为渲染函数（render 函数）
- 2. 执行渲染函数生成虚拟节点（vnode，就是 js 对象）
- 3. 使用虚拟节点更新视图（view）

```bash
模板转换为视图过程：
模板 ==编译==> 渲染函数 ==执行==> [vnode ==patch==> 视图](虚拟DOM)
```

虚拟 DOM 在 Vue 中所做的事 - 提供虚拟节点 vnode 和对新旧两个 vnode 进行比对，并根据比对结果进行 DOM 操作更新视图

```bash
虚拟 dom 执行流程
vnode ====>  [vnode ==patch/diff==> oldVnode](虚拟DOM)  ==> 视图
```

## 6. VNode

## 7. patch
