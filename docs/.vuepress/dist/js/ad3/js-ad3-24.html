<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>24. 网络请求与远程资源 - JS高程4 | 左小白的前端笔记</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/logo.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon-152x152.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#3eaf7c">
    <meta name="description" content="Ajax(Asynchronous JS + XML) 异步的 JS 和 XML，是一种用于 http 请求的技术。是 Jesse James Garrett 在 2005 年提出的方案。主要用于在不刷新页面的情况下，请求服务器接口获取数据，从而实现了更好的用户体验。现在可能觉得没什么，但以前请求服务器接口获取数据时都需要刷新页面，体验较差。Ajax 技术的核心是 XMLHttpRequest（XHR 对象），为什么是 XML 开头呢？因为在 JSON 出现之前，网络请求使用的数据都是 XML 类型的。 XHR 对象普遍认为比较难用，而 Fetch API 支持 Promise 和 Service Worker，已经成为极其强大的 Web 开发工具">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/assets/css/0.styles.594b47db.css" as="style"><link rel="preload" href="/assets/js/app.1f511cd1.js" as="script"><link rel="preload" href="/assets/js/2.4b3539f1.js" as="script"><link rel="preload" href="/assets/js/83.75bc4803.js" as="script"><link rel="preload" href="/assets/js/3.e6a4dd76.js" as="script"><link rel="prefetch" href="/assets/js/10.f7d631a1.js"><link rel="prefetch" href="/assets/js/100.62403a37.js"><link rel="prefetch" href="/assets/js/101.9eead1bc.js"><link rel="prefetch" href="/assets/js/102.a5a8c608.js"><link rel="prefetch" href="/assets/js/103.2261e92e.js"><link rel="prefetch" href="/assets/js/104.deecf853.js"><link rel="prefetch" href="/assets/js/105.d309d997.js"><link rel="prefetch" href="/assets/js/106.a16552d1.js"><link rel="prefetch" href="/assets/js/107.b2e9608f.js"><link rel="prefetch" href="/assets/js/108.8a2e6046.js"><link rel="prefetch" href="/assets/js/109.43e70fa7.js"><link rel="prefetch" href="/assets/js/11.12c7819b.js"><link rel="prefetch" href="/assets/js/110.0ae45b0c.js"><link rel="prefetch" href="/assets/js/111.3df4e9b7.js"><link rel="prefetch" href="/assets/js/112.f7699b84.js"><link rel="prefetch" href="/assets/js/113.e06ce766.js"><link rel="prefetch" href="/assets/js/114.0e500700.js"><link rel="prefetch" href="/assets/js/115.0cc12c39.js"><link rel="prefetch" href="/assets/js/116.77095d46.js"><link rel="prefetch" href="/assets/js/117.8f2f1eca.js"><link rel="prefetch" href="/assets/js/118.39b86b7e.js"><link rel="prefetch" href="/assets/js/119.da684fa3.js"><link rel="prefetch" href="/assets/js/12.66186d22.js"><link rel="prefetch" href="/assets/js/120.92adaeae.js"><link rel="prefetch" href="/assets/js/121.4dec411b.js"><link rel="prefetch" href="/assets/js/122.fbdacf5a.js"><link rel="prefetch" href="/assets/js/123.444c7f44.js"><link rel="prefetch" href="/assets/js/124.d0efc8b3.js"><link rel="prefetch" href="/assets/js/125.b4743d87.js"><link rel="prefetch" href="/assets/js/126.267168eb.js"><link rel="prefetch" href="/assets/js/127.f1f0b9ff.js"><link rel="prefetch" href="/assets/js/128.79439601.js"><link rel="prefetch" href="/assets/js/129.006b152d.js"><link rel="prefetch" href="/assets/js/13.94147151.js"><link rel="prefetch" href="/assets/js/130.86722a54.js"><link rel="prefetch" href="/assets/js/131.69c4ebcb.js"><link rel="prefetch" href="/assets/js/132.0d7e0897.js"><link rel="prefetch" href="/assets/js/133.d8bf7015.js"><link rel="prefetch" href="/assets/js/134.aeabc9d5.js"><link rel="prefetch" href="/assets/js/135.e1591304.js"><link rel="prefetch" href="/assets/js/136.bf5f4e6a.js"><link rel="prefetch" href="/assets/js/137.327a62e0.js"><link rel="prefetch" href="/assets/js/138.47e8b430.js"><link rel="prefetch" href="/assets/js/139.8ce7878c.js"><link rel="prefetch" href="/assets/js/14.e81004ee.js"><link rel="prefetch" href="/assets/js/140.5a4d28db.js"><link rel="prefetch" href="/assets/js/141.b63840e7.js"><link rel="prefetch" href="/assets/js/142.765333b1.js"><link rel="prefetch" href="/assets/js/143.d3f7d7e0.js"><link rel="prefetch" href="/assets/js/144.bbad5941.js"><link rel="prefetch" href="/assets/js/145.066623a9.js"><link rel="prefetch" href="/assets/js/146.8e265805.js"><link rel="prefetch" href="/assets/js/147.d9d37261.js"><link rel="prefetch" href="/assets/js/148.af57cd78.js"><link rel="prefetch" href="/assets/js/149.61115cb0.js"><link rel="prefetch" href="/assets/js/15.1326e39c.js"><link rel="prefetch" href="/assets/js/150.931e6dbc.js"><link rel="prefetch" href="/assets/js/151.ba91f6a4.js"><link rel="prefetch" href="/assets/js/152.c371187e.js"><link rel="prefetch" href="/assets/js/153.2d8af3b7.js"><link rel="prefetch" href="/assets/js/154.15b96843.js"><link rel="prefetch" href="/assets/js/155.db935936.js"><link rel="prefetch" href="/assets/js/156.85519e24.js"><link rel="prefetch" href="/assets/js/157.c91ed6ba.js"><link rel="prefetch" href="/assets/js/16.eb71a02a.js"><link rel="prefetch" href="/assets/js/17.f4a7a522.js"><link rel="prefetch" href="/assets/js/18.c730c964.js"><link rel="prefetch" href="/assets/js/19.4d7dfdc0.js"><link rel="prefetch" href="/assets/js/20.74075251.js"><link rel="prefetch" href="/assets/js/21.6f2ce4c0.js"><link rel="prefetch" href="/assets/js/22.b6efd501.js"><link rel="prefetch" href="/assets/js/23.c06a1b16.js"><link rel="prefetch" href="/assets/js/24.ad5c06ea.js"><link rel="prefetch" href="/assets/js/25.06895800.js"><link rel="prefetch" href="/assets/js/26.5edf933c.js"><link rel="prefetch" href="/assets/js/27.4ecf6215.js"><link rel="prefetch" href="/assets/js/28.3f66d916.js"><link rel="prefetch" href="/assets/js/29.ba60ca65.js"><link rel="prefetch" href="/assets/js/30.b6b55d35.js"><link rel="prefetch" href="/assets/js/31.5fa558a4.js"><link rel="prefetch" href="/assets/js/32.1671d948.js"><link rel="prefetch" href="/assets/js/33.b8151898.js"><link rel="prefetch" href="/assets/js/34.fc4cac22.js"><link rel="prefetch" href="/assets/js/35.257f3cea.js"><link rel="prefetch" href="/assets/js/36.33d4f83d.js"><link rel="prefetch" href="/assets/js/37.8d0a586e.js"><link rel="prefetch" href="/assets/js/38.34f4ef54.js"><link rel="prefetch" href="/assets/js/39.65fae495.js"><link rel="prefetch" href="/assets/js/4.aeb07d0c.js"><link rel="prefetch" href="/assets/js/40.79d11166.js"><link rel="prefetch" href="/assets/js/41.4a6fbd57.js"><link rel="prefetch" href="/assets/js/42.f49c21cb.js"><link rel="prefetch" href="/assets/js/43.8d141598.js"><link rel="prefetch" href="/assets/js/44.703ca403.js"><link rel="prefetch" href="/assets/js/45.4b04f0f6.js"><link rel="prefetch" href="/assets/js/46.22b3c15a.js"><link rel="prefetch" href="/assets/js/47.706163e5.js"><link rel="prefetch" href="/assets/js/48.c7d214f0.js"><link rel="prefetch" href="/assets/js/49.baf1de95.js"><link rel="prefetch" href="/assets/js/5.5b94bff7.js"><link rel="prefetch" href="/assets/js/50.ad635ba5.js"><link rel="prefetch" href="/assets/js/51.513ee75a.js"><link rel="prefetch" href="/assets/js/52.ea1b4b45.js"><link rel="prefetch" href="/assets/js/53.61eca69d.js"><link rel="prefetch" href="/assets/js/54.e0d4a9e1.js"><link rel="prefetch" href="/assets/js/55.f12ee302.js"><link rel="prefetch" href="/assets/js/56.23108a6b.js"><link rel="prefetch" href="/assets/js/57.aac4a472.js"><link rel="prefetch" href="/assets/js/58.27581ad6.js"><link rel="prefetch" href="/assets/js/59.a661c91c.js"><link rel="prefetch" href="/assets/js/6.481b22df.js"><link rel="prefetch" href="/assets/js/60.4db8717d.js"><link rel="prefetch" href="/assets/js/61.b1d1aa7e.js"><link rel="prefetch" href="/assets/js/62.f3d59428.js"><link rel="prefetch" href="/assets/js/63.0a5db164.js"><link rel="prefetch" href="/assets/js/64.43b1dbf4.js"><link rel="prefetch" href="/assets/js/65.9e2cfd46.js"><link rel="prefetch" href="/assets/js/66.8d2e6fce.js"><link rel="prefetch" href="/assets/js/67.316e3bba.js"><link rel="prefetch" href="/assets/js/68.2a9ea7c0.js"><link rel="prefetch" href="/assets/js/69.013f3120.js"><link rel="prefetch" href="/assets/js/7.cb937ed7.js"><link rel="prefetch" href="/assets/js/70.6c7635f8.js"><link rel="prefetch" href="/assets/js/71.f383131f.js"><link rel="prefetch" href="/assets/js/72.9ed6be02.js"><link rel="prefetch" href="/assets/js/73.5c649771.js"><link rel="prefetch" href="/assets/js/74.597f8d6d.js"><link rel="prefetch" href="/assets/js/75.a38dc25a.js"><link rel="prefetch" href="/assets/js/76.407167b5.js"><link rel="prefetch" href="/assets/js/77.6046be23.js"><link rel="prefetch" href="/assets/js/78.117ef2a9.js"><link rel="prefetch" href="/assets/js/79.2fd97fcb.js"><link rel="prefetch" href="/assets/js/8.dcd2d777.js"><link rel="prefetch" href="/assets/js/80.3ebdbb88.js"><link rel="prefetch" href="/assets/js/81.756f28cf.js"><link rel="prefetch" href="/assets/js/82.3357dd0a.js"><link rel="prefetch" href="/assets/js/84.bf3d114b.js"><link rel="prefetch" href="/assets/js/85.4ea0353f.js"><link rel="prefetch" href="/assets/js/86.2105b04f.js"><link rel="prefetch" href="/assets/js/87.96f9597f.js"><link rel="prefetch" href="/assets/js/88.b5409c8c.js"><link rel="prefetch" href="/assets/js/89.7459ba86.js"><link rel="prefetch" href="/assets/js/9.e0f173ad.js"><link rel="prefetch" href="/assets/js/90.a66ecac8.js"><link rel="prefetch" href="/assets/js/91.80cc472d.js"><link rel="prefetch" href="/assets/js/92.63c9c0c5.js"><link rel="prefetch" href="/assets/js/93.54570d9f.js"><link rel="prefetch" href="/assets/js/94.168f1690.js"><link rel="prefetch" href="/assets/js/95.595b78a5.js"><link rel="prefetch" href="/assets/js/96.59571918.js"><link rel="prefetch" href="/assets/js/97.e69ef9d0.js"><link rel="prefetch" href="/assets/js/98.d3ad2eac.js"><link rel="prefetch" href="/assets/js/99.70ea2b6d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.594b47db.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">左小白的前端笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="指南" class="dropdown-title"><span class="title">指南</span> <span class="arrow down"></span></button> <button type="button" aria-label="指南" class="mobile-dropdown-title"><span class="title">指南</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">
  首页
</a></li><li class="dropdown-item"><!----> <a href="/nav.html" class="nav-link">
  前端网址导航
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端进阶" class="dropdown-title"><span class="title">前端进阶</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端进阶" class="mobile-dropdown-title"><span class="title">前端进阶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/daily/" class="nav-link">
  技术日常记录
</a></li><li class="dropdown-item"><!----> <a href="/server/docker.html" class="nav-link">
  Docker 基础
</a></li><li class="dropdown-item"><h4>
          Vue.js
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vue/base/1.html" class="nav-link">
  Vue.js 笔记
</a></li><li class="dropdown-subitem"><a href="/vue/vue-router.html" class="nav-link">
  Vue Router 笔记
</a></li><li class="dropdown-subitem"><a href="/vue/vuex.html" class="nav-link">
  Vuex 笔记
</a></li></ul></li><li class="dropdown-item"><h4>
          前端工程化
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/ts/base-1.html" class="nav-link">
  TypeScript 入门教程笔记
</a></li><li class="dropdown-subitem"><a href="/node/base/1.html" class="nav-link">
  Node.js 笔记
</a></li><li class="dropdown-subitem"><a href="/webpack/base.html" class="nav-link">
  webpack 基础
</a></li></ul></li><li class="dropdown-item"><h4>
          数据可视化
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/visual/echarts.html" class="nav-link">
  Echarts 笔记
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端基础" class="dropdown-title"><span class="title">前端基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端基础" class="mobile-dropdown-title"><span class="title">前端基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          JS/ES6
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/js/es6/es6-1.html" class="nav-link">
  ES6标准入门(第三版)笔记
</a></li><li class="dropdown-subitem"><a href="/js/ad3/js-ad3-1.html" class="nav-link">
  JavaScript高级程序设计(第四版)笔记
</a></li><li class="dropdown-subitem"><a href="/js/js-dom-art.html" class="nav-link">
  JavaScript DOM编程艺术(第二版)笔记
</a></li></ul></li><li class="dropdown-item"><h4>
          CSS/CSS3
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/css/less.html" class="nav-link">
  CSS 预处理器 Less.js
</a></li><li class="dropdown-subitem"><a href="/css/flex-grid.html" class="nav-link">
  Flex与Grid布局
</a></li><li class="dropdown-subitem"><a href="/css/html5-css-1.html" class="nav-link">
  HTML5权威指南(CSS部分)笔记
</a></li></ul></li><li class="dropdown-item"><h4>
          HTML/HTML5
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/html5/html/1.html" class="nav-link">
  HTML5权威指南(HTML部分)笔记
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机基础" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机基础" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/base/js-data-struct.html" class="nav-link">
  学习JavaScript数据结构与算法(第三版)笔记
</a></li><li class="dropdown-item"><!----> <a href="/base/mocha-test.html" class="nav-link">
  Mocha - JavaScript测试框架
</a></li><li class="dropdown-item"><!----> <a href="/base/git.html" class="nav-link">
  Git 笔记
</a></li><li class="dropdown-item"><!----> <a href="/base/markdown.html" class="nav-link">
  Markdown 基础语法
</a></li><li class="dropdown-item"><!----> <a href="/base/dbtheory/1.html" class="nav-link">
  数据库系统原理笔记
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开源项目" class="dropdown-title"><span class="title">开源项目</span> <span class="arrow down"></span></button> <button type="button" aria-label="开源项目" class="mobile-dropdown-title"><span class="title">开源项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="http://vuechart.zuo11.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  @guoqzuo/vue-chart
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://zuoblog.zuo11.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  zuo-blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="http://www.zuo11.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/zuoxiaobai" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="指南" class="dropdown-title"><span class="title">指南</span> <span class="arrow down"></span></button> <button type="button" aria-label="指南" class="mobile-dropdown-title"><span class="title">指南</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">
  首页
</a></li><li class="dropdown-item"><!----> <a href="/nav.html" class="nav-link">
  前端网址导航
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端进阶" class="dropdown-title"><span class="title">前端进阶</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端进阶" class="mobile-dropdown-title"><span class="title">前端进阶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/daily/" class="nav-link">
  技术日常记录
</a></li><li class="dropdown-item"><!----> <a href="/server/docker.html" class="nav-link">
  Docker 基础
</a></li><li class="dropdown-item"><h4>
          Vue.js
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vue/base/1.html" class="nav-link">
  Vue.js 笔记
</a></li><li class="dropdown-subitem"><a href="/vue/vue-router.html" class="nav-link">
  Vue Router 笔记
</a></li><li class="dropdown-subitem"><a href="/vue/vuex.html" class="nav-link">
  Vuex 笔记
</a></li></ul></li><li class="dropdown-item"><h4>
          前端工程化
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/ts/base-1.html" class="nav-link">
  TypeScript 入门教程笔记
</a></li><li class="dropdown-subitem"><a href="/node/base/1.html" class="nav-link">
  Node.js 笔记
</a></li><li class="dropdown-subitem"><a href="/webpack/base.html" class="nav-link">
  webpack 基础
</a></li></ul></li><li class="dropdown-item"><h4>
          数据可视化
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/visual/echarts.html" class="nav-link">
  Echarts 笔记
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端基础" class="dropdown-title"><span class="title">前端基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端基础" class="mobile-dropdown-title"><span class="title">前端基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          JS/ES6
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/js/es6/es6-1.html" class="nav-link">
  ES6标准入门(第三版)笔记
</a></li><li class="dropdown-subitem"><a href="/js/ad3/js-ad3-1.html" class="nav-link">
  JavaScript高级程序设计(第四版)笔记
</a></li><li class="dropdown-subitem"><a href="/js/js-dom-art.html" class="nav-link">
  JavaScript DOM编程艺术(第二版)笔记
</a></li></ul></li><li class="dropdown-item"><h4>
          CSS/CSS3
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/css/less.html" class="nav-link">
  CSS 预处理器 Less.js
</a></li><li class="dropdown-subitem"><a href="/css/flex-grid.html" class="nav-link">
  Flex与Grid布局
</a></li><li class="dropdown-subitem"><a href="/css/html5-css-1.html" class="nav-link">
  HTML5权威指南(CSS部分)笔记
</a></li></ul></li><li class="dropdown-item"><h4>
          HTML/HTML5
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/html5/html/1.html" class="nav-link">
  HTML5权威指南(HTML部分)笔记
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机基础" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机基础" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/base/js-data-struct.html" class="nav-link">
  学习JavaScript数据结构与算法(第三版)笔记
</a></li><li class="dropdown-item"><!----> <a href="/base/mocha-test.html" class="nav-link">
  Mocha - JavaScript测试框架
</a></li><li class="dropdown-item"><!----> <a href="/base/git.html" class="nav-link">
  Git 笔记
</a></li><li class="dropdown-item"><!----> <a href="/base/markdown.html" class="nav-link">
  Markdown 基础语法
</a></li><li class="dropdown-item"><!----> <a href="/base/dbtheory/1.html" class="nav-link">
  数据库系统原理笔记
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开源项目" class="dropdown-title"><span class="title">开源项目</span> <span class="arrow down"></span></button> <button type="button" aria-label="开源项目" class="mobile-dropdown-title"><span class="title">开源项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="http://vuechart.zuo11.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  @guoqzuo/vue-chart
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://zuoblog.zuo11.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  zuo-blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="http://www.zuo11.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/zuoxiaobai" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>JS/ES6</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>ES6标准入门(第三版)笔记</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>JavaScript高级程序设计(第四版)笔记</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/js/ad3/js-ad4-diff.html" class="sidebar-link">第四版相比第三版有哪些更新 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-1.html" class="sidebar-link">1. 什么是JavaScript - JS高程4</a></li><li><a href="/js/ad3/js-ad3-2.html" class="sidebar-link">2. 在HTML中使用JavaScript - JS高程4</a></li><li><a href="/js/ad3/js-ad3-3.html" class="sidebar-link">3. ES基本概念(语言基础) - JS高程4</a></li><li><a href="/js/ad3/js-ad3-4.html" class="sidebar-link">4. 变量、作用域与内存 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-5.html" class="sidebar-link">5. 基本引用类型 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-6.html" class="sidebar-link">6. 集合引用类型 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-7.html" class="sidebar-link">7. 迭代器与生成器(Iterator 与 Generator) - JS高程4</a></li><li><a href="/js/ad3/js-ad3-8.html" class="sidebar-link">8. 对象、类与面向对象编程 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-9.html" class="sidebar-link">9. 代理与反射(Proxy与Reflect) - JS高程4</a></li><li><a href="/js/ad3/js-ad3-10.html" class="sidebar-link">10. 函数 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-11.html" class="sidebar-link">11. 期约与异步函数(Promise与async/await) - JS高程4</a></li><li><a href="/js/ad3/js-ad3-12.html" class="sidebar-link">12. BOM - JS高程4</a></li><li><a href="/js/ad3/js-ad3-13.html" class="sidebar-link">13. 客户端检测 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-14.html" class="sidebar-link">14. DOM - JS高程4</a></li><li><a href="/js/ad3/js-ad3-15.html" class="sidebar-link">15. DOM扩展 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-16.html" class="sidebar-link">16. DOM2 和 DOM3 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-17.html" class="sidebar-link">17. 事件 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-18.html" class="sidebar-link">18. 动画与 Canvas 图形 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-19.html" class="sidebar-link">19. 表单脚本 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-20.html" class="sidebar-link">20. JavaScript API - JS高程4</a></li><li><a href="/js/ad3/js-ad3-21.html" class="sidebar-link">21. 错误处理与调试 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-22.html" class="sidebar-link">22. 处理 XML - JS高程4</a></li><li><a href="/js/ad3/js-ad3-23.html" class="sidebar-link">23. JSON - JS高程4</a></li><li><a href="/js/ad3/js-ad3-24.html" aria-current="page" class="active sidebar-link">24. 网络请求与远程资源 - JS高程4</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-24.html#xmlhttprequest-对象" class="sidebar-link">XMLHttpRequest 对象</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-24.html#设置-http-头部-xhr-setrequestheader" class="sidebar-link">设置 HTTP 头部(xhr.setRequestHeader())</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-24.html#get-请求" class="sidebar-link">GET 请求</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-24.html#post-请求" class="sidebar-link">POST 请求</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-24.html#xmlhttprequest-level-2" class="sidebar-link">XMLHttpRequest Level 2</a></li></ul></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-24.html#进度事件-load、process等" class="sidebar-link">进度事件 load、process等</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-24.html#跨域资源共享-cors" class="sidebar-link">跨域资源共享 CORS</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-24.html#预检请求-preflight" class="sidebar-link">预检请求(Preflight)</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-24.html#凭据请求-cookie" class="sidebar-link">凭据请求 cookie</a></li></ul></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-24.html#其他跨域技术-img和jsonp" class="sidebar-link">其他跨域技术 (img和JSONP)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-24.html#图片探测" class="sidebar-link">图片探测</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-24.html#jsonp" class="sidebar-link">JSONP</a></li></ul></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-24.html#fetch-api" class="sidebar-link">Fetch API</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-24.html#基本用法" class="sidebar-link">基本用法</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-24.html#常见-fetch-请求模式" class="sidebar-link">常见 Fetch 请求模式</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-24.html#headers-对象" class="sidebar-link">Headers 对象</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-24.html#request-对象" class="sidebar-link">Request 对象</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-24.html#response-对象" class="sidebar-link">Response 对象</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-24.html#request、response-及-body-混入" class="sidebar-link">Request、Response 及 Body 混入</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-24.html#直接操作可读流-readablestream" class="sidebar-link">直接操作可读流 ReadableStream</a></li></ul></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-24.html#beacon-api" class="sidebar-link">Beacon API</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-24.html#web-socket" class="sidebar-link">Web Socket</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-24.html#安全" class="sidebar-link">安全</a></li></ul></li><li><a href="/js/ad3/js-ad3-25.html" class="sidebar-link">25. 客户端存储 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-26.html" class="sidebar-link">26. 模块(Modules) - JS高程4</a></li><li><a href="/js/ad3/js-ad3-27.html" class="sidebar-link">27. 工作者线程(Web Workers) - JS高程4</a></li><li><a href="/js/ad3/js-ad3-28.html" class="sidebar-link">28. 最佳实践 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-old.html" class="sidebar-link">第三版其他内容(高级技巧) - JS高程4</a></li></ul></section></li><li><a href="/js/js-dom-art.html" class="sidebar-link">JavaScript DOM 编程艺术(第二版)笔记</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_24-网络请求与远程资源"><a href="#_24-网络请求与远程资源" class="header-anchor">#</a> 24. 网络请求与远程资源</h1> <p>Ajax(Asynchronous JS + XML) 异步的 JS 和 XML，是一种用于 http 请求的技术。是 Jesse James Garrett 在 2005 年提出的方案。主要用于在不刷新页面的情况下，请求服务器接口获取数据，从而实现了更好的用户体验。现在可能觉得没什么，但以前请求服务器接口获取数据时都需要刷新页面，体验较差。Ajax 技术的核心是 XMLHttpRequest（XHR 对象），为什么是 XML 开头呢？因为在 JSON 出现之前，网络请求使用的数据都是 XML 类型的。 XHR 对象普遍认为比较难用，而 Fetch API 支持 Promise 和 Service Worker，已经成为极其强大的 Web 开发工具</p> <p>Asynchronous <code>[eɪˈsɪŋkrənəs]</code> 异步的</p> <h2 id="xmlhttprequest-对象"><a href="#xmlhttprequest-对象" class="header-anchor">#</a> XMLHttpRequest 对象</h2> <p>XMLHttpRequest，简称 XHR，使用方法如下：</p> <ol><li>使用 <code>new XMLHttpRequest()</code> 构造函数，创建 xhr 对象</li> <li>调用 <code>xhr.open(method, url, isAsync)</code> 准备即将发送的请求，method 为请求方法，比如 &quot;get&quot;、&quot;post&quot;；url 为请求的 URL；isAsync 表示是否是异步发送请求。只能向同一个域中使用相同端口和协议的URL发送请求，否则会引起安全错误(跨域)。</li> <li>使用 <code>xhr.send(data)</code> 发送请求，data 是作为请求体发送的数据，如果不需要发送请求体，必须传 null</li> <li>服务器接收到请求，响应数据后会自动填充到 xhr 对象的属性中，包含以下属性
<ul><li>xhr.status 响应的 HTTP 状态，xhr.status 大于等于 200 且小于 300，或等于 304（资源未修改） 为成功，其他状态码，表示请求异常。一般 200 为成功</li> <li>xhr.responseText 响应主体返回的文本</li> <li>xhr.responseXML 如果响应的内容类型是 &quot;text/xml&quot; 或 &quot;application/xml&quot;, 将包含响应数据的 XML DOM 文档</li> <li>xhr.statusText HTTP 状态的说明</li></ul></li></ol> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>json<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>send-req-btn<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>发送请求<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
      <span class="token comment">// https://zuo11.com/gzh_test</span>
      <span class="token keyword">let</span> sendReqBtn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'send-req-btn'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      sendReqBtn<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 创建xhr对象</span>
        <span class="token keyword">let</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建xhr对象，IE7+</span>

        <span class="token comment">// 2. 启动一个请求以备发送 xhr.open(请求类型，请求的URL，是否发送异步请求) 请求类型(&quot;get&quot;, &quot;post&quot;)，</span>
        xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;https://zuo11.com/gzh_test&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment">// 第三个参数false, 发送一个同步请求，发送请求后，不会向下执行，一直等请求完毕后才会执行后面的内容</span>
        <span class="token comment">// 只能向同一个域中使用相同端口和协议的URL发送请求，否则会引起安全错误(跨域)。</span>

        <span class="token comment">// 3. 发送请求, xhr.send(作为请求主体发送的数据)，如不需要通过请求主体发送数据，则必须传入null</span>
        xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>

        <span class="token comment">// 4. 接收到响应后, 会自动填充XHR对象的属性</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>status <span class="token operator">&gt;=</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> xhr<span class="token punctuation">.</span>status <span class="token operator">&lt;</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token operator">||</span> xhr<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">304</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 请求成功</span>
          <span class="token comment">// alert(xhr.responseText) // 显示响应数据</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xhr<span class="token punctuation">)</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span> <span class="token comment">// string</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token comment">// 和接口返回的一致：</span>
          <span class="token comment">// {</span>
          <span class="token comment">//   &quot;Response&quot;: {</span>
          <span class="token comment">//       &quot;BizToken&quot;: &quot;6EF19446-963B-43C5-AD11-40419DEE1600&quot;,</span>
          <span class="token comment">//       &quot;Url&quot;: &quot;https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx2cca36a86d5035ae&amp;redirect_uri=http%3A%2F%2Fopen.faceid.qq.com%2Fv1%2Fapi%2FgetCode%3FbizRedirect%3Dhttps%253A%252F%252Ffaceid.qq.com%252Fapi%252Fauth%252FgetOpenidAndSaveToken%253Ftoken%253D6EF19446-963B-43C5-AD11-40419DEE1600&amp;response_type=code&amp;scope=snsapi_base&amp;state=&amp;component_appid=wx9802ee81e68d6dee#wechat_redirect&quot;,</span>
          <span class="token comment">//       &quot;RequestId&quot;: &quot;594aa2de-915b-48ac-a9b5-ac3ff2fe40c4&quot;</span>
          <span class="token comment">//   }</span>
          <span class="token comment">// }</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 请求异常</span>
          <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;Request was unsuccessful: &quot;</span> <span class="token operator">+</span> xhr<span class="token punctuation">.</span>status<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><img src="/images/js/xhr%E8%AF%B7%E6%B1%82%E6%88%90%E5%8A%9F%E5%90%8Eprint.png" alt="xhr请求成功后print.png"></p> <p>上面的例子中，xhr.open 第三个参数是 false，是同步请求，会阻碍程序向下执行，一般实际开发中会使用异步的方式。如果是异步，我们通过 xhr 对象上触发的事件来处理异步请求的结果。异步请求时需要监听 xhr 的 readystatechange 事件，当 readyState 为 4 时，就表示请求完成</p> <ul><li>xhr.readyState === 0 未初始化（Uninitialized），尚未调用 open()</li> <li>xhr.readyState === 1 已打开（Open），调用了 open()，但未调用 send()</li> <li>xhr.readyState === 2 已发送（Send），调用了 send()，但未接收到响应</li> <li>xhr.readyState === 3 接收中（Receiving），已经接收到部分响应数据</li> <li>xhr.readyState === 4 完成（Complete），已经接收到全部响应数据，请求已完成。</li></ul> <p><strong>在接收到响应之前，如果想取消异步请求，可以调用 xhr.abort() 方法来取消请求</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 请求完成</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>status <span class="token operator">&gt;=</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> xhr<span class="token punctuation">.</span>status <span class="token operator">&lt;</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token operator">||</span> xhr<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">304</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 请求成功</span>
      <span class="token comment">// alert(xhr.responseText) // 显示响应数据</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xhr<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;Request was unsuccessful: &quot;</span> <span class="token operator">+</span> xhr<span class="token punctuation">.</span>status<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> <span class="token string">&quot;https://zuo11.com/getList&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 发送异步请求</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="设置-http-头部-xhr-setrequestheader"><a href="#设置-http-头部-xhr-setrequestheader" class="header-anchor">#</a> 设置 HTTP 头部(xhr.setRequestHeader())</h3> <p>每个 HTTP 请求和响应都会带有相应的头部信息, 可以在 open 方法之后，send 方法之前调用 xhr.setRequestHeader()，设置对应的请求头。默认情况下 XHR 请求会发送以下头部字段</p> <ul><li><code>Accept</code> 浏览器能够处理的内容类型</li> <li><code>Accept-Charset</code> 浏览器可以显示的字符集</li> <li><code>Accept-Encoding</code> 浏览器可以处理的压缩编码类型</li> <li><code>Accept-Language</code> 浏览器使用的语言</li> <li><code>Connection</code> 浏览器与服务器的连接类型</li> <li><code>Cookie</code> 页面中设置的 Cookie</li> <li><code>Host</code> 发送请求页面所在的域</li> <li><code>Referer</code> 发出请求页面的 URL，这个字段在 HTTP 规范中拼错了，考虑到兼容性，就将错就错，正确的拼写是 referrer</li> <li><code>User-Agent</code> 浏览器用户代理字符串</li> <li><code>Origin</code> 与 Host 类似，当前页面所在的域</li></ul> <p>在实际请求时，chrome 调试面板里 Request Headers (请求头)里，只有 Origin，Referer，User-Agent 信息，在 node 接收处理请求时，能看到请求头的更多信息：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span> 
 host<span class="token operator">:</span> <span class="token string">'localhost:8088'</span><span class="token punctuation">,</span> <span class="token comment">// 发出请求的页面所在的域</span>
 connection<span class="token operator">:</span> <span class="token string">'keep-alive'</span><span class="token punctuation">,</span> <span class="token comment">//浏览器与服务器之间的连接类型</span>
 origin<span class="token operator">:</span> <span class="token string">'http://127.0.0.1'</span><span class="token punctuation">,</span>
 <span class="token string">'user-agent'</span><span class="token operator">:</span> <span class="token comment">// 浏览器的用户代理字符串</span>
  <span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.142 Safari/537.36'</span><span class="token punctuation">,</span>
 accept<span class="token operator">:</span> <span class="token string">'*/*'</span><span class="token punctuation">,</span> <span class="token comment">// 浏览器能够处理的内容类型</span>
 referer<span class="token operator">:</span> <span class="token string">'http://127.0.0.1/json.html'</span><span class="token punctuation">,</span> <span class="token comment">// 发出请求页面的URI</span>
 <span class="token string">'accept-encoding'</span><span class="token operator">:</span> <span class="token string">'gzip, deflate, br'</span><span class="token punctuation">,</span> <span class="token comment">// 浏览器能够处理的压缩编码</span>
 <span class="token string">'accept-language'</span><span class="token operator">:</span> <span class="token string">'zh-CN,zh;q=0.9'</span><span class="token punctuation">,</span> <span class="token comment">// 浏览器当前设置的语言</span>
 <span class="token string">'if-none-match'</span><span class="token operator">:</span> <span class="token string">'W/&quot;2-l9Fw4VUO7kr8CvBlt4zaMCqXZ0w&quot;'</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>实际还有 Cookie 当前页面设置的 cookie, 跨域请求时，需要设置 xhr.withCredentials = true; 服务器才会接收到 Cookie 请求头, 后台需要设置 res.header('Access-Control-Allow-Credentials', 'true');</p> <p><strong>可以使用 xhr.getAllResponseHeaders() 获取所有响应头部信息，使用 xhr.getResponseHeader(prop) 获取属性名为 prop 的响应首部信息</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 请求完成</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>status <span class="token operator">&gt;=</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> xhr<span class="token punctuation">.</span>status <span class="token operator">&lt;</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token operator">||</span> xhr<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">304</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 请求成功</span>
      <span class="token comment">// alert(xhr.responseText) // 显示响应数据</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xhr<span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span><span class="token function">getAllResponseHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取所有的响应头信息</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span><span class="token function">getResponseHeader</span><span class="token punctuation">(</span><span class="token string">&quot;MyHeader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取某个响应头信息</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;Request was unsuccessful: &quot;</span> <span class="token operator">+</span> xhr<span class="token punctuation">.</span>status<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> <span class="token string">&quot;https://zuo11.com/getList&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 发送异步请求</span>
xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">&quot;myHeader&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Myvalue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="get-请求"><a href="#get-请求" class="header-anchor">#</a> GET 请求</h3> <p>GET 请求如果想要向服务器发送某些信息，可以在 URL 后面添加查询字符串。注意需要使用 encodeURIComponent 对内容进行编码</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">addURLParam</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  url <span class="token operator">+=</span> url<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">&quot;&amp;&quot;</span><span class="token operator">:</span> <span class="token string">&quot;?&quot;</span><span class="token punctuation">;</span>
  url <span class="token operator">+=</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'='</span> <span class="token operator">+</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> url<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>status <span class="token operator">&gt;=</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> xhr<span class="token punctuation">.</span>status <span class="token operator">&lt;</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token operator">||</span> xhr<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">304</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'请求异常'</span> <span class="token operator">+</span> xhr<span class="token punctuation">.</span>status <span class="token operator">+</span> <span class="token string">','</span> <span class="token operator">+</span> xhr<span class="token punctuation">.</span>statusText<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token string">&quot;http://127.0.0.1:8088&quot;</span><span class="token punctuation">;</span>
url <span class="token operator">=</span> <span class="token function">addURLParam</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token string">'num'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
url <span class="token operator">=</span> <span class="token function">addURLParam</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token string">'start'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="post-请求"><a href="#post-请求" class="header-anchor">#</a> POST 请求</h3> <p>每个 POST 请求都需要在请求体中携带提交的数据。由于 XML 最初主要设计用于发送 XML，所以可以传入序列化之后的 XML DOM 文档作为请求体。也可以传入任意字符串。可以通过设置 Content-Type 请求头，指定发送数据的格式。</p> <ul><li><code>&quot;application/json&quot;</code> JSON 格式数据，如 '{ a: 1, b: 2}'</li> <li><code>&quot;application/x-www-form-urlencoded&quot;</code> 序列化数据，如 'a=1&amp;b=2'</li> <li><code>&quot;multipart/form-data&quot;</code> 表单数据，如 FormData 类型，可以传文件二进制数据</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>status <span class="token operator">&gt;=</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> xhr<span class="token punctuation">.</span>status <span class="token operator">&lt;</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token operator">||</span> xhr<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">304</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'请求异常'</span> <span class="token operator">+</span> xhr<span class="token punctuation">.</span>status <span class="token operator">+</span> <span class="token string">','</span> <span class="token operator">+</span> xhr<span class="token punctuation">.</span>statusText<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token string">&quot;http://127.0.0.1:8088/getList&quot;</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'post'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;application/json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 发送json数据</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'{&quot;a&quot;: 1,&quot;b&quot;: 2}'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 发送json格式数据，要先转为JSON格式字符串</span>

<span class="token comment">// xhr.setRequestHeader(&quot;Content-Type&quot;, &quot;application/x-www-form-urlencoded&quot;); // 发送序列化数据</span>
<span class="token comment">// // serialize(form) 序列化数据</span>
<span class="token comment">// xhr.send(&quot;a=1&amp;b=2&quot;); </span>

<span class="token comment">// 以上两种方法，node express 均可用 req.body 获取对应的参数对象</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>POST 请求比 GET 请求要占用更多资源。从性能方面说，发送相同数量的数据，GET 请求比 POST 请求要快两倍</p></div> <h3 id="xmlhttprequest-level-2"><a href="#xmlhttprequest-level-2" class="header-anchor">#</a> XMLHttpRequest Level 2</h3> <p>XHR 对象作为事实标准迅速流行，促使 W3C 为规范这一行为而制定了正式标准。XMLHttpRequest Level 1 只是把已有的 XHR 对象实现细节描述了出来。而 XMLHttpRequest Level 2 又进一步发展了XHR，内容包括 FormData 类型，超时设定 timeout 等</p> <h4 id="formdata-类型"><a href="#formdata-类型" class="header-anchor">#</a> FormData 类型</h4> <p>提交表单数据之前需要序列化表单数据，或者转成 JSON 格式数据。FormData 可以快速封装表单数据，方便提交。post 请求发送 FormData 数据时不需要设置请求头的 Content-type，系统如果识别到 FormData 数据类型会自动添加对应的请求头</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// formObj为表单对象</span>
<span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span>formObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
data<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;111111&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 添加一个新元素</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>status <span class="token operator">&gt;=</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> xhr<span class="token punctuation">.</span>status <span class="token operator">&lt;</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token operator">||</span> xhr<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">304</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'请求异常'</span> <span class="token operator">+</span> xhr<span class="token punctuation">.</span>status <span class="token operator">+</span> <span class="token string">','</span> <span class="token operator">+</span> xhr<span class="token punctuation">.</span>statusText<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token string">&quot;http://127.0.0.1:8088/getList&quot;</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'post'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// xhr 对象能识别传入的数据类型是 FormData 的实例，并配置适当的头部信息</span>
<span class="token comment">// 默认配置的是 Content-Type: multipart/form-data; node bodyparse不能处理 multipart 数据，需要再用插件</span>
</code></pre></div><h4 id="超时设定-ie8"><a href="#超时设定-ie8" class="header-anchor">#</a> 超时设定 IE8+</h4> <p>IE8 为 xhr 添加了 timeout 属性，毫秒。表示请求在等待多少毫秒后没有结束就会自动终止。如果超过该时间，会触发 xhr 的 timeout 事件，这个特性后来被添加到了 XMLHttpRequest Level 2 规范中。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>status <span class="token operator">&gt;=</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> xhr<span class="token punctuation">.</span>status <span class="token operator">&lt;</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token operator">||</span> xhr<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">304</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'请求异常'</span> <span class="token operator">+</span> xhr<span class="token punctuation">.</span>status <span class="token operator">+</span> <span class="token string">','</span> <span class="token operator">+</span> xhr<span class="token punctuation">.</span>statusText<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token string">&quot;http://127.0.0.1:8088/getList&quot;</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span>timeout <span class="token operator">=</span> <span class="token number">2000</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function-variable function">ontimeout</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'请求超时'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="进度事件-load、process等"><a href="#进度事件-load、process等" class="header-anchor">#</a> 进度事件 load、process等</h2> <p>ProgressEvent 是 W3C 的工作草案，定义了客户端-服务器端通信。这些事件最初只针对 XHR，现在也推广到了其他类似的 API。有以下 6 个进度事件</p> <ul><li><code>loadstart</code> 在接收到服务器响应数据的第一个字节时触发</li> <li><code>progress</code> 在接收到响应期间不断的触发</li> <li><code>error</code> 在请求出错时触发</li> <li><code>abort</code> 在因为调用 abort() 时触发</li> <li><code>load</code> 在接收完整的数据响应时触发</li> <li><code>loadend</code> 在通信完成或者触发 error、abort 或 load 事件后触发</li></ul> <p>每个请求都从触发 loadstart 事件开始，接下来是一个或多个 progress 事件，然后触发 error、abort 或 load 事件中的一个，最后触发 loaded 事件。</p> <p><strong>load 事件</strong>，load 事件完全可以代替 xhr.onreadystatechange 事件，改写后的请求示例如下</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 请求成功</span>
    <span class="token function">alert</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'请求异常'</span><span class="token punctuation">,</span> xhr<span class="token punctuation">.</span>status<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> <span class="token string">'http://127.0.0.1:8088/getList'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>progress 事件</strong>，在文件下载，接收响应数据时 progress 事件可以获取数据接收进度，进度事件包含 3 个额外的属性</p> <ul><li><code>event.lengthComputable</code> 进度信息是否可用，如果是完整的文件信息就是 true, total 表示数据大小。如果响应数据时 stream 流式数据，则该值为 false, total 为 0。</li> <li><code>event.position/loaded</code> 已接收的字节数，最新的是 loaded</li> <li><code>event.totalSize/total</code> 表示根据 Content-Length 响应头确定的预期字节数 最新的属性是 total</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 请求成功</span>
    <span class="token function">alert</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'请求异常'</span><span class="token punctuation">,</span> xhr<span class="token punctuation">.</span>status<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
xhr<span class="token punctuation">.</span><span class="token function-variable function">onprogress</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>lengthComputable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;接收到: &quot;</span> <span class="token operator">+</span> event<span class="token punctuation">.</span>loaded <span class="token operator">+</span> <span class="token string">&quot;, 总共: &quot;</span><span class="token operator">+</span> event<span class="token punctuation">.</span>total <span class="token operator">+</span> <span class="token string">'bytes'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> <span class="token string">'http://127.0.0.1:8088/getList'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="跨域资源共享-cors"><a href="#跨域资源共享-cors" class="header-anchor">#</a> 跨域资源共享 CORS</h2> <p>通过 XHR 实现 Ajax 通信的一个主要限制，来源于跨域安全策略。默认情况下，XHR 对象只能访问与包含它的页面位于同一域中的资源。对于某些合理的跨域请求，需要允许。CORS(Cross-Origin Resource Sharing) 跨域资源共享就是为了解决这个问题的。</p> <p>CORS 定义了必须访问跨域资源时，浏览器与服务器应该如何沟通。基本思想是：使用自定义的 HTTP 头部让浏览器与服务器进行沟通，从而决定请求或响应是应该成功还是失败。IE9+</p> <p>一般请求头里会包含 Origin 字段，表示当前域。如果服务器认为这个请求可以接受，就在响应头的 Access-Control-Allow-Origin 字段中返回相同的信息，或者&quot;*&quot;，表示允许，比如：</p> <ul><li>请求头里的属性 Origin: http://127.0.0.1</li> <li>响应头里的属性 Access-Control-Allow-Origin: http://127.0.0.1 或者 Access-Control-Allow-Origin: &quot;*&quot;</li></ul> <p>如果响应头没有 Access-Control-Allow-Origin 属性，或者与请求头的 Origin 信息不匹配，浏览器就会驳回请求，如果相同，就会处理请求。注意跨域请求和响应都不包含cookie信息。</p> <ul><li>IE 对 CORS 的实现 IE8 引入了 XDR(XDomainRequest) 类型，类似于 XHR 用于支持跨域通信，IE9+ 支持XHR CORS, 故暂不考虑对 XDR 的研究</li> <li>跨域请求会有一些限制，比如不能使用 xhr.setRequestHeader() 设置自定义头部</li> <li>不能发送和接收 cookie</li> <li>调用 getAllResponseHeaders() 获取的信息会不完整</li></ul> <h3 id="预检请求-preflight"><a href="#预检请求-preflight" class="header-anchor">#</a> 预检请求(Preflight)</h3> <p>为什么会有preflight预检请求？浏览器限制跨域有两种方式：</p> <ol><li>浏览器限制发起跨域请求</li> <li>跨域请求可以正常发起，但返回的结果被浏览器拦截了</li></ol> <p>一般浏览器都是使用第二种方式限制跨域请求，跨域请求已经到达服务器，并可能对数据库里的数据进行了操作，但返回的结果被浏览器拦截了，对前端来讲这是一次失败的请求，但可能对数据库里的数据产生了影响</p> <p>为了防止这种情况发生，对于可能对服务器数据产生副作用的 HTTP 请求方法，浏览器会先发起一个 OPTIONS 预检请求，从而获知服务器是否允许跨域请求：如果允许，就发送带真实的数据请求，如果不允许，则阻止带数据的真实请求。</p> <p>什么情况会发触发CORS预检请求?</p> <ul><li>使用了 PUT、DELETE、CONNECT、OPTIONS、TRACE、PATCH 请求方法</li> <li>人为设置了CORS安全的请求头之外的其他请求头，下面是安全的请求头列表
<ul><li>Accept</li> <li>Accept-Language</li> <li>Content-Language</li> <li>Content-Type</li> <li>DPR</li> <li>Downlink</li> <li>Save-Data</li> <li>Viewport-Width</li> <li>Width</li> <li>Content-Type 值为 application/x-www-form-urlencoded、multipart/form-data、text/plain</li></ul></li></ul> <p>因此，仅设置 Access-Control-Allow-Origin 响应头，在发生跨域请求时，如果出现 OPTIONS 预检请求，就会发生错误，因此还需要设置以下响应头，跨域请求才能正常发送。</p> <div class="language-js extra-class"><pre class="language-js"><code>res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&quot;Access-Control-Allow-Origin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置响应头允许的域名，如果是* 表示所有</span>
res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Methods'</span><span class="token punctuation">,</span> <span class="token string">'PUT, GET, POST, DELETE, OPTIONS'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 允许的请求类型</span>
res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&quot;Access-Control-Max-Age&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1728000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 应该将这个 Preflight 请求缓存多久(单位为妙)</span>
res<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Headers'</span><span class="token punctuation">,</span> <span class="token string">'Content-Type'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 允许的头部</span>
</code></pre></div><p>关于请求预检的更多信息参见：<a href="http://www.zuo11.com/blog/2020/6/koa_web_cros.html" target="_blank" rel="noopener noreferrer">CORS跨域资源共享 - 利用koa来彻底理解web前端跨域问题 - 左小白的技术日常<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="凭据请求-cookie"><a href="#凭据请求-cookie" class="header-anchor">#</a> 凭据请求 cookie</h3> <blockquote><p>credentials [krəˈdenʃlz] n. [管理] 证书；文凭；</p></blockquote> <p>带凭据的请求, 默认情况下跨域请求不提供凭据(cookie, HTTP 认证及客户端 SSL 证明等)。通过将 withCredentials 属性设置为 true，可以指定某个请求应该发送凭据。如果发送的是带凭据的请求，但服务器的响应中没有包含 <code>Access-Control-Allow-Credentials: true</code> 这个头部，那浏览器不会把响应交给 JS。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 客户端请求头</span>
<span class="token comment">// xhr.withCredentials = true;</span>

<span class="token comment">// 服务器端响应头</span>
<span class="token comment">// res.header('Access-Control-Allow-Credentials', 'true'); </span>
</code></pre></div><h2 id="其他跨域技术-img和jsonp"><a href="#其他跨域技术-img和jsonp" class="header-anchor">#</a> 其他跨域技术 (img和JSONP)</h2> <p>在 CORS 出现之前，可以使用非 xhr 的方式发送跨域请求，比如 img 图片探测（image pings），JSONP 等</p> <h3 id="图片探测"><a href="#图片探测" class="header-anchor">#</a> 图片探测</h3> <p>图片 img 标签，new Image(), img.src = &quot;http://xxx.com/test?a=1&amp;b=2&quot; 发送get请求。只能发送get请求，无法访问服务器的响应数据，仅用于单向通信。可以用于跟踪用户行为(埋点)或动态显示广告。</p> <h3 id="jsonp"><a href="#jsonp" class="header-anchor">#</a> JSONP</h3> <p>JSONP，JSON with padding( 填充式JSON, 或参数式JSON)，客户端服务端都需要加上处理。</p> <ul><li>客户端使用 script 元素的 src 发送请求，且在 url 上添加处理响应的 callback 函数</li> <li>响应数据使用 callback 指定的函数名 + 响应的数据，即可在前端执行 callback 函数，接收响应</li></ul> <p>JSOP 的缺点是如果是从不同域获取的结果，可能会返回恶意的执行代码。另外 JSONP 无法接收请求失败的信息，HTML5 标准中 script 的 error 事件没有浏览器实现。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>utf-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>jsonp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 客户端代码 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>jsonpclick<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>jsonp test<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">function</span> <span class="token function">handleRes</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
      <span class="token comment">// 这里可以接收到对应的数据</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> jsonpclick <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'jsonpclick'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    jsonpclick<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'开始测试'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      script<span class="token punctuation">.</span>type<span class="token operator">=</span><span class="token string">&quot;text/javascript&quot;</span> 
      script<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&quot;http://127.0.0.1:8088/gzh_test?callback=handleRes&quot;</span>
      document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>script<span class="token punctuation">,</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>firstChild<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>jsonp node服务端代码</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">gzhM_test</span><span class="token punctuation">(</span><span class="token parameter">app<span class="token punctuation">,</span> data<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'开始执行gzhm_test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>query <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//console.log(params.query.callback);</span>
        <span class="token keyword">let</span> str <span class="token operator">=</span>  req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>callback <span class="token operator">+</span> <span class="token string">'('</span> <span class="token operator">+</span> <span class="token string">&quot;a=2&quot;</span> <span class="token operator">+</span> <span class="token string">')'</span><span class="token punctuation">;</span><span class="token comment">//jsonp</span>
        res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'b=2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//普通的json</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>跨域的理解可以参考：<a href="http://www.zuo11.com/blog/2020/6/koa_web_cros.html" target="_blank" rel="noopener noreferrer">利用koa来彻底理解web前端跨域问题 - 左小白的技术日常<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="fetch-api"><a href="#fetch-api" class="header-anchor">#</a> Fetch API</h2> <p>Fetch API 能够执行 XMLHttpRequest 对象的所有任务，且更容易使用，接口更加现代化，能够在 Web Worker 里面使用。XMLHttpRequest 可以选择异步，而 Fetch API 必须是异步。</p> <p>Fetch API 是 WHATWG 的一个 &quot;活标准&quot;（living standard）。&quot;Fetch 标准定义请求、响应，以及绑定二者的流程：获取（fetch）&quot;。在 Service worker 中，提供拦截、重定向和修改通过 fetch() 生成的请求接口。</p> <h3 id="基本用法"><a href="#基本用法" class="header-anchor">#</a> 基本用法</h3> <p><strong>1. 调用 <code>fetch(url, options)</code> 发送请求</strong>，url 为请求的地址，如果 url 以 <code>/</code> 开头就是绝对路径，也可以使用相对路径。options 为发送请求时的可配置选项。该函数返回一个 resolve 为 Response 类型的 Promise 实例。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/test'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token comment">// Promise {&lt;pending&gt;}</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token comment">// Promise {&lt;fulfilled&gt;: Response}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>2. 获取响应数据</strong>，最简单的方式是使用 Response 的 text() 方法获取纯文本格式的响应数据。它返回一个 resolve 为 String 类型的 Promise</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'a.js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>cosnole<span class="token punctuation">.</span>log<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// Response { </span>
  <span class="token comment">//   body: ReadableStream, </span>
  <span class="token comment">//   type: &quot;basic&quot;, </span>
  <span class="token comment">//   headers: Headers {}, </span>
  <span class="token comment">//   status: 200, </span>
  <span class="token comment">//   url: &quot;http://...&quot;</span>
  <span class="token comment">//   ...</span>
  <span class="token comment">// }</span>

  <span class="token comment">// 打印的 a.js 内容</span>
  <span class="token comment">// const a = 1</span>
  <span class="token comment">// console.log(a)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>利用 Promise.then 的链式调用特性，可以改写上面的例子</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'a.js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token comment">// 更精简的写法</span>
  <span class="token comment">// fetch('a.js').then(r =&gt; r.text()).then(console.log)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>3.http状态码与请求失败处理</strong>，Response 对象的 status 和 statusText 属性分别表示 <strong>状态码</strong> 以及 <strong>状态码说明</strong>，他们的值可能是</p> <table><thead><tr><th>status</th> <th>statusText</th> <th>ok</th> <th>是否是 resolve 状态</th></tr></thead> <tbody><tr><td>200</td> <td>&quot;OK&quot;</td> <td>true</td> <td>是</td></tr> <tr><td>404</td> <td>&quot;Not Found&quot;</td> <td>false</td> <td>是</td></tr> <tr><td>405</td> <td>&quot;Method Not Allowed&quot;</td> <td>false</td> <td>是</td></tr> <tr><td>500</td> <td>&quot;Internal Server Error&quot;</td> <td>false</td> <td>是</td></tr></tbody></table> <p>通常情况下，status 值为 <code>200 ~ 299</code> 时是请求 OK，<code>300 ~ 399</code> 表示重定向（redirected），500 表示服务器错误。</p> <ul><li><strong>当服务器发生错误返回 500 时， fetch 的结果也是 resolve，只要服务器返回了结果，fetch 都会是 resolve 状态</strong></li> <li><strong>404 返回的也是 resolve 状态</strong></li> <li>当发生跨域请求/接口服务停止时，状态为 rejected，错误信息为 Failed to fetch，错误类型为 TypeError。</li> <li>浏览器超时时间很长，大于 3、4 分钟，需要自己写超时策略。</li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'http://127.0.0.1:8088/user'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> status<span class="token punctuation">,</span> statusText<span class="token punctuation">,</span> url <span class="token punctuation">}</span> <span class="token operator">=</span> res
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>status<span class="token punctuation">,</span> statusText<span class="token punctuation">,</span> url<span class="token punctuation">)</span>
    <span class="token comment">// url 为请求的 url, 比如 &quot;http://127.0.0.1:8888/user&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> err<span class="token punctuation">,</span> err<span class="token punctuation">,</span> err<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// 发生跨域请求时 catch 仅能捕获到 &quot;TypeError: Failed to fetch&quot; 错误信息 </span>
  <span class="token comment">// GET http://127.0.0.1:8088/user net::ERR_CONNECTION_REFUSED</span>
  <span class="token comment">// object</span>
  <span class="token comment">// TypeError: Failed to fetch </span>
  <span class="token comment">// Failed to fetch </span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>4. options 自定义请求选项</strong></p> <table><thead><tr><th>key</th> <th>value</th></tr></thead> <tbody><tr><td>body</td> <td>指定请求体内容，必须是 Blob、BufferSource、FormData、URLSearchParams、ReadableStream 或 String 实例</td></tr> <tr><td>cache</td> <td>用于控制浏览器与 HTTP 缓存的交互。&quot;no-store&quot;、&quot;reload&quot;、&quot;no-cahe&quot; 等，默认为 &quot;default&quot;</td></tr> <tr><td>credentials</td> <td>类似 xhr.widthCredentials，默认为 &quot;same-origin&quot; 仅同源是发送。&quot;omit&quot; 为不发送 cookie，&quot;include&quot; 总是包含 cookie</td></tr> <tr><td>headers</td> <td>请求头部，必须是 Headers 对象或键值对常规对象</td></tr> <tr><td>integrity</td> <td>用于强制资资源完整性，默认为空字符串</td></tr> <tr><td>keepalive</td> <td>默认为 false，是否允许请求存在事件超出页面生命周期，比如页面 unload 之后的上报信息。可以用于替代 Navigator.sendBeacon()</td></tr> <tr><td>method</td> <td>HTTP 请求方式，默认为 &quot;GET&quot;，可以是 POST、PUT、PATCH、DELETE、HEAD、OPTIONS、CONNECT、TRACE</td></tr> <tr><td>mode</td> <td>指定跨域请求是否可以发送成功，响应结果是否可读。通过构造函数手动创建 Request 实例时，默认为 &quot;cors&quot;（允许遵循 CORS 规则的跨域请求），否则为 &quot;no-cors&quot;（允许不需要发送预检请求的跨域请求，但无法读取响应内容，响应类型是 opaque）。&quot;same-origin&quot; 任何跨域请求都不同发送。&quot;navigate&quot; 用于支持 HTML 导航，只在文档导航时有用，基本用不到</td></tr> <tr><td>redirect</td> <td>用于指定如何处理重定向（301 永久、302 临时、303、307、308）, 默认为 &quot;follow&quot;，跟踪重定向，以最终非重定向的 URL 作为最终响应。&quot;error&quot; 重定向请求直接抛出错误。&quot;manual&quot; 不跟踪重定向，返回 opaqueredirect 类型的响应，允许手动方式跟踪重定向。 opaque <code>[ə(ʊ)ˈpeɪk]</code> 不透明的</td></tr> <tr><td>referrer</td> <td>用于指定 HTTP 的 Referer(推荐人上线人,来历) 头部。默认为 &quot;client/about:client&quot;，以当前 URL 或 &quot;no-referrer&quot; 作为值， &quot;no-referrer&quot; 以 no-referrer 为值。'url值', 以伪造 URL 为值，伪造 URL 的源必须与执行脚本的源匹配</td></tr> <tr><td>referrerPolicy</td> <td>Policy <code>[ˈpɒləsi]</code> 政策、方针。指定 HTTP 的 Referrer 头部，详情参考 p728</td></tr> <tr><td>signal</td> <td>用于 abort 终止请求。默认为 AbortSignal 实例</td></tr></tbody></table> <h3 id="常见-fetch-请求模式"><a href="#常见-fetch-请求模式" class="header-anchor">#</a> 常见 Fetch 请求模式</h3> <p><strong>1.发送 JSON 数据的 POST 请求</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
  headers<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Headers</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  body<span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&quot;张三&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span>
</code></pre></div><p><strong>2.发送序列化数据</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
  headers<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Headers</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/x-www-form-urlencoded; charset=UTF-8'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  body<span class="token operator">:</span> <span class="token string">'a=1&amp;b=jack'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span>
</code></pre></div><p><strong>3.上传文件</strong>，文件数据需要使用 FormData 类型。和 xhr 类似，当发送的数据是 FormData 时，不用自己设置 Content-Type，会自动识别</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- &lt;input type=&quot;file&quot; id=&quot;file&quot;&gt; --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span> <span class="token attr-name">multiple</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">let</span> fileInput <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'file'</span><span class="token punctuation">)</span>
 
  fileInput<span class="token punctuation">.</span><span class="token function-variable function">onchange</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> formData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 多个文件上传：使用同一个字段上传</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>files<span class="token punctuation">)</span> <span class="token comment">// FileList 类数组对象</span>
    <span class="token keyword">let</span> files <span class="token operator">=</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>files
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> len <span class="token operator">=</span> files<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'image'</span><span class="token punctuation">,</span> files<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 单文件上传</span>
    <span class="token comment">// formData.append('image', files[0])</span>
    formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'param1'</span><span class="token punctuation">,</span> <span class="token string">'abc'</span><span class="token punctuation">)</span>
    <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/upload'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
      body<span class="token operator">:</span> formData
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span>
    <span class="token comment">//  { param1: 'abc' }</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>koa 处理文件上传可以使用 multer 组件，相关接口 demo 参见： <a href="https://github.com/zuoxiaobai/fedemo/blob/master/src/JS_ES6/JS%E9%AB%98%E7%A8%8B3/fetch/app.js" target="_blank" rel="noopener noreferrer">koa 处理文件上传 /upload 接口 demo | Github<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><strong>4.加载 Blob 文件</strong>，包括加载静态数据或者从接口获取文件数据</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'warning.png'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">blob</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">blob</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span>
      <span class="token keyword">let</span> img <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      img<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span>
      document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/download'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span> <span class="token operator">||</span> res<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">304</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">blob</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'/download error'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">blob</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// console.log(blob) // Blob {size: 64082, type: &quot;application/octet-stream&quot;}</span>

      <span class="token comment">// 如果接口通过响应头设置了响应的文件类型，文件名，就不用 new Blob 再转一次了</span>
      <span class="token comment">//  ctx.set({</span>
      <span class="token comment">//   'Content-Type': 'image/png',</span>
      <span class="token comment">//   'Content-Disposition': `attachment; filename=&quot;warning.png&quot;`</span>
      <span class="token comment">// })</span>
      blob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span>blob<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">&quot;image/png&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span> <span class="token comment">// Blob {size: 64082, type: &quot;image/png&quot; }</span>
      <span class="token keyword">let</span> a <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span>
      <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span>
      a<span class="token punctuation">.</span>href <span class="token operator">=</span> url
      a<span class="token punctuation">.</span>download <span class="token operator">=</span> <span class="token string">'123.png'</span> <span class="token comment">// 指定文件名</span>
      document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
      a<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
      <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">revokeObjectURL</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>参考：<a href="http://www.zuo11.com/blog/2019/10/http_download_progress.html" target="_blank" rel="noopener noreferrer">下载文件进度显示以及koa下载接口mock - 左小白的技术日常<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><strong>5.发送跨域请求</strong></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'http://127.0.0.1:8888/corsTest'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
    headers<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Headers</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    body<span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">&quot;张三&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// mode: 'no-cors' </span>
    <span class="token comment">// 允许跨域, 可以成功，但无法读响应内容 Response {type: &quot;opaque&quot;, url: &quot;&quot;, } </span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// Response {type: &quot;cors&quot;, url: &quot;http://127.0.0.1:8888/corsTest&quot; }</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span>

  <span class="token comment">// Access to fetch at 'http://127.0.0.1:8888/corsTest' from origin 'http://127.0.0.1:5502' </span>
  <span class="token comment">// has been blocked by CORS policy: Response to preflight request </span>
  <span class="token comment">// doesn't pass access control check: No 'Access-Control-Allow-Origin' </span>
  <span class="token comment">// header is present on the requested resource. If an opaque response </span>
  <span class="token comment">// serves your needs, set the request's mode to </span>
  <span class="token comment">// 'no-cors' to fetch the resource with CORS disabled.</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>后端允许跨域代码，更多跨域详情，参考 <a href="http://www.zuo11.com/blog/2020/6/koa_web_cros.html" target="_blank" rel="noopener noreferrer">利用koa来彻底理解web前端跨域问题 | 左小白的技术日常<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// options 预检请求时允许</span>
router<span class="token punctuation">.</span><span class="token function">options</span><span class="token punctuation">(</span><span class="token string">'/corsTest'</span><span class="token punctuation">,</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string">'Access-Control-Allow-Origin'</span><span class="token operator">:</span> <span class="token string">'*'</span><span class="token punctuation">,</span>
    <span class="token string">'Access-Control-Allow-Methods'</span><span class="token operator">:</span> <span class="token string">'*'</span><span class="token punctuation">,</span>
    <span class="token string">'Access-Control-Allow-Headers'</span><span class="token operator">:</span> <span class="token string">'*'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 真实请求</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/corsTest'</span><span class="token punctuation">,</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string">'Access-Control-Allow-Origin'</span><span class="token operator">:</span> <span class="token string">'*'</span><span class="token punctuation">,</span>
    <span class="token string">'Access-Control-Allow-Methods'</span><span class="token operator">:</span> <span class="token string">'*'</span><span class="token punctuation">,</span>
    <span class="token string">'Access-Control-Allow-Headers'</span><span class="token operator">:</span> <span class="token string">'*'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span> a<span class="token operator">:</span> <span class="token number">123</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>6.中断请求</strong></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">let</span> abortControler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AbortController</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>abortControler<span class="token punctuation">,</span> abortControler<span class="token punctuation">.</span>signal<span class="token punctuation">)</span>
  <span class="token comment">// AbortController {signal: AbortSignal}</span>
  <span class="token comment">// AbortSignal {aborted: false, onabort: null }</span>
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/abortTest'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
    headers<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Headers</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    body<span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">&quot;张三&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    signal<span class="token operator">:</span> abortControler<span class="token punctuation">.</span>signal
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span> 
  <span class="token comment">// 中断请求时 DOMException: The user aborted a request.</span>

  <span class="token comment">// 2 秒后中断请求</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> abortControler<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>后端接口</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/abortTest'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token function-variable function">sleep</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">t</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">r</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span> a<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="headers-对象"><a href="#headers-对象" class="header-anchor">#</a> Headers 对象</h3> <p>请求头部（Request Headers）和响应头部（Response Headers）都是 Headers 对象，类似 Map 类型。支持如下方法：has()、append()、delete()、get()、set()、forEach()、keys()、values()、entries()。使用方法如下</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
    <span class="token comment">// 请求头</span>
    headers<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Headers</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    body<span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">&quot;张三&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>headers<span class="token punctuation">)</span> <span class="token comment">// Headers {} </span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">fromEntries</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// {</span>
    <span class="token comment">//   connection: &quot;keep-alive&quot;</span>
    <span class="token comment">//   content-length: &quot;7&quot;</span>
    <span class="token comment">//   content-type: &quot;application/json; charset=utf-8&quot;</span>
    <span class="token comment">//   date: &quot;Sat, 12 Dec 2020 17:03:31 GMT&quot;</span>
    <span class="token comment">// }</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
    <span class="token comment">// application/json; charset=utf-8</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p><strong>注意：有些安全的请求头有些是不能修改的</strong>，参考：</p> <ul><li><a href="https://developer.mozilla.org/en-US/docs/Glossary/Forbidden_header_name" target="_blank" rel="noopener noreferrer">Forbidden header name | MDN<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://www.zuo11.com/blog/2019/10/http_request_header.html" target="_blank" rel="noopener noreferrer">前端ajax请求时，设置Cookie请求头无效 - 左小白的技术日常<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://developer.mozilla.org/en-US/docs/Glossary/CORS-safelisted_request_header" target="_blank" rel="noopener noreferrer">CORS-safelisted request header | MDN<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://developer.mozilla.org/zh-CN/docs/glossary/forbidden_response_header_name" target="_blank" rel="noopener noreferrer">Forbidden response header name | MDN<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h3 id="request-对象"><a href="#request-对象" class="header-anchor">#</a> Request 对象</h3> <p>资源请求信息对象使用 Request 对象来表示，相关 API 如下</p> <ul><li><code>new Request(url[, options])</code> 创建 Request对象，和 fetch 的参数类似，但不会发送请求。</li> <li><code>new Request(Request 实例[, options])</code> 拷贝 Request 实例，并不是完全相同，bodyUsed 属性可能不会完全一致</li> <li><code>Request实例.clone()</code> 拷贝 Request 实例，会创建一个一模一样的副本</li> <li><code>Request实例.text()</code> 设置 bodyUsed 为 true，这个属性为 true 后，clone() 会出错</li> <li><code>fetch(Request实例, options)</code> 在 fetch() 中使用 Reqeust 对象，如果调用了 Request.text() 后
, bodyUsed 为 true，则会抛出异常</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">Request</span><span class="token punctuation">(</span><span class="token string">'/test'</span><span class="token punctuation">)</span>
<span class="token comment">// Request {</span>
<span class="token comment">//   bodyUsed: false</span>
<span class="token comment">//   cache: &quot;default&quot;</span>
<span class="token comment">//   credentials: &quot;same-origin&quot;</span>
<span class="token comment">//   destination: &quot;empty&quot;</span>
<span class="token comment">//   headers: Headers {}</span>
<span class="token comment">//   integrity: &quot;&quot;</span>
<span class="token comment">//   isHistoryNavigation: false</span>
<span class="token comment">//   keepalive: false</span>
<span class="token comment">//   method: &quot;GET&quot;</span>
<span class="token comment">//   mode: &quot;cors&quot;</span>
<span class="token comment">//   redirect: &quot;follow&quot;</span>
<span class="token comment">//   referrer: &quot;about:client&quot;</span>
<span class="token comment">//   referrerPolicy: &quot;&quot;</span>
<span class="token comment">//   signal: AbortSignal {aborted: false, onabort: null}</span>
<span class="token comment">//   url: &quot;http://127.0.0.1:8080/test&quot;</span>
<span class="token comment">//   __proto__: Request</span>
<span class="token comment">// }</span>

<span class="token comment">// 如果传入了 options 会修改默认的值</span>
<span class="token keyword">new</span> <span class="token class-name">Request</span><span class="token punctuation">(</span><span class="token string">'/test'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
  headers<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Headers</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  body<span class="token operator">:</span> <span class="token string">'123'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="response-对象"><a href="#response-对象" class="header-anchor">#</a> Response 对象</h3> <p>Response 对象是响应信息的对象，也可以使用 new 来创建，不过一般是用来接收响应数据，不会去新建。相关 API 如下</p> <ul><li><code>new Response(可选的响应数据)</code> 可选的响应数据参数等价于 request 中的 body 参数</li> <li><code>Response.redirect(url, status)</code> 返回重定向 Response 对象，headers 包含 location 指向重定向地址。status必须是重定向 code，否则会报错</li> <li><code>Response.error()</code> 用于产生表示网络错误的 Response 对象</li> <li><code>Response实例.clone()</code> 创建 Response 对象的副本，如果使用 Response实例.text() 设置 bodyUsed 为 true 后，就无法 clone() 了。 向 text() 方法读取了 body 可读流，下一次调用 text() 或报错，使用 clone() 创建副本再读取响应内容，不会影响原 Response 的读取状态。详情参：p739</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// Response {</span>
<span class="token comment">//   body: null</span>
<span class="token comment">//   bodyUsed: false</span>
<span class="token comment">//   headers: Headers {}</span>
<span class="token comment">//   ok: true</span>
<span class="token comment">//   redirected: false</span>
<span class="token comment">//   status: 200</span>
<span class="token comment">//   statusText: &quot;&quot;</span>
<span class="token comment">//   type: &quot;default&quot;</span>
<span class="token comment">//   url: &quot;&quot;</span>
<span class="token comment">//   __proto__: Response</span>
<span class="token comment">// }</span>

<span class="token comment">// 设置响应数据</span>
<span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token punctuation">{</span>data<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
Response <span class="token punctuation">{</span>
  <span class="token comment">// body: ReadableStream</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

Response<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/test'</span><span class="token punctuation">,</span> <span class="token number">301</span><span class="token punctuation">)</span> 
<span class="token comment">// Response {</span>
<span class="token comment">//   body: null</span>
<span class="token comment">//   bodyUsed: false</span>
<span class="token comment">//   headers: Headers {} // {location: &quot;http://127.0.0.1:8080/test&quot;}</span>
<span class="token comment">//   ok: false</span>
<span class="token comment">//   redirected: false</span>
<span class="token comment">//   status: 301</span>
<span class="token comment">//   statusText: &quot;&quot;</span>
<span class="token comment">//   type: &quot;default&quot;</span>
<span class="token comment">//   url: &quot;&quot;</span>
<span class="token comment">//   __proto__: Response</span>
<span class="token comment">// }</span>
<span class="token keyword">let</span> headers <span class="token operator">=</span> Response<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/test'</span><span class="token punctuation">,</span> <span class="token number">301</span><span class="token punctuation">)</span><span class="token punctuation">.</span>headers
Object<span class="token punctuation">.</span><span class="token function">fromEntries</span><span class="token punctuation">(</span>headers<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// {location: &quot;http://127.0.0.1:8080/test&quot;}</span>
</code></pre></div><p>关于 Response 中各字段细节，参考 p738</p> <h3 id="request、response-及-body-混入"><a href="#request、response-及-body-混入" class="header-anchor">#</a> Request、Response 及 Body 混入</h3> <p>响应的数据一般放在 Response.body 中，属于流数据，类型是可读流 ReadableStream。需要注意的是 Request 对象如果传入了 body 数据属性，那么 Request 对象上也会包含对应的 ReadableStream。</p> <p>为了方便操作接口响应的可读流数据，Fetch API 在 Body 上定义了 5 个方法：text()、json()、formData()、arrayBuffer()、blob()，用于读取可读流 ReadableStream 的数据，并转换为 JS 对象类型。这些方法都在 Response、Request 对象上进行了混入（mixin），可以直接使用。他们都返回一个 resolve 为相应数据类型的 Pormise。</p> <ul><li><code>text()</code> 读取 ReadableStream，将数据转换为 UTF-8 格式字符串</li> <li><code>json()</code> 读取 ReadableStream，将数据转换为 JSON 对象</li> <li><code>formData()</code> 读取 ReadableStream，将数据转换为 FormData 类型，支持以下方法 append()、get()、set()、getAll()、has()、delete()、forEach()、keys()、values()、entries()。主要与 service workers 有关. 如果客户端提交的一个表单请求被 Service Worker 所截取，您可以像下述的样例一样，调用 formData() 方法来获取一个key-value 字典, 对该字典可以进行修饰, 然后将修饰后的表填提交给远端服务器 (或在本地应用)。参考：<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Body/formData" target="_blank" rel="noopener noreferrer">Body.formData() - MDN<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><code>arrayBuffer()</code> 读取 ReadableStream，将数据转换为 ArrayBuffer，使用 teypedArray 可以很方便的读取数据。</li> <li><code>blob()</code> 读取 ReadableStream，将数据转换为 Blob 实例</li></ul> <p><strong>注意：使用上面的函数读取 ReadableStream 后，对应的 bodyUsed 会被设置为 true，这个时候如果再次调用该函数去读取 ReadableStream 流，会返回 body stream is locked 的错误</strong></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token comment">// text()</span>
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> data<span class="token punctuation">)</span> <span class="token comment">// &quot;string&quot;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token comment">// '{&quot;name&quot;:&quot;zuo&quot;}'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// json()</span>
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> data<span class="token punctuation">)</span> <span class="token comment">// &quot;object&quot;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token comment">// { name: &quot;zuo&quot; }</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// formData()</span>
  <span class="token comment">// 请求时无法模拟，一般在 service worker 中使用</span>
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">formData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> data<span class="token punctuation">)</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// Uncaught (in promise) TypeError: Failed to fetch</span>
  <span class="token comment">// 使用 request 来测试</span>
  <span class="token keyword">let</span> formData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'zuo'</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request</span><span class="token punctuation">(</span><span class="token string">'/test'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> 
    method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span> 
    body<span class="token operator">:</span> formData
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  request<span class="token punctuation">.</span><span class="token function">formData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> data<span class="token punctuation">)</span> <span class="token comment">// object</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token comment">// FormData {}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// arrayBuffer</span>
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">arrayBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> data<span class="token punctuation">)</span> <span class="token comment">// &quot;object&quot;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token comment">// ArrayBuffer(14) {}</span>
      <span class="token keyword">let</span> str <span class="token operator">=</span> <span class="token string">''</span>
      <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">code</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        str <span class="token operator">+=</span> String<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token comment">// '{&quot;name&quot;:&quot;zuo&quot;}'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// blob()</span>
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">blob</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> data<span class="token punctuation">)</span> <span class="token comment">// &quot;object&quot;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> 
      <span class="token comment">// Blob {size: 14, type: &quot;application/json&quot;}</span>

      <span class="token comment">// 读取 Blob 文件数据</span>
      <span class="token keyword">let</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      reader<span class="token punctuation">.</span><span class="token function">readAsText</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
      reader<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>reader<span class="token punctuation">.</span>result<span class="token punctuation">)</span> <span class="token comment">// '{&quot;name&quot;:&quot;zuo&quot;}'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 重复读取流</span>
    <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">blob</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">blob</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// Uncaught (in promise) TypeError: </span>
    <span class="token comment">// Failed to execute 'blob' on 'Response': body stream already read</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="直接操作可读流-readablestream"><a href="#直接操作可读流-readablestream" class="header-anchor">#</a> 直接操作可读流 ReadableStream</h3> <p>这里需要复习下第 20 章 Streams API 的内容：<a href="http://fe.zuo11.com/js/ad3/js-ad3-20.html#streams-api" target="_blank" rel="noopener noreferrer">Streams API - 20. JavaScript API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://fetch.spec.whatwg.org/'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">body</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> reader <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">getReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> done <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// Uint8Array(65536)</span>
  <span class="token comment">// ....</span>
  <span class="token comment">// Uint8Array(100395)</span>
  <span class="token comment">// Uint8Array(33171)</span>
  <span class="token comment">// Uint8Array(80674)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>使用异步迭代重构</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://fetch.spec.whatwg.org/'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">body</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> reader <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">getReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">let</span> iterator <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>asyncIterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token punctuation">{</span>
            <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span> reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span>chunk <span class="token keyword">of</span> iterator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span> <span class="token comment">// 加了 await 会较慢，但顺序是正确的</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// Uint8Array(65536)</span>
  <span class="token comment">// ....</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>进一步优化</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token operator">*</span> <span class="token function">streamGenerator</span><span class="token punctuation">(</span><span class="token parameter">body</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> reader <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">getReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> done <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> 
        <span class="token keyword">yield</span> value
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      reader<span class="token punctuation">.</span><span class="token function">releaseLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://fetch.spec.whatwg.org/'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">body</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span>chunk <span class="token keyword">of</span> <span class="token function">streamGenerator</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span> <span class="token comment">// 加了 await 会较慢，但顺序是正确的</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>将读取的 typedArray 数据解码为字符串，这样就相当于简单实现了 text() 的功能</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token comment">// streamGenerator 参见上面的例子</span>
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://fetch.spec.whatwg.org/'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">body</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span>chunk <span class="token keyword">of</span> <span class="token function">streamGenerator</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// console.log(chunk) // 加了 await 会较慢，但顺序是正确的</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> <span class="token punctuation">{</span>
          stream<span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// &lt;!doctype html&gt;&lt;html lang=&quot;en&quot;&gt;</span>
  <span class="token comment">//  &lt;head&gt;</span>
  <span class="token comment">//   &lt;meta charset=&quot;utf-8&quot;&gt;</span>
  <span class="token comment">//   &lt;meta content=&quot;width=device-width, initial-scale=1, shrink-to-fit=no&quot; name=&quot;viewport&quot;&gt;</span>
  <span class="token comment">//   &lt;meta content=&quot;#3c790a&quot; name=&quot;theme-color&quot;&gt;</span>
  <span class="token comment">//   &lt;title&gt;Fetch Standard&lt;/title&gt;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>可以使用 ReadableStream 创建 Response 对象，可以将可读流数据读出来后存到另一个 可读流的 Response 中，可以用于过滤数据</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://fetch.spec.whatwg.org/'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> response<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">body</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> reader <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">getReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// create secondary stream</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReadableStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token keyword">async</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> done <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// Push the body stream's chunk onto the secondary stream</span>
            controller<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
          controller<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          reader<span class="token punctuation">.</span><span class="token function">releaseLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">secondaryStream</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>secondaryStream<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=&gt;</span> response<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token comment">// &lt;!doctype html&gt;&lt;html lang=&quot;en&quot;&gt;&lt;head&gt;&lt;meta charset=&quot;utf-8&quot;&gt; ... </span>
</code></pre></div><h2 id="beacon-api"><a href="#beacon-api" class="header-anchor">#</a> Beacon API</h2> <p>当页面 unload 卸载时，如果要在这个事件中添加埋点上报信息。这种情况页面都卸载了，请求相关异步操作都会被浏览器取消。 异步的 xhr 和 fetch 不适合在这种情况发送请求。为了解决这个问题，W3C 引入了 Beacon API <code>[ˈbiːkən]</code> 灯塔，信号浮标；烽火；指路明灯。</p> <ul><li><code>navigator.sendBeacon(url, payload)</code> 向 url 发送 'POST' 请求，数据为 payload。Content-Type 为字符串 &quot;text/plain;charset=UTF-8&quot;，<code>[pleɪn]</code></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
  navigator<span class="token punctuation">.</span><span class="token function">sendBeacon</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">{ page: '/xxx', duration: '12s' }</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p>koa 解析 'text/plain' 类型的 POST 数据，参考：</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-bodyparser'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  enableTypes<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'json'</span><span class="token punctuation">,</span> <span class="token string">'form'</span><span class="token punctuation">,</span> <span class="token string">'text'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">)</span> 
  <span class="token comment">// { page: '/xxx', duration: '12s' } </span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
    a<span class="token operator">:</span> <span class="token number">1</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>navigator.sendBeacon() 有点像 POST 请求的语法糖，它有下面几个重要特性</p> <ul><li>sendBeacon() 可以保证在原始页面已经关闭的情况下也会发送请求，该请求任意时间都可以使用。</li> <li>sendBeacon() 无法以编程方式处理响应数据</li> <li>该请求会携带相关 cookie</li></ul> <h2 id="web-socket"><a href="#web-socket" class="header-anchor">#</a> Web Socket</h2> <p>普通的 http 请求中，服务端无法主动向客户端发送消息。Web Socket（套接字）支持客户端与服务端全双工、双向通信。在 JS 中创建 WebSocket 时，会先发送一个 HTTP 请求用来初始化连接，socket 服务器接收到请求后，使用 Upgrade 响应头，将 HTTP 协议切换到 WebSocket 协议。后面发送、接收信息就都使用该连接了。socket 服务 url 不再是 <code>http://</code> 或 <code>https://</code>，而是 <code>ws://</code> 或 <code>wss://</code>。目的是更快的发送小数据块，不会对 HTTP 照成任何负担。需要专用的服务器，速度更快。</p> <p><img src="/images/js/socket_con_1.png" alt="socket_con_1.png"></p> <p>前端创建一个 Web Sockert 可以使用 WebSocket 构造函数，参数为 socket 服务 URL，不受跨域限制。在创建 WebSocket 实例之后会立即创建连接。WebSocket 实例支持如下属性、方法、事件：</p> <ul><li><code>readyState 属性</code> 表示 socket 连接状态
<ul><li>WebSocket.OPENING（0）连接正在建立</li> <li>WebSocket.OPEN（1）连接已经建立</li> <li>WebSocket.CLOSING（2）连接正在关闭</li> <li>WebSocket.CLOSE（3）连接已经关闭</li></ul></li> <li><code>binaryType 属性</code> message 事件后接收到的数据类型，可能是 &quot;blob&quot; 或 &quot;arraybuffer&quot;</li> <li><code>bufferedAmount 属性</code> 在发送大量数据到服务端时，由于网络的原因，send 的数据不会立即全部到达服务端，而是依次进入队列再发送。bufferedAmount 表示已进度队列但尚未发送到服务器的字节数</li> <li><code>protocol 属性</code> new WebSocket 时可以指定一组客户端支持的协议，让服务器选择使用哪一种，protocol 字段就是服务端使用的协议名。默认为空字符串 &quot;&quot;</li> <li><code>send() 方法</code>，向服务端发送数据，数据可以是字符串、ArrayBuffer、Blob</li> <li><code>close() 方法</code>，关闭 socket 连接，调用后 readyState 立即变为 2，并会在关闭后变为 3</li> <li><code>open 事件</code> 在连接成功时触发</li> <li><code>message 事件</code> 接收到服务器发送的消息时触发，通过 event.data 访问</li> <li><code>error 事件</code> 在发生错误时触发，连接无法续存</li> <li><code>close() 事件</code> 在连接关闭时触发，通过参数可以指定关闭类型</li></ul> <p>下面来看一个例子</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 创建一个 socket 连接</span>
<span class="token keyword">let</span> socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">&quot;ws://127.0.0.1:3000/socket.io/&quot;</span><span class="token punctuation">)</span>

<span class="token comment">// socket 连接成功</span>
socket<span class="token punctuation">.</span><span class="token function-variable function">onopen</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'socket 已连接'</span><span class="token punctuation">)</span>
  <span class="token comment">// 发送字符串数据</span>
  socket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Hello Socket'</span><span class="token punctuation">)</span>
  <span class="token comment">// 发送 ArrayBuffer 数据</span>
  socket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>Uint8Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'f'</span><span class="token punctuation">,</span> <span class="token string">'o'</span><span class="token punctuation">,</span> <span class="token string">'o'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>buffer<span class="token punctuation">)</span>
  <span class="token comment">// 发送 Blob 数据</span>
  socket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'f'</span><span class="token punctuation">,</span> <span class="token string">'o'</span><span class="token punctuation">,</span> <span class="token string">'o'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

socket<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token punctuation">{</span> event <span class="token punctuation">}</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'接收到数据'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>

socket<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'socket 连接发生错误'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

socket<span class="token punctuation">.</span><span class="token function-variable function">onclose</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'socket 连接已关闭'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>下面是使用 socket.io 的 demo。前端、Node.js 端都需要引入 socket.io</p> <p>前端 vue.html</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://cdn.bootcss.com/socket.io/2.3.0/socket.io.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://cdn.jsdelivr.net/npm/vue/dist/vue.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>message<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>发送<span class="token punctuation">&quot;</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>send<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token comment">&lt;!-- &lt;input type=&quot;button&quot; value=&quot;清除&quot; @click=&quot;clear&quot;&gt; --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">v-for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item in msgList<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{ item }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">let</span> vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      el<span class="token operator">:</span> <span class="token string">'#app'</span><span class="token punctuation">,</span>
      data<span class="token operator">:</span> <span class="token punctuation">{</span>
        message<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
        msgList<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>socket <span class="token operator">=</span> <span class="token function">io</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'chat message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>socket<span class="token punctuation">)</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>msgList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connect'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Socket.io connected...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'time'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">beforeDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>socket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      methods<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token keyword">async</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> msg <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>message
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'send msg'</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>socket<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'chat message'</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>message <span class="token operator">=</span> <span class="token string">''</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>服务端 app.js，注意服务端 socket.io 版本最好与客户端保持一致</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> io <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'socket.io'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-static'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">'/public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> users <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

io<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connection'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'a user connect'</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token comment">// 每个链接都是一个新的连接</span>
  users<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'在线人数'</span><span class="token punctuation">,</span> users<span class="token punctuation">.</span>length<span class="token punctuation">)</span>

  <span class="token comment">// 接收到消息</span>
  socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'chat message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'chat msg'</span><span class="token punctuation">,</span> socket<span class="token punctuation">.</span>id <span class="token operator">+</span> <span class="token string">': '</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span>
    <span class="token comment">// 广播给所有人</span>
    io<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'chat message'</span><span class="token punctuation">,</span> socket<span class="token punctuation">.</span>id <span class="token operator">+</span> <span class="token string">': '</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span>
    <span class="token comment">// 广播给除了发送者的所有人</span>
    <span class="token comment">// socket.broadcast.emit('chat message', socket.id + ': ' + msg)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 如果有连接离线</span>
  socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'disconnect'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span>id <span class="token operator">+</span> <span class="token string">'已离线'</span><span class="token punctuation">)</span>
    users<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>users<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'在线人数'</span><span class="token punctuation">,</span> users<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'服务开启成功，3000端口'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>Chrome NetWork 面板中 Socket 数据如下图</p> <p><img src="/images/js/socket_con_2.png" alt="socket_con_2.png"></p> <p>完成 demo 代码参见：<a href="https://github.com/zuoxiaobai/fedemo/blob/master/src/JS_ES6/JS%E9%AB%98%E7%A8%8B3/socket/" target="_blank" rel="noopener noreferrer">soket.io 前端后测试 demo - Github<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>更多详情参考：</p> <ul><li>《HTML5 WebSocket 权威指南》</li> <li><a href="https://github.com/socketio/socket.io-client" target="_blank" rel="noopener noreferrer">socket.io-client 前端源码 - Github<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/socketio/socket.io#readme" target="_blank" rel="noopener noreferrer">socket.io - 服务端源码 - Github<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h2 id="安全"><a href="#安全" class="header-anchor">#</a> 安全</h2> <p>在 Web 中需要考虑的安全问题非常多，这里只是简单的提一下。对于常规的 Get 请求，比如接口地址为 <code>/user?id=12</code>，如果更换 id 为其他数字，比如 25、26 时需要校验是否用对于的访问权限，现在一般使用 token 的方式验证。</p> <p>在未经授权可以访问某个资源时，可以将其视为 <strong>跨站点请求伪造（CSRF，cross-site request forgery <code>['fɔ:dʒəri]</code>）攻击</strong>。</p> <p>一些建议：</p> <ul><li>接口使用 SSL 证书，支持 https</li> <li>每个请求都发送一个按约定算法计算好的令牌（token）</li></ul> <p>注意，以下手段对防止 CSRF 攻击是无效的</p> <ul><li>使用 POST 而非 GET</li> <li>使用来源的 URL 验证来源，来源 URL 很容易伪造，referer</li> <li>基于 cookie 验证，cookie 容易伪造</li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">12/15/2020, 8:23:37 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/js/ad3/js-ad3-23.html" class="prev">
        23. JSON - JS高程4
      </a></span> <span class="next"><a href="/js/ad3/js-ad3-25.html">
        25. 客户端存储 - JS高程4
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.1f511cd1.js" defer></script><script src="/assets/js/2.4b3539f1.js" defer></script><script src="/assets/js/83.75bc4803.js" defer></script><script src="/assets/js/3.e6a4dd76.js" defer></script>
  </body>
</html>
