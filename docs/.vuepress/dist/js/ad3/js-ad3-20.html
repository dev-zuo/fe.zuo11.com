<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>20. JavaScript API - JS高程4 | 左小白的前端笔记</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/logo.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon-152x152.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#3eaf7c">
    <meta name="description" content="HTML5 规范定义了一批增强已有标准的 API 和浏览器特性。另外一些规范，如 Web Cryptography 和 Notifications API 只为一个特性定义了一个 API。不同的浏览器对新 API 的实现情况不同，本章仅介绍与大多数开发者相关，已经得到多个浏览器支持，且本书中其他章节没有涵盖的内容。主要内容有 Atomics 与 SharedrrayBuffer、跨上下文消息、Encoding API、File API 与 Blob API、拖放、Notifications API、Page Visibility API、Streams API、计时 API、Web components、Web Cryptography API。">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/assets/css/0.styles.c896736b.css" as="style"><link rel="preload" href="/assets/js/app.5dbb3b16.js" as="script"><link rel="preload" href="/assets/js/2.3f8a6b0b.js" as="script"><link rel="preload" href="/assets/js/84.bd60c92f.js" as="script"><link rel="preload" href="/assets/js/3.018b29e2.js" as="script"><link rel="prefetch" href="/assets/js/10.354e6f15.js"><link rel="prefetch" href="/assets/js/100.c819952b.js"><link rel="prefetch" href="/assets/js/101.d3f56181.js"><link rel="prefetch" href="/assets/js/102.db6427d9.js"><link rel="prefetch" href="/assets/js/103.8a9c7618.js"><link rel="prefetch" href="/assets/js/104.35d4c324.js"><link rel="prefetch" href="/assets/js/105.ad6881bd.js"><link rel="prefetch" href="/assets/js/106.373b4433.js"><link rel="prefetch" href="/assets/js/107.2503e0f3.js"><link rel="prefetch" href="/assets/js/108.b4d7e593.js"><link rel="prefetch" href="/assets/js/109.9e08fa69.js"><link rel="prefetch" href="/assets/js/11.b7e99381.js"><link rel="prefetch" href="/assets/js/110.79a70bd7.js"><link rel="prefetch" href="/assets/js/111.d1ce5107.js"><link rel="prefetch" href="/assets/js/112.899088c2.js"><link rel="prefetch" href="/assets/js/113.6de1d6b3.js"><link rel="prefetch" href="/assets/js/114.dd7c3b32.js"><link rel="prefetch" href="/assets/js/115.1d7d49ce.js"><link rel="prefetch" href="/assets/js/116.a2213cda.js"><link rel="prefetch" href="/assets/js/117.9a93260d.js"><link rel="prefetch" href="/assets/js/118.40b461ca.js"><link rel="prefetch" href="/assets/js/119.06ec3c12.js"><link rel="prefetch" href="/assets/js/12.2e54819b.js"><link rel="prefetch" href="/assets/js/120.0b3ea7f2.js"><link rel="prefetch" href="/assets/js/121.0b8bde4d.js"><link rel="prefetch" href="/assets/js/122.d2e73d20.js"><link rel="prefetch" href="/assets/js/123.6eee3fbc.js"><link rel="prefetch" href="/assets/js/124.8bbe1b34.js"><link rel="prefetch" href="/assets/js/125.418052a5.js"><link rel="prefetch" href="/assets/js/126.cef6a3e9.js"><link rel="prefetch" href="/assets/js/127.17eb976e.js"><link rel="prefetch" href="/assets/js/128.2ac90be1.js"><link rel="prefetch" href="/assets/js/129.f628e357.js"><link rel="prefetch" href="/assets/js/13.2189e393.js"><link rel="prefetch" href="/assets/js/130.4021753f.js"><link rel="prefetch" href="/assets/js/131.64367708.js"><link rel="prefetch" href="/assets/js/132.a78117c0.js"><link rel="prefetch" href="/assets/js/133.cc7aa0e9.js"><link rel="prefetch" href="/assets/js/134.898729aa.js"><link rel="prefetch" href="/assets/js/135.7283a4dc.js"><link rel="prefetch" href="/assets/js/136.39e10aa7.js"><link rel="prefetch" href="/assets/js/137.91af548a.js"><link rel="prefetch" href="/assets/js/138.81d58b53.js"><link rel="prefetch" href="/assets/js/139.a40c017f.js"><link rel="prefetch" href="/assets/js/14.5ce6db09.js"><link rel="prefetch" href="/assets/js/140.43257c97.js"><link rel="prefetch" href="/assets/js/141.db30cf52.js"><link rel="prefetch" href="/assets/js/142.99248d7f.js"><link rel="prefetch" href="/assets/js/143.51af45d3.js"><link rel="prefetch" href="/assets/js/144.1852b0e0.js"><link rel="prefetch" href="/assets/js/145.c42647a8.js"><link rel="prefetch" href="/assets/js/146.255e0053.js"><link rel="prefetch" href="/assets/js/147.a53455cb.js"><link rel="prefetch" href="/assets/js/148.c1caabbb.js"><link rel="prefetch" href="/assets/js/149.d4672362.js"><link rel="prefetch" href="/assets/js/15.5469b4a1.js"><link rel="prefetch" href="/assets/js/150.7eda3e9c.js"><link rel="prefetch" href="/assets/js/151.3840e8dd.js"><link rel="prefetch" href="/assets/js/152.b5eead7e.js"><link rel="prefetch" href="/assets/js/153.72e927d9.js"><link rel="prefetch" href="/assets/js/154.5f8b93d8.js"><link rel="prefetch" href="/assets/js/155.24499e9c.js"><link rel="prefetch" href="/assets/js/156.7abc3d22.js"><link rel="prefetch" href="/assets/js/157.2ee4c6ad.js"><link rel="prefetch" href="/assets/js/158.6c820f29.js"><link rel="prefetch" href="/assets/js/159.2e2a8e03.js"><link rel="prefetch" href="/assets/js/16.1191ebc2.js"><link rel="prefetch" href="/assets/js/160.3df56bcb.js"><link rel="prefetch" href="/assets/js/161.48915ef4.js"><link rel="prefetch" href="/assets/js/162.b0d3aa72.js"><link rel="prefetch" href="/assets/js/163.c0974f59.js"><link rel="prefetch" href="/assets/js/164.319b796b.js"><link rel="prefetch" href="/assets/js/165.1b0c8e83.js"><link rel="prefetch" href="/assets/js/166.59655a10.js"><link rel="prefetch" href="/assets/js/167.f866505f.js"><link rel="prefetch" href="/assets/js/17.08eb5070.js"><link rel="prefetch" href="/assets/js/18.549c446f.js"><link rel="prefetch" href="/assets/js/19.4ff1cbb8.js"><link rel="prefetch" href="/assets/js/20.5dba5cbc.js"><link rel="prefetch" href="/assets/js/21.9f0ce5d2.js"><link rel="prefetch" href="/assets/js/22.682fbab2.js"><link rel="prefetch" href="/assets/js/23.ed628486.js"><link rel="prefetch" href="/assets/js/24.0d55fdfc.js"><link rel="prefetch" href="/assets/js/25.b513497e.js"><link rel="prefetch" href="/assets/js/26.38b016e3.js"><link rel="prefetch" href="/assets/js/27.51d9bd77.js"><link rel="prefetch" href="/assets/js/28.ada66cb3.js"><link rel="prefetch" href="/assets/js/29.ea0bf202.js"><link rel="prefetch" href="/assets/js/30.f8b68fed.js"><link rel="prefetch" href="/assets/js/31.84f7c8e8.js"><link rel="prefetch" href="/assets/js/32.cdd50ff9.js"><link rel="prefetch" href="/assets/js/33.3872e844.js"><link rel="prefetch" href="/assets/js/34.b73356ae.js"><link rel="prefetch" href="/assets/js/35.c89bfe3e.js"><link rel="prefetch" href="/assets/js/36.7d08c9af.js"><link rel="prefetch" href="/assets/js/37.3247d5e3.js"><link rel="prefetch" href="/assets/js/38.46f6bec8.js"><link rel="prefetch" href="/assets/js/39.a0aae745.js"><link rel="prefetch" href="/assets/js/4.727b3cb3.js"><link rel="prefetch" href="/assets/js/40.d74326d2.js"><link rel="prefetch" href="/assets/js/41.e6693e88.js"><link rel="prefetch" href="/assets/js/42.fa3dd430.js"><link rel="prefetch" href="/assets/js/43.82c0efdd.js"><link rel="prefetch" href="/assets/js/44.a6fd5424.js"><link rel="prefetch" href="/assets/js/45.5783826e.js"><link rel="prefetch" href="/assets/js/46.73bb240c.js"><link rel="prefetch" href="/assets/js/47.b47109b2.js"><link rel="prefetch" href="/assets/js/48.3989e8b0.js"><link rel="prefetch" href="/assets/js/49.a90588e1.js"><link rel="prefetch" href="/assets/js/5.5f97339e.js"><link rel="prefetch" href="/assets/js/50.78efb680.js"><link rel="prefetch" href="/assets/js/51.dbc615c4.js"><link rel="prefetch" href="/assets/js/52.55dec5bc.js"><link rel="prefetch" href="/assets/js/53.f4e566cd.js"><link rel="prefetch" href="/assets/js/54.c37cffd0.js"><link rel="prefetch" href="/assets/js/55.af505001.js"><link rel="prefetch" href="/assets/js/56.55190502.js"><link rel="prefetch" href="/assets/js/57.8717401e.js"><link rel="prefetch" href="/assets/js/58.7d488a8f.js"><link rel="prefetch" href="/assets/js/59.aa85a6c8.js"><link rel="prefetch" href="/assets/js/6.8b6802aa.js"><link rel="prefetch" href="/assets/js/60.5e4fa3e7.js"><link rel="prefetch" href="/assets/js/61.22bcc17e.js"><link rel="prefetch" href="/assets/js/62.b1b30f77.js"><link rel="prefetch" href="/assets/js/63.35551730.js"><link rel="prefetch" href="/assets/js/64.bc28097f.js"><link rel="prefetch" href="/assets/js/65.e6e6851c.js"><link rel="prefetch" href="/assets/js/66.3bf92dea.js"><link rel="prefetch" href="/assets/js/67.175ff21f.js"><link rel="prefetch" href="/assets/js/68.790d1d1c.js"><link rel="prefetch" href="/assets/js/69.c31cc210.js"><link rel="prefetch" href="/assets/js/7.55c6af5e.js"><link rel="prefetch" href="/assets/js/70.8d7c375e.js"><link rel="prefetch" href="/assets/js/71.be95136a.js"><link rel="prefetch" href="/assets/js/72.32704e34.js"><link rel="prefetch" href="/assets/js/73.6e92309c.js"><link rel="prefetch" href="/assets/js/74.79ba8a89.js"><link rel="prefetch" href="/assets/js/75.0003d6fa.js"><link rel="prefetch" href="/assets/js/76.81604cd0.js"><link rel="prefetch" href="/assets/js/77.0641879e.js"><link rel="prefetch" href="/assets/js/78.7ab92c58.js"><link rel="prefetch" href="/assets/js/79.681c5778.js"><link rel="prefetch" href="/assets/js/8.539cd54f.js"><link rel="prefetch" href="/assets/js/80.a574f302.js"><link rel="prefetch" href="/assets/js/81.9392e551.js"><link rel="prefetch" href="/assets/js/82.587d4619.js"><link rel="prefetch" href="/assets/js/83.27dffcc9.js"><link rel="prefetch" href="/assets/js/85.c57c938f.js"><link rel="prefetch" href="/assets/js/86.cb4e2238.js"><link rel="prefetch" href="/assets/js/87.74f6eaeb.js"><link rel="prefetch" href="/assets/js/88.90fb27ee.js"><link rel="prefetch" href="/assets/js/89.0d3fe4f0.js"><link rel="prefetch" href="/assets/js/9.4d954cfb.js"><link rel="prefetch" href="/assets/js/90.1dcd6669.js"><link rel="prefetch" href="/assets/js/91.c62df855.js"><link rel="prefetch" href="/assets/js/92.3b0ba45c.js"><link rel="prefetch" href="/assets/js/93.0370bd3e.js"><link rel="prefetch" href="/assets/js/94.563a8758.js"><link rel="prefetch" href="/assets/js/95.a030b7e8.js"><link rel="prefetch" href="/assets/js/96.5cf55cae.js"><link rel="prefetch" href="/assets/js/97.f803219d.js"><link rel="prefetch" href="/assets/js/98.6eaf31e9.js"><link rel="prefetch" href="/assets/js/99.c3aa1321.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c896736b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">左小白的前端笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="指南" class="dropdown-title"><span class="title">指南</span> <span class="arrow down"></span></button> <button type="button" aria-label="指南" class="mobile-dropdown-title"><span class="title">指南</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">
  首页
</a></li><li class="dropdown-item"><!----> <a href="/nav.html" class="nav-link">
  前端网址导航
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端进阶" class="dropdown-title"><span class="title">前端进阶</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端进阶" class="mobile-dropdown-title"><span class="title">前端进阶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/daily/" class="nav-link">
  技术日常记录
</a></li><li class="dropdown-item"><!----> <a href="/server/docker.html" class="nav-link">
  Docker 基础
</a></li><li class="dropdown-item"><h4>
          Vue.js
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vue/base/1.html" class="nav-link">
  Vue.js 笔记
</a></li><li class="dropdown-subitem"><a href="/vue/vue-router.html" class="nav-link">
  Vue Router 笔记
</a></li><li class="dropdown-subitem"><a href="/vue/vuex.html" class="nav-link">
  Vuex 笔记
</a></li></ul></li><li class="dropdown-item"><h4>
          前端工程化
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/ts/base-1.html" class="nav-link">
  TypeScript 入门教程笔记
</a></li><li class="dropdown-subitem"><a href="/node/base/1.html" class="nav-link">
  Node.js 笔记
</a></li><li class="dropdown-subitem"><a href="/webpack/base.html" class="nav-link">
  webpack 基础
</a></li></ul></li><li class="dropdown-item"><h4>
          数据可视化
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/visual/echarts.html" class="nav-link">
  Echarts 笔记
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端基础" class="dropdown-title"><span class="title">前端基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端基础" class="mobile-dropdown-title"><span class="title">前端基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          JS/ES6
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/js/es6/es6-1.html" class="nav-link">
  ES6标准入门(第三版)笔记
</a></li><li class="dropdown-subitem"><a href="/js/you-donot-know-js-1/scope-closures.html" class="nav-link">
  你不知道的 JavaScript - 上卷
</a></li><li class="dropdown-subitem"><a href="/js/ad3/js-ad3-1.html" class="nav-link">
  JavaScript高级程序设计(第四版)笔记
</a></li><li class="dropdown-subitem"><a href="/js/js-dom-art.html" class="nav-link">
  JavaScript DOM编程艺术(第二版)笔记
</a></li></ul></li><li class="dropdown-item"><h4>
          CSS/CSS3
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/css/less.html" class="nav-link">
  CSS 预处理器 Less.js
</a></li><li class="dropdown-subitem"><a href="/css/flex-grid.html" class="nav-link">
  Flex与Grid布局
</a></li><li class="dropdown-subitem"><a href="/css/html5-css-1.html" class="nav-link">
  HTML5权威指南(CSS部分)笔记
</a></li></ul></li><li class="dropdown-item"><h4>
          HTML/HTML5
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/html5/html/1.html" class="nav-link">
  HTML5权威指南(HTML部分)笔记
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机基础" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机基础" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/base/js-data-struct.html" class="nav-link">
  学习JavaScript数据结构与算法(第三版)笔记
</a></li><li class="dropdown-item"><!----> <a href="/base/mocha-test.html" class="nav-link">
  Mocha - JavaScript测试框架
</a></li><li class="dropdown-item"><!----> <a href="/base/git.html" class="nav-link">
  Git 笔记
</a></li><li class="dropdown-item"><!----> <a href="/base/markdown.html" class="nav-link">
  Markdown 基础语法
</a></li><li class="dropdown-item"><!----> <a href="/base/dbtheory/1.html" class="nav-link">
  数据库系统原理笔记
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开源项目" class="dropdown-title"><span class="title">开源项目</span> <span class="arrow down"></span></button> <button type="button" aria-label="开源项目" class="mobile-dropdown-title"><span class="title">开源项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/zuoxiaobai/service-monitor" target="_blank" rel="noopener noreferrer" class="nav-link external">
  service-monitor
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://vuechart.zuo11.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  @guoqzuo/vue-chart
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://zuoblog.zuo11.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  zuo-blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="http://www.zuo11.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/zuoxiaobai" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="指南" class="dropdown-title"><span class="title">指南</span> <span class="arrow down"></span></button> <button type="button" aria-label="指南" class="mobile-dropdown-title"><span class="title">指南</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">
  首页
</a></li><li class="dropdown-item"><!----> <a href="/nav.html" class="nav-link">
  前端网址导航
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端进阶" class="dropdown-title"><span class="title">前端进阶</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端进阶" class="mobile-dropdown-title"><span class="title">前端进阶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/daily/" class="nav-link">
  技术日常记录
</a></li><li class="dropdown-item"><!----> <a href="/server/docker.html" class="nav-link">
  Docker 基础
</a></li><li class="dropdown-item"><h4>
          Vue.js
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vue/base/1.html" class="nav-link">
  Vue.js 笔记
</a></li><li class="dropdown-subitem"><a href="/vue/vue-router.html" class="nav-link">
  Vue Router 笔记
</a></li><li class="dropdown-subitem"><a href="/vue/vuex.html" class="nav-link">
  Vuex 笔记
</a></li></ul></li><li class="dropdown-item"><h4>
          前端工程化
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/ts/base-1.html" class="nav-link">
  TypeScript 入门教程笔记
</a></li><li class="dropdown-subitem"><a href="/node/base/1.html" class="nav-link">
  Node.js 笔记
</a></li><li class="dropdown-subitem"><a href="/webpack/base.html" class="nav-link">
  webpack 基础
</a></li></ul></li><li class="dropdown-item"><h4>
          数据可视化
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/visual/echarts.html" class="nav-link">
  Echarts 笔记
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端基础" class="dropdown-title"><span class="title">前端基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端基础" class="mobile-dropdown-title"><span class="title">前端基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          JS/ES6
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/js/es6/es6-1.html" class="nav-link">
  ES6标准入门(第三版)笔记
</a></li><li class="dropdown-subitem"><a href="/js/you-donot-know-js-1/scope-closures.html" class="nav-link">
  你不知道的 JavaScript - 上卷
</a></li><li class="dropdown-subitem"><a href="/js/ad3/js-ad3-1.html" class="nav-link">
  JavaScript高级程序设计(第四版)笔记
</a></li><li class="dropdown-subitem"><a href="/js/js-dom-art.html" class="nav-link">
  JavaScript DOM编程艺术(第二版)笔记
</a></li></ul></li><li class="dropdown-item"><h4>
          CSS/CSS3
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/css/less.html" class="nav-link">
  CSS 预处理器 Less.js
</a></li><li class="dropdown-subitem"><a href="/css/flex-grid.html" class="nav-link">
  Flex与Grid布局
</a></li><li class="dropdown-subitem"><a href="/css/html5-css-1.html" class="nav-link">
  HTML5权威指南(CSS部分)笔记
</a></li></ul></li><li class="dropdown-item"><h4>
          HTML/HTML5
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/html5/html/1.html" class="nav-link">
  HTML5权威指南(HTML部分)笔记
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机基础" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机基础" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/base/js-data-struct.html" class="nav-link">
  学习JavaScript数据结构与算法(第三版)笔记
</a></li><li class="dropdown-item"><!----> <a href="/base/mocha-test.html" class="nav-link">
  Mocha - JavaScript测试框架
</a></li><li class="dropdown-item"><!----> <a href="/base/git.html" class="nav-link">
  Git 笔记
</a></li><li class="dropdown-item"><!----> <a href="/base/markdown.html" class="nav-link">
  Markdown 基础语法
</a></li><li class="dropdown-item"><!----> <a href="/base/dbtheory/1.html" class="nav-link">
  数据库系统原理笔记
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开源项目" class="dropdown-title"><span class="title">开源项目</span> <span class="arrow down"></span></button> <button type="button" aria-label="开源项目" class="mobile-dropdown-title"><span class="title">开源项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/zuoxiaobai/service-monitor" target="_blank" rel="noopener noreferrer" class="nav-link external">
  service-monitor
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://vuechart.zuo11.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  @guoqzuo/vue-chart
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://zuoblog.zuo11.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  zuo-blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="http://www.zuo11.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/zuoxiaobai" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>JS/ES6</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>ES6标准入门(第三版)笔记</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>你不知道的 JavaScript - 上卷</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>JavaScript高级程序设计(第四版)笔记</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/js/ad3/js-ad4-diff.html" class="sidebar-link">第四版相比第三版有哪些更新 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-1.html" class="sidebar-link">1. 什么是JavaScript - JS高程4</a></li><li><a href="/js/ad3/js-ad3-2.html" class="sidebar-link">2. 在HTML中使用JavaScript - JS高程4</a></li><li><a href="/js/ad3/js-ad3-3.html" class="sidebar-link">3. ES基本概念(语言基础) - JS高程4</a></li><li><a href="/js/ad3/js-ad3-4.html" class="sidebar-link">4. 变量、作用域与内存 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-5.html" class="sidebar-link">5. 基本引用类型 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-6.html" class="sidebar-link">6. 集合引用类型 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-7.html" class="sidebar-link">7. 迭代器与生成器(Iterator 与 Generator) - JS高程4</a></li><li><a href="/js/ad3/js-ad3-8.html" class="sidebar-link">8. 对象、类与面向对象编程 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-9.html" class="sidebar-link">9. 代理与反射(Proxy与Reflect) - JS高程4</a></li><li><a href="/js/ad3/js-ad3-10.html" class="sidebar-link">10. 函数 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-11.html" class="sidebar-link">11. 期约与异步函数(Promise与async/await) - JS高程4</a></li><li><a href="/js/ad3/js-ad3-12.html" class="sidebar-link">12. BOM - JS高程4</a></li><li><a href="/js/ad3/js-ad3-13.html" class="sidebar-link">13. 客户端检测 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-14.html" class="sidebar-link">14. DOM - JS高程4</a></li><li><a href="/js/ad3/js-ad3-15.html" class="sidebar-link">15. DOM扩展 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-16.html" class="sidebar-link">16. DOM2 和 DOM3 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-17.html" class="sidebar-link">17. 事件 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-18.html" class="sidebar-link">18. 动画与 Canvas 图形 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-19.html" class="sidebar-link">19. 表单脚本 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-20.html" aria-current="page" class="active sidebar-link">20. JavaScript API - JS高程4</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#atomics-与-sharedrraybuffer" class="sidebar-link">Atomics 与 SharedrrayBuffer</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#sharedarraybuffer" class="sidebar-link">SharedArrayBuffer</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#原子操作基础" class="sidebar-link">原子操作基础</a></li></ul></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#跨上下文-文档-消息传送-xdm" class="sidebar-link">跨上下文(文档)消息传送（XDM）</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#streams-api" class="sidebar-link">Streams API</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#可读流-readablestream" class="sidebar-link">可读流 ReadableStream</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#可写流-writablestream" class="sidebar-link">可写流 WritableStream</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#转换流-transformstream" class="sidebar-link">转换流 TransformStream</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#通过管道连接流" class="sidebar-link">通过管道连接流</a></li></ul></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#encoding-api" class="sidebar-link">Encoding API</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#textencoder-与-textdecoder" class="sidebar-link">TextEncoder 与 TextDecoder</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#textencoderstream-与-textdecoderstream" class="sidebar-link">TextEncoderStream 与 TextDecoderStream</a></li></ul></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#file-api-与-blob-api" class="sidebar-link">File API 与 Blob API</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#filereader-类型" class="sidebar-link">FileReader 类型</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#filereadersync-类型" class="sidebar-link">FileReaderSync 类型</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#blob-读取部分文件内容" class="sidebar-link">Blob 读取部分文件内容</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#对象-url-与-blob" class="sidebar-link">对象 URL 与 Blob</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#读取拖拽文件并上传" class="sidebar-link">读取拖拽文件并上传</a></li></ul></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#媒体元素video-audio" class="sidebar-link">媒体元素video/audio</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#指定多个媒体源-检测编解码器" class="sidebar-link">指定多个媒体源/检测编解码器</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#audio-音频类型" class="sidebar-link">Audio 音频类型</a></li></ul></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#原生拖放" class="sidebar-link">原生拖放</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#notifications-api" class="sidebar-link">Notifications API</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#page-visibility-api-页面可见性api" class="sidebar-link">Page Visibility API(页面可见性API)</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#计时-api-performace性能" class="sidebar-link">计时 API（Performace性能）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#high-resolution-time-api" class="sidebar-link">High Resolution Time API</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#performance-timing-扩展" class="sidebar-link">performance.timing(扩展)</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#performance-navigation-扩展" class="sidebar-link">performance.navigation(扩展)</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#performance-memory-扩展" class="sidebar-link">performance.memory(扩展)</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#performance-eventcounts-扩展" class="sidebar-link">performance.eventCounts(扩展)</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#performance-timeline-api" class="sidebar-link">Performance Timeline API</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#performancenavigationtiming" class="sidebar-link">PerformanceNavigationTiming</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#performanceresourcetiming" class="sidebar-link">PerformanceResourceTiming</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#user-timing-api-自定义" class="sidebar-link">User Timing API 自定义</a></li></ul></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#web-组件-web-components" class="sidebar-link">Web 组件（Web Components）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#html-模板-template-元素" class="sidebar-link">HTML 模板(template 元素)</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#影子dom-shadow-dom" class="sidebar-link">影子DOM(shadow DOM)</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#自定义元素" class="sidebar-link">自定义元素</a></li></ul></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#web-cryptography-api" class="sidebar-link">Web Cryptography API</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#生成随机数" class="sidebar-link">生成随机数</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#subtlecrypto-对象" class="sidebar-link">SubtleCrypto 对象</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#生成密码学摘要-crypto-subtle-digest" class="sidebar-link">生成密码学摘要(crypto.subtle.digest())</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#根据秘钥算法生成秘钥-cryptokey-实例-crypto-subtle-generatekey" class="sidebar-link">根据秘钥算法生成秘钥(CryptoKey)实例(crypto.subtle.generateKey())</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#导出和导入秘钥-crypto-subtle-exportkey-importkey" class="sidebar-link">导出和导入秘钥(crypto.subtle.exportKey/importKey())</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#从主秘钥派生秘钥-crypto-subtle-derivekey-derivebits" class="sidebar-link">从主秘钥派生秘钥(crypto.subtle.deriveKey/deriveBits())</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#使用非对称秘钥签名和验证消息-crypto-subtle-sign-verify" class="sidebar-link">使用非对称秘钥签名和验证消息(crypto.subtle.sign/verify())</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#使用对称秘钥加密和解密-crypto-subtle-encrypt-descrypt" class="sidebar-link">使用对称秘钥加密和解密(crypto.subtle.encrypt/descrypt())</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-20.html#包装和解包秘钥-crypto-subtle-wrapkey-unwrapkey" class="sidebar-link">包装和解包秘钥(crypto.subtle.wrapKey/unwrapKey())</a></li></ul></li></ul></li><li><a href="/js/ad3/js-ad3-21.html" class="sidebar-link">21. 错误处理与调试 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-22.html" class="sidebar-link">22. 处理 XML - JS高程4</a></li><li><a href="/js/ad3/js-ad3-23.html" class="sidebar-link">23. JSON - JS高程4</a></li><li><a href="/js/ad3/js-ad3-24.html" class="sidebar-link">24. 网络请求与远程资源 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-25.html" class="sidebar-link">25. 客户端存储 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-26.html" class="sidebar-link">26. 模块(Modules) - JS高程4</a></li><li><a href="/js/ad3/js-ad3-27.html" class="sidebar-link">27. 工作者线程(Web Workers) - JS高程4</a></li><li><a href="/js/ad3/js-ad3-28.html" class="sidebar-link">28. 最佳实践 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-old.html" class="sidebar-link">第三版其他内容(高级技巧) - JS高程4</a></li></ul></section></li><li><a href="/js/js-dom-art.html" class="sidebar-link">JavaScript DOM 编程艺术(第二版)笔记</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_20-javascript-api"><a href="#_20-javascript-api" class="header-anchor">#</a> 20. JavaScript API</h1> <p>HTML5 规范定义了一批增强已有标准的 API 和浏览器特性。另外一些规范，如 Web Cryptography 和 Notifications API 只为一个特性定义了一个 API。不同的浏览器对新 API 的实现情况不同，本章仅介绍与大多数开发者相关，已经得到多个浏览器支持，且本书中其他章节没有涵盖的内容。主要内容有 Atomics 与 SharedrrayBuffer、跨上下文消息、Encoding API、File API 与 Blob API、拖放、Notifications API、Page Visibility API、Streams API、计时 API、Web components、Web Cryptography API。</p> <h2 id="atomics-与-sharedrraybuffer"><a href="#atomics-与-sharedrraybuffer" class="header-anchor">#</a> Atomics 与 SharedrrayBuffer</h2> <p>Atomics API 是 ES2017 新增的 API。在 Web Worker 中，如果多个线程操作共享缓冲区（SharedArrayBuffer）时，就可能出现资源争夺的问题，Atomics（原子操作）API 通过强制同一时刻只能对一个缓冲区执行一个操作，可以让多个上线文安全的读写一个 SharedArrayBuffer。</p> <h3 id="sharedarraybuffer"><a href="#sharedarraybuffer" class="header-anchor">#</a> SharedArrayBuffer</h3> <p>SharedArrayBuffer 与 ArrayBuffer 具有同样的 API，主要区别是 ArrayBuffer 只能被当前执行上下文使用。SharedArrayBuffer 可以被多个执行上下文同时使用。下面是 4 个专用工作者线程（Dedicated Workers）操作同一个 SharedArrayBuffer 的实例：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// main.js</span>
<span class="token comment">// Create worker pool of size 4 创建包含 4 个线程的线程池</span>
<span class="token keyword">const</span> workers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  workers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'./worker.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Log the final value after the last worker completes</span>
<span class="token comment">// 在最后一个 worker 完成后打印最终值</span>
<span class="token keyword">let</span> responseCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> worker <span class="token keyword">of</span> workers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  worker<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>responseCount <span class="token operator">==</span> workers<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Final buffer value: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>view<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Initialize the SharedArrayBuffer</span>
<span class="token keyword">const</span> sharedArrayBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SharedArrayBuffer</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 通过 typed array 向 sharedArrayBuffer 写入值 1</span>
<span class="token keyword">const</span> view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint32Array</span><span class="token punctuation">(</span>sharedArrayBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
view<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token comment">// Send the SharedArrayBuffer to each worker</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> worker <span class="token keyword">of</span> workers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>sharedArrayBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 理论上值应该是 4000001，但实际是不超过 400万的数，而且还是动态的。</span>
<span class="token comment">// (Expected result is 4000001. Actual output will be something like:)</span>
<span class="token comment">// Final buffer value: 3254012</span>

<span class="token comment">// worker.js</span>
self<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>data<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint32Array</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Perform 1000000 add operations 执行 100 万次加 1 操作</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1E6</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    view<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  self<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>上面的例子中，每个工作者线程都顺序执行了 100 万次加操作，每次都是读取共享数组的索引，执行一次加操作，然后再把值写回索引。在线程并发执行时，可能会发生资源争用。例如</p> <ol><li>线程 A 读取到值 1</li> <li>线程 B 读取到值 1</li> <li>线程 A 加 1 并 将 2 写回数组</li> <li>然后线程 A 用就的数据 1，同样把 2 写回数组</li></ol> <p>为了解决这个问题，可以使用 Atomics API，执行原子操作。<code>view[0] += 1</code> 改为 <code>Atomics.add(view, 0, 1)</code>。关于多个 Worker 操作 SharedArrayBuffer 可以参考 <a href="http://fe.zuo11.com/js/ad3/js-ad3-27.html#%E5%B7%A5%E4%BD%9C%E8%80%85%E7%BA%BF%E7%A8%8B%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93" target="_blank" rel="noopener noreferrer">工作者线程数据传输 - 27. 工作者线程(Web Workers)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="原子操作基础"><a href="#原子操作基础" class="header-anchor">#</a> 原子操作基础</h3> <p>任何全局上下文中都有 Atomics 对象，它包含了一些用于执行线程安全操作的静态方法，多数方法以一个 TypedArray 实例（一个 SharedArrayBuffer 的引用）为第一个参数，相关操作数为后续参数</p> <p><strong>算术以及位操作方法</strong></p> <ul><li><code>Atomics.add(typedArray, index, 要加的数)</code> 对 typedArray index 索引值，执行原子加操作</li> <li><code>Atomics.sub(typedArray, index, 要减的数)</code> 对 typedArray index 索引值，执行原子减操作</li> <li><code>Atomics.or(typedArray, index, 要或的数)</code> 对 typedArray index 索引值，执行原子或操作</li> <li><code>Atomics.and(typedArray, index, 要与的数)</code> 对 typedArray index 索引值，执行原子与操作</li> <li><code>Atomics.xor(typedArray, index, 要异或的数)</code> 对 typedArray index 索引值，执行原子异或操作</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 创建一个字节的缓冲区，如果不清楚用法参考：6.集合引用类型 typed array</span>
<span class="token keyword">let</span> sharedArrayBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SharedArrayBuffer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment">// 基于缓冲区创建 类型数组 Uint8Array （另一种形式的 ArrayBuffer 视图）</span>
<span class="token keyword">let</span> typedArray <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>sharedArrayBuffer<span class="token punctuation">)</span>
<span class="token comment">// 默认 ArrayBuffer 里的值为 0</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>typedArray<span class="token punctuation">)</span> <span class="token comment">// Uint8Array [0]</span>

<span class="token keyword">const</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
      num <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>

<span class="token comment">// 执行原子加、减、或、与、异或操作</span>
Atomics<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>typedArray<span class="token punctuation">,</span> index<span class="token punctuation">,</span> num<span class="token punctuation">)</span>
typedArray <span class="token comment">// Uint8Array [5]</span>
Atomics<span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>typedArray<span class="token punctuation">,</span> index<span class="token punctuation">,</span> num<span class="token punctuation">)</span>
typedArray <span class="token comment">// Uint8Array [0]</span>
Atomics<span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span>typedArray<span class="token punctuation">,</span> index<span class="token punctuation">,</span> <span class="token number">0b1111</span><span class="token punctuation">)</span> <span class="token comment">// 十进制 15</span>
typedArray <span class="token comment">// Uint8Array [15]</span>
Atomics<span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span>typedArray<span class="token punctuation">,</span> index<span class="token punctuation">,</span> <span class="token number">0b1100</span><span class="token punctuation">)</span>
typedArray <span class="token comment">// Uint8Array [12]</span>
Atomics<span class="token punctuation">.</span><span class="token function">xor</span><span class="token punctuation">(</span>typedArray<span class="token punctuation">,</span> index<span class="token punctuation">,</span> <span class="token number">0b1111</span><span class="token punctuation">)</span> <span class="token comment">// 相同为0，不同为1</span>
typedArray <span class="token comment">// Uint8Array [3]</span>
</code></pre></div><p><strong>原子读和写</strong> 原子读和原子写之前或之后的非原子操作在执行时不会被重排，可以保证其执行顺序。</p> <ul><li><code>Atomics.load(typedArray, index)</code> 获取 typedArray index 索引处的值</li> <li><code>Atomics.store(typedArray, index, value)</code> 设置 typedArray index 索引处的值为 value</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 创建 4 个字节缓冲区</span>
<span class="token keyword">let</span> sharedArrayBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SharedArrayBuffer</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint32Array</span><span class="token punctuation">(</span>sharedArrayBuffer<span class="token punctuation">)</span>
<span class="token comment">// 执行非原子写</span>
view<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
<span class="token comment">// 非原子写可以保证在这个读操作之前完成，这里面一定读到的是 1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Atomics<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// 执行原子写</span>
Atomics<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token comment">// 非原子读，可以保证在原子写完成后执行，这里面一定督导的是 2</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>view<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 2</span>
</code></pre></div><p><strong>原子交换</strong>，将缓冲区的值设置为新的值</p> <ul><li><code>Atomics.exchange(typedArray, index, newValue)</code> 原子交换，读取 typedArray index 索引的值，并将该缓冲区的值设置为 newValue</li> <li><code>Atomics.compareExchange(typedArray, index, oldView, newValue)</code> 有条件的原子交换，读取 typedArray index 索引的值，看是否与原缓冲区的值 oldView 一致，如果一致就写入新的值，否则不进行任何操作。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 创建 4 个字节缓冲区</span>
<span class="token keyword">let</span> sharedArrayBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SharedArrayBuffer</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint32Array</span><span class="token punctuation">(</span>sharedArrayBuffer<span class="token punctuation">)</span>
Atomics<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Atomics<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 2</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Atomics<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 5</span>

<span class="token keyword">let</span> oldValue <span class="token operator">=</span> Atomics<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> newValue <span class="token operator">=</span> oldValue <span class="token operator">**</span> <span class="token number">2</span>
<span class="token comment">// 缓冲区的值未修改，还是 5，像缓冲区写入新值 25</span>
Atomics<span class="token punctuation">.</span><span class="token function">compareExchange</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> oldValue<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Atomics<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 25</span>

<span class="token comment">// 缓冲区的值已修改，不会像缓冲区写入新值 3</span>
Atomics<span class="token punctuation">.</span><span class="token function">compareExchange</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Atomics<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 25</span>
</code></pre></div><p><strong>原子 Futex（fase user-space mutex 快速用户空间互斥量）操作与加锁</strong>，为了支持更加复杂的需求。Atomics API 提供了模仿 Linux Futex的方法。注意：这些方法只能用于操作 Int32Array 视图，而且只能用在 Worker(工作者线程) 内部</p> <ul><li><code>Atomics.wait(typedArray, index, value[, timeout])</code> 当 typedArray 视图中 index 索引的值等于 value 时阻塞，停止向下执行，获得锁。直到被唤醒或超时，超时时间为 tiemout 单位毫秒。默认值为 Infinity</li> <li><code>Atomics.notify(typedArray, index, count)</code> 唤醒 typedArray 中 index 索引位置的阻塞队列，通知唤醒的线程数量由 count 指定，默认是 Infinity</li> <li><code>Atomics.isLockFree(n)</code> 基本不会用到，用于在高性能算法中确定是否有必要获取锁</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> workerScript <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
self.onmessage = ({data}) =&gt; {
  const view = new Int32Array(data)
  console.log('等待获得锁')
  Atomics.wait(view, 0, 0, 1E5)
  console.log('获得锁')
  Atomics.add(view, 0, 1)
  console.log('释放锁')
  // 只允许一个 Work 继续执行
  Atomics.notify(view, 0, 1)
  self.postMessage(null)
}
</span><span class="token template-punctuation string">`</span></span>
<span class="token keyword">const</span> workerScriptUrl <span class="token operator">=</span> <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span>workerScript<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> workers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token comment">// 创建 4 个 Worker</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  workers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span>workerScriptUrl<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 在最后一个 worker 完成后打印最终值</span>
<span class="token keyword">let</span> responseCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> worker <span class="token keyword">of</span> workers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  worker<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>responseCount <span class="token operator">==</span> workers<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Final buffer value: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>view<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> sharedArrayBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SharedArrayBuffer</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Int32Array</span><span class="token punctuation">(</span>sharedArrayBuffer<span class="token punctuation">)</span>
<span class="token comment">// 将 sharedArrayBuffer 发送到每个工作者线程执行 +1 操作</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> worker <span class="token keyword">of</span> workers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>sharedArrayBuffer<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 1s 后释放第一个锁</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Atomics<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
</code></pre></div><p>执行结果</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 等待获得锁</span>
<span class="token comment">// 等待获得锁</span>
<span class="token comment">// 等待获得锁</span>
<span class="token comment">// 等待获得锁</span>
<span class="token comment">// 获得锁</span>
<span class="token comment">// 释放锁</span>
<span class="token comment">// 获得锁</span>
<span class="token comment">// 释放锁</span>
<span class="token comment">// 获得锁</span>
<span class="token comment">// 释放锁</span>
<span class="token comment">// 获得锁</span>
<span class="token comment">// 释放锁</span>
<span class="token comment">// Final buffer value: 4</span>
</code></pre></div><h2 id="跨上下文-文档-消息传送-xdm"><a href="#跨上下文-文档-消息传送-xdm" class="header-anchor">#</a> 跨上下文(文档)消息传送（XDM）</h2> <p>跨文档消息，也简称为 XDM（cross-document messaging），是一种在不同执行上下文（如不同的工作线程或与 iframe 内嵌页面）间传递信息的能力。这里主要介绍与 iframe 内嵌的页面通信，关于 Worker 线程之间的通信参考本书第 27 章 工作者线程相关内容。XDM 的核心是 postMessage() 函数与 message 事件。</p> <ul><li><code>awindow.postMessage(message, sourceURL)</code> 向 awindow 窗口发送 message 信息, 指定接收源为 sourceURL（可以用于限制接收窗口的源必须是 sourceURL）。也可以设置为 * ，不限制源，但一般不推荐这么做。</li> <li><code>message</code> 事件，在 postMessage 后，awindow 上会触发 message 事件。该事件处理的程序的 event 包含以下三个重要信息
<ul><li><code>data</code> 作为第一个参数传给 postMessge() 的字符串 message，虽然有些浏览器可以使用 JSON 数据，但不是所有浏览器都兼容，对于 JSON 数据还是需要调用 JSON.stringify() 将其转换为字符串。</li> <li><code>origin</code> 发送消息的文档源，例如 &quot;http://127.0.0.1&quot;</li> <li><code>source</code> 发送信息的文档中 window 对象的代理，主要用于向源窗口 postMessage</li></ul></li></ul> <p>通过 iframe 加载不同的域时，使用 XDM 可以很方便的通信。也可以用于同源页面之间通信。下面是同源页面通信的示例 demo</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- 主页面 xdm.html --&gt;</span>
从 iframe 页面接收的消息：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>msg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>下面是 iframe，内嵌 iframe.html 页面 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>iframe</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>iframe.html<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>300<span class="token punctuation">&quot;</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>300<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>iframe</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  window<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'准备开始 postMessage'</span><span class="token punctuation">)</span>
    <span class="token comment">// 2s 后向 iframe 页面发送消息</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> iframeWindow <span class="token operator">=</span> frames<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token comment">// 等价于</span>
        <span class="token comment">// let iframeWindow = document.getElementsByTagName('iframe')[0].contentWindow</span>
        <span class="token comment">// iframeWindow.postMessage('1111', 'http://127.0.0.1')</span>
        iframeWindow<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'1111'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果有加 http://127.0.0.1 限制接收源会报异常</span>
        <span class="token comment">// Failed to execute 'postMessage' on 'DOMWindow': </span>
        <span class="token comment">// The target origin provided ('http://127.0.0.1') does not match </span>
        <span class="token comment">// the recipient window's origin ('http://127.0.0.1:5502').</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
    <span class="token comment">// 接收 iframe 窗口的消息并显示到 msg 位置</span>
    window<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> msg <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'msg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      msg<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> event<span class="token punctuation">.</span>data
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
      <span class="token comment">// { data: &quot;消息已成功收到！&quot;, origin: &quot;http://127.0.0.1:5502&quot; } </span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>iframe.html代码如下:</p> <div class="language-html extra-class"><pre class="language-html"><code>接收到主页面发送的消息: <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>msg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  window<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> msg <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'msg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msg<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> event<span class="token punctuation">.</span>data
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
    <span class="token comment">// event.source.postMessage('消息已成功收到！', 'http://127.0.0.1/xdm/iframe.html')</span>
    event<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'消息已成功收到！'</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'消息已收到'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>运行效果如下</p> <p><img src="/images/js/jsapi_xdm.gif" alt="jsapi_xdm.gif"></p> <h2 id="streams-api"><a href="#streams-api" class="header-anchor">#</a> Streams API</h2> <blockquote><p>由于 Encoding API 涉及到流，这里将流的内容放到前面</p></blockquote> <p>Streams API 用于处理有序的小信息块，主要有两个应用场景</p> <ul><li>大块数据可能不会立即可用，http 响应数据时是以连续信息包形式传输的，流式处理可以让数据一到达就能使用，而不用等所有数据都加载完毕。</li> <li>大块数据可能需要分成小块来处理。视频处理、数据压缩等都可以分成小块进行处理，而不必等所有数据都在内存中时再处理。</li></ul> <p>Streams API 直接解决的问题是<strong>处理网络请求和读写磁盘</strong>，它定义了三种流</p> <ul><li><code>可读流 ReadableStream</code>，通过公共接口读取数据块的流。数据在内部从底层源进入流，然后由消费者（consumer）处理</li> <li><code>可写流 WritableStream</code>，通过公共接口写入数据块的流。生成者（producer）将数据写入流，数据在内部传入底层数据槽（sink）</li> <li><code>转换流 TransformStream</code>，由两种流组成，可写流用于接收数据（可写端），可读流用于输出数据（可读端）。这两个流之间是转换程序（transformer），可以根据需要检查和修改流内容</li></ul> <p><strong>块、内部队列和反压</strong> 流的基本单位是 <strong>块（chunk）</strong>。块可以是任意数据类型，但通常是 typedArray。块不是固定大小的，也不一定按固定时间到达。流都有入口和出口的概念，数据进出速率不同，可能会出现不匹配的情况。为此流平衡可能会出现三种情况</p> <ol><li>流出口处理数据的速度比入口提供数据的速度快，流出口经常空闲，只会浪费一点内存或计算资源，这种情况可以接受</li> <li>流入和流出均衡，理想状态</li> <li>流入口提供数据的速度比出口处理数据的速度快，这种不平衡，会导致在某个地方出现数据积压，流必须做处理</li></ol> <p>流不平衡是常见的问题，因此所有流都会为已进入流，但未离开流的块提供一个 <strong>内部队列</strong>。如果块入列速度快与出列速度，内部队列会不断增大。流不可能允许内部队列无限增大，因此流会使用 <strong>反压（backpressure）</strong> 通知流入口停止发送数据，知道队列大小降到某个阈值之下。排列策略定义了内部队列可以占用的最大内存（即高水位线 high water mark）。</p> <h3 id="可读流-readablestream"><a href="#可读流-readablestream" class="header-anchor">#</a> 可读流 ReadableStream</h3> <p>可读流是对底层数据源的封装。底层数据源可以将数据填充到流中，允许消费者通过流的公共接口读取数据。</p> <p>一般通过可读流的控制器（controller）将数据传入可读流，它是一个 ReadableStreamDefaultController 实例。在创建 ReadableStream 实例时，通过在 start 函数参数中，使用 controller.enqueue(chunk) 可以将 chunk 数据传入可读流</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> readableStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReadableStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>controller<span class="token punctuation">)</span> 
    <span class="token comment">// ReadableStreamDefaultController {desiredSize: 1}</span>
    <span class="token comment">// 每隔 1 s 将 1、2、3、4、5 这几个值依次传入可读流</span>
    <span class="token keyword">let</span> chunk <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token keyword">let</span> timer <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>chunk <span class="token operator">===</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">clearInterval</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      controller<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>chunk<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token comment">// 传入完成后 调动 close 方法</span>
    controller<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// ReadableStream {locked: false}</span>
</code></pre></div><p>上面的代码将 5 个值加入了可读流（ReadableStream 实例）的队列，但没有把它从队列中读取出来。我们需要使用 ReadableStream 实例的 <strong>getReader()</strong> 方法获取可读流的读取器（默认的 reader），调用该方法后会返回一个 ReadableStreamDefaultReader 实例。此时 ReadableStream 实例的 locked 会设置为 true。保证只有这个读取器可以从流中读取值。</p> <p>消费者使用 ReadableStreamDefaultReader 实例的 read() 方法可以读出队列的值，这个 read() 方法的行为类似迭代器的 next() 方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> <span class="token function-variable function">sleep</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> readableStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReadableStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>controller<span class="token punctuation">)</span> 
    <span class="token comment">// ReadableStreamDefaultController {desiredSize: 1}</span>
    <span class="token comment">// 每隔 1 s 将 1、2、3、4、5 这几个值依次传入可读流</span>
    <span class="token keyword">let</span> chunk <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>chunk <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      controller<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>chunk<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 传入完成后 调动 close 方法</span>
    controller<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
readableStream<span class="token punctuation">.</span>locked <span class="token comment">// false</span>
<span class="token keyword">const</span> readableStreamDefaultReader <span class="token operator">=</span> readableStream<span class="token punctuation">.</span><span class="token function">getReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
readableStream<span class="token punctuation">.</span>locked <span class="token comment">// true</span>

<span class="token comment">// 读取读取器实例的值，消费者</span>
<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> done <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> readableStreamDefaultReader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">break</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 每隔 1 s 依次打印 1 2 3 4 5</span>
</code></pre></div><p>上面的例子中，我们使用了 sleep 函数，每隔 1s 向可读流队列加入值，书中使用了 Generator 加异步迭代（for await of）的方法，在第 3 章 ECMAScript 基本概念 Symbol 类型中，有讲异步迭代，如果忘了可以翻看对应位置的笔记。这里使用书中的方法来重构上面的写法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">ints</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">yield</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> readableStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReadableStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>controller<span class="token punctuation">)</span> 
    <span class="token comment">// ReadableStreamDefaultController {desiredSize: 1}</span>
    <span class="token comment">// 每隔 1 s 将 1、2、3、4、5 这几个值依次传入可读流</span>
    <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">const</span> chunk <span class="token keyword">of</span> <span class="token function">ints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      controller<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 传入完成后 调动 close 方法</span>
    controller<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
readableStream<span class="token punctuation">.</span>locked <span class="token comment">// false</span>
<span class="token keyword">const</span> readableStreamDefaultReader <span class="token operator">=</span> readableStream<span class="token punctuation">.</span><span class="token function">getReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
readableStream<span class="token punctuation">.</span>locked <span class="token comment">// true</span>

<span class="token comment">// 读取读取器实例的值，消费者</span>
<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> done <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> readableStreamDefaultReader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">break</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 每隔 1 s 依次打印 1 2 3 4 5</span>
</code></pre></div><h3 id="可写流-writablestream"><a href="#可写流-writablestream" class="header-anchor">#</a> 可写流 WritableStream</h3> <p>使用 WriteableStream 构造函数可以创建一个可写流，可以将数据写入该流，方法与 ReadableStream 类似，但有一些区别</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> writableStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WritableStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">write</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// WritableStream {locked: false}</span>
writableStream<span class="token punctuation">.</span>locked <span class="token comment">// false</span>
<span class="token keyword">const</span> writableStreamDefaultWriter <span class="token operator">=</span> writableStream<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
writableStream<span class="token punctuation">.</span>locked <span class="token comment">// true</span>

<span class="token keyword">let</span> <span class="token function-variable function">sleep</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> chunk <span class="token operator">=</span> <span class="token number">1</span>
<span class="token comment">// 生成者</span>
<span class="token keyword">while</span><span class="token punctuation">(</span>chunk <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 等待写入器可以写入值</span>
  <span class="token keyword">await</span> writableStreamDefaultWriter<span class="token punctuation">.</span>ready
  <span class="token comment">// 向写入器写入值</span>
  writableStreamDefaultWriter<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>chunk<span class="token operator">++</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 将流关闭</span>
writableStreamDefaultWriter<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="转换流-transformstream"><a href="#转换流-transformstream" class="header-anchor">#</a> 转换流 TransformStream</h3> <p>转换流用于组合可读流和可写流。其构造函数为 TransformStream，数据块在两个流之间通过 transform() 方法完成。写入的流会通过 transform 函数处理后，再传给可读流</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> writable<span class="token punctuation">,</span> readable <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransformStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">transform</span><span class="token punctuation">(</span><span class="token parameter">chunk<span class="token punctuation">,</span> controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    controller<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>chunk <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>writable<span class="token punctuation">,</span> readable<span class="token punctuation">)</span>
<span class="token keyword">const</span> writableStreamDefaultWriter <span class="token operator">=</span> writable<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> readableStreamDefaultReader <span class="token operator">=</span> readable<span class="token punctuation">.</span><span class="token function">getReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 消费者</span>
<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> done <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> readableStreamDefaultReader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">break</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 生产者</span>
<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token function-variable function">sleep</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> chunk <span class="token operator">=</span> <span class="token number">1</span>
  <span class="token comment">// 生成者</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span>chunk <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 等待写入器可以写入值</span>
    <span class="token keyword">await</span> writableStreamDefaultWriter<span class="token punctuation">.</span>ready
    <span class="token comment">// 向写入器写入值</span>
    writableStreamDefaultWriter<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>chunk<span class="token operator">++</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 将流关闭</span>
  writableStreamDefaultWriter<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 每隔 1s 依次打印</span>
<span class="token comment">// 2 4 6 8 10</span>
</code></pre></div><h3 id="通过管道连接流"><a href="#通过管道连接流" class="header-anchor">#</a> 通过管道连接流</h3> <p>流可以通过管道连接在一起，ReadableStream 的实例可以使用以下两种方法操作管道</p> <ul><li><code>readableStream.pipeThrough(transformStream)</code> 通过管道，将 readableStream 接入 transformStream。readableStream 先把自己的值传给 transformStream 内部的 writableStream，然后转换后的值又在新的 readableStream 上出现。</li> <li><code>readableStream.pipeTo(writableStream)</code> 通过管道，将 readableStream 连接到 writableStream。管道连接操作隐式从 readableStream 获取了一个读取器，并把产生的值填充到 writeableStream</li></ul> <p>将 readableStream 接入 transformStream 实例</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> <span class="token function-variable function">sleep</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> readableStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReadableStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> chunk <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>chunk <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      controller<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>chunk<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    controller<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> transformStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransformStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">transform</span><span class="token punctuation">(</span><span class="token parameter">chunk<span class="token punctuation">,</span> controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    controller<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>chunk <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// TransformStream {readable: ReadableStream, writable: WritableStream}</span>

<span class="token comment">// 通过管道连接流</span>
<span class="token keyword">const</span> pipedStream <span class="token operator">=</span> readableStream<span class="token punctuation">.</span><span class="token function">pipeThrough</span><span class="token punctuation">(</span>transformStream<span class="token punctuation">)</span>
<span class="token comment">// 从管道连接流获取 reader</span>
<span class="token keyword">const</span> pipedStreamDefaultReader <span class="token operator">=</span> pipedStream<span class="token punctuation">.</span><span class="token function">getReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 消费者</span>
<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> done <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> pipedStreamDefaultReader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">break</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 每隔 1s 依次打印 2 4 6 8 10</span>
</code></pre></div><p>将 readableStream 连接到 writableStream 实例：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> <span class="token function-variable function">sleep</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> readableStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReadableStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> chunk <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>chunk <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      controller<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>chunk<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    controller<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> writableStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WritableStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">write</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> pipedStream <span class="token operator">=</span> readableStream<span class="token punctuation">.</span><span class="token function">pipeTo</span><span class="token punctuation">(</span>writableStream<span class="token punctuation">)</span>

<span class="token comment">// 每隔 1s 依次打印 1 2 3 4 5</span>
</code></pre></div><h2 id="encoding-api"><a href="#encoding-api" class="header-anchor">#</a> Encoding API</h2> <p>Encoding API 主要用于实现字符串与 typed array之间的转换。规范新增了 4 个用于执行转换的全局类 TextEncoder、TextEncoderStream、TextDecoder 和 TextDecoderStream</p> <p>&quot;编码&quot; Encode 是将字符串转为 typedArray，&quot;解码&quot; Decode 是将 typedArray 转换为字符串。</p> <h3 id="textencoder-与-textdecoder"><a href="#textencoder-与-textdecoder" class="header-anchor">#</a> TextEncoder 与 TextDecoder</h3> <p>普通字符串编码（bulk 编码/批量编码）使用 TextEncoder 类，TextEncoder 实例支持如下方法：</p> <ul><li><code>textEncoder.encode(str)</code> 将字符串 str 转换为 Uint8Array 格式的 typed array。返回每个字符的 UTF-8 编码</li> <li><code>textEncoder.encodeInto(str, typedArray)</code> 将每个字符的 UTF-8 编码写入类型为 Uint8Array 的 typedArray。主要是可以指定类型数组(定型数组)长度，如果类型数组空间不够会提交终止，返回值是一个对象：<code>{ read: 成功从源字符串读取的字符个数，written: 成功写入到目标 typedArray 的字符个数 }</code></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> textEncoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> encodeText <span class="token operator">=</span> textEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">'foo0'</span><span class="token punctuation">)</span>
<span class="token comment">// f 的 UTF-8 编码是 102 =&gt; 0x66，0 48 =&gt; 0x30</span>
<span class="token comment">// encodeText Uint8Array(4) [102, 111, 111, 48]</span>
<span class="token comment">// 有些字符可能会占用多个索引</span>
textEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">'😊'</span><span class="token punctuation">)</span> <span class="token comment">// Uint8Array(4) [240, 159, 152, 138]</span>

<span class="token keyword">const</span> aView <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> bView <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
textEncoder<span class="token punctuation">.</span><span class="token function">encodeInto</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span> aView<span class="token punctuation">)</span> <span class="token comment">// { read: 3, written: 3 }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>aView<span class="token punctuation">)</span> <span class="token comment">// Uint8Array(3) [102, 111, 111]</span>
textEncoder<span class="token punctuation">.</span><span class="token function">encodeInto</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span> bView<span class="token punctuation">)</span> <span class="token comment">// { read: 1, written: 1 }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>bView<span class="token punctuation">)</span> <span class="token comment">// Uint8Array(1) [102]</span>
</code></pre></div><p>可以使用 TextDecoder 对 typedArray 进行解码，将其转换为字符串，TextDecoder 实例支持如下方法:</p> <ul><li><code>textDecoder.decode(typedArray)</code> 将 typedArray 转换为字符串，默认字符编码是 UTF-8。也可以解码 UTF-16 字符编码进行解码。解码器不关心传入的是那种 typedArray，只专心解码整个二进制表示。传入 Uint32Array 也可以解码。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> textDecoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// Uint8 1个字节 8 位 [0x66, 0x6F, 0x6F, 0x30]</span>
<span class="token keyword">let</span> decodeText <span class="token operator">=</span> textDecoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>Uint8Array<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">,</span> <span class="token number">48</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// decodeText &quot;foo0&quot;</span>

<span class="token comment">// Unit32 4个字节 32位 [0x0066, 0x006F, 0x006F, 0x0030] </span>
textDecoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>Uint32Array<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">,</span> <span class="token number">48</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// 返回 &quot;foo0&quot; 书中加了空格是错的</span>

textDecoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>Uint8Array<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">240</span><span class="token punctuation">,</span> <span class="token number">159</span><span class="token punctuation">,</span> <span class="token number">152</span><span class="token punctuation">,</span> <span class="token number">138</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// &quot;😊&quot;</span>

<span class="token keyword">const</span> utf16TextDecoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextDecoder</span><span class="token punctuation">(</span><span class="token string">'utf-16'</span><span class="token punctuation">)</span>
utf16TextDecoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>Uint16Array<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// &quot;foo&quot;</span>
</code></pre></div><h3 id="textencoderstream-与-textdecoderstream"><a href="#textencoderstream-与-textdecoderstream" class="header-anchor">#</a> TextEncoderStream 与 TextDecoderStream</h3> <p>流编码（stream 编码）使用 TextEncoderStream，它其实就是 TransformStream 形式的 TextEncoder，将可读流的内容连接到 TextEncoderStream 实例（类似于 TransformStream 实例），可读流的内容传给该实例的可写流，然后将内部 transform（编码） 后的值，再给到新的可读流。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 先创建一个可读的流，内容分别是 f o o 0</span>
<span class="token keyword">let</span> <span class="token function-variable function">sleep</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> readableStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReadableStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> str <span class="token operator">=</span> <span class="token string">&quot;foo0&quot;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> len <span class="token operator">=</span> str<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      controller<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>str<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    controller<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 对流进行编码</span>
<span class="token keyword">const</span> encodeTextStream <span class="token operator">=</span> readableStream<span class="token punctuation">.</span><span class="token function">pipeThrough</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextEncoderStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> encodeTextStreamDefaultReader <span class="token operator">=</span> encodeTextStream<span class="token punctuation">.</span><span class="token function">getReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 读取编码后的流</span>
<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> done <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> encodeTextStreamDefaultReader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">break</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 每隔 1s 依次打印</span>
<span class="token comment">// Uint8Array [102] </span>
<span class="token comment">// Uint8Array [111]</span>
<span class="token comment">// Uint8Array [111]</span>
<span class="token comment">// Uint8Array [48]</span>
</code></pre></div><p>TextDecoderStream 流解码与流编码类似。文本解码器流能够识别分散在不同块上的字符。解码器流会保持块片段直到取得完整的字符。比如当解码笑脸符号时，它不会单独输出，而是一个完整的笑脸。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 先创建一个可读的流，内容分别是 f o o 0</span>
<span class="token keyword">let</span> <span class="token function-variable function">sleep</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> readableStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReadableStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">controller</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// let arr = [102, 111, 111, 48] // foo0</span>
    <span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">240</span><span class="token punctuation">,</span> <span class="token number">159</span><span class="token punctuation">,</span> <span class="token number">152</span><span class="token punctuation">,</span> <span class="token number">138</span><span class="token punctuation">]</span> <span class="token comment">// </span>
    arr <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> Uint8Array<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> len <span class="token operator">=</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      controller<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    controller<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 对流进行编码</span>
<span class="token keyword">const</span> decodeTextStream <span class="token operator">=</span> readableStream<span class="token punctuation">.</span><span class="token function">pipeThrough</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextDecoderStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> decodeTextStreamDefaultReader <span class="token operator">=</span> decodeTextStream<span class="token punctuation">.</span><span class="token function">getReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 读取编码后的流</span>
<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> done <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> decodeTextStreamDefaultReader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">break</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 如果 arr = [102, 111, 111, 48]</span>
<span class="token comment">// 每隔 1s 依次打印</span>
<span class="token comment">// f</span>
<span class="token comment">// o</span>
<span class="token comment">// o</span>
<span class="token comment">// 0</span>

<span class="token comment">// 如果 arr = [240, 159, 152, 138]</span>
<span class="token comment">// 5s 后打印 😊</span>
</code></pre></div><p>文本解码器流经常和 fetch() 一起使用，因为响应体可以作为 ReadableStream 来处理，例如</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 访问 https://api.zuo11.com/ibd/fooddaily/info</span>
<span class="token comment">// 打开 console，粘贴下面的代码并执行</span>
<span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://api.zuo11.com/ibd/fooddaily/info'</span><span class="token punctuation">)</span>
<span class="token comment">// Response {</span>
<span class="token comment">//  type: &quot;basic&quot;, </span>
<span class="token comment">//  status: 200,</span>
<span class="token comment">//  body: ReadableStream,</span>
<span class="token comment">//  headers: {}</span>
<span class="token comment">// }</span>
<span class="token keyword">const</span> stream <span class="token operator">=</span> res<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">pipeThrough</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextDecoderStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// ReadableStream {locked: false}</span>
<span class="token keyword">const</span> decodedStream <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">getReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> resData <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> done <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> decodedStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'resData'</span><span class="token punctuation">,</span> resData<span class="token punctuation">)</span>
      <span class="token keyword">break</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      resData <span class="token operator">+=</span> value
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// {&quot;code&quot;:200,&quot;msg&quot;:&quot;成功&quot;,&quot;data&quot;:{&quot;id&quot;:1,&quot;auditMark&quot;:0}}</span>
<span class="token comment">// resData {&quot;code&quot;:200,&quot;msg&quot;:&quot;成功&quot;,&quot;data&quot;:{&quot;id&quot;:1,&quot;auditMark&quot;:0}}</span>
</code></pre></div><h2 id="file-api-与-blob-api"><a href="#file-api-与-blob-api" class="header-anchor">#</a> File API 与 Blob API</h2> <p>2000年以前，处理文件的唯一方式就是在表单中加入 <code>&lt;input type=&quot;file&quot;&gt;</code> 字段。File API 和 Blob API 在表单中的文件输入字段的基础上，添加了一些直接访问文件的接口。HTML5 在 DOM 上为文件输入元素添加了一个 files 集合。通过文件输入字段选择一个或多个文件时，该元素 files 属性里会包含一组 File 对象，一个 File 对象对应着一个文件。每个 File 对象，都有下列只读属性:</p> <ul><li>name 本地文件系统中的文件名</li> <li>size 文件的字节大小</li> <li>type 字符串，文件的 MIME 类型</li> <li>lastModifiedDate: 字符串，文件上一次被修改的时间</li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fileInput<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>multipleFileInput<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span> <span class="token attr-name">multiple</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>multiple<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">let</span> fileInput <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'fileInput'</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> multipleFileInput <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'multipleFileInput'</span><span class="token punctuation">)</span>

  <span class="token comment">// 文件内容改变时，显示文件信息</span>
  fileInput<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> fileChangeHandle<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
  multipleFileInput<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> fileChangeHandle<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>

  <span class="token keyword">function</span> <span class="token function">fileChangeHandle</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> files <span class="token operator">=</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>files
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> files<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> fileInfo <span class="token operator">=</span> files<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token comment">// File对象</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'name: '</span><span class="token punctuation">,</span> fileInfo<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'lastModified: '</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>fileInfo<span class="token punctuation">.</span>lastModified<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLocaleString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// timestamp</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'type: '</span><span class="token punctuation">,</span> fileInfo<span class="token punctuation">.</span>type<span class="token punctuation">)</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'size: '</span><span class="token punctuation">,</span> fileInfo<span class="token punctuation">.</span>size<span class="token punctuation">)</span>  <span class="token comment">// B 字节  /1000 kb</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// name: 截屏2020-12-03 下午8.49.12.png</span>
  <span class="token comment">// lastModified: 2020/12/3 下午8:49:18</span>
  <span class="token comment">// type: image/png</span>
  <span class="token comment">// size: 93192</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="filereader-类型"><a href="#filereader-类型" class="header-anchor">#</a> FileReader 类型</h3> <p>FileReader 是一种异步文件的读取机制，可以把 FileReader 想象成 XMLHttpRequest，区别只是它读取的是文件系统，而不是远程服务器数据。FileReader 提供了如下方法，来读取文件中的数据</p> <ul><li><code>readAsText(file[, encoding])</code> 以纯文本形式读取文件，将读取到的文本保存在对应 FileReader 实例的 result 属性中。</li> <li><code>readAsDataURL(file)</code> 读取文件，将文件以数据 URI（base64 格式字符串）的形式保存在 result 属性中。</li> <li><code>readAsBinaryString(file)</code> 读取文件，并将每个字符的二进制数据保存在 result 属性中，字符串中的每个字符表示一字节。</li> <li><code>readAsArrayBuffer(file)</code> 读取文件，并将文件内容以 ArrayBuffer 的形式保存在 result 中。</li></ul> <p>这些操作都是异步的，每个 FileReader 实例都会发布几个事件，其中比较有用的三个事件时：</p> <ul><li><code>progress 事件</code>，还有更多数据，每 50ms 触发一次，与 XHR 的 progress 事件具有相同的信息：lengthComputable、loaded、total，还可以读取 FileReader 实例的 result 属性</li> <li><code>error 事件</code>，发生了错误，FileReader 的 error 属性时一个对象，它仅有一个 code 属性，这个错误码的值可能是：1 未找到文件 2 安全错误 3 读取被中断 4 文件不可读 5 编码错误。</li> <li><code>load 事件</code>，读取完成，如果 error 事件被触发，不会触发 load 事件</li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>inputFile<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">let</span> inputFile <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'inputFile'</span><span class="token punctuation">)</span>
  inputFile<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> file <span class="token operator">=</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

    <span class="token comment">// 读取文件</span>
    <span class="token keyword">let</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果是图片，直接获取数据 URI 直接显示， 如果是其他，直接读取文本</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">.</span>type<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'image'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      reader<span class="token punctuation">.</span><span class="token function">readAsText</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token comment">// 读取文件为文本内容</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      reader<span class="token punctuation">.</span><span class="token function">readAsDataURL</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token comment">// 获取文件的 Base64 URI</span>
    <span class="token punctuation">}</span>

    reader<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> errMsg <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'未找到文件'</span><span class="token punctuation">,</span> <span class="token string">'安全性错误'</span><span class="token punctuation">,</span> <span class="token string">'读取中断'</span><span class="token punctuation">,</span> <span class="token string">'文件不可读'</span><span class="token punctuation">,</span> <span class="token string">'编码错误'</span><span class="token punctuation">]</span>
      <span class="token keyword">let</span> errCode <span class="token operator">=</span> reader<span class="token punctuation">.</span>error<span class="token punctuation">.</span>code
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'读取文件错误, code: '</span> <span class="token operator">+</span> errCode <span class="token operator">+</span> <span class="token string">'，错误提示: '</span> <span class="token operator">+</span> errMsg<span class="token punctuation">[</span>errCode<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    reader<span class="token punctuation">.</span><span class="token function-variable function">onprogress</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 文件读取中，大概 50ms 刷新一次</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">加载进度 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>e<span class="token punctuation">.</span>loaded<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> / </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>e<span class="token punctuation">.</span>total<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    reader<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 文件读取完成会存到 reader.result里面</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>reader<span class="token punctuation">.</span>result<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="filereadersync-类型"><a href="#filereadersync-类型" class="header-anchor">#</a> FileReaderSync 类型</h3> <p>FileReaderSync 是 FileReader 的同步版本，仅在 Worker 中可用。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>inputFile<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">let</span> inputFile <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'inputFile'</span><span class="token punctuation">)</span>
  inputFile<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> file <span class="token operator">=</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token comment">// 新开一个 Worker 线程去处理</span>
    <span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'worker.js'</span><span class="token punctuation">)</span>
    <span class="token comment">// 将文件数据发送给 worker</span>
    worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
    <span class="token comment">// 监听 worker 内部发送的信息</span>
    worker<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'接收到 worker 的值'</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
      <span class="token comment">// 接收到 worker 的值</span>
      <span class="token comment">// MessageEvent { data: &quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPQA…j1JhSFU&quot;,... }</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>worker.js 代码</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 当 worker 接收到 file 数据时</span>
self<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>data<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 同步读 file</span>
  <span class="token keyword">const</span> syncReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReaderSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> syncReader<span class="token punctuation">.</span><span class="token function">readAsDataURL</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
  <span class="token comment">// 将数据发给主线程</span>
  self<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="blob-读取部分文件内容"><a href="#blob-读取部分文件内容" class="header-anchor">#</a> Blob 读取部分文件内容</h3> <p>如果只想读取文件的一部分，而不是全部，可以使用 File 对象的 slice(起始字节，要读取的字节数) 方法。会返回一个 Blob 实例，Blob 是 File 的超类（父类）。blob 表示二进制大对象（binary large object） 是 JS 对不可修改二进制数据的封装类型。</p> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>File<span class="token punctuation">.</span>__proto__  <span class="token operator">===</span> Blob<span class="token punctuation">)</span> <span class="token comment">// true</span>
</code></pre></div><p>可以使用字符串数组、ArrayBuffers、ArrayBuffersViews、其他Blob实例来创建 Blob。它的构造函数可以接收一个 options 参数，并在其中指定 MIME 类型。</p> <ul><li><code>new Blob(contentArray[, options])</code> 创建一个 Blob 对象，内容是 contentArray 拼接的内容。options 是一个可选的对象，支持传入文件 MIME type。Blob 实例包含两个属性 size，表示数据大小(字节)。type 表示文件 MIME 类型。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// Blob {size: 3, type: &quot;&quot;}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'{&quot;a&quot;: &quot;b&quot;}'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&quot;application/json&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// Blob {size: 10, type: &quot;application/json&quot;}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'&lt;p&gt;Foo&lt;/p&gt;'</span><span class="token punctuation">,</span> <span class="token string">'&lt;p&gt;Bar&lt;/p&gt;'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&quot;text/html&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// Blob {size: 20, type: &quot;text/html&quot;}</span>
</code></pre></div><p>使用 slice() 切分文件，返回 blob 对象，使用 FileReader 读取，可以实现仅读取文件的部分内容。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">let</span> fileInput <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'file'</span><span class="token punctuation">)</span>
  fileInput<span class="token punctuation">.</span><span class="token function-variable function">onchange</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> file <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">let</span> blob <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token comment">// 只读取 32B（字节）的内容</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span> <span class="token comment">// Blob {size: 32, type: &quot;&quot;}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>blob<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      reader<span class="token punctuation">.</span><span class="token function">readAsText</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span>
      reader<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'读取文件错误, '</span> <span class="token operator">+</span> reader<span class="token punctuation">.</span>error<span class="token punctuation">.</span>code<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      reader<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'读取文件成功，'</span> <span class="token operator">+</span> reader<span class="token punctuation">.</span>result<span class="token punctuation">)</span>
        <span class="token keyword">let</span> div <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span>
        div<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>reader<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span>
        document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>div<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      reader<span class="token punctuation">.</span><span class="token function-variable function">onprogress</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'读取中.....'</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>loaded <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>total<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'您的浏览器不支持blob.slice()'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="对象-url-与-blob"><a href="#对象-url-与-blob" class="header-anchor">#</a> 对象 URL 与 Blob</h3> <p>对象 URL，也称为 Blob URL，引用保存在 File 或 Blob 中数据的 URL，它的优点是不必把文件内容读取到 JS 中也可以直接使用文件。创建对象 URL，可以使用 window.URL.createObjectURL() 方法并传入 File 或 Blob 对象。IE10+ 支持</p> <ul><li><code>window.URL.createObjectURL(File或Blob对象)</code> 创建对象 URL，返回一个 string 类型的 URL</li> <li><code>window.URL.revokeObjectURL(objectURL)</code> 释放对应对象 URL 的内存。 虽然页面卸载时会自动释放对象URL占用的内存，但如果不用了，还是建议手工释放，节约内存。</li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>img<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">var</span> file <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'file'</span><span class="token punctuation">)</span>
  file<span class="token punctuation">.</span><span class="token function-variable function">onchange</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> myfile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">var</span> img <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> dataUrl <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>myfile<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'dataURL: '</span> <span class="token operator">+</span> dataUrl<span class="token punctuation">)</span>
    <span class="token comment">// dataURL: blob:http://localhost:63342/b42b5b0a-fef8-4cb2-b26d-1973517ac08a</span>
    img<span class="token punctuation">.</span>src <span class="token operator">=</span> dataUrl
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      window<span class="token punctuation">.</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">revokeObjectURL</span><span class="token punctuation">(</span>dataUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>对象 URL 以及 FileReader.prototype.readAsDataURL 虽然都可以用于预览图片，但是他们的区别是 readAsDataURL 返回的是文件的 URI, base64 格式。而 createObjectURL() 返回的是一个链接 URL。对于比较大的文件 base64 会卡，对象 URL 不会，详情参见：<a href="http://www.zuo11.com/blog/2020/10/file_preview_download.html" target="_blank" rel="noopener noreferrer">FileReader.readAsDataURL与URL.createObjectURL的区别 | 左小白的技术日常<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="读取拖拽文件并上传"><a href="#读取拖拽文件并上传" class="header-anchor">#</a> 读取拖拽文件并上传</h3> <p>使用 H5 拖放 API，从桌面上把文件拖放到浏览器中会触发 drop 事件。在 event.dataTransger.files 中可以读取到放置的文件，与通过 type 为 file 的 input 获取的 File 一致</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
    <span class="token selector">#dragDiv</span> <span class="token punctuation">{</span> <span class="token property">width</span><span class="token punctuation">:</span>300px<span class="token punctuation">;</span><span class="token property">height</span><span class="token punctuation">:</span> 150px<span class="token punctuation">;</span><span class="token property">border</span><span class="token punctuation">:</span>2px dashed #ccc<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token selector">.draging</span> <span class="token punctuation">{</span> <span class="token property">border</span><span class="token punctuation">:</span>2px dashed red <span class="token important">!important</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>拖拽文件到下面的方框区域<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dragDiv<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">let</span> dragDiv <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'dragDiv'</span><span class="token punctuation">)</span>

    dragDiv<span class="token punctuation">.</span><span class="token function-variable function">ondragenter</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 当文件拖动到区域，设置red边框样式</span>
      dragDiv<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">&quot;draging&quot;</span>
    <span class="token punctuation">}</span>
    dragDiv<span class="token punctuation">.</span><span class="token function-variable function">ondragover</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 取消默认行为，设置可拖放</span>
    <span class="token punctuation">}</span>
    dragDiv<span class="token punctuation">.</span><span class="token function-variable function">ondrop</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 有文件拖放触发</span>
      dragDiv<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">&quot;&quot;</span>
      e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// drop默认行为会打开新的窗口，取消默认行为</span>

      <span class="token comment">// 将文件用XHR上传操作</span>
      <span class="token comment">// 1. 准备数据</span>
      <span class="token keyword">let</span> files <span class="token operator">=</span> e<span class="token punctuation">.</span>dataTransfer<span class="token punctuation">.</span>files
      <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">let</span> info <span class="token operator">=</span> <span class="token string">''</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> files<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>files<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        data<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'file'</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> files<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        info <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;文件名: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>files<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">，文件类型: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>files<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">}&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">}</span>
      dragDiv<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> info
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">fromEntries</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

      <span class="token comment">// 2. 开始上传</span>
      <span class="token keyword">let</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'post'</span><span class="token punctuation">,</span> <span class="token string">'/fileupdate'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// 异步发送请求</span>
      xhr<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 请求成功</span>
          <span class="token function">alert</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'请求异常'</span><span class="token punctuation">,</span> xhr<span class="token punctuation">.</span>status<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    dragDiv<span class="token punctuation">.</span><span class="token function-variable function">ondragleave</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 文件移出</span>
      dragDiv<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">&quot;&quot;</span>
    <span class="token punctuation">}</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="媒体元素video-audio"><a href="#媒体元素video-audio" class="header-anchor">#</a> 媒体元素video/audio</h2> <p>HTML5新增了两个与媒体相关的标签，让开发人员不必依赖任何插件就能在网页中嵌入音频与视频内容。标签为video和audio，IE9+ 支持。视频支持格式video/mp4; video/ogg; video/webm; 音频支持格式 audio/mp4; audio/mpeg(mp3); audio/ogg; audio/wav;</p> <ul><li>video 和 audio 一般需要手动点击才能自动播放，如果 video 元素加了 muted 无声，是可以自动播放的。使用 Audio 构造函数创建音频播放时，只有等用户在页面上做了交互操作，才能播放。否则会报错 Uncaught (in promise) DOMException: play() failed because the user didn't interact with the document first</li> <li>一般只有在视频可以播放时才能通过 JS 获取到视频总时长</li> <li>更多属性、事件参考 p628</li></ul> <p>下面来看 video 与 audio 元素的 demo</p> <p><img src="/images/js/video.png" alt="video元素"></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>video<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 嵌入视频, 如果浏览器不支持会显示Video element not support --&gt;</span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>video</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>最后一公里.mp4<span class="token punctuation">&quot;</span></span> <span class="token attr-name">controls</span><span class="token punctuation">&gt;</span></span>Video element not support<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>video</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>video</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>最后一公里.mp4<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Video element not support<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>video</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>video</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>video<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>最后一公里.mp4<span class="token punctuation">&quot;</span></span> <span class="token attr-name">controls</span> <span class="token attr-name">poster</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>posterimg.png<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Video element not support<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>video</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>video</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>最后一公里.mp4<span class="token punctuation">&quot;</span></span> <span class="token attr-name">controls</span> <span class="token attr-name">poster</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>posterimg.png<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>300<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Video element not support<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>video</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!--- 如果单独设置了autoplay，无法播放，需要再加一个muted属性才能自动播放，muted是让视频静音--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>video</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>最后一公里.mp4<span class="token punctuation">&quot;</span></span> <span class="token attr-name">controls</span> <span class="token attr-name">poster</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>posterimg.png<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>300<span class="token punctuation">&quot;</span></span> <span class="token attr-name">autoplay</span> <span class="token attr-name">muted</span><span class="token punctuation">&gt;</span></span>Video element not support<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>video</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>play()<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>播放<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pause()<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>暂停<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>curPlayTime<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>totalPlayTime<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>  音量：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>volume<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
      <span class="token keyword">var</span> video <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'video'</span><span class="token punctuation">)</span>
      <span class="token comment">// 无效</span>
      <span class="token comment">// setTimeout(function() {</span>
      <span class="token comment">//   console.log(video)</span>
      <span class="token comment">//   video.play()</span>
      <span class="token comment">// }, 5000)</span>
      <span class="token comment">// 需要点击事件才能触发，如果一进来直接调用函数会无效，除非播放时加入muted属性无声音。放在oncanplay里也无效</span>
      <span class="token keyword">function</span> <span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'video.play'</span><span class="token punctuation">)</span>
        video<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">function</span> <span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'video.pause'</span><span class="token punctuation">)</span>
        video<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">var</span> curPlayTimeEle <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'curPlayTime'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> totalPlayTimeEle <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'totalPlayTime'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> volumeEle <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'volume'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 只有在视频可以播放时才能获取到视频总时长</span>
      video<span class="token punctuation">.</span><span class="token function-variable function">oncanplay</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// video.play()</span>
        <span class="token keyword">var</span> duration <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>video<span class="token punctuation">.</span>duration<span class="token punctuation">)</span>
        totalPlayTimeEle<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>duration <span class="token operator">/</span> <span class="token number">60</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'分'</span> <span class="token operator">+</span> duration <span class="token operator">%</span> <span class="token number">60</span> <span class="token operator">+</span> <span class="token string">'秒'</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>video<span class="token punctuation">.</span>duration<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 更新当前播放时长及音量</span>
      <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        curPlayTimeEle<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> video<span class="token punctuation">.</span>currentTime<span class="token punctuation">;</span>
        volumeEle<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> video<span class="token punctuation">.</span>volume<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">250</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>audio src 可以是声音，也可以是视频，如果是视频只会播放其声音</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>video<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 嵌入audio, 如果浏览器不支持会显示Video element not support --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>播放mp4声音: 最后一公里.mp4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>audio</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>最后一公里.mp4<span class="token punctuation">&quot;</span></span> <span class="token attr-name">controls</span><span class="token punctuation">&gt;</span></span>audio element not support<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>audio</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>播放mp3声音: 王菲 - 匆匆那年.mp3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>audio</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>audio<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>王菲 - 匆匆那年.mp3<span class="token punctuation">&quot;</span></span> <span class="token attr-name">controls</span><span class="token punctuation">&gt;</span></span>audio element not support<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>audio</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>play()<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>播放<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pause()<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>暂停<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
      <span class="token keyword">var</span> audio <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'audio'</span><span class="token punctuation">)</span>
      audio<span class="token punctuation">.</span><span class="token function-variable function">oncanplaythrough</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'可以播放了'</span><span class="token punctuation">)</span>
        <span class="token comment">// 这样也无效，还是要用按钮click触发</span>
        <span class="token comment">// chrome 和 firefox无效，IE11有效</span>
        <span class="token comment">// audio.play()</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">function</span> <span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'audio.play'</span><span class="token punctuation">)</span>
        audio<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">function</span> <span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'audio.pause'</span><span class="token punctuation">)</span>
        audio<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>素材及完整 demo 参见：<a href="https://github.com/zuoxiaobai/fedemo/blob/master/src/JS_ES6/JS%E9%AB%98%E7%A8%8B3/HTML%E8%84%9A%E6%9C%AC%E7%BC%96%E7%A8%8B/3_%E5%AA%92%E4%BD%93%E5%85%83%E7%B4%A0video_audio/" target="_blank" rel="noopener noreferrer">video 与 audio demo | Github<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="指定多个媒体源-检测编解码器"><a href="#指定多个媒体源-检测编解码器" class="header-anchor">#</a> 指定多个媒体源/检测编解码器</h3> <p>由于浏览器支持的媒体格式不同，可以在 video 或 audio 元素内部使用 source 元素指定多个不同的媒体源，这时需要删除 src 属性。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- 嵌入视频 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>video</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>video<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>a.webm<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>video/webm; codecs=<span class="token punctuation">'</span>vp8, vorbis<span class="token punctuation">'</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>a.ogv<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>video/ogg; codecs=<span class="token punctuation">'</span>theora, vorbis<span class="token punctuation">'</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>a.mpg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  不支持 video 功能
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>video</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 嵌入音频 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>audio</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>audio<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>b.ogg<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>audio/ogg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>b.mp3<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>audio/mpeg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  不支持 audio 功能
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>audio</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>可以使用 audio 和 video 元素的 canplayType() 方法来检测浏览器是否支持给定格式和编解码器。它返回一个字符串：&quot;probably&quot;, &quot;maybe&quot;, &quot;&quot;</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>audio<span class="token punctuation">.</span><span class="token function">canPlayType</span><span class="token punctuation">(</span><span class="token string">'audio/mpeg'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 支持</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="audio-音频类型"><a href="#audio-音频类型" class="header-anchor">#</a> Audio 音频类型</h3> <p>使用 Audio 构造函数与 audio 元素类似。不需要插入 dom 即可工作。创建实例后，等下载完毕后就可以调用 play() 播放音频。但浏览器为了安全考虑，一般需要和页面有交互时，才可以播放音乐。在 iOS 中调用 play() 会弹出对话框，请求用户授权播放声音。为了连续播放，必须在 onfinish 事件处理程序中立即调用 play()</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>123<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  window<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> audio <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Audio</span><span class="token punctuation">(</span><span class="token string">'王菲 - 匆匆那年.mp3'</span><span class="token punctuation">)</span>
    audio<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'canplaythrough'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 延时 3 s，中途点击页面，完成用 dom 交互</span>
      <span class="token comment">// Uncaught (in promise) DOMException: play() failed because the user didn't interact with the document first.</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'开始自动播放'</span><span class="token punctuation">)</span>
        audio<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="原生拖放"><a href="#原生拖放" class="header-anchor">#</a> 原生拖放</h2> <p><strong>该章节由于没有实例，且重要部分介绍内容有两处与实际不符，不好理解，不建议阅读本章来学习原生拖放</strong></p> <blockquote><p>HTML标签 draggabl e属性，表示是否可拖动，img 和 a 标签、选中的文本默认为是可拖动的，其他元素默认为 false, 无法拖动。如果想让某个区域成为可放置区域，只需要将该区域 dragover 事件，阻止其默认行为</p></blockquote> <p>拖动某个元素时，会依次触发<strong>dragstart, drag, dragend</strong> 事件。当某个元素被拖动到一个有效的目标位置时，目标元素会依次触发<strong>dragenter, dragover</strong>，<strong>dragleave(不可放置)或drop(可放置)</strong></p> <p>参考: <a href="http://www.zuo11.com/blog/2020/8/js_drag_drop.html" target="_blank" rel="noopener noreferrer">H5原生拖放(Drag and Drop)demo以及浏览器兼容性处理 | 左小白的技术日常<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>drag demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
      <span class="token selector">.sec-content</span> <span class="token punctuation">{</span> <span class="token property">width</span><span class="token punctuation">:</span>600px<span class="token punctuation">;</span><span class="token property">height</span><span class="token punctuation">:</span> 400px<span class="token punctuation">;</span><span class="token property">border</span><span class="token punctuation">:</span>1px solid #ccc<span class="token punctuation">;</span> <span class="token punctuation">}</span>
      <span class="token selector">.dragdiv</span> <span class="token punctuation">{</span><span class="token property">width</span><span class="token punctuation">:</span>50px<span class="token punctuation">;</span> <span class="token property">height</span><span class="token punctuation">:</span>50px<span class="token punctuation">;</span><span class="token property">border</span><span class="token punctuation">:</span>1px solid blue<span class="token punctuation">;</span> <span class="token property">margin-right</span><span class="token punctuation">:</span>10px<span class="token punctuation">;</span><span class="token punctuation">}</span>
      <span class="token selector">.flexdiv</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span><span class="token punctuation">}</span>
      <span class="token selector">#square1</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span> <span class="token property">flex-wrap</span><span class="token punctuation">:</span> wrap<span class="token punctuation">}</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sec-title<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>可拖动模块<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>flexdiv<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>flexdiv<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dragdiv1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dragdiv<span class="token punctuation">&quot;</span></span> <span class="token attr-name">draggable</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dragdiv2<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dragdiv<span class="token punctuation">&quot;</span></span> <span class="token attr-name">draggable</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dragdiv3<span class="token punctuation">&quot;</span></span><span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dragdiv<span class="token punctuation">&quot;</span></span> <span class="token attr-name">draggable</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dragdiv4<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dragdiv<span class="token punctuation">&quot;</span></span> <span class="token attr-name">draggable</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sec-title<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>放置区域1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>square1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sec-content<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
      <span class="token keyword">var</span> flexdiv <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'flexdiv'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      flexdiv<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'dragstart'</span><span class="token punctuation">,</span> dragdivHandle<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      flexdiv<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'drag'</span><span class="token punctuation">,</span> dragdivHandle<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      flexdiv<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'dragend'</span><span class="token punctuation">,</span> dragdivHandle<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">var</span> square1 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'square1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      square1<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'dragenter'</span><span class="token punctuation">,</span> squareEventHandle<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      square1<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'dragover'</span><span class="token punctuation">,</span> squareEventHandle<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      square1<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'dragleave'</span><span class="token punctuation">,</span> squareEventHandle<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      square1<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'drop'</span><span class="token punctuation">,</span> squareEventHandle<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">function</span> <span class="token function">dragdivHandle</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>type<span class="token punctuation">)</span>
        <span class="token keyword">switch</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">case</span> <span class="token string">'dragstart'</span><span class="token operator">:</span>
            <span class="token comment">// 针对拖动元素，设置event.effectAllowed</span>
            <span class="token comment">// event.dataTransfer.effectAllowed = 'copy'; // 这个设置与不设置貌似没什么作用</span>
            event<span class="token punctuation">.</span>dataTransfer<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token string">'Text'</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">function</span> <span class="token function">squareEventHandle</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>type<span class="token punctuation">)</span>
        <span class="token keyword">switch</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// case 'dragenter': // JS高程3里面p482内容: 如果想要让元素成为可放置区域，需要这里也阻止默认行为，但实际不用</span>
          <span class="token comment">//   event.preventDefault();</span>
          <span class="token comment">//   break;</span>
          <span class="token keyword">case</span> <span class="token string">'dragover'</span><span class="token operator">:</span>
            event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 取消默认操作，可以让元素成为可放置区域</span>
            <span class="token comment">// 针对放置目标，设置event.dropEffect</span>
            <span class="token comment">// event.dataTransfer.dropEffect = 'copy'; // 这个设置与不设置貌似没什么作用</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> <span class="token string">'drop'</span><span class="token operator">:</span> <span class="token comment">// 该操作是动作执行的核心</span>
            <span class="token comment">// 防止火狐下，每次拖拽都会打开新的标签页</span>
            event<span class="token punctuation">.</span><span class="token function">stopPropagation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//阻止冒泡</span>
            event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 阻止默认事件</span>

            <span class="token keyword">var</span> id <span class="token operator">=</span> event<span class="token punctuation">.</span>dataTransfer<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">'Text'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
            <span class="token comment">// 如果克隆了节点，不会删除源节点，如果通过getElementById获取对应的节点，会删除原来拖动的节点</span>
            <span class="token comment">// 如果是拖拽文件到该区域</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>dataTransfer<span class="token punctuation">.</span>files<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 得到files数组，里面都是File文件对象</span>
            square1<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cloneNode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="notifications-api"><a href="#notifications-api" class="header-anchor">#</a> Notifications API</h2> <p>Notifications API 可以用于向用户发送通知。它在 Service Worker 中非常有用。PWA（Progressive Web Application 渐进式 Web应用）通过触发通知可以在页面不活跃时向用户显示消息，看起来就像原生应用。</p> <p>通知权限需要用户授权，而且通知只能运行在安全上下文的代码中被触发，且必须按照每个源的原则，明确得到用户许可。可以使用下面的方法，触发用户授权</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  Notification<span class="token punctuation">.</span><span class="token function">requestPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">permission</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'用户响应通知授权请求'</span><span class="token punctuation">,</span> permission<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>第一次进入时，会有下面的弹窗提示。如果用户点击了运行，permission 的值为  <code>granted</code>，如果用户点击了禁止，返回 <code>denied</code></p> <p><img src="/images/js/notification_1.png" alt="notification_1.png"></p> <p>注意如果用户选择后，无法再通过代码的方式重新触发授权。只能手动设置浏览器，下图是 Chrome 浏览器设置的方法：点击页面 URL 前面的 <code>信息</code> 图标，会弹出一个下拉框。在通知那一栏，选择询问。再次调用上面的代码会重新触发通知授权。</p> <p><img src="/images/js/notification_2.png" alt="notification_2.png"></p> <p>授权成功后的页面，调用 new Notification(title [, options]) 会立即发送通知</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  Notification<span class="token punctuation">.</span><span class="token function">requestPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">permission</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'用户响应通知授权请求'</span><span class="token punctuation">,</span> permission<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>permission <span class="token operator">===</span> <span class="token string">'granted'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">new</span> <span class="token class-name">Notification</span><span class="token punctuation">(</span><span class="token string">'Title Text!'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        body<span class="token operator">:</span> <span class="token string">'Body Text'</span><span class="token punctuation">,</span>
        image<span class="token operator">:</span> <span class="token string">'notification_1.png'</span><span class="token punctuation">,</span> 
        vibrate<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">// 是否震动</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>效果如下图，默认 4-5 s 关闭，也可以通过 Notification 实例的 close() 方法手动关闭</p> <p><img src="/images/js/notification_3.png" alt="notification_3.png"></p> <p>通知不非只用于显示文本字符串，也可以用于交互，Notificaiton API 提供了 4 个用于添加回调的声明周期方法</p> <ul><li><code>onshow</code> 在通知显示时触发</li> <li><code>onclick</code> 在通知被点击是触发</li> <li><code>onclose</code> 在通知消失或通过 close() 关闭时触发</li> <li><code>onerror</code> 在发生错误阻止通知显示时触发</li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  Notification<span class="token punctuation">.</span><span class="token function">requestPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">permission</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'用户响应通知授权请求'</span><span class="token punctuation">,</span> permission<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>permission <span class="token operator">===</span> <span class="token string">'granted'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> n <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">Notification</span><span class="token punctuation">(</span><span class="token string">'Title Text!'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        body<span class="token operator">:</span> <span class="token string">'Body Text'</span><span class="token punctuation">,</span>
        image<span class="token operator">:</span> <span class="token string">'notification_1.png'</span><span class="token punctuation">,</span> 
        vibrate<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">// 是否震动</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">// 1s 后关闭通知</span>
      <span class="token comment">// setTimeout(() =&gt; n.close(), 1000)</span>
      n<span class="token punctuation">.</span><span class="token function-variable function">onshow</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'notification show'</span><span class="token punctuation">)</span>
      n<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'onclick'</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'notification onclick'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      n<span class="token punctuation">.</span><span class="token function-variable function">onclose</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'notification close'</span><span class="token punctuation">)</span>
      n<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'notification error'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="page-visibility-api-页面可见性api"><a href="#page-visibility-api-页面可见性api" class="header-anchor">#</a> Page Visibility API(页面可见性API)</h2> <p>如果页面最小化了或者隐藏在了其他标签页面后面，有些功能可以停下来，比如轮询服务器或某些动画效果。而 Page Visibility API 就是为了让开发人员知道页面是否对用户可见而推出的。</p> <ul><li><code>document.hidden</code> 页面是否隐藏</li> <li><code>document.visibilityState</code> IE10 和 Chrome 对应的状态值有较大差异 IE 值为 document.MS_PAGE_HIDDEN(0) document.MS_PAGE_VISIBLE(1)，chrome值为: hidden, visible, prerender(页面在屏外预渲染)</li> <li><code>visibilitychange 事件</code>，当文档从可见变为不可见或从不可见变为可见时，触发该事件</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 实现tab间切换时，隐藏页面title改变功能</span>
<span class="token keyword">var</span> title <span class="token operator">=</span> document<span class="token punctuation">.</span>title<span class="token punctuation">;</span>
document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'visibilitychange'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'--------------------'</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>hidden<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>visibilityState<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'--------------------'</span><span class="token punctuation">)</span>

  document<span class="token punctuation">.</span>title <span class="token operator">=</span>  document<span class="token punctuation">.</span>hidden <span class="token operator">?</span> <span class="token string">'~ 你快回来 ~ '</span> <span class="token operator">:</span> title
  <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>hidden<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 做一些暂停操作</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 开始操作</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="计时-api-performace性能"><a href="#计时-api-performace性能" class="header-anchor">#</a> 计时 API（Performace性能）</h2> <p>Web Timing API，核心是 window.performance 对象。可以全面的了解页面再被加载到浏览器的过程中都经历了哪些阶段，页面哪些阶段可能是影响性能的瓶颈。部分功能 IE10+ 支持，部分不支持 IE，更多兼容性参考：<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Performance" target="_blank" rel="noopener noreferrer">Performance | MDN<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>Performance 接口由多个 API 组成</p> <ul><li><strong>High Resolution Time API</strong>，高精确度的时间 API，performance.now()，微秒精度。</li> <li><strong>Performance Timeline API</strong>，性能条目（entry）时间轴 API，performace.getEntries()。按顺序记录页面加载过程中所有细节时间，包括导航时间、各资源加载时间(包括ajax请求)、渲染时间等，还可以自定义性能条目。</li> <li><strong>Navigation Timing API</strong>，导航计时API，根据 performance.getEntriesByType('navigation') 获取 PerformanceNavigationTiming 对象，描述页面是何时以及如何加载的。</li> <li><strong>User Timing API</strong>，用于自定义性能条目, performance.mark(), performance.measure()</li> <li><strong>Resource Timing API</strong>，资源加载时间</li> <li><strong>Paint Timing API</strong>, 渲染时间</li></ul> <h3 id="high-resolution-time-api"><a href="#high-resolution-time-api" class="header-anchor">#</a> High Resolution Time API</h3> <p>High Resolution Time API 定义了 performance.now() 方法，返回一个微秒精度的浮点数。用以解决 Date.now() 毫秒级精度的一些缺陷。</p> <ul><li><code>performance.now()</code> 采用相对时间，在页面打开或执行上下文创建时，从 0 开始计时。</li> <li><code>performance.timeOrigin</code> performance.now() 为 0 时，真实的时间戳</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 页面打开时间不到 1 秒时执行</span>
performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 920.7399999722838</span>
<span class="token comment">// 页面打开 5 秒后执行</span>
performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 5289.069999940693</span>

<span class="token keyword">let</span> relativeTime <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token comment">// performance.now() 为 0 时的真实时间</span>
performance<span class="token punctuation">.</span>timeOrigin <span class="token comment">// 1607430305179.698</span>
<span class="token keyword">let</span> realTime <span class="token operator">=</span> performance<span class="token punctuation">.</span>timeOrigin <span class="token operator">+</span> relativeTime
<span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>realTime<span class="token punctuation">)</span> <span class="token comment">// 当前时间</span>
</code></pre></div><h3 id="performance-timing-扩展"><a href="#performance-timing-扩展" class="header-anchor">#</a> performance.timing(扩展)</h3> <p>performance.timing 记录了开始导航到当前页面的时间、浏览器开始请求页面的时间、浏览器成功连接到服务器的时间等。PerformanceTiming 类型。下面是按照顺序对各个字段的解释：</p> <p><img src="/images/js/performance.png" alt="performance.png"></p> <ul><li><code>navigationStart: 1607492537332</code> 同一个浏览器上一个页面卸载结束时的时间戳。如果没有上一个页面的话，那么该值会和 fetchStart 的值相同。</li> <li><code>redirectStart: 0</code> 第一个 HTTP 重定向开始的时间戳。如果没有重定向，或者重定向到一个不同源的话，那么该值返回为 0。</li> <li><code>redirectEnd: 0</code> 最后一个 HTTP 重定向完成时的时间戳。如果没有重定向，或者重定向到一个不同的源，该值也返回为 0。</li> <li><code>fetchStart: 1607492537338</code> 浏览器准备好使用 http 请求的时间(发生在检查本地缓存之前)。</li> <li><code>domainLookupStart: 1607492537349</code> DNS 域名查询开始的时间，如果使用了本地缓存（即无 DNS 查询）或持久连接，则与 fetchStart 值相等</li> <li><code>domainLookupEnd: 1607492537403</code> DNS 域名查询结束的时间，如果使用了本地缓存（即无 DNS 查询）或持久连接，则与 fetchStart 值相等</li> <li><code>connectStart: 1607492537403</code> HTTP（TCP）开始/重新 建立连接的时间，如果是持久连接，则与 fetchStart 值相等。</li> <li><code>secureConnectionStart: 1607492537472</code> HTTPS 连接开始的时间，如果不是安全连接，则值为 0。</li> <li><code>connectEnd: 1607492537600</code> HTTP（TCP） 完成建立连接的时间（完成握手），如果是持久连接，则与 fetchStart 值相等。</li> <li><code>requestStart: 1607492537601</code> HTTP 请求读取真实文档开始的时间（完成建立连接），包括从本地读取缓存。</li> <li><code>responseStart: 1607492537841</code>  HTTP 开始接收响应的时间（获取到第一个字节），包括从本地读取缓存。</li> <li><code>responseEnd: 1607492537996</code> HTTP 响应全部接收完成的时间（获取到最后一个字节），包括从本地读取缓存。</li> <li><code>unloadEventStart: 0</code> 前一个网页（和当前页面同域）unload的时间戳，如果没有前一个网页或前一个网页是不同的域的话，那么该值为0.</li> <li><code>unloadEventEnd: 0</code> 前一个页面 unload 时间绑定的回掉函数执行完毕的时间戳。</li> <li><code>domLoading: 1607492537852</code> 开始解析渲染 DOM 树的时间，此时 Document.readyState 变为 loading，并将抛出 readystatechange 相关事件。</li> <li><code>domInteractive: 1607492538002</code>  完成解析 DOM 树的时间，Document.readyState 变为 interactive，并将抛出 readystatechange 相关事件，注意只是 DOM 树解析完成，这时候并没有开始加载网页内的资源。</li> <li><code>domContentLoadedEventStart: 1607492538002</code> DOM 解析完成后，网页内资源加载开始的时间，在 DOMContentLoaded 事件抛出前发生。</li> <li><code>domContentLoadedEventEnd: 1607492538002</code> DOM 解析完成后，网页内资源加载完成的时间（如 JS 脚本加载执行完毕）。</li> <li><code>domComplete: 1607492544648</code> DOM 树解析完成，且资源也准备就绪的时间，Document.readyState 变为 complete，并将抛出 readystatechange 相关事件。</li> <li><code>loadEventStart: 1607492544648</code> load 事件发送给文档，也即 load 回调函数开始执行的时间。如果没有绑定load事件，该值为0.</li> <li><code>loadEventEnd: 1607492544653</code> load 事件的回调函数执行完毕的时间。如果没有绑定load事件，该值为0.</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">getPerfermanceTiming</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> t <span class="token operator">=</span> performance<span class="token punctuation">.</span>timing

  <span class="token comment">// 重定向结束时间 - 重定向开始时间</span>
  <span class="token keyword">let</span> redirect <span class="token operator">=</span> t<span class="token punctuation">.</span>redirectEnd <span class="token operator">-</span> t<span class="token punctuation">.</span>redirectStart
  <span class="token comment">// DNS 查询开始时间 - fetech start 时间</span>
  <span class="token keyword">let</span> appCache <span class="token operator">=</span> t<span class="token punctuation">.</span>domainLookupStart <span class="token operator">-</span> t<span class="token punctuation">.</span>fetchStart
  <span class="token comment">// DNS 查询结束时间 - DNS 查询开始时间</span>
  <span class="token keyword">let</span> dns <span class="token operator">=</span> t<span class="token punctuation">.</span>domainLookupEnd <span class="token operator">-</span> t<span class="token punctuation">.</span>domainLookupStart
  <span class="token comment">// 完成 TCP 连接握手时间 - TCP 连接开始时间 </span>
  <span class="token keyword">let</span> tcp <span class="token operator">=</span> t<span class="token punctuation">.</span>connectEnd <span class="token operator">-</span> t<span class="token punctuation">.</span>connectStart
  <span class="token comment">// 从请求开始到接收到第一个响应字符的时间 </span>
  <span class="token keyword">let</span> ttfb <span class="token operator">=</span> t<span class="token punctuation">.</span>responseStart <span class="token operator">-</span> t<span class="token punctuation">.</span>requestStart
  <span class="token comment">// 资源下载时间，响应结束时间 - 响应开始时间</span>
  <span class="token keyword">let</span> contentDL <span class="token operator">=</span> t<span class="token punctuation">.</span>responseEnd <span class="token operator">-</span> t<span class="token punctuation">.</span>responseStart
  <span class="token comment">// 从请求开始到响应结束的时间</span>
  <span class="token keyword">let</span> httpTotal <span class="token operator">=</span> t<span class="token punctuation">.</span>responseEnd <span class="token operator">-</span> t<span class="token punctuation">.</span>requestStart
  <span class="token comment">// 从页面开始到 domContentLoadedEventEnd</span>
  <span class="token keyword">let</span> domContentloaded <span class="token operator">=</span> t<span class="token punctuation">.</span>domContentLoadedEventEnd <span class="token operator">-</span> t<span class="token punctuation">.</span>navigationStart
  <span class="token comment">// 从页面开始到 loadEventEnd</span>
  <span class="token keyword">let</span> loaded <span class="token operator">=</span> t<span class="token punctuation">.</span>loadEventEnd <span class="token operator">-</span> t<span class="token punctuation">.</span>navigationStart

  <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token string">&quot;Redirect&quot;</span><span class="token punctuation">,</span> desc<span class="token operator">:</span> <span class="token string">&quot;网页重定向的耗时&quot;</span><span class="token punctuation">,</span> value<span class="token operator">:</span> redirect <span class="token punctuation">}</span><span class="token punctuation">,</span> 
    <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token string">&quot;AppCache&quot;</span><span class="token punctuation">,</span> desc<span class="token operator">:</span> <span class="token string">&quot;检查本地缓存的耗时&quot;</span><span class="token punctuation">,</span> value<span class="token operator">:</span> appCache <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token string">&quot;DNS&quot;</span><span class="token punctuation">,</span> desc<span class="token operator">:</span> <span class="token string">&quot;DNS查询的耗时&quot;</span><span class="token punctuation">,</span> value<span class="token operator">:</span> dns <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token string">&quot;TCP&quot;</span><span class="token punctuation">,</span> desc<span class="token operator">:</span> <span class="token string">&quot;TCP连接的耗时&quot;</span><span class="token punctuation">,</span> value<span class="token operator">:</span> tcp <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token string">&quot;Waiting(TTFB)&quot;</span><span class="token punctuation">,</span> desc<span class="token operator">:</span> <span class="token string">&quot;从客户端发起请求到接收到响应的时间 / Time To First Byte&quot;</span><span class="token punctuation">,</span> value<span class="token operator">:</span> ttfb <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token string">&quot;Content Download&quot;</span><span class="token punctuation">,</span> desc<span class="token operator">:</span> <span class="token string">&quot;下载服务端返回数据的时间&quot;</span><span class="token punctuation">,</span> value<span class="token operator">:</span> contentDL <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token string">&quot;HTTP Total Time&quot;</span><span class="token punctuation">,</span> desc<span class="token operator">:</span> <span class="token string">&quot;http请求总耗时&quot;</span><span class="token punctuation">,</span> value<span class="token operator">:</span> httpTotal <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token string">&quot;DOMContentLoaded&quot;</span><span class="token punctuation">,</span> desc<span class="token operator">:</span> <span class="token string">&quot;dom加载完成的时间&quot;</span><span class="token punctuation">,</span> value<span class="token operator">:</span> domContentloaded <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token string">&quot;Loaded&quot;</span><span class="token punctuation">,</span> desc<span class="token operator">:</span> <span class="token string">&quot;页面load的总耗时&quot;</span><span class="token punctuation">,</span> value<span class="token operator">:</span> loaded <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
  <span class="token keyword">return</span> result
<span class="token punctuation">}</span>
<span class="token function">getPerfermanceTiming</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>参考:</p> <ul><li><a href="https://blog.csdn.net/z9061/article/details/101454438" target="_blank" rel="noopener noreferrer">Web 性能优化-首屏和白屏时间<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.jianshu.com/p/1355232d525a" target="_blank" rel="noopener noreferrer">Performance --- 前端性能监控<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h3 id="performance-navigation-扩展"><a href="#performance-navigation-扩展" class="header-anchor">#</a> performance.navigation(扩展)</h3> <p>performance.navigation 记录了页面加载器重定向的次数，导航类型(页面第一次加载，页面重载过等状态)</p> <ul><li><code>redirectCount: 0</code> 页面经过了多少次重定向</li> <li><code>type: 0</code> <ul><li>0 表示正常进入页面；&quot;navigate&quot;</li> <li>1 表示通过 window.location.reload() 刷新页面；&quot;reload&quot;</li> <li>2 表示通过浏览器前进后退进入页面；&quot;back_forward&quot;</li> <li>255 表示其它方式 &quot;TYPE_RESERVED&quot;</li></ul></li></ul> <h3 id="performance-memory-扩展"><a href="#performance-memory-扩展" class="header-anchor">#</a> performance.memory(扩展)</h3> <p>MemoryInfo 记录了当前页面的内存信息</p> <ul><li><code>jsHeapSizeLimit: 4294,705,152</code> 内存大小限制，以字节计算。4G 电脑本身内存是 16G</li> <li><code>totalJSHeapSize: 30,257,998</code> 可使用的内存，已分配的堆体积，示例中是 30M 左右，每个页面不一样，动态值</li> <li><code>usedJSHeapSize: 25,172,926</code> JS 对象占用的内存，示例中是 25M 左右，每个页面不一样，动态值</li></ul> <h3 id="performance-eventcounts-扩展"><a href="#performance-eventcounts-扩展" class="header-anchor">#</a> performance.eventCounts(扩展)</h3> <p>EventCounts 用于统计页面事件触发次数。每个页面都是 36 个事件，可以使用 performance.eventCounts.get('事件名称') 获取对应事件在页面中触发的次数。比如发生一次点击后，改之就会加 1。可以使用 forEach，entries 等遍历</p> <div class="language-js extra-class"><pre class="language-js"><code>performance<span class="token punctuation">.</span>eventCounts <span class="token comment">// EventCounts {size: 36}</span>
<span class="token punctuation">[</span><span class="token operator">...</span>performance<span class="token punctuation">.</span>eventCounts<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token comment">// [</span>
<span class="token comment">//   // ...</span>
<span class="token comment">//   [&quot;click&quot;, 1]</span>
<span class="token comment">//   [&quot;pointercancel&quot;, 0]</span>
<span class="token comment">//   [&quot;dragover&quot;, 0]</span>
<span class="token comment">//   [&quot;dragend&quot;, 0]</span>
<span class="token comment">//   [&quot;beforeinput&quot;, 0]</span>
<span class="token comment">//   [&quot;touchend&quot;, 0]</span>
<span class="token comment">//   [&quot;compositionend&quot;, 0]</span>
<span class="token comment">//   [&quot;mouseleave&quot;, 0]</span>
<span class="token comment">//   [&quot;input&quot;, 0]</span>
<span class="token comment">// ]</span>
Object<span class="token punctuation">.</span><span class="token function">fromEntries</span><span class="token punctuation">(</span>performance<span class="token punctuation">.</span>eventCounts<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// {</span>
<span class="token comment">//   // ....</span>
<span class="token comment">//   auxclick: 0</span>
<span class="token comment">//   beforeinput: 0</span>
<span class="token comment">//   click: 4</span>
<span class="token comment">//   compositionend: 0</span>
<span class="token comment">//   compositionstart: 0</span>
<span class="token comment">//   compositionupdate: 0</span>
<span class="token comment">//   contextmenu: 0</span>
<span class="token comment">//   dblclick: 0</span>
<span class="token comment">// }</span>
</code></pre></div><h3 id="performance-timeline-api"><a href="#performance-timeline-api" class="header-anchor">#</a> Performance Timeline API</h3> <p>性能时间轴 API，记录页面打开过程中，各个性能条目 (entry，如导航、资源加载、绘制等) 的耗时。使用 <code>performance.getEntries()</code> 可以获取所有性能条目信息数组。数组中的每一个元素代表一个性能条目，他们都是 PerformanceEntry 的子类，比如</p> <ul><li>PerformanceNavigationTiming 导航时间对象，entryType: &quot;navigation&quot;</li> <li>PerformanceResourceTiming 某个资源加载时间对象，entryType: &quot;resource&quot;。发起者类型(资源类型)initiatorType: &quot;script&quot;，还可能是：&quot;xmlhttprequest&quot;、&quot;css&quot;、&quot;img&quot;、&quot;other&quot;</li> <li>PerformancePaintTiming 绘制时间对象 entryType: &quot;paint&quot;</li></ul> <p>除了系统自带的这些性能条目外，还支持用户自定义性能条目</p> <ul><li>PerformanceMark，用户自定义性能条目, entryType: &quot;mark&quot;</li> <li>PerformanceMeasure，性能度量条目, entryType: &quot;measure&quot;</li></ul> <p>可以使用  <code>performance.getEntriesByType(entryType)</code> 获取指定类型的性能条目，它返回一个数组</p> <div class="language-js extra-class"><pre class="language-js"><code>performance<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// [ </span>
<span class="token comment">//   PerformanceNavigationTiming, </span>
<span class="token comment">//   PerformanceResourceTiming, </span>
<span class="token comment">//   ..., </span>
<span class="token comment">//   PerformancePaintTiming, </span>
<span class="token comment">//   ...</span>
<span class="token comment">// ]</span>
</code></pre></div><h3 id="performancenavigationtiming"><a href="#performancenavigationtiming" class="header-anchor">#</a> PerformanceNavigationTiming</h3> <p>一般 performance.getEntries() 的第一个元素就是 PerformanceNavigationTiming，浏览器会在导航事件发生时自动记录该性能条目。 duration = loadEventEnd - startTime</p> <div class="language-js extra-class"><pre class="language-js"><code>performance<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment">// 或 performance.getEntriesByType('navigation')[0]</span>
<span class="token comment">// PerformanceNavigationTiming</span>
<span class="token punctuation">{</span>
  connectEnd<span class="token operator">:</span> <span class="token number">2.0849999273195863</span>
  connectStart<span class="token operator">:</span> <span class="token number">2.0849999273195863</span>
  decodedBodySize<span class="token operator">:</span> <span class="token number">816</span>
  <span class="token comment">// domComplete: 9127.099999925122</span>
  <span class="token comment">// domContentLoadedEventEnd: 8586.609999998473 </span>
  <span class="token comment">// domContentLoadedEventStart: 8586.6049999604</span>
  <span class="token comment">// domInteractive: 8586.544999969192</span>
  domainLookupEnd<span class="token operator">:</span> <span class="token number">2.0849999273195863</span>
  domainLookupStart<span class="token operator">:</span> <span class="token number">2.0849999273195863</span>
  duration<span class="token operator">:</span> <span class="token number">9127.134999958798</span> <span class="token comment">// PerformanceNavigationTiming.loadEventEnd - PerformanceEntry.startTime</span>
  encodedBodySize<span class="token operator">:</span> <span class="token number">816</span>
  entryType<span class="token operator">:</span> <span class="token string">&quot;navigation&quot;</span> <span class="token comment">// 条目类型</span>
  fetchStart<span class="token operator">:</span> <span class="token number">2.0849999273195863</span> 
  initiatorType<span class="token operator">:</span> <span class="token string">&quot;navigation&quot;</span> <span class="token comment">// 发起者类型</span>
  <span class="token comment">// loadEventEnd: 9127.134999958798   // load事件的回调函数执行完毕的时间，如果没有绑定load事件，该值为0.</span>
  <span class="token comment">// loadEventStart: 9127.124999999069 // load事件发送给文档。也即load回调函数开始执行的时间，如果没有绑定load事件，则该值为0.</span>
  name<span class="token operator">:</span> <span class="token string">&quot;http://127.0.0.1:8080/js/ad3/js-ad3-20.html#high-resolution-time-api&quot;</span> <span class="token comment">// document's address.</span>
  nextHopProtocol<span class="token operator">:</span> <span class="token string">&quot;http/1.1&quot;</span>
  redirectCount<span class="token operator">:</span> <span class="token number">0</span> <span class="token comment">// 如果有重定向的话，页面通过几次重定向跳转而来，默认为0；</span>
  redirectEnd<span class="token operator">:</span> <span class="token number">0</span>  <span class="token comment">// </span>
  redirectStart<span class="token operator">:</span> <span class="token number">0</span> <span class="token comment">// 该值的含义是第一个http重定向开始的时间戳，如果没有重定向，或者重定向到一个不同源的话，那么该值返回为0.</span>
  requestStart<span class="token operator">:</span> <span class="token number">10.624999995343387</span>
  responseEnd<span class="token operator">:</span> <span class="token number">8198.495000018738</span> 
  responseStart<span class="token operator">:</span> <span class="token number">8198.014999972656</span>
  secureConnectionStart<span class="token operator">:</span> <span class="token number">0</span>
  serverTiming<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  startTime<span class="token operator">:</span> <span class="token number">0</span> <span class="token comment">// Returns a DOMHighResTimeStamp with a value of &quot;0&quot;.</span>
  transferSize<span class="token operator">:</span> <span class="token number">1100</span>
  type<span class="token operator">:</span> <span class="token string">&quot;reload&quot;</span><span class="token punctuation">,</span> <span class="token comment">// navigation type. Must be: 0: &quot;navigate&quot;（表示正常进入该页面(非刷新、非重定向)）, 1: &quot;reload&quot;(表示通过 window.location.reload 刷新的页面。如果我现在刷新下页面后，再来看该值就变成1了), 2: &quot;back_forward&quot;（表示通过浏览器的前进、后退按钮进入的页面。如果我此时先前进下页面，再后退返回到该页面后，查看打印的值，发现变成2了） or &quot;prerender&quot; (其他).</span>
  <span class="token comment">// unloadEventEnd: 8201.974999974482</span>
  <span class="token comment">// unloadEventStart: 8201.824999996461</span>
  workerStart<span class="token operator">:</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="performanceresourcetiming"><a href="#performanceresourcetiming" class="header-anchor">#</a> PerformanceResourceTiming</h3> <p>计算某个资源的加载时间 duration =  responseEnd - startTime</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// performance.getEntriesByType('resource')[0]</span>
connectEnd<span class="token operator">:</span> <span class="token number">12499.234999995679</span>
connectStart<span class="token operator">:</span> <span class="token number">12499.234999995679</span>
decodedBodySize<span class="token operator">:</span> <span class="token number">4575838</span>
domainLookupEnd<span class="token operator">:</span> <span class="token number">12499.234999995679</span>
domainLookupStart<span class="token operator">:</span> <span class="token number">12499.234999995679</span>
duration<span class="token operator">:</span> <span class="token number">134.51500004157424</span> <span class="token comment">// responseEnd - startTime</span>
encodedBodySize<span class="token operator">:</span> <span class="token number">975116</span>
entryType<span class="token operator">:</span> <span class="token string">&quot;resource&quot;</span>
fetchStart<span class="token operator">:</span> <span class="token number">12499.234999995679</span>
initiatorType<span class="token operator">:</span> <span class="token string">&quot;script&quot;</span>
name<span class="token operator">:</span> <span class="token string">&quot;http://127.0.0.1:8080/assets/js/app.js&quot;</span>
nextHopProtocol<span class="token operator">:</span> <span class="token string">&quot;http/1.1&quot;</span>
redirectEnd<span class="token operator">:</span> <span class="token number">0</span>
redirectStart<span class="token operator">:</span> <span class="token number">0</span>
requestStart<span class="token operator">:</span> <span class="token number">12504.305000067689</span>
responseEnd<span class="token operator">:</span> <span class="token number">12633.750000037253</span>
responseStart<span class="token operator">:</span> <span class="token number">12512.550000101328</span>
secureConnectionStart<span class="token operator">:</span> <span class="token number">0</span>
serverTiming<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
startTime<span class="token operator">:</span> <span class="token number">12499.234999995679</span>
transferSize<span class="token operator">:</span> <span class="token number">975939</span>
workerStart<span class="token operator">:</span> <span class="token number">0</span>
</code></pre></div><h3 id="user-timing-api-自定义"><a href="#user-timing-api-自定义" class="header-anchor">#</a> User Timing API 自定义</h3> <p>performance.mark('foo') 可以在 performance.getEntries() 中新增一条自定义性能条目，可以用于自定义性能分析。</p> <div class="language-js extra-class"><pre class="language-js"><code>performance<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span> 
<span class="token comment">// PerformanceMark {</span>
<span class="token comment">//   detail: null, </span>
<span class="token comment">//   name: &quot;foo&quot;, </span>
<span class="token comment">//   entryType: &quot;mark&quot;, </span>
<span class="token comment">//   startTime: 39518.05999991484, </span>
<span class="token comment">//   duration: 0</span>
<span class="token comment">// }</span>
</code></pre></div><p>利用两个 mark 性能条目可以计算时间差</p> <div class="language-js extra-class"><pre class="language-js"><code>performance<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span> 
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1E6</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
performance<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">)</span> 
<span class="token keyword">let</span> <span class="token punctuation">[</span>startMark<span class="token punctuation">,</span> endMark<span class="token punctuation">]</span> <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">getEntriesByType</span><span class="token punctuation">(</span><span class="token string">'mark'</span><span class="token punctuation">)</span>
endMark<span class="token punctuation">.</span>startTime <span class="token operator">-</span> startMark<span class="token punctuation">.</span>startTime <span class="token comment">// 4.205000004731119</span>
</code></pre></div><p>performance.measure() 可以生成一个新的性能条目，度量(计算) 两个 mark 之间的持续时间（duration）</p> <div class="language-js extra-class"><pre class="language-js"><code>performance<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span> 
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1E6</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
performance<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">)</span> 
performance<span class="token punctuation">.</span><span class="token function">measure</span><span class="token punctuation">(</span><span class="token string">'newVal'</span><span class="token punctuation">,</span> <span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">)</span> 
<span class="token comment">// PerformanceMeasure {</span>
<span class="token comment">//   detail: null</span>
<span class="token comment">//   duration: 4.055000026710331</span>
<span class="token comment">//   entryType: &quot;measure&quot;</span>
<span class="token comment">//   name: &quot;newVal&quot;</span>
<span class="token comment">//   startTime: 2636.534999939613</span>
<span class="token comment">// }</span>
</code></pre></div><h2 id="web-组件-web-components"><a href="#web-组件-web-components" class="header-anchor">#</a> Web 组件（Web Components）</h2> <p>这里所说的 Web Components 是一套用于增强 DOM 行为的功能，包括 <strong>影子 DOM（shadow DOM）</strong>、<strong>自定义元素</strong> 和 <strong>HTML 模板(template 元素)</strong>，这一套浏览器 API 比较混乱：</p> <ul><li>并没有统一的 &quot;Web Components&quot; 规范，每个 Web Components 都在不同的规范中定义</li> <li>有些 Web Components 如影子 DOM 和自定义元素，已经出现了向后不兼容的版本问题</li> <li>浏览器实现极其不一致</li></ul> <p>由于存在上面的问题，一般使用 Web Components 时通常需要引入一个 Web 组件库，比如 Polymer，它可以模拟浏览器中缺失的 Web Components</p> <h3 id="html-模板-template-元素"><a href="#html-模板-template-元素" class="header-anchor">#</a> HTML 模板(template 元素)</h3> <p>在 Web Components 之前，一直缺少基于 HTML 解析构建 DOM 子树，然后在需要时把该子树渲染出来的机制。有两种替代的方法：</p> <ul><li>使用 innerHTML 把标记字符串转为 DOM 元素，但它存在严重的安全隐患。</li> <li>使用 document.createElement 创建元素并拼接，这样非常麻烦</li></ul> <p>HTML 模板 template 元素就是为了解决这个问题而出现的，可以提前在页面中写出 template 内容，浏览器自动将其解析为 DOM 子树，但跳过渲染。等需要时，再渲染。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>foo<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>模板内部p元素<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>  
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>上面的例子中，使用 template 元素写了一个简单的模板，它的内容不属于活动的文档，内容不会渲染到页面上。使用 document.querySelector() 等 DOM 查询方法不会找到 p 元素，p 元素仅包含在 template 中的 DocumentFragment 内，审查元素时会看到下面的效果。可以通过 template 元素的 content 获取 DocumentFragment 节点的引用</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>foo<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  #document-fragment
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>模板内部p元素<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>  
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">const</span> fragment <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#foo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>content 
  <span class="token comment">// #document-fragment</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;p&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// null</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> fragment<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;p&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// &lt;p&gt;...&lt;/p&gt;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>可以将 template 元素的内容，动态添加到 dom 中，仅一次重排。这就是 DocumentFragment 的优点</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>foo<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bar<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>a<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>b<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>c<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token comment">// 将 template 元素的内容转移到 foo 元素内</span>
  <span class="token keyword">const</span> barTemplate <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#bar'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> fragment <span class="token operator">=</span> barTemplate<span class="token punctuation">.</span>content
  <span class="token keyword">const</span> fooElement <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#foo'</span><span class="token punctuation">)</span>
  <span class="token comment">// appendChild 会移动元素，之前的元素所在的位置会删除</span>
  fooElement<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span>
  <span class="token comment">// 如果需要保留原元素，需要在 appendChild 时创建一个节点的副本</span>
  <span class="token comment">// fooElement.appendChild(document.importNode(fragment, true))</span>
  <span class="token comment">// fooElement.appendChild(fragment.cloneNode(true))</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>barTemplate<span class="token punctuation">.</span>content<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token comment">// HTMLCollection []</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>模板内也可以使用 script 脚本，最开始不会执行，等 template 内容添加到真实的 DOM 树中时才会执行</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>foo<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bar<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'template script execute'</span><span class="token punctuation">)</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">let</span> fragment <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#bar'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>content
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span>
  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#foo'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">)</span>
  <span class="token comment">// a</span>
  <span class="token comment">// template script execute</span>
  <span class="token comment">// b</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="影子dom-shadow-dom"><a href="#影子dom-shadow-dom" class="header-anchor">#</a> 影子DOM(shadow DOM)</h3> <p>shadow DOM 是什么？HTML 元素调用 attachShadow() 方法，可以给自己添加一个影子DOM。该影子 dom 是一个独立的 DOM 子树，内部的 style 只会在该 影子 DOM 中有效，不干扰全局。默认情况下，影子 DOM 的内容会覆盖原 HTML 元素的内容。</p> <p>注意：并不是所有的元素都可以添加影子 DOM，可以创建影子 DOM 的元素有 自定义元素、div、span、atricle、body 等，参见 p652</p> <p>下面的例子中，为 foo 和 bar 元素添加影子 DOM 后，原内容 a、b 会被影子 DOM 覆盖，默认显示为空白，因为还没有向影子 DOM 添加任何内容。其中</p> <ul><li>foo、bar 容纳影子 DOM 的元素被称为 <strong>影子宿主（shadow host）</strong></li> <li>影子 DOM 的根节点被称为 <strong>影子根（shadow root）</strong></li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>foo<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>a<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bar<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>b<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">const</span> foo <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#foo'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> bar <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#bar&quot;</span><span class="token punctuation">)</span>
  <span class="token comment">// 在 foo, bar 上创建影子 DOM，返回影子 dom 实例</span>
  <span class="token keyword">const</span> fooShadowDom <span class="token operator">=</span> foo<span class="token punctuation">.</span><span class="token function">attachShadow</span><span class="token punctuation">(</span><span class="token punctuation">{</span> mode<span class="token operator">:</span> <span class="token string">&quot;open&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> barShadowDom <span class="token operator">=</span> bar<span class="token punctuation">.</span><span class="token function">attachShadow</span><span class="token punctuation">(</span><span class="token punctuation">{</span> mode<span class="token operator">:</span> <span class="token string">&quot;closed&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fooShadowDom<span class="token punctuation">)</span>   <span class="token comment">// #shadow-root（open）</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>barShadowDom<span class="token punctuation">)</span>   <span class="token comment">// #shadow-root（closed）</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo<span class="token punctuation">.</span>shadowRoot<span class="token punctuation">)</span> <span class="token comment">// #shadow-root（open）</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>bar<span class="token punctuation">.</span>shadowRoot<span class="token punctuation">)</span> <span class="token comment">// null</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><img src="/images/js/shadowDom_1.png" alt="shadowDom_1.png"></p> <p>为元素添加影子 DOM 后，我们可以像常规 DOM 一样使用影子 DOM，来看下面的例子</p> <div class="language-js extra-class"><pre class="language-js"><code>fooShadowDom<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  &lt;p&gt;颜色：red&lt;/p&gt;
  &lt;style&gt;p { color: red; }&lt;/style&gt;
</span><span class="token template-punctuation string">`</span></span>
barShadowDom<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  &lt;p&gt;颜色：green&lt;/p&gt;
  &lt;style&gt;p { color: green; }&lt;/style&gt;
</span><span class="token template-punctuation string">`</span></span>
document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">)</span> <span class="token comment">// 无法获取影子 dom 中的 p元素</span>
<span class="token comment">// NodeList [] </span>
document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shadowRoot
<span class="token comment">// #shadow-root (open)</span>
<span class="token comment">// &lt;p&gt;​颜色：red​&lt;/p&gt;</span>
<span class="token comment">// ​&lt;style&gt;​p { color: red; }​&lt;/style&gt;​</span>
</code></pre></div><p>效果如下</p> <p><img src="/images/js/shadowDom_2.png" alt="shadowDom_2.png"></p> <p>可以使用 appendChild() 向影子 DOM 中动态的添加元素，前面的例子中我们知道影子 DOM 会覆盖原元素的内容。如果我们想要在影子 DOM 中显示该内容，可以使用 slot 插槽元素来显示</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>foo<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>我是被隐藏的内容，在影子 DOM 中可以使用 slot 插槽来显示<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">const</span> foo <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#foo'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> fooShadowDom <span class="token operator">=</span> foo<span class="token punctuation">.</span><span class="token function">attachShadow</span><span class="token punctuation">(</span><span class="token punctuation">{</span> mode<span class="token operator">:</span> <span class="token string">&quot;open&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 仅显示 abc</span>
  <span class="token comment">// fooShadowDom.innerHTML = `</span>
  <span class="token comment">//   &lt;div id=&quot;bar&quot;&gt;</span>
  <span class="token comment">//     abc</span>
  <span class="token comment">//   &lt;/div&gt;</span>
  <span class="token comment">// `</span>
  <span class="token comment">// 显示 abc，以及原元素中的内容</span>
  fooShadowDom<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;div id=&quot;bar&quot;&gt;
      abc
      &lt;slot&gt;&lt;/slot&gt;
    &lt;/div&gt;
  </span><span class="token template-punctuation string">`</span></span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>上面使用的是匿名插槽，如果有多个插槽内容，可以使用命名插槽（named slot），类似 Vue 中的具名插槽</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>foo<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">slot</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>a<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>我是a内容<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">slot</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>b<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>我是b内容<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#foo'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">attachShadow</span><span class="token punctuation">(</span><span class="token punctuation">{</span> mode<span class="token operator">:</span> <span class="token string">&quot;open&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      内容b:
      &lt;slot name=&quot;b&quot;&gt;&lt;/slot&gt;
      内容a: 
      &lt;slot name=&quot;a&quot;&gt;&lt;/slot&gt;
    </span><span class="token template-punctuation string">`</span></span>
  <span class="token comment">// 内容b:</span>
  <span class="token comment">// 我是b内容</span>
  <span class="token comment">// 内容a:</span>
  <span class="token comment">// 我是a内容</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>影子 DOM 中的事件，如果影子 DOM 中发生了浏览器事件比如 click，事件会逃出影子 DOM 并经过事件重定向(event target)在外部被处理。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>console.log(<span class="token punctuation">'</span>在外部处理<span class="token punctuation">'</span>, event.target)<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">attachShadow</span><span class="token punctuation">(</span><span class="token punctuation">{</span>mode<span class="token operator">:</span> <span class="token string">'open'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      &lt;button onclick=&quot;console.log('在内部处理', event.target)&quot;&gt;Foo&lt;/button&gt;
    </span><span class="token template-punctuation string">`</span></span>
  <span class="token comment">// 在内部处理 &lt;button onclick=​&quot;console.log('在内部处理', event.target)​&quot;&gt;​Foo​&lt;/button&gt;​</span>
  <span class="token comment">// 在外部处理 &lt;div onclick=​&quot;console.log('在外部处理', event.target)​&quot;&gt;​…​&lt;/div&gt;​</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="自定义元素"><a href="#自定义元素" class="header-anchor">#</a> 自定义元素</h3> <p>类似子框架中的自定义组件，比如 <code>&lt;my-button /&gt;</code>，创建自定义元素有两种方法：</p> <ul><li>直接在 html 中写自定义元素，比如 <code>&lt;x-foo&gt;我是自定义元素&lt;/x-foo&gt;</code></li> <li>使用 <code>customeElements.define(tagName, HTMLElementSubClass[, options])</code> 创建自定义元素</li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x-foo</span><span class="token punctuation">&gt;</span></span>我是自定义元素<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x-foo</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">let</span> xfooElement <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'x-foo'</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xfooElement <span class="token keyword">instanceof</span> <span class="token class-name">HTMLElement</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>使用 JS 创建自定义元素，下面的例子中，console 中会打印 3 个 hello，页面上 body 中会包含 3 个自定义元素</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>1212<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">class</span> <span class="token class-name">FooElement</span> <span class="token keyword">extends</span> <span class="token class-name">HTMLElement</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  customElements<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'x-foo'</span><span class="token punctuation">,</span> FooElement<span class="token punctuation">)</span><span class="token punctuation">;</span>

  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;x-foo&gt;a&lt;/x-foo&gt;
    &lt;x-foo&gt;b&lt;/x-foo&gt;
    &lt;x-foo&gt;c&lt;/x-foo&gt;
  </span><span class="token template-punctuation string">`</span></span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>可以使用 customElements.define() 方法的第三个参数，可以标签(元素)指定为自定义元素的实例。注意自定义 FooElement 继承自 HTMLDivElement</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>1212<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">class</span> <span class="token class-name">FooElement</span> <span class="token keyword">extends</span> <span class="token class-name">HTMLDivElement</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  customElements<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'x-foo'</span><span class="token punctuation">,</span> FooElement<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">extends</span><span class="token operator">:</span> <span class="token string">'div'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;div is=&quot;x-foo&quot;&gt;a&lt;/div&gt;
    &lt;div is=&quot;x-foo&quot;&gt;b&lt;/div&gt;
    &lt;div is=&quot;x-foo&quot;&gt;c&lt;/div&gt;
  </span><span class="token template-punctuation string">`</span></span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--
hello
hello
hello 
--&gt;</span>
</code></pre></div><p>可以结合影子 DOM 向自定义元素添加内容</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>123<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">class</span> <span class="token class-name">FooElement</span> <span class="token keyword">extends</span> <span class="token class-name">HTMLElement</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">attachShadow</span><span class="token punctuation">(</span><span class="token punctuation">{</span> mode<span class="token operator">:</span> <span class="token string">'open'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>shadowRoot<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
        &lt;p&gt;我是自定义组件的内容&lt;/p&gt;
        &lt;slot&gt;&lt;/slot&gt;
      </span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  customElements<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'x-foo'</span><span class="token punctuation">,</span> FooElement<span class="token punctuation">)</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;x-foo&gt;
      &lt;div&gt;我是插槽内容&lt;/div&gt;
    &lt;/x-foo&gt;
  </span><span class="token template-punctuation string">`</span></span>
  <span class="token comment">// 我是自定义组件的内容</span>
  <span class="token comment">// 我是插槽内容</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>可以使用 template 重构上面的例子</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>123<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-foo-tpl<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>我是自定义组件的内容<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>slot</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>slot</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
    <span class="token selector">p</span> <span class="token punctuation">{</span> <span class="token property">color</span><span class="token punctuation">:</span> red <span class="token punctuation">}</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">const</span> template <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#x-foo-tpl'</span><span class="token punctuation">)</span>
  <span class="token keyword">class</span> <span class="token class-name">FooElement</span> <span class="token keyword">extends</span> <span class="token class-name">HTMLElement</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">attachShadow</span><span class="token punctuation">(</span><span class="token punctuation">{</span> mode<span class="token operator">:</span> <span class="token string">'open'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>shadowRoot<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>template<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">cloneNode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  customElements<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'x-foo'</span><span class="token punctuation">,</span> FooElement<span class="token punctuation">)</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;x-foo&gt;
      &lt;p&gt;我是插槽内容&lt;/p&gt;
    &lt;/x-foo&gt;
  </span><span class="token template-punctuation string">`</span></span>
  <span class="token comment">// 123</span>
  <span class="token comment">// 我是自定义组件的内容 // 红色</span>
  <span class="token comment">// 我是插槽内容 // 黑色 slot 内的内容不受影子 dom 内部样式影响</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>自定义元素有 5 个生命周期方法</p> <ul><li>constructor() 在创建元素实例或将已有 DOM 元素升级为自定义元素时调用。</li> <li>connectedCallback() 在每次将这个自定义元素实例添加到 DOM 中时调用。</li> <li>disconnectedCallback() 在每次将这个自定义元素实例从 DOM 中移除时调用。</li> <li>attributeChangeCallback() 自定义元素<strong>可观察属性</strong> 的值发生变化时调用。在初始化值时，也算一次变化。</li> <li>adoptedCallback() 在通过 document.adoptNode() 将这个自定义元素移动到新文档对象时调用。</li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>123<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">class</span> <span class="token class-name">FooElement</span> <span class="token keyword">extends</span> <span class="token class-name">HTMLElement</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'constructor'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">connectedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'connected'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">disconnectedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'disconnected'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  customElements<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'x-foo'</span><span class="token punctuation">,</span> FooElement<span class="token punctuation">)</span>
  <span class="token keyword">const</span> fooElement <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'x-foo'</span><span class="token punctuation">)</span>
  <span class="token comment">// constructor</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>fooElement<span class="token punctuation">)</span>
  <span class="token comment">// connected</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>fooElement<span class="token punctuation">)</span>
  <span class="token comment">// disconnected</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

</code></pre></div><p>observedAttributes() 方法可以定义改变时触发 attributeChangedCallback() 的属性名。下面是一个例子</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>123<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">class</span> <span class="token class-name">FooElement</span> <span class="token keyword">extends</span> <span class="token class-name">HTMLElement</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">set</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 可观察属性 bar</span>
    <span class="token keyword">static</span> <span class="token keyword">get</span> <span class="token function">observedAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token string">'bar'</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token function">attributeChangedCallback</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> oldValue<span class="token punctuation">,</span> newValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldValue <span class="token operator">!==</span> newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">oldValue: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>oldValue<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> =&gt; newValue: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>newValue<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> newValue
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  customElements<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'x-foo'</span><span class="token punctuation">,</span> FooElement<span class="token punctuation">)</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;x-foo bar=&quot;false&quot;&gt;abc&lt;/x-foo&gt;</span><span class="token template-punctuation string">`</span></span>
  <span class="token comment">// oldValue: null =&gt; newValue: false</span>
  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'x-foo'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">,</span> <span class="token string">'true'</span><span class="token punctuation">)</span>
  <span class="token comment">// oldValue: false =&gt; newValue: true</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>自定义元素 customElements 除了 define() 外，还有另外几个函数</p> <ul><li><code>customElements.whenDefined(tagName)</code> 返回 promise，当定义后触发 resolve 函数</li> <li><code>customElements.get(tagName)</code> 返回该自定义元素对应的构造函数（类 class）</li> <li><code>customElements.upgrade(customElement)</code> 强制升级自定义元素</li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  customElements<span class="token punctuation">.</span><span class="token function">whenDefined</span><span class="token punctuation">(</span><span class="token string">'x-foo'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'defined'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>customElements<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'x-foo'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// undefined</span>
  customElements<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'x-foo'</span><span class="token punctuation">,</span> <span class="token keyword">class</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// defined!</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>customElements<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'x-foo'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// class {}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>当自定义元素没有创建时，也可以先创建该自定义元素，后面再使用  customElements.upgrade() 强制升级。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token comment">// 在自定义元素没有定义之前会创建 hTMLUnkownElement 对象</span>
  <span class="token keyword">const</span> fooElement <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'x-foo'</span><span class="token punctuation">)</span>
  
  <span class="token comment">// 创建自定义元素</span>
  <span class="token keyword">class</span> <span class="token class-name">FooElement</span> <span class="token keyword">extends</span> <span class="token class-name">HTMLElement</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  customElements<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'x-foo'</span><span class="token punctuation">,</span> FooElement<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fooElement <span class="token keyword">instanceof</span> <span class="token class-name">FooElement</span><span class="token punctuation">)</span> <span class="token comment">// false</span>
  <span class="token comment">// 强制升级</span>
  customElements<span class="token punctuation">.</span><span class="token function">upgrade</span><span class="token punctuation">(</span>fooElement<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fooElement <span class="token keyword">instanceof</span> <span class="token class-name">FooElement</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="web-cryptography-api"><a href="#web-cryptography-api" class="header-anchor">#</a> Web Cryptography API</h2> <p>Web Cryptography API 描述了一套密码学工具，规范了 JS 如果以安全和符合惯例的方式实现加密。包括生成、使用加密秘钥对，加密、解密信息以及生成可靠的随机数。</p> <h3 id="生成随机数"><a href="#生成随机数" class="header-anchor">#</a> 生成随机数</h3> <p>一般我们生成随机数首先想到的是 Math.random()，这个方法在浏览器中是以 <strong>伪随机数生成器（PRNG, PseudoRandom Number Generator）</strong> 方式实现的。pseudo- <code>[ˈsuːdəʊ]</code> 假的。伪随机指的是只是模拟了随机的特性，并未使用真正的随机源。如果使用 PRNG 生成的私有秘钥用于加密，攻击者可以利用它的缺点推算出私有秘钥。详情参见 p663</p> <p>伪随机数生成器主要用于快速计算出看起来随机的值，并不适合用于加密计算。为了解决这个问题，引入了 <strong>CSPRNG（密码学安全伪随机数，Cryptographically Secure PseudoRandom Number Generator）</strong> 额外增加了一个熵作为输入。这样一来计算速度明显比 PRNG 慢很多，但 CSPRNG 生成的值很难预测，可以用于加密。</p> <p>Web Cryptography API 引入了 CSPRNG，可以通过 crypto.getRandomValues() 访问 ，crypto <code>[ˈkrɪptəʊ]</code> graphy <code>['ɡræfɪ]</code>。该函数会把随机值写入作为参数的定型数组，定型数组类型不重要，底层缓冲区会被随机的二进制位填充</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 定义 1 个字节的 typed array，最大值 255</span>
<span class="token keyword">const</span> array <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> n <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">getRandomValues</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> n<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// Uint8Array [140] 140</span>
<span class="token comment">// Uint8Array [214] 214</span>
<span class="token comment">// Uint8Array [122] 122</span>
<span class="token comment">// Uint8Array [202] 202</span>
<span class="token comment">// Uint8Array [81] 81</span>
</code></pre></div><p>getRandomValues() 最多可以生成 2 ** 16（65536）字节，超出则会抛出错误 <code>Failed to execute 'getRandomValues' on 'Crypto': The ArrayBufferView's byte length (65537) exceeds the number of bytes of entropy available via this API (65536).</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> array <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">**</span> <span class="token number">16</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span><span class="token function">getRandomValues</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// Uint8Array(65536) [48, 96, 106, 4, 11, 72 186, 93, 44, 176, 156, 55, 178, 49, 255, 18, 173, 40, 193, 49, 3, 61, 194, 132, 190, 86, …]</span>
<span class="token keyword">const</span> array2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">**</span> <span class="token number">16</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span><span class="token function">getRandomValues</span><span class="token punctuation">(</span>array2<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// Uncaught DOMException: Failed to execute 'getRandomValues' on 'Crypto': The ArrayBufferView's byte length (65537) exceeds the number of bytes of entropy available via this API (65536).</span>
</code></pre></div><p>使用 CSPRNG 重新视线 Math.random() 通过随机生成一个随机的 32 位数值，然后用他去除以最大的值 <code>0xFFFFFFFF</code> ，这样就会获得一个介于 0 和 1 之间的数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">randomFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> array <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint32Array</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token comment">// 0xFFFFFFFF === 2 ** 32 -1 // true</span>
  <span class="token keyword">const</span> maxUint32 <span class="token operator">=</span> <span class="token number">0xFFFFFFFF</span>
  <span class="token keyword">return</span> crypto<span class="token punctuation">.</span><span class="token function">getRandomValues</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">/</span> maxUint32
<span class="token punctuation">}</span>
<span class="token function">randomFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 0.2779637703853575</span>
<span class="token function">randomFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 0.21668057078883995</span>
<span class="token function">randomFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 0.8739860593047892</span>
</code></pre></div><h3 id="subtlecrypto-对象"><a href="#subtlecrypto-对象" class="header-anchor">#</a> SubtleCrypto 对象</h3> <p>subtle [ˈsʌtl] 精细的，Web Cryptography API 核心的特性都暴露在了 SubtleCrypto 对象上，可以使用 window.crypto.subtle 方法</p> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>crypto<span class="token punctuation">.</span>subtle<span class="token punctuation">)</span> <span class="token comment">// SubtleCrypto {}</span>
</code></pre></div><p>可以用于加密、散列、签名和生成秘钥。由于所有密码学操作都在原始的二进制数据上执行，所以 SubtleCrypto 的每个方法都要用到 ArrayBuffer 和 ArrayBufferView 类型。由于字符串是密码学操作的重要场景，因此用于二进制数据与字符串之间相互转换的 TextEncoder 和 TextDecoder 经常与 SubtleCrypto 一起使用。</p> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>SubtleCrypto 对象只能在安全的上下文（https）中使用，不安全的上下文中，crypto.subtle 属性为 undefined</p></div> <h3 id="生成密码学摘要-crypto-subtle-digest"><a href="#生成密码学摘要-crypto-subtle-digest" class="header-anchor">#</a> 生成密码学摘要(crypto.subtle.digest())</h3> <blockquote><p>digest <code>[dɪˈdʒɛst]</code> 消化/摘要、hash <code>[hæʃ]</code> 哈希/散列、algorithm  <code>[ˈæl ɡə rɪðəm]</code> 算法、Secure <code>[sɪˈkjʊər]</code> adj. 安全的</p></blockquote> <p><code>crypto.subtle.digest(hash(散列)算法类型, typedArray)</code> 用于生成消息摘要，支持 4 种摘要算法：SHA-1 和 3 种 SHA-2，分别对应字符串 &quot;SHA-1&quot;、&quot;SHA-256&quot;、&quot;SHA-384&quot;、&quot;SHA-512&quot;。</p> <ul><li><code>SHA-1（Secure Hash Algorithm 1）</code> 构架类似 MD5 的散列函数。接收任意大小的输入，生成 160 位消息散列。容易受到碰撞攻击，该算法已经不再安全。</li> <li><code>SHA-2（Secure Hash Algorithm 2）</code> 构建于相同耐碰撞单向压缩函数之上的一套散列函数。规范支持其中三种 <strong>SHA-256、SHA-384、SHA-512</strong>。生成的摘要信息可以是 256位、384位、512位。该算法被认为是安全的，广泛应用于很多领域和协议，包括 TLS、PGP 和加密货币（如比特币）。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> textEncoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> msg <span class="token operator">=</span> textEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span> <span class="token comment">// Uint8Array(3) [102, 111, 111]</span>
  <span class="token keyword">const</span> msgDigest <span class="token operator">=</span> <span class="token keyword">await</span> crypto<span class="token punctuation">.</span>subtle<span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'SHA-256'</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msgDigest<span class="token punctuation">)</span> <span class="token comment">// ArrayBuffer(32)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Uint32Array</span><span class="token punctuation">(</span>msgDigest<span class="token punctuation">)</span><span class="token punctuation">)</span> 
  <span class="token comment">// Uint32Array(8) </span>
  <span class="token comment">// [1806968364, 2412183400, 1011194873, 876687389, </span>
  <span class="token comment">//  1882014227, 2696905572, 2287897337, 2934400610]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>通常在使用时，二进制的消息摘要需要转换为 16 进制的字符串格式，256 位转 16 进制就是 64 位字符串。将二进制数据按照 8 位进行分割，再通过 toString(16) 就可以把任何数组缓冲区转换为 16 进制字符串</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> textEncoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> msg <span class="token operator">=</span> textEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span> <span class="token comment">// Uint8Array(3) [102, 111, 111]</span>
  <span class="token keyword">const</span> msgDigest <span class="token operator">=</span> <span class="token keyword">await</span> crypto<span class="token punctuation">.</span>subtle<span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'SHA-256'</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msgDigest<span class="token punctuation">)</span> <span class="token comment">// ArrayBuffer(32)</span>

  <span class="token comment">// 8位分割后的数据大小为 0 - 255</span>
  b <span class="token operator">=</span> <span class="token number">44</span>
  b<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token comment">// &quot;2c&quot;</span>
  c <span class="token operator">=</span> <span class="token number">1</span>
  c<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token comment">// &quot;1&quot;</span>
  c<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">padStart</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span> <span class="token comment">// &quot;01&quot;</span>

  <span class="token keyword">const</span> hexDigest <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>msgDigest<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">i</span> <span class="token operator">=&gt;</span> i<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>hexDigest<span class="token punctuation">)</span>
  <span class="token comment">// 2c26b46b68ffc68ff99b453c1d30413413422d706483bfa0f98a5e886266e7ae</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>在上面的例子中，把 new Uint8Array(msgDigest) 换成 16/32 位也可以生成字符串，就是和结果不一样，为什么一定要按照 8 位分割呢？二进制位以字节为单位？textEncoder.encode('foo') 默认编码后的就是 8 位？</p> <p>计算文件的散列(hash)字符串，可以用于确认文件是否被修改过。例子参见 p665</p> <h3 id="根据秘钥算法生成秘钥-cryptokey-实例-crypto-subtle-generatekey"><a href="#根据秘钥算法生成秘钥-cryptokey-实例-crypto-subtle-generatekey" class="header-anchor">#</a> 根据秘钥算法生成秘钥(CryptoKey)实例(crypto.subtle.generateKey())</h3> <p>crypto.subtle.generateKey() 方法用于生成秘钥，返回一个 CryptoKey 实例。CryptoKey 类支持多种加密算法，允许控制秘钥抽取和使用。CryptoKey 类支持以下算法：</p> <blockquote><p>对称型加密算法(如 DES/AES 算法) 使用单个秘钥对数据进行加密或解密。非对称型加密算法（如 RSA 算法）也称为公用秘钥算法，有两个秘钥（公用秘钥和私用秘钥）。只有两者搭配才能完成加密或解密的全过程。</p></blockquote> <ul><li><code>RSA（Rivest-Shamir-Adleman）</code> 1978年，麻省理工学院的三名教授瑞斯特(Rivest)、沙米尔(Shamir)和艾德曼(Adleman) 开发了非对称 RSA 公共密钥算法。公钥密码系统，使用两大素数获得一对公钥和私钥，<strong>可用于签名/验证或加密/解密消息</strong>。
<ul><li>一些加密算法是对 RSA 的应用，比如：RSASSA-PKCS1-v1_5、RSA-PSS、RSA-OAEP</li></ul></li> <li><code>ECC（Elliptic-Curve Cryptography）</code> 公钥密码系统，<strong>椭圆曲线密码</strong>（Elliptic Curve <code>[ɪ'lɪptɪk]</code> <code>[kɜːv]</code>），使用一个素数和一个椭圆曲线获得一对公钥和私钥，<strong>可用于签名/验证消息</strong>，ECC 被认为优与 RSA，它比 RSA 秘钥短，且操作更快。
<ul><li>一些加密算法是对 ECC 的应用，比如：ECDSA、ECDH</li></ul></li> <li><code>AES（Advanced Encryption Standard）</code> <strong>高级加密标准</strong>，属于对称秘钥密码系统。由于 DES 密钥太短已无法满足安全的需要，2000年10月美国国家标准与技术研究所(NIST)发布高级加密标准(AES)作为新的加密电子数据加密标准。使用派生自置换组合网络的分组密码加密和解密数据。AES 在不同模式下使用，不同模式算法的特性也不同。
<ul><li>AES 有多种模式的算法，比如：AES-CTR（AES 计数模式 counter mode）、AES-CBC（AED 密码分组链模式 cipher block chaining mode）、AES-GCM、AES-KW</li></ul></li> <li><code>HMAC（Hash-Based Message Authentication Code）</code> <strong>哈希信息验证码</strong>， n. 认证 [ɔːˌθentɪˈkeɪʃn]，用于生成消息认证码的算法，用于验证通过不可信网络接收的消息没有被修改过。两方使用hash函数和共享私钥来签名和验证消息。</li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>上面只是列出部分，更多信息参见 p667。CryptoKey 支持很多算法，但其中只有部分算法可以用于 SubtleCrypto 的方法。如果需要了解细节，可以参考 W3C 上 Web Cryptography API 规范的 &quot;Algorithm Overview&quot;</p></div> <p><code>crypto.subtle.generateKey(algorithm, extractable, keyUsages)</code> 可以生成随机 CryptoKey，返回一个 Promise，resolve 是用来表示秘钥的一个或多个 CryptoKey 实例。它有三个参数：</p> <ul><li><code>algorithm</code> 指定加密算法类型的对象</li> <li><code>extractable</code> <code>[ɪk'stræktəbl]</code> 布尔值，表示密码是否可以从 CryptoKey 中提取出来</li> <li><code>keyUsages</code> 表示这个秘钥可以与那些 SubtleCrypto 方法一起使用，类型为字符串数组，比如 &quot;encrypt&quot;、&quot;decrypt&quot;、&quot;sign&quot;、&quot;verify&quot;、&quot;deriveKey&quot;、&quot;wrapKey&quot; 等</li></ul> <p>更多细节可以参考：<a href="https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto/generateKey" target="_blank" rel="noopener noreferrer">SubtleCrypto.generateKey() | MDN<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token keyword">await</span> crypto<span class="token punctuation">.</span>subtle<span class="token punctuation">.</span><span class="token function">generateKey</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&quot;AES-CTR&quot;</span><span class="token punctuation">,</span>
    length<span class="token operator">:</span> <span class="token number">128</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> 
  <span class="token boolean">false</span><span class="token punctuation">,</span> 
  <span class="token punctuation">[</span><span class="token string">'encrypt'</span><span class="token punctuation">,</span> <span class="token string">'decrypt'</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span>
<span class="token comment">// CryptoKey {type: &quot;secret&quot;, extractable: false, algorithm: {…}, usages: Array(2)}</span>

<span class="token keyword">const</span> key2 <span class="token operator">=</span> <span class="token keyword">await</span> crypto<span class="token punctuation">.</span>subtle<span class="token punctuation">.</span><span class="token function">generateKey</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">&quot;ECDSA&quot;</span><span class="token punctuation">,</span>
    namedCurve<span class="token operator">:</span> <span class="token string">'P-256'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> 
  <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token string">'sign'</span><span class="token punctuation">,</span> <span class="token string">'verify'</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span>
<span class="token comment">// {publicKey: CryptoKey, privateKey: CryptoKey}</span>
<span class="token comment">// privateKey: CryptoKey</span>
<span class="token comment">//   algorithm: {name: &quot;ECDSA&quot;, namedCurve: &quot;P-256&quot;}</span>
<span class="token comment">//   extractable: true</span>
<span class="token comment">//   type: &quot;private&quot;</span>
<span class="token comment">//   usages: [&quot;sign&quot;]</span>
<span class="token comment">//   __proto__: CryptoKey</span>
<span class="token comment">// publicKey: CryptoKey</span>
<span class="token comment">//   algorithm: {name: &quot;ECDSA&quot;, namedCurve: &quot;P-256&quot;}</span>
<span class="token comment">//   extractable: true</span>
<span class="token comment">//   type: &quot;public&quot;</span>
<span class="token comment">//   usages: [&quot;verify&quot;]</span>
</code></pre></div><h3 id="导出和导入秘钥-crypto-subtle-exportkey-importkey"><a href="#导出和导入秘钥-crypto-subtle-exportkey-importkey" class="header-anchor">#</a> 导出和导入秘钥(crypto.subtle.exportKey/importKey())</h3> <p>如果秘钥是可以提取的，那么就可以在 CryptoKey 对象内部暴露秘钥原始的二进制内容。使用 exportKey() 可以获取秘钥</p> <ul><li><code>crypto.subtle.exportKey(keyFormat, key)</code> 将秘钥 key 使用 format 指定的格式导出。format 格式可以使 &quot;raw&quot;（未加工的,原始的）、&quot;pkcs8&quot;、&quot;spki&quot; 或 &quot;jwk&quot;。该方法返回一个 Promise，resolve 一个包含秘钥的 ArrayBuffer 数组。</li> <li><code>crypto.subtle.importKey(keyFormat, keyData, algorithmName, extractable, keyUsages)</code> 将导出来的秘钥导入到一个新的秘钥对象中，相当于 generateKey() 和 exportKey() 的逆向操作。keyData 是使用 exportKey 导出的秘钥数据，algorithmName 是加密算法名称,  extractable, keyUsages 参数同 generateKey() 函数。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token keyword">await</span> crypto<span class="token punctuation">.</span>subtle<span class="token punctuation">.</span><span class="token function">generateKey</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">&quot;AES-CTR&quot;</span><span class="token punctuation">,</span>
      length<span class="token operator">:</span> <span class="token number">128</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> 
    <span class="token boolean">true</span><span class="token punctuation">,</span> 
    <span class="token punctuation">[</span><span class="token string">'encrypt'</span><span class="token punctuation">,</span> <span class="token string">'decrypt'</span><span class="token punctuation">]</span>
  <span class="token punctuation">)</span>
  <span class="token keyword">const</span> rawKey <span class="token operator">=</span> <span class="token keyword">await</span> crypto<span class="token punctuation">.</span>subtle<span class="token punctuation">.</span><span class="token function">exportKey</span><span class="token punctuation">(</span><span class="token string">'raw'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>rawKey<span class="token punctuation">)</span> <span class="token comment">// ArrayBuffer(16) {}</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>rawKey<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">// Uint8Array(16) [126, 188, 169, 122, 134, 143, 90, 180, 153, 154, 133, 178, 133, 48, 217, 170]</span>

  <span class="token keyword">let</span> importedKey <span class="token operator">=</span> <span class="token keyword">await</span> crypto<span class="token punctuation">.</span>subtle<span class="token punctuation">.</span><span class="token function">importKey</span><span class="token punctuation">(</span><span class="token string">'raw'</span><span class="token punctuation">,</span> rawKey<span class="token punctuation">,</span> <span class="token string">'AES-CTR'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'encrypt'</span><span class="token punctuation">,</span> <span class="token string">'decrypt'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>importedKey<span class="token punctuation">)</span>
  <span class="token comment">// CryptoKey {type: &quot;secret&quot;, extractable: true, algorithm: {…}, usages: Array(2)}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="从主秘钥派生秘钥-crypto-subtle-derivekey-derivebits"><a href="#从主秘钥派生秘钥-crypto-subtle-derivekey-derivebits" class="header-anchor">#</a> 从主秘钥派生秘钥(crypto.subtle.deriveKey/deriveBits())</h3> <p>derive <code>[dɪˈraɪv]</code> 派生，从已有秘钥获取新秘钥</p> <ul><li><code>crypto.subtle.deriveBits(algorithm, baseKey, length)</code> 返回一个 resolve 为 ArrayBuffer 的 Promise。</li> <li><code>crypto.subtle.deriveKey(algorithm, baseKey, derivedKeyAlgorithm, extractable, keyUsages)</code> 返回一个 resolve 为 CryptoKey 的 Promise。与调用 deriveBits() 后再将结果传给 importKey() 结果相同。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> keyA <span class="token operator">=</span> <span class="token keyword">await</span> crypto<span class="token punctuation">.</span>subtle<span class="token punctuation">.</span><span class="token function">generateKey</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'ECDH'</span><span class="token punctuation">,</span>
  namedCurve<span class="token operator">:</span> <span class="token string">'P-256'</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'deriveBits'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> keyB <span class="token operator">=</span> <span class="token keyword">await</span> crypto<span class="token punctuation">.</span>subtle<span class="token punctuation">.</span><span class="token function">generateKey</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'ECDH'</span><span class="token punctuation">,</span>
  namedCurve<span class="token operator">:</span> <span class="token string">'P-256'</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'deriveBits'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> deriveAB <span class="token operator">=</span> <span class="token keyword">await</span> crypto<span class="token punctuation">.</span>subtle<span class="token punctuation">.</span><span class="token function">deriveBits</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'ECDH'</span><span class="token punctuation">,</span>
  namedCurve<span class="token operator">:</span> <span class="token string">'P-256'</span><span class="token punctuation">,</span>
  <span class="token keyword">public</span><span class="token operator">:</span> keyA<span class="token punctuation">.</span>publicKey <span class="token comment">// A 的公钥</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> keyB<span class="token punctuation">.</span>privateKey<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span> <span class="token comment">// B 的私钥</span>
<span class="token comment">// ArrayBuffer(16) {} </span>
<span class="token keyword">const</span> deriveBA <span class="token operator">=</span> <span class="token keyword">await</span> crypto<span class="token punctuation">.</span>subtle<span class="token punctuation">.</span><span class="token function">deriveBits</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'ECDH'</span><span class="token punctuation">,</span>
  namedCurve<span class="token operator">:</span> <span class="token string">'P-256'</span><span class="token punctuation">,</span>
  <span class="token keyword">public</span><span class="token operator">:</span> keyB<span class="token punctuation">.</span>publicKey <span class="token comment">// B 的公钥</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> keyA<span class="token punctuation">.</span>privateKey<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span>  <span class="token comment">// A 的私钥</span>
<span class="token comment">// ArrayBuffer(16) {}</span>
<span class="token keyword">const</span> arrayAB <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint32Array</span><span class="token punctuation">(</span>deriveAB<span class="token punctuation">)</span>
<span class="token keyword">const</span> arrayBA <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint32Array</span><span class="token punctuation">(</span>deriveBA<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>deriveAB<span class="token punctuation">,</span> deriveBA<span class="token punctuation">,</span> arrayAB<span class="token punctuation">,</span> arrayBA<span class="token punctuation">)</span>
<span class="token comment">// ArrayBuffer(16) {}</span>
<span class="token comment">// ArrayBuffer(16) {}</span>
<span class="token comment">// Uint32Array(4) [434851524, 2869415471, 310093849, 3098225050] </span>
<span class="token comment">// Uint32Array(4) [434851524, 2869415471, 310093849, 3098225050]</span>
</code></pre></div><p>deriveKey 实例参见 p671</p> <h3 id="使用非对称秘钥签名和验证消息-crypto-subtle-sign-verify"><a href="#使用非对称秘钥签名和验证消息-crypto-subtle-sign-verify" class="header-anchor">#</a> 使用非对称秘钥签名和验证消息(crypto.subtle.sign/verify())</h3> <p>一般使用私钥生成签名，对应 sign() 方法。使用公钥验证签名，对应 verify()。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> publicKey<span class="token punctuation">,</span> privateKey <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> crypto<span class="token punctuation">.</span>subtle<span class="token punctuation">.</span><span class="token function">generateKey</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'ECDSA'</span><span class="token punctuation">,</span>
    namedCurve<span class="token operator">:</span> <span class="token string">'P-256'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'sign'</span><span class="token punctuation">,</span> <span class="token string">'verify'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

  <span class="token comment">// 使用私钥生成签名</span>
  <span class="token keyword">const</span> msg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">&quot;some info, some msg&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> signature <span class="token operator">=</span> <span class="token keyword">await</span> crypto<span class="token punctuation">.</span>subtle<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'ECDSA'</span><span class="token punctuation">,</span>
    hash<span class="token operator">:</span> <span class="token string">'SHA-256'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> privateKey<span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>signature<span class="token punctuation">)</span> <span class="token comment">// ArrayBuffer(64) {}</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Uint32Array</span><span class="token punctuation">(</span>signature<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">// Uint32Array(16) [965020713, 1414793526, 3039910164, 2277130781, ...]</span>

  <span class="token comment">// 使用公钥验证消息是否正确</span>
  <span class="token keyword">const</span> verified <span class="token operator">=</span> <span class="token keyword">await</span> crypto<span class="token punctuation">.</span>subtle<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'ECDSA'</span><span class="token punctuation">,</span>
    hash<span class="token operator">:</span> <span class="token string">'SHA-256'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> publicKey<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>verified<span class="token punctuation">)</span> <span class="token comment">// true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="使用对称秘钥加密和解密-crypto-subtle-encrypt-descrypt"><a href="#使用对称秘钥加密和解密-crypto-subtle-encrypt-descrypt" class="header-anchor">#</a> 使用对称秘钥加密和解密(crypto.subtle.encrypt/descrypt())</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token keyword">await</span> crypto<span class="token punctuation">.</span>subtle<span class="token punctuation">.</span><span class="token function">generateKey</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'AES-CBC'</span><span class="token punctuation">,</span>
    length<span class="token operator">:</span> <span class="token number">256</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'encrypt'</span><span class="token punctuation">,</span> <span class="token string">'decrypt'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> originalPlainText <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">&quot;some info, some msg&quot;</span><span class="token punctuation">)</span>

  <span class="token comment">// cipher [ˈsaɪfər] 密码</span>
  <span class="token comment">// 加密信息</span>
  <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'AES-CBC'</span><span class="token punctuation">,</span>
    iv<span class="token operator">:</span> crypto<span class="token punctuation">.</span><span class="token function">getRandomValues</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> cipherText <span class="token operator">=</span> <span class="token keyword">await</span> crypto<span class="token punctuation">.</span>subtle<span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> key<span class="token punctuation">,</span> originalPlainText<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>cipherText<span class="token punctuation">)</span> <span class="token comment">// ArrayBuffer(32) {}</span>

  <span class="token comment">// 解密信息</span>
  <span class="token keyword">const</span> decryptedPlainText <span class="token operator">=</span> <span class="token keyword">await</span> crypto<span class="token punctuation">.</span>subtle<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> key<span class="token punctuation">,</span> cipherText<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>decryptedPlainText<span class="token punctuation">)</span> <span class="token comment">// ArrayBuffer(19) {}</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>decryptedPlainText<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">// some info, some msg</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="包装和解包秘钥-crypto-subtle-wrapkey-unwrapkey"><a href="#包装和解包秘钥-crypto-subtle-wrapkey-unwrapkey" class="header-anchor">#</a> 包装和解包秘钥(crypto.subtle.wrapKey/unwrapKey())</h3> <p>SubtleCrypto 支持包装（wrap）与解包（unwrap）秘钥，以便在非信任渠道传输信息，分别对应 crypto.subtle.wrapKey() 与 crypto.subtle.unwrapKey()，来看一个例子，生成对称 AES-GCM 秘钥，用 AES-KW 来包装秘钥，再解包</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 对称 AES-GCM 秘钥</span>
  <span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token keyword">await</span> crypto<span class="token punctuation">.</span>subtle<span class="token punctuation">.</span><span class="token function">generateKey</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'AES-GCM'</span><span class="token punctuation">,</span>
    length<span class="token operator">:</span> <span class="token number">256</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'encrypt'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

  <span class="token comment">// 用于包装秘钥的 AES-KW 秘钥</span>
  <span class="token keyword">const</span> wrapKey <span class="token operator">=</span> <span class="token keyword">await</span> crypto<span class="token punctuation">.</span>subtle<span class="token punctuation">.</span><span class="token function">generateKey</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'AES-KW'</span><span class="token punctuation">,</span>
    length<span class="token operator">:</span> <span class="token number">256</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'wrapKey'</span><span class="token punctuation">,</span> <span class="token string">'unwrapKey'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

  <span class="token comment">// 包装后的秘钥</span>
  <span class="token keyword">const</span> wrappedKey <span class="token operator">=</span> <span class="token keyword">await</span> crypto<span class="token punctuation">.</span>subtle<span class="token punctuation">.</span><span class="token function">wrapKey</span><span class="token punctuation">(</span><span class="token string">'raw'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> wrapKey<span class="token punctuation">,</span> <span class="token string">'AES-KW'</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>wrappedKey<span class="token punctuation">)</span> <span class="token comment">// ArrayBuffer(40) {}</span>

  <span class="token comment">// 解包后的秘钥</span>
  <span class="token keyword">const</span> unwrappedKey <span class="token operator">=</span> <span class="token keyword">await</span> crypto<span class="token punctuation">.</span>subtle<span class="token punctuation">.</span><span class="token function">unwrapKey</span><span class="token punctuation">(</span><span class="token string">'raw'</span><span class="token punctuation">,</span> wrappedKey<span class="token punctuation">,</span> wrapKey<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'AES-KW'</span><span class="token punctuation">,</span>
    length<span class="token operator">:</span> <span class="token number">256</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'AES-GCM'</span><span class="token punctuation">,</span>
    length<span class="token operator">:</span> <span class="token number">256</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'encrypt'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>unwrappedKey<span class="token punctuation">)</span>
  <span class="token comment">// CryptoKey {type: &quot;secret&quot;, extractable: true, algorithm: {…}, usages: Array(1)}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2020/12/13 上午5:07:38</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/js/ad3/js-ad3-19.html" class="prev">
        19. 表单脚本 - JS高程4
      </a></span> <span class="next"><a href="/js/ad3/js-ad3-21.html">
        21. 错误处理与调试 - JS高程4
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.5dbb3b16.js" defer></script><script src="/assets/js/2.3f8a6b0b.js" defer></script><script src="/assets/js/84.bd60c92f.js" defer></script><script src="/assets/js/3.018b29e2.js" defer></script>
  </body>
</html>
