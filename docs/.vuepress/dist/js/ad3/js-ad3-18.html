<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>18. 动画与 Canvas 图形 - JS高程4 | 左小白的前端笔记</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/logo.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon-152x152.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#3eaf7c">
    <meta name="description" content="早期 Web 中 JS 动画的实现使用的是 setTimeout() 与 setInterval()，但由于事件队列机制无法保证计时器的时间精度，无法创建平滑的动画。于是出现了 requestAnimationFrame() API，浏览器会使用最优的方式来绘制动画。HTML5 加入了 canvas 元素，IE9+ 支持，这个元素会占据一块页面区域，让 JavaScript 可以动态在上面绘制图片。canvas 仅支持基础绘图能力，是 2D、非矢量的。如果需要做 3D 绘图，可以使用 WebGL。">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/assets/css/0.styles.c896736b.css" as="style"><link rel="preload" href="/assets/js/app.222184eb.js" as="script"><link rel="preload" href="/assets/js/2.3f8a6b0b.js" as="script"><link rel="preload" href="/assets/js/81.b0b699ad.js" as="script"><link rel="preload" href="/assets/js/3.018b29e2.js" as="script"><link rel="prefetch" href="/assets/js/10.9d91f1b8.js"><link rel="prefetch" href="/assets/js/100.c819952b.js"><link rel="prefetch" href="/assets/js/101.62c77c5f.js"><link rel="prefetch" href="/assets/js/102.b62e6f04.js"><link rel="prefetch" href="/assets/js/103.e64c7ead.js"><link rel="prefetch" href="/assets/js/104.35d4c324.js"><link rel="prefetch" href="/assets/js/105.4147930a.js"><link rel="prefetch" href="/assets/js/106.b01c2d24.js"><link rel="prefetch" href="/assets/js/107.8453fecf.js"><link rel="prefetch" href="/assets/js/108.492914d7.js"><link rel="prefetch" href="/assets/js/109.9e08fa69.js"><link rel="prefetch" href="/assets/js/11.b7e99381.js"><link rel="prefetch" href="/assets/js/110.68bfb110.js"><link rel="prefetch" href="/assets/js/111.8d790a52.js"><link rel="prefetch" href="/assets/js/112.8c759909.js"><link rel="prefetch" href="/assets/js/113.2cb44b65.js"><link rel="prefetch" href="/assets/js/114.af866c28.js"><link rel="prefetch" href="/assets/js/115.81a99552.js"><link rel="prefetch" href="/assets/js/116.bdb1301b.js"><link rel="prefetch" href="/assets/js/117.bf5ecfeb.js"><link rel="prefetch" href="/assets/js/118.9244e9be.js"><link rel="prefetch" href="/assets/js/119.06ec3c12.js"><link rel="prefetch" href="/assets/js/12.42673558.js"><link rel="prefetch" href="/assets/js/120.af976ac8.js"><link rel="prefetch" href="/assets/js/121.b2fda307.js"><link rel="prefetch" href="/assets/js/122.d2e73d20.js"><link rel="prefetch" href="/assets/js/123.99e72a69.js"><link rel="prefetch" href="/assets/js/124.486ecec9.js"><link rel="prefetch" href="/assets/js/125.f251cf73.js"><link rel="prefetch" href="/assets/js/126.0f844bcf.js"><link rel="prefetch" href="/assets/js/127.ac094c12.js"><link rel="prefetch" href="/assets/js/128.aa7f5018.js"><link rel="prefetch" href="/assets/js/129.61ef7f75.js"><link rel="prefetch" href="/assets/js/13.986f7498.js"><link rel="prefetch" href="/assets/js/130.10c3b575.js"><link rel="prefetch" href="/assets/js/131.373c3a15.js"><link rel="prefetch" href="/assets/js/132.a78117c0.js"><link rel="prefetch" href="/assets/js/133.ba2c2f72.js"><link rel="prefetch" href="/assets/js/134.898729aa.js"><link rel="prefetch" href="/assets/js/135.1da68a32.js"><link rel="prefetch" href="/assets/js/136.c4a37002.js"><link rel="prefetch" href="/assets/js/137.bc509ee2.js"><link rel="prefetch" href="/assets/js/138.06d4dada.js"><link rel="prefetch" href="/assets/js/139.09d2fe2e.js"><link rel="prefetch" href="/assets/js/14.5ce6db09.js"><link rel="prefetch" href="/assets/js/140.43257c97.js"><link rel="prefetch" href="/assets/js/141.619ef672.js"><link rel="prefetch" href="/assets/js/142.2f4291a3.js"><link rel="prefetch" href="/assets/js/143.4cb35e2e.js"><link rel="prefetch" href="/assets/js/144.1852b0e0.js"><link rel="prefetch" href="/assets/js/145.333a9d23.js"><link rel="prefetch" href="/assets/js/146.27b09871.js"><link rel="prefetch" href="/assets/js/147.48f652f9.js"><link rel="prefetch" href="/assets/js/148.8d03109b.js"><link rel="prefetch" href="/assets/js/149.d4672362.js"><link rel="prefetch" href="/assets/js/15.9cd93588.js"><link rel="prefetch" href="/assets/js/150.93b40e8f.js"><link rel="prefetch" href="/assets/js/151.c35e85e6.js"><link rel="prefetch" href="/assets/js/152.b5eead7e.js"><link rel="prefetch" href="/assets/js/153.6c42745a.js"><link rel="prefetch" href="/assets/js/154.3d4a9d38.js"><link rel="prefetch" href="/assets/js/155.2719d7e4.js"><link rel="prefetch" href="/assets/js/156.9a05d99f.js"><link rel="prefetch" href="/assets/js/157.2ee4c6ad.js"><link rel="prefetch" href="/assets/js/158.9a466cb2.js"><link rel="prefetch" href="/assets/js/159.2e2a8e03.js"><link rel="prefetch" href="/assets/js/16.ea0f861e.js"><link rel="prefetch" href="/assets/js/160.87f7a1f5.js"><link rel="prefetch" href="/assets/js/161.3b990d2c.js"><link rel="prefetch" href="/assets/js/162.03fbe89f.js"><link rel="prefetch" href="/assets/js/163.91c13e9e.js"><link rel="prefetch" href="/assets/js/164.14aeccf0.js"><link rel="prefetch" href="/assets/js/165.ac44f873.js"><link rel="prefetch" href="/assets/js/166.d949dcf8.js"><link rel="prefetch" href="/assets/js/167.f866505f.js"><link rel="prefetch" href="/assets/js/17.b02447ea.js"><link rel="prefetch" href="/assets/js/18.dadf715c.js"><link rel="prefetch" href="/assets/js/19.711ca118.js"><link rel="prefetch" href="/assets/js/20.67b2e7ac.js"><link rel="prefetch" href="/assets/js/21.1062ab94.js"><link rel="prefetch" href="/assets/js/22.58137531.js"><link rel="prefetch" href="/assets/js/23.4c1fc498.js"><link rel="prefetch" href="/assets/js/24.f04d7b70.js"><link rel="prefetch" href="/assets/js/25.b513497e.js"><link rel="prefetch" href="/assets/js/26.98142d7d.js"><link rel="prefetch" href="/assets/js/27.3463feb1.js"><link rel="prefetch" href="/assets/js/28.668030a9.js"><link rel="prefetch" href="/assets/js/29.6e2056fb.js"><link rel="prefetch" href="/assets/js/30.7346364e.js"><link rel="prefetch" href="/assets/js/31.8e563168.js"><link rel="prefetch" href="/assets/js/32.ff88cb29.js"><link rel="prefetch" href="/assets/js/33.3872e844.js"><link rel="prefetch" href="/assets/js/34.8528d11c.js"><link rel="prefetch" href="/assets/js/35.8bc50305.js"><link rel="prefetch" href="/assets/js/36.c228b885.js"><link rel="prefetch" href="/assets/js/37.3247d5e3.js"><link rel="prefetch" href="/assets/js/38.091ab5f2.js"><link rel="prefetch" href="/assets/js/39.a0aae745.js"><link rel="prefetch" href="/assets/js/4.727b3cb3.js"><link rel="prefetch" href="/assets/js/40.a4511166.js"><link rel="prefetch" href="/assets/js/41.aa3d1bb9.js"><link rel="prefetch" href="/assets/js/42.a48c9270.js"><link rel="prefetch" href="/assets/js/43.05418d59.js"><link rel="prefetch" href="/assets/js/44.a6fd5424.js"><link rel="prefetch" href="/assets/js/45.2d28ee99.js"><link rel="prefetch" href="/assets/js/46.73bb240c.js"><link rel="prefetch" href="/assets/js/47.533c85cc.js"><link rel="prefetch" href="/assets/js/48.675c7b9f.js"><link rel="prefetch" href="/assets/js/49.a90588e1.js"><link rel="prefetch" href="/assets/js/5.5f97339e.js"><link rel="prefetch" href="/assets/js/50.16999182.js"><link rel="prefetch" href="/assets/js/51.3f652437.js"><link rel="prefetch" href="/assets/js/52.19a0186f.js"><link rel="prefetch" href="/assets/js/53.3816f661.js"><link rel="prefetch" href="/assets/js/54.9966941e.js"><link rel="prefetch" href="/assets/js/55.11cf3564.js"><link rel="prefetch" href="/assets/js/56.1904522d.js"><link rel="prefetch" href="/assets/js/57.ccab6ccc.js"><link rel="prefetch" href="/assets/js/58.65f407b4.js"><link rel="prefetch" href="/assets/js/59.f799e6e1.js"><link rel="prefetch" href="/assets/js/6.8b6802aa.js"><link rel="prefetch" href="/assets/js/60.a70ee3de.js"><link rel="prefetch" href="/assets/js/61.aa96422c.js"><link rel="prefetch" href="/assets/js/62.461d77f6.js"><link rel="prefetch" href="/assets/js/63.ffd14805.js"><link rel="prefetch" href="/assets/js/64.862ba338.js"><link rel="prefetch" href="/assets/js/65.e9864945.js"><link rel="prefetch" href="/assets/js/66.3f5ed71a.js"><link rel="prefetch" href="/assets/js/67.175ff21f.js"><link rel="prefetch" href="/assets/js/68.582d2924.js"><link rel="prefetch" href="/assets/js/69.7217f814.js"><link rel="prefetch" href="/assets/js/7.55c6af5e.js"><link rel="prefetch" href="/assets/js/70.8d7c375e.js"><link rel="prefetch" href="/assets/js/71.4732a004.js"><link rel="prefetch" href="/assets/js/72.32704e34.js"><link rel="prefetch" href="/assets/js/73.c1bc5a66.js"><link rel="prefetch" href="/assets/js/74.a5f3f7b7.js"><link rel="prefetch" href="/assets/js/75.0003d6fa.js"><link rel="prefetch" href="/assets/js/76.7e5be669.js"><link rel="prefetch" href="/assets/js/77.ce6fc909.js"><link rel="prefetch" href="/assets/js/78.3d505a90.js"><link rel="prefetch" href="/assets/js/79.3abcd1d6.js"><link rel="prefetch" href="/assets/js/8.b5a4a0a4.js"><link rel="prefetch" href="/assets/js/80.a574f302.js"><link rel="prefetch" href="/assets/js/82.94d7a1c2.js"><link rel="prefetch" href="/assets/js/83.33648457.js"><link rel="prefetch" href="/assets/js/84.1779fff1.js"><link rel="prefetch" href="/assets/js/85.8b7f817c.js"><link rel="prefetch" href="/assets/js/86.cb4e2238.js"><link rel="prefetch" href="/assets/js/87.97a84c9d.js"><link rel="prefetch" href="/assets/js/88.bfbd70a7.js"><link rel="prefetch" href="/assets/js/89.15644171.js"><link rel="prefetch" href="/assets/js/9.c5b9353e.js"><link rel="prefetch" href="/assets/js/90.689c48d2.js"><link rel="prefetch" href="/assets/js/91.3b922a75.js"><link rel="prefetch" href="/assets/js/92.3cf18cbf.js"><link rel="prefetch" href="/assets/js/93.ed12d953.js"><link rel="prefetch" href="/assets/js/94.37d44c56.js"><link rel="prefetch" href="/assets/js/95.655e0323.js"><link rel="prefetch" href="/assets/js/96.7323a21e.js"><link rel="prefetch" href="/assets/js/97.fff0d8fd.js"><link rel="prefetch" href="/assets/js/98.51a30d4d.js"><link rel="prefetch" href="/assets/js/99.37dd8e53.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c896736b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">左小白的前端笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="指南" class="dropdown-title"><span class="title">指南</span> <span class="arrow down"></span></button> <button type="button" aria-label="指南" class="mobile-dropdown-title"><span class="title">指南</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">
  首页
</a></li><li class="dropdown-item"><!----> <a href="/nav.html" class="nav-link">
  前端网址导航
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端进阶" class="dropdown-title"><span class="title">前端进阶</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端进阶" class="mobile-dropdown-title"><span class="title">前端进阶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/daily/" class="nav-link">
  技术日常记录
</a></li><li class="dropdown-item"><!----> <a href="/server/docker.html" class="nav-link">
  Docker 基础
</a></li><li class="dropdown-item"><h4>
          Vue.js
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vue/base/1.html" class="nav-link">
  Vue.js 笔记
</a></li><li class="dropdown-subitem"><a href="/vue/vue-router.html" class="nav-link">
  Vue Router 笔记
</a></li><li class="dropdown-subitem"><a href="/vue/vuex.html" class="nav-link">
  Vuex 笔记
</a></li></ul></li><li class="dropdown-item"><h4>
          前端工程化
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/ts/base-1.html" class="nav-link">
  TypeScript 入门教程笔记
</a></li><li class="dropdown-subitem"><a href="/node/base/1.html" class="nav-link">
  Node.js 笔记
</a></li><li class="dropdown-subitem"><a href="/webpack/base.html" class="nav-link">
  webpack 基础
</a></li></ul></li><li class="dropdown-item"><h4>
          数据可视化
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/visual/echarts.html" class="nav-link">
  Echarts 笔记
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端基础" class="dropdown-title"><span class="title">前端基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端基础" class="mobile-dropdown-title"><span class="title">前端基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          JS/ES6
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/js/es6/es6-1.html" class="nav-link">
  ES6标准入门(第三版)笔记
</a></li><li class="dropdown-subitem"><a href="/js/you-donot-know-js-1/scope-closures.html" class="nav-link">
  你不知道的 JavaScript - 上卷
</a></li><li class="dropdown-subitem"><a href="/js/ad3/js-ad3-1.html" class="nav-link">
  JavaScript高级程序设计(第四版)笔记
</a></li><li class="dropdown-subitem"><a href="/js/js-dom-art.html" class="nav-link">
  JavaScript DOM编程艺术(第二版)笔记
</a></li></ul></li><li class="dropdown-item"><h4>
          CSS/CSS3
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/css/less.html" class="nav-link">
  CSS 预处理器 Less.js
</a></li><li class="dropdown-subitem"><a href="/css/flex-grid.html" class="nav-link">
  Flex与Grid布局
</a></li><li class="dropdown-subitem"><a href="/css/html5-css-1.html" class="nav-link">
  HTML5权威指南(CSS部分)笔记
</a></li></ul></li><li class="dropdown-item"><h4>
          HTML/HTML5
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/html5/html/1.html" class="nav-link">
  HTML5权威指南(HTML部分)笔记
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机基础" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机基础" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/base/js-data-struct.html" class="nav-link">
  学习JavaScript数据结构与算法(第三版)笔记
</a></li><li class="dropdown-item"><!----> <a href="/base/mocha-test.html" class="nav-link">
  Mocha - JavaScript测试框架
</a></li><li class="dropdown-item"><!----> <a href="/base/git.html" class="nav-link">
  Git 笔记
</a></li><li class="dropdown-item"><!----> <a href="/base/markdown.html" class="nav-link">
  Markdown 基础语法
</a></li><li class="dropdown-item"><!----> <a href="/base/dbtheory/1.html" class="nav-link">
  数据库系统原理笔记
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开源项目" class="dropdown-title"><span class="title">开源项目</span> <span class="arrow down"></span></button> <button type="button" aria-label="开源项目" class="mobile-dropdown-title"><span class="title">开源项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/zuoxiaobai/service-monitor" target="_blank" rel="noopener noreferrer" class="nav-link external">
  service-monitor
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://vuechart.zuo11.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  @guoqzuo/vue-chart
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://zuoblog.zuo11.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  zuo-blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="http://www.zuo11.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/zuoxiaobai" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="指南" class="dropdown-title"><span class="title">指南</span> <span class="arrow down"></span></button> <button type="button" aria-label="指南" class="mobile-dropdown-title"><span class="title">指南</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">
  首页
</a></li><li class="dropdown-item"><!----> <a href="/nav.html" class="nav-link">
  前端网址导航
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端进阶" class="dropdown-title"><span class="title">前端进阶</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端进阶" class="mobile-dropdown-title"><span class="title">前端进阶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/daily/" class="nav-link">
  技术日常记录
</a></li><li class="dropdown-item"><!----> <a href="/server/docker.html" class="nav-link">
  Docker 基础
</a></li><li class="dropdown-item"><h4>
          Vue.js
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vue/base/1.html" class="nav-link">
  Vue.js 笔记
</a></li><li class="dropdown-subitem"><a href="/vue/vue-router.html" class="nav-link">
  Vue Router 笔记
</a></li><li class="dropdown-subitem"><a href="/vue/vuex.html" class="nav-link">
  Vuex 笔记
</a></li></ul></li><li class="dropdown-item"><h4>
          前端工程化
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/ts/base-1.html" class="nav-link">
  TypeScript 入门教程笔记
</a></li><li class="dropdown-subitem"><a href="/node/base/1.html" class="nav-link">
  Node.js 笔记
</a></li><li class="dropdown-subitem"><a href="/webpack/base.html" class="nav-link">
  webpack 基础
</a></li></ul></li><li class="dropdown-item"><h4>
          数据可视化
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/visual/echarts.html" class="nav-link">
  Echarts 笔记
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端基础" class="dropdown-title"><span class="title">前端基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端基础" class="mobile-dropdown-title"><span class="title">前端基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          JS/ES6
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/js/es6/es6-1.html" class="nav-link">
  ES6标准入门(第三版)笔记
</a></li><li class="dropdown-subitem"><a href="/js/you-donot-know-js-1/scope-closures.html" class="nav-link">
  你不知道的 JavaScript - 上卷
</a></li><li class="dropdown-subitem"><a href="/js/ad3/js-ad3-1.html" class="nav-link">
  JavaScript高级程序设计(第四版)笔记
</a></li><li class="dropdown-subitem"><a href="/js/js-dom-art.html" class="nav-link">
  JavaScript DOM编程艺术(第二版)笔记
</a></li></ul></li><li class="dropdown-item"><h4>
          CSS/CSS3
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/css/less.html" class="nav-link">
  CSS 预处理器 Less.js
</a></li><li class="dropdown-subitem"><a href="/css/flex-grid.html" class="nav-link">
  Flex与Grid布局
</a></li><li class="dropdown-subitem"><a href="/css/html5-css-1.html" class="nav-link">
  HTML5权威指南(CSS部分)笔记
</a></li></ul></li><li class="dropdown-item"><h4>
          HTML/HTML5
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/html5/html/1.html" class="nav-link">
  HTML5权威指南(HTML部分)笔记
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机基础" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机基础" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/base/js-data-struct.html" class="nav-link">
  学习JavaScript数据结构与算法(第三版)笔记
</a></li><li class="dropdown-item"><!----> <a href="/base/mocha-test.html" class="nav-link">
  Mocha - JavaScript测试框架
</a></li><li class="dropdown-item"><!----> <a href="/base/git.html" class="nav-link">
  Git 笔记
</a></li><li class="dropdown-item"><!----> <a href="/base/markdown.html" class="nav-link">
  Markdown 基础语法
</a></li><li class="dropdown-item"><!----> <a href="/base/dbtheory/1.html" class="nav-link">
  数据库系统原理笔记
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开源项目" class="dropdown-title"><span class="title">开源项目</span> <span class="arrow down"></span></button> <button type="button" aria-label="开源项目" class="mobile-dropdown-title"><span class="title">开源项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/zuoxiaobai/service-monitor" target="_blank" rel="noopener noreferrer" class="nav-link external">
  service-monitor
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://vuechart.zuo11.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  @guoqzuo/vue-chart
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://zuoblog.zuo11.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  zuo-blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="http://www.zuo11.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/zuoxiaobai" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>JS/ES6</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>ES6标准入门(第三版)笔记</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>你不知道的 JavaScript - 上卷</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>JavaScript高级程序设计(第四版)笔记</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/js/ad3/js-ad4-diff.html" class="sidebar-link">第四版相比第三版有哪些更新 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-1.html" class="sidebar-link">1. 什么是JavaScript - JS高程4</a></li><li><a href="/js/ad3/js-ad3-2.html" class="sidebar-link">2. 在HTML中使用JavaScript - JS高程4</a></li><li><a href="/js/ad3/js-ad3-3.html" class="sidebar-link">3. ES基本概念(语言基础) - JS高程4</a></li><li><a href="/js/ad3/js-ad3-4.html" class="sidebar-link">4. 变量、作用域与内存 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-5.html" class="sidebar-link">5. 基本引用类型 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-6.html" class="sidebar-link">6. 集合引用类型 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-7.html" class="sidebar-link">7. 迭代器与生成器(Iterator 与 Generator) - JS高程4</a></li><li><a href="/js/ad3/js-ad3-8.html" class="sidebar-link">8. 对象、类与面向对象编程 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-9.html" class="sidebar-link">9. 代理与反射(Proxy与Reflect) - JS高程4</a></li><li><a href="/js/ad3/js-ad3-10.html" class="sidebar-link">10. 函数 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-11.html" class="sidebar-link">11. 期约与异步函数(Promise与async/await) - JS高程4</a></li><li><a href="/js/ad3/js-ad3-12.html" class="sidebar-link">12. BOM - JS高程4</a></li><li><a href="/js/ad3/js-ad3-13.html" class="sidebar-link">13. 客户端检测 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-14.html" class="sidebar-link">14. DOM - JS高程4</a></li><li><a href="/js/ad3/js-ad3-15.html" class="sidebar-link">15. DOM扩展 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-16.html" class="sidebar-link">16. DOM2 和 DOM3 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-17.html" class="sidebar-link">17. 事件 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-18.html" aria-current="page" class="active sidebar-link">18. 动画与 Canvas 图形 - JS高程4</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-18.html#使用-requestanimationframe" class="sidebar-link">使用 requestAnimationFrame</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-18.html#浏览器自身计时精度问题" class="sidebar-link">浏览器自身计时精度问题</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-18.html#requestanimationframe" class="sidebar-link">requestAnimationFrame()</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-18.html#cancelanimationframe" class="sidebar-link">cancelAnimationFrame()</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-18.html#通过-requestanimationframe-节流" class="sidebar-link">通过 requestAnimationFrame 节流</a></li></ul></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-18.html#基本的-canvas-画布功能" class="sidebar-link">基本的 canvas 画布功能</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-18.html#_2d-绘图上下文" class="sidebar-link">2D 绘图上下文</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-18.html#填充和描边-绘制矩形" class="sidebar-link">填充和描边/绘制矩形</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-18.html#绘制路径" class="sidebar-link">绘制路径</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-18.html#绘制文本" class="sidebar-link">绘制文本</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-18.html#变换" class="sidebar-link">变换</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-18.html#绘制图形" class="sidebar-link">绘制图形</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-18.html#阴影" class="sidebar-link">阴影</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-18.html#渐变" class="sidebar-link">渐变</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-18.html#图案-pattern" class="sidebar-link">图案 pattern</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-18.html#图像数据-调整图片像素" class="sidebar-link">图像数据/调整图片像素</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-18.html#合成-composite" class="sidebar-link">合成(composite)</a></li></ul></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-18.html#webgl" class="sidebar-link">WebGL</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-18.html#webgl-上下文" class="sidebar-link">WebGL 上下文</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-18.html#webgl基础" class="sidebar-link">WebGL基础</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-18.html#webgl1-与-webgl2" class="sidebar-link">WebGL1 与 WebGL2</a></li></ul></li></ul></li><li><a href="/js/ad3/js-ad3-19.html" class="sidebar-link">19. 表单脚本 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-20.html" class="sidebar-link">20. JavaScript API - JS高程4</a></li><li><a href="/js/ad3/js-ad3-21.html" class="sidebar-link">21. 错误处理与调试 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-22.html" class="sidebar-link">22. 处理 XML - JS高程4</a></li><li><a href="/js/ad3/js-ad3-23.html" class="sidebar-link">23. JSON - JS高程4</a></li><li><a href="/js/ad3/js-ad3-24.html" class="sidebar-link">24. 网络请求与远程资源 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-25.html" class="sidebar-link">25. 客户端存储 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-26.html" class="sidebar-link">26. 模块(Modules) - JS高程4</a></li><li><a href="/js/ad3/js-ad3-27.html" class="sidebar-link">27. 工作者线程(Web Workers) - JS高程4</a></li><li><a href="/js/ad3/js-ad3-28.html" class="sidebar-link">28. 最佳实践 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-old.html" class="sidebar-link">第三版其他内容(高级技巧) - JS高程4</a></li></ul></section></li><li><a href="/js/js-dom-art.html" class="sidebar-link">JavaScript DOM 编程艺术(第二版)笔记</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_18-动画与-canvas-图形"><a href="#_18-动画与-canvas-图形" class="header-anchor">#</a> 18. 动画与 Canvas 图形</h1> <p>早期 Web 中 JS 动画的实现使用的是 setTimeout() 与 setInterval()，但由于事件队列机制无法保证计时器的时间精度，无法创建平滑的动画。于是出现了 requestAnimationFrame() API，浏览器会使用最优的方式来绘制动画。</p> <p>HTML5 加入了 <code>&lt;canvas&gt;</code> 元素，IE9+ 支持，这个元素会占据一块页面区域，让 JavaScript 可以动态在上面绘制图片。canvas 仅支持基础绘图能力，是 2D、非矢量的。如果需要做 3D 绘图，可以使用 WebGL。</p> <h2 id="使用-requestanimationframe"><a href="#使用-requestanimationframe" class="header-anchor">#</a> 使用 requestAnimationFrame</h2> <p>很长时间以来，计时器和间隔执行一直都是 JavaScript 动画的核心。但 setTimeout() 和 setInterval() 计时器都不是十分精确，他们只是把动画代码添加到浏览器的任务队列，如果队列前面还有其他任务。实际执行时间会比正常时间晚一点。循环间隔会有误差。requestAnimationFrame() 可以避免这个误差，创建平滑的动画效果。</p> <p>下面是使用 setInterval() 控制动画执行的例子</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">function</span> <span class="token function">updateAnimations</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">doAnimation1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">doAnimation2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">setInterval</span><span class="token punctuation">(</span>updateAnimations<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre></div><h3 id="浏览器自身计时精度问题"><a href="#浏览器自身计时精度问题" class="header-anchor">#</a> 浏览器自身计时精度问题</h3> <p>创建平滑动画的关键是知道如何绘制下一帧。随着 canvas 的流行和 HTML5 游戏的兴起，开发者发现 setTimeout() 和 setInterval() 不精确是个大问题。而且浏览器自身计时器的精度让这个问题更加明显，另外浏览器在对切换到后台或不活跃标签页中的计时器进行限流。即使将时间间隔设置到最优，也只能得到近似的结果。</p> <h3 id="requestanimationframe"><a href="#requestanimationframe" class="header-anchor">#</a> requestAnimationFrame()</h3> <p>浏览器知道 CSS 过渡和动画应该什么时候开始执行，并据此计算出正确的时间间隔，到时间就刷新 UI。</p> <p>对于 JS 而言，浏览器不知道动画什么时候开始，于是出现 requestAnimationFrame API，用来通知浏览器某些 JS 代码要执行动画了。这样浏览器就可以在运行某些代码后进行适当的优化。</p> <p>requestAnimationFrame(callback) 告诉浏览器——你希望执行一个动画，并且要求浏览器在下次重绘之前调用指定的回调函数更新动画。该方法需要传入一个回调函数作为参数，该回调函数会在浏览器下一次重绘之前执行。若你想在浏览器下次重绘之前继续更新下一帧动画，那么回调函数自身必须再次调用 window.requestAnimationFrame()</p> <p>下面是一个例子，用 JS 实现一个 width 从 5% 到 100% 的动画</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>status<span class="token punctuation">&quot;</span></span> <span class="token style-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token style language-css"><span class="token property">width</span><span class="token punctuation">:</span>5%<span class="token punctuation">;</span><span class="token property">background</span><span class="token punctuation">:</span>red<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>测试<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">function</span> <span class="token function">updateProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> div <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;status&quot;</span><span class="token punctuation">)</span>
    div<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>div<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'%'</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>div<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">!==</span> <span class="token string">'100%'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      window<span class="token punctuation">.</span><span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>updateProgress<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

  <span class="token punctuation">}</span>
  window<span class="token punctuation">.</span><span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>updateProgress<span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>上面我们并没有规定多长时间内执行完毕，其实也可以将时间作为判断条件。回调函数会默认接收一个 timestamp 参数，类似于当前页面打开时间 performance.now() 的返回值，单位是毫秒。下面的例子中，将首次执行动画时的时间，保存到了 start 里。后面每次执行动画时，都将最新的时间与 start 进行比较，如果间隔 2000（2秒）就停止动画。这样就可以指定动画执行时间。下面的动画是将 status 元素向右平移 200px 的动画，动画时间 2s。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;status&quot;</span> style<span class="token operator">=</span><span class="token string">&quot;width:5%;background:red;&quot;</span><span class="token operator">&gt;</span>测试<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
  <span class="token keyword">const</span> element <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'status'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token keyword">let</span> start<span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">step</span><span class="token punctuation">(</span><span class="token parameter">timestamp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'tiemstamp'</span><span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> <span class="token keyword">typeof</span> timestamp<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      start <span class="token operator">=</span> timestamp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'start'</span><span class="token punctuation">,</span> start<span class="token punctuation">)</span>
    <span class="token keyword">const</span> elapsed <span class="token operator">=</span> timestamp <span class="token operator">-</span> start<span class="token punctuation">;</span>

    <span class="token comment">//这里使用`Math.min()`确保元素刚好停在200px的位置。</span>
    element<span class="token punctuation">.</span>style<span class="token punctuation">.</span>transform <span class="token operator">=</span> <span class="token string">'translateX('</span> <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">0.1</span> <span class="token operator">*</span> elapsed<span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'px)'</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>elapsed <span class="token operator">&lt;</span> <span class="token number">2000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 在两秒后停止动画</span>
      window<span class="token punctuation">.</span><span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>step<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  window<span class="token punctuation">.</span><span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>step<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><h3 id="cancelanimationframe"><a href="#cancelanimationframe" class="header-anchor">#</a> cancelAnimationFrame()</h3> <p>requestAnimationFrame() 返回一个请求 ID，可以用于通过 cancelAnimationFrame() 来取消重绘任务。下面的例子中，有一个 5 秒的动画，在 2 秒时取消。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">let</span> start<span class="token punctuation">,</span> requestID<span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token function-variable function">cb</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">t</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token operator">!</span>start <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>start <span class="token operator">=</span> t<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'重绘'</span><span class="token punctuation">)</span>
    <span class="token comment">// console.log &quot;重绘&quot;，持续 5 秒</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">-</span> start <span class="token operator">&lt;</span> <span class="token number">5000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      requestID <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> 
    <span class="token punctuation">}</span> 
  <span class="token punctuation">}</span>
  requestID <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> 
  <span class="token comment">// 2 秒后取消打印</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span><span class="token function">cancelAnimationFrame</span><span class="token punctuation">(</span>requestID<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

</code></pre></div><h3 id="通过-requestanimationframe-节流"><a href="#通过-requestanimationframe-节流" class="header-anchor">#</a> 通过 requestAnimationFrame 节流</h3> <p>requestAnimationFrame 的每次调用，都会在队列上推入一个回调函数，浏览器可以保证每次重绘最多调用一次回调函数，可以用于节流。由于重绘是非常频繁的操作。所以需要加一个 setTimeout 限制重绘执行的频率。下面的例子中，限制 500ms 内只执行一次回调。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token comment">// 创建可滚动的页面</span>
  <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">,</span> 
      htmlStr <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span>count<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    htmlStr <span class="token operator">+=</span> <span class="token string">'&lt;li&gt;test&lt;/li&gt;'</span>
  <span class="token punctuation">}</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;ul&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>htmlStr<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/ul&gt;</span><span class="token template-punctuation string">`</span></span>

  <span class="token comment">// 监听滚动事件，使用 requestAnimationFrame 节流</span>
  <span class="token keyword">let</span> enabled <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token keyword">let</span> <span class="token function-variable function">cb</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Invoked at '</span><span class="token punctuation">,</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'scroll'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>enabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      enabled <span class="token operator">=</span> <span class="token boolean">false</span>
      window<span class="token punctuation">.</span><span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> 
        enabled <span class="token operator">=</span> <span class="token boolean">true</span> 
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="基本的-canvas-画布功能"><a href="#基本的-canvas-画布功能" class="header-anchor">#</a> 基本的 canvas 画布功能</h2> <p>canvas 元素必须设置 width 和 height 属性，指定绘图区域的大小，如果不添加样式或绘制内容是看不到该元素的，可以设置 border 看效果。元素中间可以设置内容，当浏览器不支持 canvas 元素时会显示。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>drawing<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>200<span class="token punctuation">&quot;</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>200<span class="token punctuation">&quot;</span></span> <span class="token style-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token style language-css"><span class="token property">border</span><span class="token punctuation">:</span>1px solid #ccc<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>
  A draw of something. 当前浏览器不支持 canvas.
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>在画布上绘制图形，需要先获取绘图上下文。使用 getContext() 方法可以获取绘图上下文的引用。对于 2D 平面图形，需要传入 &quot;2d&quot; 参数，表示获取 2D 绘图上下文对象。类型是 CanvasRenderingContext2D</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> drawing <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'drawing'</span><span class="token punctuation">)</span>
<span class="token comment">// 如果浏览器支持 canvas</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>drawing<span class="token punctuation">.</span>getContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> ctx <span class="token operator">=</span> drawing<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'2d'</span><span class="token punctuation">)</span>
  <span class="token comment">// 开始使用 2d 绘图上下文对象 ctx 绘制图形</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以使用 toDataURL() 方法，导出 canvas 元素上的图像。这个方法接收一个参数：要生成图像的 MIME 类型，下面是将 canvas 绘制的内容，导出为一张 png 格式的图片。导出的图片大小与画布大小一致。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>drawing<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>200<span class="token punctuation">&quot;</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>200<span class="token punctuation">&quot;</span></span> <span class="token style-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token style language-css"><span class="token property">border</span><span class="token punctuation">:</span>1px solid #ccc<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">let</span> drawing <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'drawing'</span><span class="token punctuation">)</span>
  <span class="token comment">// 如果浏览器支持 canvas</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>drawing<span class="token punctuation">.</span>getContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在 (10,10) 位置上，绘制一个边长为 50 的正方形。</span>
    <span class="token keyword">let</span> ctx <span class="token operator">=</span> drawing<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'2d'</span><span class="token punctuation">)</span>
    ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">&quot;#ff0000&quot;</span>
    ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span>
    
    <span class="token comment">// 获取图像数据 URI，base64</span>
    <span class="token keyword">let</span> imgURI <span class="token operator">=</span> drawing<span class="token punctuation">.</span><span class="token function">toDataURL</span><span class="token punctuation">(</span><span class="token string">'image/png'</span><span class="token punctuation">)</span>

    <span class="token comment">// 显示图片</span>
    <span class="token keyword">let</span> img <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span>
    img<span class="token punctuation">.</span>src <span class="token operator">=</span> imgURI
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span>

    <span class="token comment">// 自动下载该图片</span>
    <span class="token keyword">let</span> link <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span>
    link<span class="token punctuation">.</span>download <span class="token operator">=</span> <span class="token string">'img'</span>
    link<span class="token punctuation">.</span>href <span class="token operator">=</span> imgURI
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span>
    link<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="_2d-绘图上下文"><a href="#_2d-绘图上下文" class="header-anchor">#</a> 2D 绘图上下文</h2> <p>2D 绘图上下文提供了绘制 2D 图形的方法，包括矩形、弧形和路径。2D 上下文的坐标原点是 (0, 0)，即 canvas 元素的左上角。所有坐标值都相对于该点计算。为了方便描述 2D 绘图上下文对象提供的属性、方法，这里将 2D 绘图上下文对象简写为 ctx。</p> <h3 id="填充和描边-绘制矩形"><a href="#填充和描边-绘制矩形" class="header-anchor">#</a> 填充和描边/绘制矩形</h3> <p>填充和描边是 2D 上下文的两个基本绘制操作。fillStyle 和 strokeStyle 用于指定填充和描边的样式。值可以是字符串颜色、渐变对象或图案对象。颜色字符串可以是 CSS 支持的任意格式：名称、十六进制、rgb、rgba、hsl 等。另外在描边时，可以使用 lineWidth 指定线条宽度，lineCap 控制线条端点的形状，比如圆角等。lienJoin 控制线条交点的形状。</p> <ul><li><code>ctx.fillStyle</code> 以指定样式，自动填充形状，默认值为 '#000000'</li> <li><code>ctx.strokeStyle</code> 描边只是为图形边界着色，默认值 '#000000'</li> <li><code>ctx.lineWidth</code> 整数，描边时，线条宽度</li> <li><code>ctx.lineCap</code> 字符串，描边时，线条端点形状 butt(平头)、round(圆角)、square(方头)</li> <li><code>ctx.lineJoin</code> 字符串，描边时，线条交点形状 round(圆角)、bevel(取平)、miter(出尖)</li></ul> <p>矩形是唯一可以直接在 2D 绘图上下文中绘制的形状。与矩形相关的有三个方法，他们都接收 4 个参数，矩形开始的 x 坐标，y 坐标，矩形宽度、矩形高度</p> <ul><li><code>ctx.fillRect(x, y, w, h)</code> 绘制矩形，填充颜色使用 fillStyle 属性设置的颜色</li> <li><code>ctx.strokeRect(x, y, w, h)</code> 绘制矩形边框(轮廓)，颜色使用 strokeStyle 属性设置的颜色。</li> <li><code>ctx.clearRect(x, y, w, h)</code> 擦除画布中的某个矩形区域</li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>drawing<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>200<span class="token punctuation">&quot;</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>200<span class="token punctuation">&quot;</span></span> <span class="token style-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span><span class="token style language-css"><span class="token property">border</span><span class="token punctuation">:</span>1px solid #ccc<span class="token punctuation">;</span></span><span class="token punctuation">'</span></span></span><span class="token punctuation">&gt;</span></span>
  A draw of something.
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">var</span> drawing <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'drawing'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> context <span class="token operator">=</span> drawing<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'2d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 设置描边颜色为红色，strokeRect画边框矩形时，边框的颜色，默认为黑色</span>
  context<span class="token punctuation">.</span>strokeStyle <span class="token operator">=</span> <span class="token string">'red'</span><span class="token punctuation">;</span> 
  <span class="token comment">// 设置填充颜色为蓝色，默认为黑色</span>
  context<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">'#0000ff'</span><span class="token punctuation">;</span> 
  <span class="token comment">// context.fillStyle = &quot;rgba(0,0,255,0.1)&quot;;</span>
  
  <span class="token comment">// 绘制矩形，在画布的 (10,10) 位置，填充宽 50 高 50 的蓝色矩形，</span>
  context<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 修改填充颜色为蓝色透明，再在画布(30,30)位置，填充宽50高50的蓝色透明矩形</span>
  context<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">&quot;rgba(0,0,255,0.5)&quot;</span><span class="token punctuation">;</span>
  context<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 在(100,100)位置，描边宽50高50的红色矩形框</span>
  context<span class="token punctuation">.</span><span class="token function">strokeRect</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 修改描边的颜色为黑色，然后在(120,120)位置，描边宽50高50黑色矩形框</span>
  context<span class="token punctuation">.</span>strokeStyle <span class="token operator">=</span> <span class="token string">'black'</span><span class="token punctuation">;</span>
  context<span class="token punctuation">.</span><span class="token function">strokeRect</span><span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 清除指定位置的rect区域</span>
  context<span class="token punctuation">.</span><span class="token function">clearRect</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>绘制效果如下</p> <p><img src="/images/js/cavasrect.png" alt="cavasrect"></p> <h3 id="绘制路径"><a href="#绘制路径" class="header-anchor">#</a> 绘制路径</h3> <p>通过路径绘制可以创造出复杂的形状和线条。绘制路径前必须先调用 <code>ctx.beginPath()</code> 方法, 表示要开始绘制新路径。然后通过下面的方法来创建路径</p> <ul><li><code>ctx.arc(x, y, radius, startAngle, endAngle, counterclockwise)</code> 以 (x, y) 为圆心绘制一条弧线，半径为 radius, 起始角度和结束角度分别为 startAngle、endAngle，counterclockwise 表示是否是逆时针方向绘制，默认为顺时针方向绘制</li> <li><code>ctx.arcTo(x1, y1, x2, y2, radius)</code> 从上一点开始绘制一条弧线，到 (x2, y2) 为止，并以给定的半径，穿过 (x1, y1)，当 (x1,y1) 到 (x2, y2) 的距离大于半径，可能到达不了 (x2, y2) 停在中途</li> <li><code>lineTo(x, y)</code> 从上一点开始绘制一条直线，到 (x, y) 为止</li> <li><code>moveTo(x, y)</code> 将游标移动到 (x, y) 不画线</li> <li><code>rect(x, y, width, height)</code> 从点 (x, y) 开始绘制一个矩形，宽为 widht，高为 height，与 strokeRect() 和 fillRect() 的区别在于这个方法绘制的是一条路径，而不是独立的图形。</li> <li><code>bezierCurveTo(c1x, c1y, c2x, c2y, x, y)</code> 以 (c1x, c1y) 和 (c2x, c2y) 为控制点，绘制一条从上一点到 (x, y) 的弧线（三次贝塞尔曲线）</li> <li><code>quadraticCurveTo(cx, cy, x, y)</code> 以 (cx, cy) 为控制点，绘制一条从上一点到 (x, y) 的弧线（二次贝塞尔曲线）</li></ul> <p>绘制完路径后，可以调用下面的方法，来填充路径、描画路径或剪切路径</p> <ul><li><code>ctx.closePath()</code> 绘制一条返回起点的线</li> <li><code>ctx.fill()</code> 填充路径</li> <li><code>ctx.stroke()</code> 描画路径</li> <li><code>ctx.clip()</code> 剪切路径</li></ul> <p>注意：使用 fill()、stroke()、clip() 绘制完后，如果需要继续绘制路径，需要重新调用 ctx.beginPath()</p> <p>使用 ctx.arc()、ctx.moveTo()、ctx.stroke() 绘制时钟表盘</p> <p><img src="/images/js/canvas_clock.png" alt="canvas_clock.png"></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>drawing<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>200<span class="token punctuation">&quot;</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>200<span class="token punctuation">&quot;</span></span> <span class="token style-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token style language-css"><span class="token property">border</span><span class="token punctuation">:</span>1px solid #ccc<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">var</span> darwing <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'drawing'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> ctx <span class="token operator">=</span> darwing<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'2d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 开始路径</span>
  ctx<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  ctx<span class="token punctuation">.</span><span class="token function">arc</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">*</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 外圆</span>
  <span class="token comment">// 由于画完圆后，坐标停留在(200, 100)的位置，需要移动下起点。</span>
  ctx<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span><span class="token number">192</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">arc</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">92</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">*</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 内圆</span>

  <span class="token comment">// 将绘图游标移动到中心点，画指针</span>
  ctx<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">stroke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>关于 arc()、arcTo() 函数的理解</p> <p><img src="/images/js/canvas_arc_arcTo.png" alt="canvas_arc_arcTo绘制路线图"></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>drawing<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>200<span class="token punctuation">&quot;</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>200<span class="token punctuation">&quot;</span></span> <span class="token style-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token style language-css"><span class="token property">border</span><span class="token punctuation">:</span>1px solid #ccc<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">var</span> drawing <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'drawing'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> ctx <span class="token operator">=</span> drawing<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'2d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 顺时针画圆 </span>
  <span class="token comment">// ctx.arc(100, 100, 99, 0, 2*Math.PI, false)</span>
  <span class="token comment">// ctx.arc(100, 100, 99, 0, 0.5*Math.PI, false)</span>
  <span class="token comment">// ctx.arc(100, 100, 99, 0.5*Math.PI, 1*Math.PI, false)</span>
  <span class="token comment">// ctx.arc(100, 100, 99, Math.PI, 1.5*Math.PI, false)</span>
  <span class="token comment">// ctx.arc(100, 100, 99, 1.5*Math.PI, 2*Math.PI, false)</span>

  <span class="token comment">// 逆时针画圆</span>
  <span class="token comment">// ctx.arc(100, 100, 99, 2*Math.PI, 0, true)</span>
  <span class="token comment">// ctx.arc(100, 100, 99, 1.5*Math.PI, 0, true)</span>
  <span class="token comment">// ctx.arc(100, 100, 99, 1*Math.PI, 0, true)</span>
  <span class="token comment">// ctx.arc(100, 100, 99, 0.5*Math.PI, 0, true)</span>
  <span class="token comment">// ctx.arc(100, 100, 99, 0.3*Math.PI, 0, true)</span>
  ctx<span class="token punctuation">.</span><span class="token function">stroke</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>上面的例子中，注释的语句如果正常执行，按顺序绘制效果如下</p> <p><img src="/images/js/canvas_arc_1.png" alt="canvas_arc_1.png"></p> <p><img src="/images/js/canvas_arc_2.png" alt="canvas_arc_2.png"></p> <p>再来看 arcTo() 的例子，图1 ~ 图5 的代码如下</p> <div class="language-js extra-class"><pre class="language-js"><code>ctx<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ctx<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ctx<span class="token punctuation">.</span><span class="token function">arcTo</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>   <span class="token comment">// 图 1</span>
<span class="token comment">// ctx.arcTo(100, 100, 0, 0, 200)  // 图 2</span>
<span class="token comment">// ctx13.arcTo(100, 100, 0, 0, 60) // 图 3</span>
ctx<span class="token punctuation">.</span><span class="token function">stroke</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 开始绘制圆弧辅助线</span>
ctx<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ctx<span class="token punctuation">.</span>strokeStyle <span class="token operator">=</span> <span class="token string">&quot;rgba(0, 0, 255, 0.2)&quot;</span>
ctx<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 图 1</span>
<span class="token comment">// ctx12.moveTo(0, 0); // 图 2、图 3</span>
ctx<span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ctx<span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ctx<span class="token punctuation">.</span><span class="token function">stroke</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="/images/js/canvas_arcTo.png" alt="canvas_arcTo.png"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 图 4</span>
ctx14<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ctx14<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ctx14<span class="token punctuation">.</span><span class="token function">arcTo</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span>
ctx14<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ctx14<span class="token punctuation">.</span><span class="token function">arcTo</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">)</span>
ctx14<span class="token punctuation">.</span><span class="token function">stroke</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 开始绘制圆弧辅助线</span>
ctx14<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ctx14<span class="token punctuation">.</span>strokeStyle <span class="token operator">=</span> <span class="token string">&quot;rgba(0, 0, 255, 0.2)&quot;</span>
ctx14<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ctx14<span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ctx14<span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ctx14<span class="token punctuation">.</span><span class="token function">stroke</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 图 5</span>
ctx15<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ctx15<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ctx15<span class="token punctuation">.</span><span class="token function">arcTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
ctx15<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ctx15<span class="token punctuation">.</span><span class="token function">arcTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span>
ctx15<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ctx15<span class="token punctuation">.</span><span class="token function">arcTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">)</span>
ctx15<span class="token punctuation">.</span><span class="token function">stroke</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 开始绘制圆弧辅助线</span>
ctx15<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ctx15<span class="token punctuation">.</span>strokeStyle <span class="token operator">=</span> <span class="token string">&quot;rgba(0, 0, 255, 0.2)&quot;</span>
ctx15<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ctx15<span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ctx15<span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ctx15<span class="token punctuation">.</span><span class="token function">stroke</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>完整代码：<a href="https://github.com/zuoxiaobai/fedemo/blob/master/src/JS_ES6/JS%E9%AB%98%E7%A8%8B3/%E4%BD%BF%E7%94%A8Canvas%E7%BB%98%E5%9B%BE/2_cavasPath.html" target="_blank" rel="noopener noreferrer">canvas arc、arcTo demo | Github<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，在线示例：<a href="https://zuoxiaobai.github.io/fedemo/src/JS_ES6/JS%E9%AB%98%E7%A8%8B3/%E4%BD%BF%E7%94%A8Canvas%E7%BB%98%E5%9B%BE/2_cavasPath.html" target="_blank" rel="noopener noreferrer">canvas arc、arcTo demo 在线示例<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="绘制文本"><a href="#绘制文本" class="header-anchor">#</a> 绘制文本</h3> <p>ctx.fillText() 和 ctx.strokeText() 绘制文本，或者文本边框。如 fillRect 类似，不需要像绘制路径那样需要先 beginPath()。绘制文本方法有 4 个参数，如下:</p> <ul><li>text：要绘制的文本字符串</li> <li>x：要绘制的x坐标</li> <li>y: 要绘制的y坐标</li> <li>width：可选，占用的最大像素宽度。</li></ul> <p>2D 绘图上下文有 4 个关于绘制文本的基础属性、方法，如下：</p> <ul><li><code>ctx.font</code> 表示文本样式字体，用css指定字体的格式来。 如 &quot;bold 10px Arial&quot;</li> <li><code>ctx.textAlign</code> 水平对齐方式 默认为start，还有end，center</li> <li><code>ctx.textBaseline</code> 垂直对齐方式，默认为bottom，还有 top, middle</li> <li><code>ctx.measureText(text)</code> 返回一个 TextMetrics 对象，该对象只有一个 width 属性，表示绘制文本会占用的宽度。使用 while 循环调整 font size 再调用该函数，可以确定固定宽度时，什么字体大小刚好合适。</li></ul> <p><img src="/images/js/canvas_fillText.png" alt="canvas_drawtext"></p> <p>代码如下：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>208*200, 20*20小网格<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>drawing<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>200<span class="token punctuation">&quot;</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>200<span class="token punctuation">&quot;</span></span> <span class="token style-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token style language-css"><span class="token property">border</span><span class="token punctuation">:</span>1px solid #ccc<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">var</span> darwing <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'drawing'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> ctx <span class="token operator">=</span> darwing<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'2d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 开始路径</span>
  ctx<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  ctx<span class="token punctuation">.</span><span class="token function">arc</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">*</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 外圆</span>
  <span class="token comment">// 由于画完圆后，坐标停留在(200, 100)的位置，需要移动下起点。</span>
  ctx<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span><span class="token number">192</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">arc</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">92</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">*</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 内圆</span>

  <span class="token comment">// 将绘图游标移动到中心点，画指针</span>
  ctx<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">stroke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 绘制参考线 20*20 的网格</span>
  ctx<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span>strokeStyle <span class="token operator">=</span> <span class="token string">&quot;rgba(0,0,0,.1)&quot;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">200</span><span class="token punctuation">;</span> i<span class="token operator">+=</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  ctx<span class="token punctuation">.</span><span class="token function">stroke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 绘制参考中心点</span>
  <span class="token function">fillPoint</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fillPoint</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fillPoint</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fillPoint</span><span class="token punctuation">(</span><span class="token number">140</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fillPoint</span><span class="token punctuation">(</span><span class="token number">140</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fillPoint</span><span class="token punctuation">(</span><span class="token number">140</span><span class="token punctuation">,</span> <span class="token number">140</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">fillPoint</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> color</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> radius <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">&quot;rgba(0,0,255)&quot;</span>
    ctx<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span>x<span class="token operator">+</span>radius<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
    ctx<span class="token punctuation">.</span><span class="token function">arc</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> radius<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">*</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    ctx<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 绘制文本</span>
  ctx<span class="token punctuation">.</span>font <span class="token operator">=</span> <span class="token string">&quot;bold 14px Arial&quot;</span>
  ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">&quot;red&quot;</span>
  <span class="token comment">// 默认textAlign为start</span>
  ctx<span class="token punctuation">.</span><span class="token function">fillText</span><span class="token punctuation">(</span><span class="token string">'12'</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>

  ctx<span class="token punctuation">.</span>textAlign <span class="token operator">=</span> <span class="token string">&quot;center&quot;</span>
  ctx<span class="token punctuation">.</span><span class="token function">fillText</span><span class="token punctuation">(</span><span class="token string">'12'</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>

  ctx<span class="token punctuation">.</span>textAlign <span class="token operator">=</span> <span class="token string">&quot;end&quot;</span>
  ctx<span class="token punctuation">.</span><span class="token function">fillText</span><span class="token punctuation">(</span><span class="token string">'12'</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>

  ctx<span class="token punctuation">.</span>textBaseline <span class="token operator">=</span> <span class="token string">&quot;bottom&quot;</span> <span class="token comment">// 默认textBaseline为bottom</span>
  ctx<span class="token punctuation">.</span><span class="token function">fillText</span><span class="token punctuation">(</span><span class="token string">'12'</span><span class="token punctuation">,</span> <span class="token number">140</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>

  ctx<span class="token punctuation">.</span>textBaseline <span class="token operator">=</span> <span class="token string">&quot;top&quot;</span>
  ctx<span class="token punctuation">.</span><span class="token function">fillText</span><span class="token punctuation">(</span><span class="token string">'12'</span><span class="token punctuation">,</span> <span class="token number">140</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>

  ctx<span class="token punctuation">.</span>textBaseline <span class="token operator">=</span> <span class="token string">&quot;middle&quot;</span>
  ctx<span class="token punctuation">.</span><span class="token function">fillText</span><span class="token punctuation">(</span><span class="token string">'12'</span><span class="token punctuation">,</span> <span class="token number">140</span><span class="token punctuation">,</span> <span class="token number">140</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>

  <span class="token comment">// 绘制measureText的测试矩形区域</span>
  ctx<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span>strokeStyle <span class="token operator">=</span> <span class="token string">&quot;rgb(0,0,255,.5)&quot;</span>
  ctx<span class="token punctuation">.</span><span class="token function">rect</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">140</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>
  ctx<span class="token punctuation">.</span><span class="token function">stroke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 需要在40px宽度的位置绘制Hello，用measureText(str), 确定字体后再绘制</span>
  <span class="token keyword">var</span> fontsize <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span>font <span class="token operator">=</span> fontsize <span class="token operator">+</span> <span class="token string">&quot;px Arial&quot;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">measureText</span><span class="token punctuation">(</span><span class="token string">'Hello'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>width <span class="token operator">&gt;</span> <span class="token number">40</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fontsize<span class="token operator">--</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>font <span class="token operator">=</span> fontsize <span class="token operator">+</span> <span class="token string">&quot;px Arial&quot;</span>
  <span class="token punctuation">}</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fontsize<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">measureText</span><span class="token punctuation">(</span><span class="token string">'Hello'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>width<span class="token punctuation">)</span>
  ctx<span class="token punctuation">.</span>textBaseline <span class="token operator">=</span> <span class="token string">&quot;top&quot;</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span>textAlign <span class="token operator">=</span> <span class="token string">&quot;start&quot;</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">fillText</span><span class="token punctuation">(</span><span class="token string">'Hello'</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">140</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="变换"><a href="#变换" class="header-anchor">#</a> 变换</h3> <p>2D 绘图上下文提供了多个用于变换画布的 API</p> <ul><li><code>ctx.rotate(angle)</code> 围绕原点把图像旋转 angle 角度 Math.PI 为 180°，旋转后，整个画布都旋转了。初始坐标也会跟着旋转。</li> <li><code>scale(scaleX, scaleY)</code> 通过在 x 轴乘以 scaleX，在 y 轴乘以 scaleY 来缩放图像。默认值都是 1.0</li> <li><code>translate(x, y)</code> 把原点移动到 (x, y)，原点会从原来的 (0, 0) 变更到 (x, y)</li> <li><code>transform(m1_1, m1_2, m2_1, m2_2, dx, dy)</code> 通过矩阵乘法直接修改矩阵</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>m1_1 m1_2 dx
m2_1 m2_2 dy
<span class="token number">0</span>    <span class="token number">0</span>    <span class="token number">1</span>
</code></pre></div><ul><li>setTransform(m1_1, m1_2, m2_1, m2_2, dx, dy) 把矩阵重置为默认值，再以传入的参数调用 transform</li></ul> <p>来看一个例子</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>drawing<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>200<span class="token punctuation">&quot;</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>200<span class="token punctuation">&quot;</span></span> <span class="token style-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span><span class="token style language-css"><span class="token property">border</span><span class="token punctuation">:</span>1px solid #ccc<span class="token punctuation">;</span></span><span class="token punctuation">'</span></span></span><span class="token punctuation">&gt;</span></span>A draw of something.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">let</span> drawing <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'drawing'</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> ctx <span class="token operator">=</span> drawing<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'2d'</span><span class="token punctuation">)</span>
  ctx<span class="token punctuation">.</span><span class="token function">beginPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 绘制外圆</span>
  ctx<span class="token punctuation">.</span><span class="token function">arc</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
  <span class="token comment">// 绘制内圆</span>
  ctx<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span><span class="token number">194</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
  ctx<span class="token punctuation">.</span><span class="token function">arc</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">94</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>

  ctx<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token comment">// 移动原点到表盘中心</span>
  
  <span class="token comment">// 旋转图像</span>
  <span class="token comment">// ctx.rotate(Math.PI / 3) // 围绕原点将图像旋转 60°</span>
  <span class="token comment">// ctx.rotate(Math.PI / 2) // 围绕原点将图像旋转 90°</span>
  <span class="token comment">// ctx.rotate(Math.PI) // 围绕原点将图像旋转 180°</span>

  <span class="token comment">// 绘制分针与时针</span>
  ctx<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>   <span class="token comment">// 相当于原来的 (100, 100)</span>
  ctx<span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">85</span><span class="token punctuation">)</span> <span class="token comment">// 相当于原来的 (100, 15)</span>
  ctx<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>   <span class="token comment">// 相当于原来的 (100, 100)</span>
  ctx<span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">65</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// 相当于原来的 (35, 100)</span>

  ctx<span class="token punctuation">.</span><span class="token function">stroke</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><img src="/images/js/canvas_change.png" alt="canvas_change.png"></p> <p>此外，2D 绘图上下文还提供了 2 个函数，用于保存和恢复 fillStyle、strokeStyle 和变换的设置。</p> <ul><li><code>ctx.save()</code> 将当前的 fillStyle, strokeStyle，变换的设置保存到栈中</li> <li><code>ctx.restore()</code> 从栈中恢复之前保存的设置</li></ul> <p>来看一个例子</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>drawing<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>200<span class="token punctuation">&quot;</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>200<span class="token punctuation">&quot;</span></span> <span class="token style-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span><span class="token style language-css"><span class="token property">border</span><span class="token punctuation">:</span>1px solid #ccc<span class="token punctuation">;</span><span class="token property">width</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span></span><span class="token punctuation">'</span></span></span><span class="token punctuation">&gt;</span></span>A draw of something.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">let</span> drawing <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'drawing'</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> ctx <span class="token operator">=</span> drawing<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'2d'</span><span class="token punctuation">)</span>

  ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">&quot;red&quot;</span>
  ctx<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 将当前设置存到栈中</span>

  ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">&quot;green&quot;</span>
  ctx<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
  ctx<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 将当前设置存到栈中</span>

  ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">'blue'</span>
  ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span> <span class="token comment">// 在 (100, 100) 的位置绘制蓝色矩形</span>

  ctx<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span> <span class="token comment">// 在 (110, 110) 的位置绘制绿色矩形</span>

  ctx<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span> <span class="token comment">// 在 (0, 0) 的位置绘制红色矩形</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><img src="/images/js/save_restore.png" alt="save_restore.png"></p> <h3 id="绘制图形"><a href="#绘制图形" class="header-anchor">#</a> 绘制图形</h3> <p><code>ctx.drawImage()</code> 可以用来在画布上绘制图片，有三种传参方式：</p> <ul><li>3参 ctx.drawImage(image, x, y) 在画布 (x, y) 位置，开始绘制 image</li> <li>5参 ctx.drawImage(image, x, y, width, height)， 在画布 (x, y) 位置，开始绘制 image，绘制的 image 宽为 width, 高为 height</li> <li>9参 ctx.drawImage(image, 源图像x坐标, 源图像y坐标, 源图像width, 源图像height, 目标图像x坐标，目标图像y坐标，目标图像width，目标图像height)，从原图像的 (x, y) 坐标开始截图 width * height 大小的图片，绘制到画布 (x,y) 坐标位置</li></ul> <p>注意：图片加载是异步的，如果不等 image 加载完，drawImage() 会无效，参考：<a href="https://zhidao.baidu.com/question/500218334361912884.html" target="_blank" rel="noopener noreferrer">canvas的drawImage()方法，图片不显示<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
  <span class="token selector">canvas</span> <span class="token punctuation">{</span> <span class="token property">border</span><span class="token punctuation">:</span> 1px solid #ccc<span class="token punctuation">;</span> <span class="token property">width</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token selector">.sec</span> <span class="token punctuation">{</span> <span class="token property">margin-right</span><span class="token punctuation">:</span>20px<span class="token punctuation">;</span><span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>图片原大小: 1078*681，下面展示的大小 100*300<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>cavasimg.png<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>500<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token style-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token style language-css"><span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sec<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span> 
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>ctx.drawImage(image, 10, 10)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>drawing<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>200<span class="token punctuation">&quot;</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>200<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sec<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span> ctx2.drawImage(image, 10, 10, 100, 50)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>drawing2<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>200<span class="token punctuation">&quot;</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>200<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>sec<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>ctx3.drawImage(image, 100, 0, 150, 150, 10, 10, 150, 150)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>drawing3<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>200<span class="token punctuation">&quot;</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>200<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">var</span> image <span class="token operator">=</span> document<span class="token punctuation">.</span>images<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  image<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> drawing <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'drawing'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> ctx <span class="token operator">=</span> drawing<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'2d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 从(10,10) 开始绘制 image，不改变原图大小</span>
    ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> 

    <span class="token keyword">var</span> drawing2 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'drawing2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> ctx2 <span class="token operator">=</span> drawing2<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'2d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 从(10,10) 开始绘制 image，设置绘制的图片大小为 100*50</span>
    ctx2<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span> 

    <span class="token keyword">var</span> drawing3 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'drawing3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> ctx3 <span class="token operator">=</span> drawing3<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'2d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 从原图像的 (100, 0) 坐标开始，截图宽 150 高 150 的图片，</span>
    <span class="token comment">// 然后在画布 (10,10) 的位置开始绘制图形，宽为 150, 高为150</span>
    ctx3<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">)</span> 
    
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><img src="/images/js/canvas_img.png" alt="canvas_img.png"></p> <h3 id="阴影"><a href="#阴影" class="header-anchor">#</a> 阴影</h3> <p>2D 绘图上下文可以根据以下属性的值，自动为已有形状或路径生成阴影</p> <ul><li><code>ctx.shadowColor</code> css颜色值，阴影颜色，默认为黑色</li> <li><code>ctx.shadowOffsetX</code> 阴影相对于形状或路径的 x 坐标偏移量, 默认为 0</li> <li><code>ctx.shadowOffsetY</code> 阴影相对于形状或路径的 y 坐标偏移量, 默认为 0</li> <li><code>ctx.shadowBlur</code> 阴影的模糊量，默认为 0，表示不模糊</li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>drawing<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>200<span class="token punctuation">&quot;</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>200<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">var</span> drawing <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'drawing'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> ctx <span class="token operator">=</span> drawing<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'2d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 设置阴影</span>
  ctx<span class="token punctuation">.</span>shadowOffsetX <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span>shadowOffsetY <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span>shadowBlur <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment">// 模糊像素</span>
  ctx<span class="token punctuation">.</span>shadowColor <span class="token operator">=</span> <span class="token string">&quot;rgba(0, 0, 0, 0.5)&quot;</span><span class="token punctuation">;</span>
  <span class="token comment">// 1.1 绘制红色矩形，会自带阴影</span>
  ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">&quot;#ff0000&quot;</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 1.2 绘制蓝色矩形，会自带阴影</span>
  ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">&quot;blue&quot;</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><img src="/images/js/canvas_shadow.png" alt="canvas_shadow.png"></p> <h3 id="渐变"><a href="#渐变" class="header-anchor">#</a> 渐变</h3> <p>渐变使用 CanvasGradient 实例表示。可以通过下面两个方法来创建渐变</p> <ul><li><code>ctx.createLinearGradient(startX, startY, endX, endY)</code> 创建一个线性渐变 CanvasGradient 实例。</li> <li><code>ctx.createRadialGradient(起点圆心x, 起点圆心y, 起点圆半径r, 终点圆心x, 终点圆心y, 终点圆半径r)</code> 创建一个径向渐变（放射性渐变）实例。</li></ul> <p>创建 CanvasGradient 实例后，可以使用实例的方法来指定渐变的过渡颜色</p> <ul><li><code>addColorStop(渐变位置，颜色)</code> 渐变位置是 0 到 1 之间的值，0 表示开始位置，1 表示结束位置。0.5 表示中间位置。</li></ul> <p>来看一个实例</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>drawing<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>200<span class="token punctuation">&quot;</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>200<span class="token punctuation">&quot;</span></span> <span class="token style-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token style language-css"><span class="token property">border</span><span class="token punctuation">:</span>1px solid #ccc<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">var</span> drawing <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'drawing'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> ctx <span class="token operator">=</span> drawing<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'2d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 设置线性渐变 从(30 ,30) 到 (60,60) 渐变</span>
  <span class="token keyword">var</span> gradient <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">createLinearGradient</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  gradient<span class="token punctuation">.</span><span class="token function">addColorStop</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'white'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 渐变的起点色为白色</span>
  <span class="token comment">// gradient.addColorStop(0.5, 'blue'); </span>
  gradient<span class="token punctuation">.</span><span class="token function">addColorStop</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'black'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 渐变的结束色为白色</span>
  <span class="token comment">// 绘制红色矩形</span>
  ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">'red'</span>
  ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 绘制线性渐变矩形</span>
  ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> gradient<span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span>

  <span class="token comment">// 绘制辐射渐变, 绘制从 (150, 25) 起点，0 为半径的圆。到终点 (150, 25)，半径为 30 的圆渐变。</span>
  <span class="token keyword">var</span> gradient <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">createRadialGradient</span><span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span> 
  gradient<span class="token punctuation">.</span><span class="token function">addColorStop</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'red'</span><span class="token punctuation">)</span>
  gradient<span class="token punctuation">.</span><span class="token function">addColorStop</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'blue'</span><span class="token punctuation">)</span>
  ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> gradient
  ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span><span class="token number">125</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><img src="/images/js/canvas_gradient.png" alt="canvas_gradient.png"></p> <h3 id="图案-pattern"><a href="#图案-pattern" class="header-anchor">#</a> 图案 pattern</h3> <p>patter 图案，之前翻译为 模式，用于填充和描绘重复图像。创建新图案，可以使用下面的方法</p> <ul><li><code>cxt.createPattern(html 中的 img 元素, 指定如果重复图像的字符串)</code> 第二个参数的值与 CSS 的 background-repeat 属性时一样的，包括：repeat、repeat-x、repeat-y、no-repeat</li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>images/img.png<span class="token punctuation">&quot;</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>50<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>50<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>drawing<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>200<span class="token punctuation">&quot;</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>200<span class="token punctuation">&quot;</span></span> <span class="token style-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token style language-css"><span class="token property">border</span><span class="token punctuation">:</span>1px solid #ccc<span class="token punctuation">;</span><span class="token property">width</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">var</span> drawing <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'drawing'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> ctx <span class="token operator">=</span> drawing<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'2d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> image <span class="token operator">=</span> document<span class="token punctuation">.</span>images<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  image<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> pattern <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">createPattern</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> <span class="token string">'repeat'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建重复的模式</span>
    <span class="token comment">// var pattern = ctx.createPattern(image, 'repeat-x'); // 创建重复的模式</span>
    <span class="token comment">// var pattern = ctx.createPattern(image, 'repeat-y'); // 创建重复的模式</span>
    <span class="token comment">// var pattern = ctx.createPattern(image, 'no-repeat'); // 创建重复的模式</span>
    ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> pattern<span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><img src="/images/js/canvas_pattern.png" alt="canvas_pattern.png"></p> <h3 id="图像数据-调整图片像素"><a href="#图像数据-调整图片像素" class="header-anchor">#</a> 图像数据/调整图片像素</h3> <ul><li><code>ctx.getImageData(x, y, width, height)</code> 获取图像的原始数据。它返回的结果是 ImageData 对象，包含三个属性
<ul><li><code>width</code> 图像宽度</li> <li><code>height</code> 图像高度</li> <li><code>data</code> 包含原始像素信息的数组。每个像素在数组中都由 4 个值表示：红、绿、蓝、透明度值。第一个像素的信息包含在第 0 - 3 个值中。第二个像素包含在第 4 - 7 个值中。</li></ul></li> <li><code>ctx.putImageData(ImageData实例, x, y)</code> 将图像数据绘制到画布，从坐标 (x,y) 开始</li></ul> <p>我们可以通过更改图像数据创建一个简单的灰阶过滤器，来看下面的例子</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>images/img.png<span class="token punctuation">&quot;</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>50<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>50<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>drawing<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>200<span class="token punctuation">&quot;</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>200<span class="token punctuation">&quot;</span></span> <span class="token style-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token style language-css"><span class="token property">border</span><span class="token punctuation">:</span>1px solid #ccc<span class="token punctuation">;</span><span class="token property">width</span><span class="token punctuation">:</span>100px<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">let</span> drawing <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'drawing'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> ctx <span class="token operator">=</span> drawing<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'2d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> img <span class="token operator">=</span> document<span class="token punctuation">.</span>images<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token comment">// 图片加载完成后再绘制到 canvas</span>
  img<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> imgData <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">getImageData</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> img<span class="token punctuation">.</span>width<span class="token punctuation">,</span> img<span class="token punctuation">.</span>height<span class="token punctuation">)</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> imgData
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>imgData<span class="token punctuation">)</span> <span class="token comment">// { data: Uint8ClampedArray(10000) [], height: 50, width: 50 } </span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> len <span class="token operator">=</span> data<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> <span class="token punctuation">[</span>red<span class="token punctuation">,</span> green<span class="token punctuation">,</span> blue<span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span>
      <span class="token comment">// 取得每个像素的 RGB 平均值</span>
      <span class="token keyword">let</span> average <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">(</span>red <span class="token operator">+</span> green <span class="token operator">+</span> blue<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">)</span>
      <span class="token comment">// 设置 RGB 为平均值，不管透明度</span>
      data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> average
      data<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> average
      data<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> average
    <span class="token punctuation">}</span>
    <span class="token comment">// 修改后将数据写回 ImageData 并应用到画布上</span>
    imgData<span class="token punctuation">.</span>data <span class="token operator">=</span> data
    ctx<span class="token punctuation">.</span><span class="token function">putImageData</span><span class="token punctuation">(</span>imgData<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>效果如下，等价于 CSS 滤镜 <code>filter: grayscale(1)</code> 的效果</p> <p><img src="/images/js/canvas_img_data.png" alt="canvas_img_data.png"></p> <h3 id="合成-composite"><a href="#合成-composite" class="header-anchor">#</a> 合成(composite)</h3> <p>2D 绘制上下文有两个属性，用于设置多个内容重叠时的行为</p> <ul><li><code>ctx.globalAlpha</code> 全局透明度 0 到 1 之间，0.5 为半透明，1 为完全不透明，默认值。书中说的默认值为 0，是错误的，p568。参考：<a href="https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/globalAlpha" target="_blank" rel="noopener noreferrer">CanvasRenderingContext2D.globalAlpha | MDN<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><code>ctx.globalCompositeOperation</code> 设置新绘制的内容与之前绘制的内容重合时，怎么处理，有 11 种情况。需要注意：不同浏览器可能会有差异
<ul><li><code>source-over</code> 默认、新绘制内容在原图形上面，遮盖</li> <li><code>source-in</code> 新图形只绘制出与原图形重叠的部分，原图中其他部分全部透明(不可见)</li> <li><code>source-out</code> 新图形只绘制出不与原图形重叠的部分，原图中其他部分全部透明(不可见)</li> <li><code>source-atop</code> 新图形只绘制出与原图形重叠的部分，原图不受影响</li> <li><code>destination-over</code> 后绘制的内容在先绘制的下面</li> <li><code>destination-in</code> 新图形绘制在原图形下面。原图只有与新图形重叠的部分显示，其他都不可见</li> <li><code>destination-out</code> 新图形与原图形重叠的部分完全透明，其他不受影响</li> <li><code>destination-atop</code> 新图形绘制在原图形的下面，原图形与新图形不重叠的部分全部透明</li> <li><code>lighter</code> 新图形与原图形重叠的部分像素值相加，类似高亮的效果</li> <li><code>copy</code> 新图形完全取代旧图形</li> <li><code>xor</code> 新图形与原图形重叠部分的像素执行 &quot;异或&quot; 计算</li></ul></li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>drawing<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>200<span class="token punctuation">&quot;</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>200<span class="token punctuation">&quot;</span></span> <span class="token style-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token style language-css"><span class="token property">border</span><span class="token punctuation">:</span>1px solid #ccc<span class="token punctuation">;</span><span class="token property">width</span><span class="token punctuation">:</span>100px<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token comment">// 设置全局透明度 ctx.globalAlpha</span>
  <span class="token keyword">var</span> drawing <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'drawing'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> ctx <span class="token operator">=</span> drawing<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'2d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 绘制红色矩形</span>
  ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">'red'</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 修改全局透明度</span>
  ctx<span class="token punctuation">.</span>globalAlpha <span class="token operator">=</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
  <span class="token comment">// 绘制蓝色矩形</span>
  ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">&quot;blue&quot;</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 重置全局透明度</span>
  ctx<span class="token punctuation">.</span>globalAlpha <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// p568， 值为 0，貌似有问题</span>

  ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">'red'</span>
  ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span>
  <span class="token comment">// 设置合成（composite）操作</span>
  <span class="token comment">// ctx.globalCompositeOperation = 'source-over' // 默认、新图像绘制在原图形上面</span>
  <span class="token comment">// ctx.globalCompositeOperation = 'source-in' </span>
  <span class="token comment">// ctx.globalCompositeOperation = 'source-out' </span>
  <span class="token comment">// ctx.globalCompositeOperation = 'source-atop' </span>
  <span class="token comment">// ctx.globalCompositeOperation = 'destination-over' // 后绘制的位于先绘制的下面</span>
  <span class="token comment">// ctx.globalCompositeOperation = 'destination-in' </span>
  <span class="token comment">// ctx.globalCompositeOperation = 'destination-out'</span>
  <span class="token comment">// ctx.globalCompositeOperation = 'destination-atop'</span>
  <span class="token comment">// ctx.globalCompositeOperation = 'lighter'</span>
  <span class="token comment">// ctx.globalCompositeOperation = 'copy'</span>
  <span class="token comment">// ctx.globalCompositeOperation = 'xor'</span>
  ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">'rgba(0,0,255,1)'</span>
  ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span><span class="token number">125</span><span class="token punctuation">,</span> <span class="token number">125</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>上的例子中，在绘制蓝色矩形之前，将  ctx.globalCompositeOperation 设置为各种值，效果如下：</p> <p><img src="/images/js/canvas_compsition.png" alt="canvas_compsition.png"></p> <h2 id="webgl"><a href="#webgl" class="header-anchor">#</a> WebGL</h2> <p>WebGL 是 canvas(画布) 的 3D 上下文。它不是 W3C 的标准，而是 Khronos Group 的标准。</p> <blockquote><p>Khronos Group 是非盈利性、会员资助的联盟，专注于多平台和设备下并行计算、图形和动态媒体的无专利费开放标准。Khronos Group 也定制了其他图形 API, 包括作为浏览器中 WebGL 基础的 OpenGL ES2.0</p></blockquote> <p>建议先了解 OpenGL ES2.0 基本概念，再看本节内容，推荐一个 WebGL 教程网站：Learn WebGL。定型数组(typed array)/类型数组是 WebGL 中执行操作的重要数据结构，详情参见第 6 章。</p> <h3 id="webgl-上下文"><a href="#webgl-上下文" class="header-anchor">#</a> WebGL 上下文</h3> <p>2D 绘图上下文获取上下文时，使用的是 &quot;2d&quot;。3D 绘图上下文 WebGL 也有对应的值。WebGL 2.0 参数是 &quot;webgl2&quot;，返回类型为 WebGL2RenderingContext。WebGL 1.0 上下文参数为 &quot;webgl&quot;，类型为 WebGLRenderingContext。如果浏览器不支持 WebGL 则返回 null。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>drawing<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>200<span class="token punctuation">&quot;</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>200<span class="token punctuation">&quot;</span></span> <span class="token style-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token style language-css"><span class="token property">border</span><span class="token punctuation">:</span>1px solid #ccc<span class="token punctuation">;</span><span class="token property">width</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">let</span> drawing <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'drawing'</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> gl <span class="token operator">=</span> drawing<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'webgl'</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>gl<span class="token punctuation">)</span> <span class="token comment">// WebGLRenderingContext {}</span>
  <span class="token comment">// let gl= drawing.getContext('webgl1') // null</span>
  <span class="token comment">// console.log(gl) // null</span>
  <span class="token comment">// let gl = drawing.getContext('webgl2')</span>
  <span class="token comment">// console.log(gl) // WebGL2RenderingContext {}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>WebGL 上下文实例，一般命名为 gl</p> <h3 id="webgl基础"><a href="#webgl基础" class="header-anchor">#</a> WebGL基础</h3> <p>获取 WebGL 上下文后，就可以开始 3D 绘图了。由于 WebGL 是 OpenGL ES2.0 在 Web 中的实现，这里讨论的概率实际上都是 JS 实现的 OpenGL 概念。</p> <p>使用 getContext() 获取 WebGL 上下文时，还可以通过第二个参数指定一些选项，第二个参数是一个 options 对象。可以包含如下属性：</p> <ul><li><code>alpha</code> 布尔值，是否为上下文创建透明通道缓冲区，默认为 true</li> <li><code>depth</code> 布尔值，是否使用 16 位深缓冲区，默认为 true</li> <li><code>stencil</code> 布尔值，是否使用 8 位魔板缓冲区，默认为 false</li> <li><code>antialias</code> 布尔值，是否使用默认机制执行抗锯齿操作，默认为 true</li> <li><code>premultipliedAlpha</code> 布尔值，绘图缓冲区是否预乘透明度值，默认为 true</li> <li><code>preserveDrawingBuffer</code> 布尔值，表示绘图完成后是否保留绘图缓冲区，默认为 false</li></ul> <p>注意：修改默认值，可能会影响性能。由于有些浏览器在调用 getContext() 不能创建 WebGL上下文时会抛出错误，影响后面代码执行，因此使用时最好用 try/catch 包裹。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>drawing<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>200<span class="token punctuation">&quot;</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>200<span class="token punctuation">&quot;</span></span> <span class="token style-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token style language-css"><span class="token property">border</span><span class="token punctuation">:</span>1px solid #ccc<span class="token punctuation">;</span><span class="token property">width</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">let</span> drawing <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'drawing'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      gl<span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
     gl <span class="token operator">=</span> drawing<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'webgl'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      alpha<span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 什么也不做</span>
  <span class="token punctuation">}</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>gl<span class="token punctuation">)</span> <span class="token comment">// WebGLRenderingContext {}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>gl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果 gl 存在</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>1. 常量</strong>，在 OpenGL 中，用于操作的各种常量都是以 GL_ 开头，在 WebGL 上下文中，常量不包含 GL_ 前缀。例子 GL_COLOR_BUFFER_BIT 常量在 WebGL 中要使用 gl.COLOR_BUFFER_BIT 访问。</p> <p><strong>2. 方法命名</strong>，WebGL 中的很多方法名中会包含数据类型，及参数个数信息。比如 gl.uniform4f() 表示需要 4 个浮点数值参数，而 gl.uniform3i() 表示需要 3 个整数值参数。数组类型一般使用字母 v 表示（&quot;vector&quot;）。gl.uniform3iv() 表示要接收一个包含三个值的数组参数。</p> <p><strong>3. 准备绘图</strong>，在绘图之前，需要先指定一种颜色，清除绘制区域 gl.clearColor(r, g, b, a)。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 使用黑色清除绘制区域</span>
gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment">// 使用之前定义的颜色填充画布，canvas 会被填充为黑色</span>
gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>4. 视口与坐标</strong>，绘图前还要定义 WebGL 视口，默认情况下视口使用整个 canvas 区域。要改变视口，可以调用 viewport() 方法并传入视口相对于 canvas 元素的 x, y 坐标及高度和高度。<strong>注意：定义视口时 (0, 0) 是左下角</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 使用整个 canvas 区域作为视口</span>
gl<span class="token punctuation">.</span><span class="token function">viewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> drawing<span class="token punctuation">.</span>width<span class="token punctuation">,</span> drawing<span class="token punctuation">.</span>height<span class="token punctuation">)</span>
<span class="token comment">// 视口是 canvas 左下角 1/4 区域</span>
gl<span class="token punctuation">.</span><span class="token function">viewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> drawing<span class="token punctuation">.</span>width<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span> drawing<span class="token punctuation">.</span>height<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token comment">// 视口是 canvas 左上角 1/4 区域</span>
gl<span class="token punctuation">.</span><span class="token function">viewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> drawing<span class="token punctuation">.</span>height<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span> drawing<span class="token punctuation">.</span>width<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span> drawing<span class="token punctuation">.</span>height<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token comment">// 视口是右下角 1/4 区域</span>
gl<span class="token punctuation">.</span><span class="token function">viewport</span><span class="token punctuation">(</span>drawing<span class="token punctuation">.</span>width<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> drawing<span class="token punctuation">.</span>width<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span> drawing<span class="token punctuation">.</span>height<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre></div><p>定义视口时的坐标系统和视口中的坐标系统不一样。(0, 0) 是视口的中心点。左下角是 (-1, -1)，右上角是 (1, 1)</p> <p><strong>5.缓冲区</strong>，JS 中，定点信息保存在 typed array 中，要使用这些信息，需要先把他们转换为 WebGL 缓冲区。</p> <ul><li><code>gl.createBuffer()</code> 创建 WebGL 缓冲区，返回一个 WebGLBuffer 实例。</li> <li><code>gl.bindBuffer(target, WebGLBuffer实例)</code> 将 WebGL 缓冲区，绑定到 WebGL 上下文，绑定后就可以用数据填充缓冲区了。target 的值可以是:
<ul><li><code>gl.ARRAY_BUFFER</code>：包含顶点属性的缓冲区，例如顶点坐标，纹理坐标数据或顶点颜色数据。</li> <li><code>gl.ELEMENT_ARRAY_BUFFER</code> 用于元素数组缓冲区。</li></ul></li> <li><code>gl.bufferData(target, typed array数据, 如果使用缓冲区)</code> 使用 JS typed array 数据初始化当前 WebGL 缓冲区，将 JS 数组内容写入 buffer。第 3 个参数表示如何使用缓冲区，可以是以下常量值：
<ul><li><code>gl.STATIC_DRAW</code> 数据加载一次，可以在多次绘制中使用。<strong>最常用</strong></li> <li><code>gl.STREAM_DRAW</code> 数据加载一次，只能在几次绘制中使用。</li> <li><code>gl.DYNAMIC_DRAW</code> 数据可以重复修改，在多次绘制中使用。</li></ul></li> <li><code>gl.deleteBuffer()</code> 缓冲区会一直驻留在内存中，知道页面 unload 卸载。可以使用 gl.deleteBuffer() 释放其占用的内容。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 创建 WebGL 缓存区</span>
<span class="token keyword">let</span> buffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token comment">// 将 buffer 设置为上下文的当前缓冲区</span>
gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span> 
<span class="token comment">// 使用一个 Float32Array 数组初始化 buffer（将内容写入 buffer）</span>
<span class="token comment">// 通常把所有顶点点信息保存在 Float32Array 中</span>
gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span>

<span class="token comment">// 如果不需要缓冲区了，可以释放其内存</span>
fl<span class="token punctuation">.</span><span class="token function">deleteBuffer</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span>
</code></pre></div><p><strong>6. 错误</strong>，WebGL 通常不会像 JS 那样直接抛出错误。必须在可能会执行失败的方法后，调用 gl.getError() ，该方法返回一个常量，表示错误类型，其值可能是：</p> <ul><li><code>gl.NO_ERROR</code> 上一次操作没错误发生 (0)</li> <li><code>gl.INVALID_ENUM</code> 上一次操作没有传入 WebGL 预定义的常量</li> <li><code>gl.INVALID_VALE</code> 上一次操作需要无符号数，但传入了负数</li> <li><code>gl.INVALID_OPERATION</code> 上一次操作在当前状态下无法完成</li> <li><code>gl.OUT_OF_MEMORY</code> 上一次操作因内存不足无法完成</li> <li><code>gl.CONTEXT_LOST_WEBGL</code> 上一次操作因为外部事件（如停电）而丢失了 WebGL 上下文</li></ul> <p>如果有多个错误，需要多次调用 gl.getError()，直到返回 gl.NO_ERROR（数值0）为止</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> errorCode <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getError</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>errorCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Error: &quot;</span><span class="token punctuation">,</span> errorCode<span class="token punctuation">)</span>
  errorCode <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getError</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>7. 着色器</strong>，WebGL 中有两种着色器：</p> <ul><li><strong>顶点着色器</strong>，用于把 3D 顶点转换为可以渲染的 2D 点。</li> <li><strong>片段(或像素)着色器</strong>，用于计算绘制一个像素的正确颜色。</li></ul> <p>WebGL 着色器不是 JS 实现的，而是使用类似于 C 语言的 GLSL(OpenGL Shading Language) 语言写的。每个着色器都有一个 main() 方法，会绘制期间重复执行。给着色器传递数据的方式有两种：</p> <ul><li>attribute 用于将顶点传入顶点着色器</li> <li>uniform 用于将常量值传入任何着色器。</li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- 顶点着色器 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-webgl/x-vertex-shader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token comment">// 定义一个顶点着色器 aVertexPosition</span>
<span class="token comment">// vec2 数据类型，包含两项的数组，(x, y)</span>
attribute vec2 aVertexPosition<span class="token punctuation">;</span> 
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  gl_position <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span>aVertexPosition<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 片段着色器 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-webgl/x-fragment-shader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token comment">// 定义一个片段着色器 uColor</span>
uniform vec4 uColor<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  gl_FragColor <span class="token operator">=</span> uColor
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">let</span> vertexGlsl <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElmentById</span><span class="token punctuation">(</span><span class="token string">&quot;vertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
  <span class="token keyword">let</span> fragmentGlsl <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;fragmentShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>有了着色器代码的字符串，下一步是创建着色器（shader）对象</p> <ul><li><code>gl.createShader(shader_type)</code> 创建着色器（shader）对象，类型为 WebGLShader，着色器类型有两种：<code>gl.VERTEX_SHADER</code> 或 <code>gl.FRAGMENT_SHADER</code>。分别对应顶点着色器和片段着色器</li> <li><code>gl.shaderSource(着色器对象, GLSL着色器代码)</code> 将 GLSL 代码应用到着色器对象</li> <li><code>gl.compileShader(着色器对象)</code> 编译着色器</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> vertexShader <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createShader</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">VERTEX_SHADER</span><span class="token punctuation">)</span>
gl<span class="token punctuation">.</span><span class="token function">shaderSource</span><span class="token punctuation">(</span>vertexShader<span class="token punctuation">,</span> vertexGlsl<span class="token punctuation">)</span>
gl<span class="token punctuation">.</span><span class="token function">compileShader</span><span class="token punctuation">(</span>vertexShader<span class="token punctuation">)</span>

<span class="token keyword">let</span> fragmentShader <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createShader</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">FRAGMENT_SHADER</span><span class="token punctuation">)</span>
gl<span class="token punctuation">.</span><span class="token function">shaderSource</span><span class="token punctuation">(</span>fragmentShader<span class="token punctuation">,</span> fragmentGlsl<span class="token punctuation">)</span>
gl<span class="token punctuation">.</span><span class="token function">compileShader</span><span class="token punctuation">(</span>fragmentShader<span class="token punctuation">)</span>
</code></pre></div><p>上面的代码中，创建了两个着色器对象，还需要把着色器对象链接到着色器程序</p> <ul><li><code>gl.createProgram()</code> 用于创建着色器程序（WebGLProgram）对象，它由两个编译过后的 WebGLShader 组成 - 顶点着色器和片段着色器（均由 GLSL 语言所写）。这些组合成一个可用的 WebGL 着色器程序。</li> <li><code>gl.attachShader(着色器程序对象, 着色器对象)</code> 负责向 WebGLProgram 对象添加一个片段或者顶点着色器。</li> <li><code>gl.linkProgram(着色器程序对象)</code> 链接着色器程序，完成片段着色器和顶点着色器 GPU 代码的准备工作</li> <li><code>gl.userProgram(着色器程序对象)</code> 应用着色器程序到当前渲染状态中，后续的绘制操作都会使用这个程序</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> program <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createProgram</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
gl<span class="token punctuation">.</span><span class="token function">attachShader</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> vertexShader<span class="token punctuation">)</span>
gl<span class="token punctuation">.</span><span class="token function">attachShader</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> fragmentShader<span class="token punctuation">)</span>
gl<span class="token punctuation">.</span><span class="token function">linkProgram</span><span class="token punctuation">(</span>program<span class="token punctuation">)</span>
gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>program<span class="token punctuation">)</span>
</code></pre></div><p>前面的着色器都需要传入一个值，才能工作。对于顶点</p> <ul><li><code>gl.getUniformLocation(program, name)</code> 返回着色器程序 program 中名为 name 的片段着色器内存地址。类型：WebGLUniformLocation</li> <li><code>gl.uniform4fv(A WebGLUniformLocation object, value)</code> 为着色器设置值，参考：<a href="https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/uniform" target="_blank" rel="noopener noreferrer">WebGLRenderingContext.uniform[1234][fi][v] | MDN<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><code>gl.getAttribLocation(program, name)</code> 返回着色器程序 program 中名为 name 的顶点着色器内存地址。类型：WebGLUniformLocation</li> <li><code>gl.enableVertexAttribArray(WebGLUniformLocation实例)</code> 激活内存地址（索引）</li> <li><code>gl.vertexAttribPointer(index, size, type, normalized, stride, offset)</code> 告诉显卡从当前绑定的缓冲区（bindBuffer()指定的缓冲区）中读取顶点数据。index 指定要修改的顶点属性的索引，size 指定每个顶点属性的组成数量，必须是1，2，3或4。type 指定数组中每个元素的数据类型，normalized 当转换为浮点数时是否应该将整数数值归一化到特定的范围。stride 指定连续顶点属性开始之间的偏移量(即数组中一行长度)。offset 指定顶点属性数组中第一部分的字节偏移量。参考：<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/WebGLRenderingContext/vertexAttribPointer" target="_blank" rel="noopener noreferrer">WebGLRenderingContext.vertexAttribPointer() | MDN<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 在着色器程序 program 中，找到片段着色器 uColor 的内存位置</span>
<span class="token keyword">let</span> uColor <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">&quot;uColor&quot;</span><span class="token punctuation">)</span>
<span class="token comment">// 向 uColor 内存位置，写入值 [0, 0, 0, 1]</span>
gl<span class="token punctuation">.</span><span class="token function">uniform4fv</span><span class="token punctuation">(</span>uColor<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">// 取得顶点着色器 aVertexPosition 的内存位置(索引)</span>
<span class="token keyword">let</span> aVertexPpsition <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">&quot;aVertexPosition&quot;</span><span class="token punctuation">)</span>
<span class="token comment">// 激活索引</span>
gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>aVertexPosition<span class="token punctuation">)</span>
<span class="token comment">// 从当前缓冲区(bindBuffer()指定的缓冲区)读取顶点数据</span>
<span class="token keyword">let</span> vertexSetSize <span class="token operator">=</span> <span class="token number">2</span>
gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>aVertexPosition<span class="token punctuation">,</span> vertexSetSize<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>一般着色器操作的失败是静默的，不会抛出真实的错误，需要自己去捕获。</strong>，如果我们跑上面的例子会发现，在控制台有 warning：<code>WebGL: INVALID_OPERATION: useProgram: program not valid</code>，着色器程序是无效的。用以下方法可以进行调试</p> <ul><li><code>gl.getShaderParameter(shader实例, pname)</code> 返回着色器实例的 pname 信息， pname 的可选值如下：
<ul><li><code>gl.COMPILE_STATUS</code> 着色器是否编译成功 true or false</li> <li><code>gl.DELETE_STATUS</code> 着色器是否被删除 true or false</li> <li><code>gl.SHADER_TYPE</code> 着色器类型（顶点着色器，还是片段着色器）</li></ul></li> <li><code>gl.getShaderInfoLog(shader实例)</code> 获取着色器 log 信息，It contains warnings, debugging and compile information.</li></ul> <p>我们使用上面的两个函数可以读取到 fragmentShader 编译的错误信息：<code>ERROR: 0:2: '' : No precision specified for (float)</code> 片段着色器代码没有添加精度描述，在前面加上一句 <code>precision mediump float;</code> 16 位浮点格式，即可</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>gl<span class="token punctuation">.</span><span class="token function">getShaderParameter</span><span class="token punctuation">(</span>fragmentShader<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">COMPILE_STATUS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token function">getShaderInfoLog</span><span class="token punctuation">(</span>fragmentShader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>另外也可以通过 <code>gl.getProgramParameter()</code> 和 <code>gl.getProgramInfoLog()</code> 获取着色器程序的 log 信息</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token function">getProgramParameter</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINK_STATUS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token function">getProgramInfoLog</span><span class="token punctuation">(</span>program<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>8. 绘图</strong> WebGL 只能绘制三种形状：点、线和三角形。绘图需要使用下面两个函数</p> <ul><li><code>gl.drawArrays(mode, first, count)</code> Renders primitives from array data. 使用数组缓冲区绘制图元，first GLint 类型 ，指定从哪个点开始绘制。count GLsizei 类型，指定绘制需要使用到多少个点。</li> <li><code>gl.drawElements(mode, count, type, offset)</code> 使用 元素数组缓冲区绘制图元</li></ul> <p>mode，GLenum 类型，指定绘制图元的方式，可能值如下。</p> <ul><li><code>gl.POINTS</code> 绘制一系列点。</li> <li><code>gl.LINE_STRIP</code> 绘制一个线条。即，绘制一系列线段，上一点连接下一点。</li> <li><code>gl.LINE_LOOP</code> 绘制一个线圈。即，绘制一系列线段，上一点连接下一点，并且最后一点与第一个点相连。</li> <li><code>gl.LINES</code> 绘制一系列单独线段。每两个点作为端点，线段之间不连接。</li> <li><code>gl.TRIANGLE_STRIP</code> 绘制一个三角带。</li> <li><code>gl.TRIANGLE_FAN</code> 绘制一个三角扇。</li> <li><code>gl.TRIANGLES</code> 绘制一系列三角形。每三个点作为顶点。</li></ul> <p>完整绘制三角形代码</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>drawing<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>200<span class="token punctuation">&quot;</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>200<span class="token punctuation">&quot;</span></span> <span class="token style-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token style language-css"><span class="token property">border</span><span class="token punctuation">:</span>1px solid #ccc<span class="token punctuation">;</span><span class="token property">width</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 顶点着色器 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-webgl/x-vertex-shader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vertexShader<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
attribute vec2 aVertexPosition<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  gl_Position <span class="token operator">=</span> <span class="token function">vec4</span><span class="token punctuation">(</span>aVertexPosition<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 片段着色器 --&gt;</span>
<span class="token comment">&lt;!-- precision mediump float; --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>x-webgl/x-fragment-shader<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>fragmentShader<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
precision mediump float<span class="token punctuation">;</span>
uniform vec4 uColor<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  gl_FragColor <span class="token operator">=</span> uColor<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">let</span> drawing <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'drawing'</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> gl <span class="token operator">=</span> drawing<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'webgl'</span><span class="token punctuation">)</span>

  <span class="token comment">// 使用白色清除绘制区域</span>
  gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token comment">// 使用之前定义的颜色填充画布，canvas 会被填充为黑色</span>
  gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span>

  <span class="token comment">// 设置视口视口</span>
  gl<span class="token punctuation">.</span><span class="token function">viewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> drawing<span class="token punctuation">.</span>width<span class="token punctuation">,</span> drawing<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 定义三角形，三个顶点信息 typed array 数组</span>
  <span class="token keyword">let</span> vertices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token comment">// x, y 两个点坐标</span>
  <span class="token keyword">let</span> vertexSetSize <span class="token operator">=</span> <span class="token number">2</span>

  <span class="token comment">// 创建 WebGL 缓冲区</span>
  <span class="token keyword">let</span> buffer <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  <span class="token comment">// 将 buffer 设置为上下文的当前缓冲区</span>
  gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span> 
  <span class="token comment">// 使用一个 Float32Array 数组初始化 buffer（将内容写入 buffer）</span>
  <span class="token comment">// 通常把所有顶点点信息保存在 Float32Array 中</span>
  gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> vertices<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span>
  
  <span class="token comment">// 获取 glsl 着色器代码</span>
  <span class="token keyword">let</span> vertexGlsl <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;vertexShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
  <span class="token keyword">let</span> fragmentGlsl <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;fragmentShader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>vertexGlsl<span class="token punctuation">,</span> fragmentGlsl<span class="token punctuation">)</span>

  <span class="token comment">// 根据着色器代码创建着色器实例 vertexShader、fragmentShader</span>
  <span class="token keyword">let</span> vertexShader <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createShader</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">VERTEX_SHADER</span><span class="token punctuation">)</span>
  gl<span class="token punctuation">.</span><span class="token function">shaderSource</span><span class="token punctuation">(</span>vertexShader<span class="token punctuation">,</span> vertexGlsl<span class="token punctuation">)</span>
  gl<span class="token punctuation">.</span><span class="token function">compileShader</span><span class="token punctuation">(</span>vertexShader<span class="token punctuation">)</span>
  <span class="token keyword">let</span> fragmentShader <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createShader</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">FRAGMENT_SHADER</span><span class="token punctuation">)</span>
  gl<span class="token punctuation">.</span><span class="token function">shaderSource</span><span class="token punctuation">(</span>fragmentShader<span class="token punctuation">,</span> fragmentGlsl<span class="token punctuation">)</span>
  gl<span class="token punctuation">.</span><span class="token function">compileShader</span><span class="token punctuation">(</span>fragmentShader<span class="token punctuation">)</span>
  <span class="token comment">// 测试片段着色器编译是否有异常</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>gl<span class="token punctuation">.</span><span class="token function">getShaderParameter</span><span class="token punctuation">(</span>fragmentShader<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">COMPILE_STATUS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token function">getShaderInfoLog</span><span class="token punctuation">(</span>fragmentShader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>vertexShader<span class="token punctuation">,</span> fragmentShader<span class="token punctuation">)</span> <span class="token comment">// WebGLShader {}</span>

  <span class="token comment">// 创建着色器程序</span>
  <span class="token keyword">let</span> program <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createProgram</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  gl<span class="token punctuation">.</span><span class="token function">attachShader</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> vertexShader<span class="token punctuation">)</span>
  gl<span class="token punctuation">.</span><span class="token function">attachShader</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> fragmentShader<span class="token punctuation">)</span>
  gl<span class="token punctuation">.</span><span class="token function">linkProgram</span><span class="token punctuation">(</span>program<span class="token punctuation">)</span>
  gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>program<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>program<span class="token punctuation">)</span> <span class="token comment">// WebGLProgram {}</span>

  <span class="token comment">// 给着色器赋值</span>
  <span class="token comment">// 在着色器程序 program 中，找到片段着色器 uColor 的内存位置</span>
  <span class="token keyword">let</span> uColorLocation <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">&quot;uColor&quot;</span><span class="token punctuation">)</span>
  <span class="token comment">// 向 uColor 内存位置，写入值 [0, 0, 0, 1]</span>
  gl<span class="token punctuation">.</span><span class="token function">uniform4fv</span><span class="token punctuation">(</span>uColorLocation<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token comment">// 取得顶点着色器 aVertexPosition 内存位置(索引)，并将顶点信息传入</span>
  <span class="token keyword">let</span> aVertexPosition <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> <span class="token string">&quot;aVertexPosition&quot;</span><span class="token punctuation">)</span>
  <span class="token comment">// 激活索引</span>
  gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>aVertexPosition<span class="token punctuation">)</span>
  <span class="token comment">// 从当前绑定的缓冲区（bindBuffer()指定的缓冲区）中读取顶点数据</span>
  gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>aVertexPosition<span class="token punctuation">,</span> vertexSetSize<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

  <span class="token comment">// 绘制三角形 从 index 0 开，3 个点</span>
  gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> vertices<span class="token punctuation">.</span>length <span class="token operator">/</span> vertexSetSize<span class="token punctuation">)</span>
  <span class="token comment">// gl.drawArrays(gl.LINE_LOOP, 0, vertices.length / vertexSetSize)</span>
  <span class="token comment">// gl.drawArrays(gl.LINE_STRIP, 0, vertices.length / vertexSetSize)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><img src="/images/js/webgl_triangle.png" alt="webgl_triangle.png"></p> <p><strong>9. 纹理</strong> WebGL 纹理可以使用 DOM 中的图片，详情参考：<a href="https://zhuanlan.zhihu.com/p/52590272" target="_blank" rel="noopener noreferrer">WebGL 纹理详解 - 知乎<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>img.png<span class="token punctuation">&quot;</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>50<span class="token punctuation">&quot;</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>50<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token comment">// 使用现有图片</span>
<span class="token comment">// let image = document.images[0]</span>
<span class="token comment">// 动态加载图片</span>
<span class="token keyword">let</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
image<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&quot;img.png&quot;</span>
image<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 创建纹理</span>
  <span class="token keyword">let</span> texture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 绑定纹理</span>
  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span>
  <span class="token comment">// 开启 FlipY（UNPACK_FLIP_Y_WEBGL）不过不使用这个标准图片会倒过来</span>
  gl<span class="token punctuation">.</span><span class="token function">pixelStorei</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">UNPACK_FLIP_Y_WEBGL</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token comment">// 填充纹理内容</span>
  gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> image<span class="token punctuation">)</span>
  <span class="token comment">// 参数设置</span>
  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MAG_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">NEAREST</span><span class="token punctuation">)</span>
  gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">NEAREST</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>texture<span class="token punctuation">)</span>

  <span class="token comment">// 清除当前纹理</span>
  gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>10. 读取像素</strong>，类似于 2D 上下文中的 <code>ctx.getImage()</code>，WebGL 上下文可以通过 <code>gl.readPixels()</code> 读取像素信息</p> <ul><li>gl.readPixels(x, y, width, height, format, type, pixels) 参考: <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/WebGLRenderingContext/readPixels" target="_blank" rel="noopener noreferrer">WebGLRenderingContext.readPixels() | MDN<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>下面的代码是读取帧缓冲区中 25 x 25 像素区域，把读到的像素信息存入 pixels。其中每个像素的颜色都已 4 个值表示，rgba。每个数值取值 0 ~ 255。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> pixels <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token number">25</span> <span class="token operator">*</span> <span class="token number">25</span><span class="token punctuation">)</span>
gl<span class="token punctuation">.</span><span class="token function">readPixels</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">RGB</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span> pixels<span class="token punctuation">)</span>
</code></pre></div><h3 id="webgl1-与-webgl2"><a href="#webgl1-与-webgl2" class="header-anchor">#</a> WebGL1 与 WebGL2</h3> <p>WebGL1 与 WebGL2 几乎完全兼容，WebGL2 加入了一些扩展。WebGL1 的上下文与 WebGL2 向下文不同。</p> <ul><li>&quot;webgl&quot; (或&quot;experimental-webgl&quot;) 这将创建一个 WebGLRenderingContext 三维渲染上下文对象。只在实现WebGL 版本1(OpenGL ES 2.0)的浏览器上可用。</li> <li>&quot;webgl2&quot; (或 &quot;experimental-webgl2&quot;) 这将创建一个 WebGL2RenderingContext 三维渲染上下文对象。只在实现 WebGL 版本2 (OpenGL ES 3.0)的浏览器上可用。</li></ul> <p>WebGL2 着色器语言 GLSL 从 GLSL 100 升级到 GLSL 300</p> <p>更多 WebGL2 信息参考：<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/WebGL2RenderingContext" target="_blank" rel="noopener noreferrer">WebGL2RenderingContext | MDN<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2020/12/3 下午2:16:53</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/js/ad3/js-ad3-17.html" class="prev">
        17. 事件 - JS高程4
      </a></span> <span class="next"><a href="/js/ad3/js-ad3-19.html">
        19. 表单脚本 - JS高程4
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.222184eb.js" defer></script><script src="/assets/js/2.3f8a6b0b.js" defer></script><script src="/assets/js/81.b0b699ad.js" defer></script><script src="/assets/js/3.018b29e2.js" defer></script>
  </body>
</html>
