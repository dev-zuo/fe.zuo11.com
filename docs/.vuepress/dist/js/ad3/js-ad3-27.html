<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>27. 工作者线程(Web Workers) - JS高程4 | 左小白的前端笔记</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/logo.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon-152x152.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#3eaf7c">
    <meta name="description" content="JavaScript 是单线程的，这样可以保证它与浏览器 API 兼容。如果 JavaScript 可以多线程执行并发更改，那么像 DOM 这样的 API 就会出现问题。单线程意味着不能把工作委托给独立的线程、进程去做。这就是 工作者线程 存在的价值所在：允许把主线的工作转嫁给独立的实体，而不会改变现有的单线程模型。它的特点是独立于 JavaScript 主执行环境。">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/assets/css/0.styles.594b47db.css" as="style"><link rel="preload" href="/assets/js/app.05304cd4.js" as="script"><link rel="preload" href="/assets/js/2.4b3539f1.js" as="script"><link rel="preload" href="/assets/js/85.8ea0a641.js" as="script"><link rel="preload" href="/assets/js/3.e6a4dd76.js" as="script"><link rel="prefetch" href="/assets/js/10.71696328.js"><link rel="prefetch" href="/assets/js/100.af4eb0dd.js"><link rel="prefetch" href="/assets/js/101.799fd293.js"><link rel="prefetch" href="/assets/js/102.ef90d320.js"><link rel="prefetch" href="/assets/js/103.c238a6be.js"><link rel="prefetch" href="/assets/js/104.a99af0df.js"><link rel="prefetch" href="/assets/js/105.3efb51e9.js"><link rel="prefetch" href="/assets/js/106.3d1881fb.js"><link rel="prefetch" href="/assets/js/107.0ed11eb1.js"><link rel="prefetch" href="/assets/js/108.3d265327.js"><link rel="prefetch" href="/assets/js/109.c3abb2af.js"><link rel="prefetch" href="/assets/js/11.f94d3695.js"><link rel="prefetch" href="/assets/js/110.49981c69.js"><link rel="prefetch" href="/assets/js/111.d1d61cbb.js"><link rel="prefetch" href="/assets/js/112.8d76b681.js"><link rel="prefetch" href="/assets/js/113.e345b7e8.js"><link rel="prefetch" href="/assets/js/114.6d851ece.js"><link rel="prefetch" href="/assets/js/115.0eebc982.js"><link rel="prefetch" href="/assets/js/116.2aadb56a.js"><link rel="prefetch" href="/assets/js/117.37e37c52.js"><link rel="prefetch" href="/assets/js/118.1e8f5afa.js"><link rel="prefetch" href="/assets/js/119.2ff36c4f.js"><link rel="prefetch" href="/assets/js/12.5065a0a0.js"><link rel="prefetch" href="/assets/js/120.71db3662.js"><link rel="prefetch" href="/assets/js/121.d57525fa.js"><link rel="prefetch" href="/assets/js/122.a83b24b5.js"><link rel="prefetch" href="/assets/js/123.9f86fe8b.js"><link rel="prefetch" href="/assets/js/124.084523c1.js"><link rel="prefetch" href="/assets/js/125.e9bac513.js"><link rel="prefetch" href="/assets/js/126.c16d4f67.js"><link rel="prefetch" href="/assets/js/127.18fceb32.js"><link rel="prefetch" href="/assets/js/128.9e0458bf.js"><link rel="prefetch" href="/assets/js/129.f759a036.js"><link rel="prefetch" href="/assets/js/13.82e7edce.js"><link rel="prefetch" href="/assets/js/130.49e5429d.js"><link rel="prefetch" href="/assets/js/131.e98fec29.js"><link rel="prefetch" href="/assets/js/132.2af68f32.js"><link rel="prefetch" href="/assets/js/133.2b5d9790.js"><link rel="prefetch" href="/assets/js/134.c3904d3e.js"><link rel="prefetch" href="/assets/js/135.0f89a7a5.js"><link rel="prefetch" href="/assets/js/136.b730b767.js"><link rel="prefetch" href="/assets/js/137.3a58c871.js"><link rel="prefetch" href="/assets/js/138.e2b6fabb.js"><link rel="prefetch" href="/assets/js/139.19b9b802.js"><link rel="prefetch" href="/assets/js/14.47fdb070.js"><link rel="prefetch" href="/assets/js/140.bacebfef.js"><link rel="prefetch" href="/assets/js/141.dcb25d46.js"><link rel="prefetch" href="/assets/js/142.13510333.js"><link rel="prefetch" href="/assets/js/143.c4f8cfbb.js"><link rel="prefetch" href="/assets/js/144.f14b64cf.js"><link rel="prefetch" href="/assets/js/145.3ee999ca.js"><link rel="prefetch" href="/assets/js/146.e8b1eca4.js"><link rel="prefetch" href="/assets/js/147.bb492c99.js"><link rel="prefetch" href="/assets/js/148.b97c8e6e.js"><link rel="prefetch" href="/assets/js/149.09d4a2d6.js"><link rel="prefetch" href="/assets/js/15.96e033fa.js"><link rel="prefetch" href="/assets/js/150.09459140.js"><link rel="prefetch" href="/assets/js/151.e58d50d6.js"><link rel="prefetch" href="/assets/js/152.144e4b5a.js"><link rel="prefetch" href="/assets/js/153.8fc0a77c.js"><link rel="prefetch" href="/assets/js/154.66d523bd.js"><link rel="prefetch" href="/assets/js/155.753cc2ca.js"><link rel="prefetch" href="/assets/js/156.b3989277.js"><link rel="prefetch" href="/assets/js/16.eb71a02a.js"><link rel="prefetch" href="/assets/js/17.92df7b99.js"><link rel="prefetch" href="/assets/js/18.50bc4846.js"><link rel="prefetch" href="/assets/js/19.b1ef1e4b.js"><link rel="prefetch" href="/assets/js/20.0bd8c323.js"><link rel="prefetch" href="/assets/js/21.61706504.js"><link rel="prefetch" href="/assets/js/22.8dd4c425.js"><link rel="prefetch" href="/assets/js/23.586aa03f.js"><link rel="prefetch" href="/assets/js/24.587da8d7.js"><link rel="prefetch" href="/assets/js/25.48dbd4aa.js"><link rel="prefetch" href="/assets/js/26.457ebcaa.js"><link rel="prefetch" href="/assets/js/27.1963bdd9.js"><link rel="prefetch" href="/assets/js/28.fd255c8f.js"><link rel="prefetch" href="/assets/js/29.9be7c06f.js"><link rel="prefetch" href="/assets/js/30.ec48e840.js"><link rel="prefetch" href="/assets/js/31.6dcc588d.js"><link rel="prefetch" href="/assets/js/32.04333fd7.js"><link rel="prefetch" href="/assets/js/33.0ae0efe9.js"><link rel="prefetch" href="/assets/js/34.b4be6b86.js"><link rel="prefetch" href="/assets/js/35.64cf8684.js"><link rel="prefetch" href="/assets/js/36.6db6ff86.js"><link rel="prefetch" href="/assets/js/37.148032a4.js"><link rel="prefetch" href="/assets/js/38.58df30af.js"><link rel="prefetch" href="/assets/js/39.a470e9de.js"><link rel="prefetch" href="/assets/js/4.cc6d99c2.js"><link rel="prefetch" href="/assets/js/40.d4b18e0c.js"><link rel="prefetch" href="/assets/js/41.e20068b4.js"><link rel="prefetch" href="/assets/js/42.3a75683d.js"><link rel="prefetch" href="/assets/js/43.ba2cdbb2.js"><link rel="prefetch" href="/assets/js/44.98e76581.js"><link rel="prefetch" href="/assets/js/45.ed0f9610.js"><link rel="prefetch" href="/assets/js/46.2825326b.js"><link rel="prefetch" href="/assets/js/47.ce00ed53.js"><link rel="prefetch" href="/assets/js/48.99180398.js"><link rel="prefetch" href="/assets/js/49.63a36b62.js"><link rel="prefetch" href="/assets/js/5.5b94bff7.js"><link rel="prefetch" href="/assets/js/50.1eb2e756.js"><link rel="prefetch" href="/assets/js/51.6c4ff19b.js"><link rel="prefetch" href="/assets/js/52.b3544353.js"><link rel="prefetch" href="/assets/js/53.1c5bada0.js"><link rel="prefetch" href="/assets/js/54.3f612a54.js"><link rel="prefetch" href="/assets/js/55.e371eb4b.js"><link rel="prefetch" href="/assets/js/56.0c442daa.js"><link rel="prefetch" href="/assets/js/57.96bb7db7.js"><link rel="prefetch" href="/assets/js/58.3e297889.js"><link rel="prefetch" href="/assets/js/59.c05a9392.js"><link rel="prefetch" href="/assets/js/6.481b22df.js"><link rel="prefetch" href="/assets/js/60.e88ec729.js"><link rel="prefetch" href="/assets/js/61.9a499194.js"><link rel="prefetch" href="/assets/js/62.17aa3868.js"><link rel="prefetch" href="/assets/js/63.98f2d0e9.js"><link rel="prefetch" href="/assets/js/64.5a7e0382.js"><link rel="prefetch" href="/assets/js/65.75353cfc.js"><link rel="prefetch" href="/assets/js/66.2f77d310.js"><link rel="prefetch" href="/assets/js/67.9fd528d0.js"><link rel="prefetch" href="/assets/js/68.3e65a767.js"><link rel="prefetch" href="/assets/js/69.4483a196.js"><link rel="prefetch" href="/assets/js/7.cb937ed7.js"><link rel="prefetch" href="/assets/js/70.f4e7a648.js"><link rel="prefetch" href="/assets/js/71.e376b330.js"><link rel="prefetch" href="/assets/js/72.dcb8ba9a.js"><link rel="prefetch" href="/assets/js/73.037831aa.js"><link rel="prefetch" href="/assets/js/74.654ba410.js"><link rel="prefetch" href="/assets/js/75.5d2d6c3a.js"><link rel="prefetch" href="/assets/js/76.643f6d9b.js"><link rel="prefetch" href="/assets/js/77.0ce16396.js"><link rel="prefetch" href="/assets/js/78.5f05ca92.js"><link rel="prefetch" href="/assets/js/79.662034ba.js"><link rel="prefetch" href="/assets/js/8.9b412011.js"><link rel="prefetch" href="/assets/js/80.c731131b.js"><link rel="prefetch" href="/assets/js/81.76951019.js"><link rel="prefetch" href="/assets/js/82.9cd618c9.js"><link rel="prefetch" href="/assets/js/83.beb1efe0.js"><link rel="prefetch" href="/assets/js/84.8dc3ae7c.js"><link rel="prefetch" href="/assets/js/86.0e1f35a3.js"><link rel="prefetch" href="/assets/js/87.6f89ccf2.js"><link rel="prefetch" href="/assets/js/88.77626763.js"><link rel="prefetch" href="/assets/js/89.2fa83aed.js"><link rel="prefetch" href="/assets/js/9.b551853b.js"><link rel="prefetch" href="/assets/js/90.bc412f4d.js"><link rel="prefetch" href="/assets/js/91.69f41fec.js"><link rel="prefetch" href="/assets/js/92.ab147dde.js"><link rel="prefetch" href="/assets/js/93.078b5817.js"><link rel="prefetch" href="/assets/js/94.f602d07f.js"><link rel="prefetch" href="/assets/js/95.f348d112.js"><link rel="prefetch" href="/assets/js/96.e0a54a9b.js"><link rel="prefetch" href="/assets/js/97.390f851a.js"><link rel="prefetch" href="/assets/js/98.742e7f81.js"><link rel="prefetch" href="/assets/js/99.b8d65f8d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.594b47db.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">左小白的前端笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="指南" class="dropdown-title"><span class="title">指南</span> <span class="arrow down"></span></button> <button type="button" aria-label="指南" class="mobile-dropdown-title"><span class="title">指南</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">
  首页
</a></li><li class="dropdown-item"><!----> <a href="/nav.html" class="nav-link">
  前端网址导航
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端进阶" class="dropdown-title"><span class="title">前端进阶</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端进阶" class="mobile-dropdown-title"><span class="title">前端进阶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/daily/" class="nav-link">
  技术日常记录
</a></li><li class="dropdown-item"><!----> <a href="/server/docker.html" class="nav-link">
  Docker 基础
</a></li><li class="dropdown-item"><h4>
          Vue.js
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vue/base/1.html" class="nav-link">
  Vue.js 笔记
</a></li><li class="dropdown-subitem"><a href="/vue/vue-router.html" class="nav-link">
  Vue Router 笔记
</a></li><li class="dropdown-subitem"><a href="/vue/vuex.html" class="nav-link">
  Vuex 笔记
</a></li></ul></li><li class="dropdown-item"><h4>
          前端工程化
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/ts/base-1.html" class="nav-link">
  TypeScript 入门教程笔记
</a></li><li class="dropdown-subitem"><a href="/node/base/1.html" class="nav-link">
  Node.js 笔记
</a></li><li class="dropdown-subitem"><a href="/webpack/base.html" class="nav-link">
  webpack 基础
</a></li></ul></li><li class="dropdown-item"><h4>
          数据可视化
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/visual/echarts.html" class="nav-link">
  Echarts 笔记
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端基础" class="dropdown-title"><span class="title">前端基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端基础" class="mobile-dropdown-title"><span class="title">前端基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          JS/ES6
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/js/es6/es6-1.html" class="nav-link">
  ES6标准入门(第三版)笔记
</a></li><li class="dropdown-subitem"><a href="/js/ad3/js-ad3-1.html" class="nav-link">
  JavaScript高级程序设计(第四版)笔记
</a></li><li class="dropdown-subitem"><a href="/js/js-dom-art.html" class="nav-link">
  JavaScript DOM编程艺术(第二版)笔记
</a></li></ul></li><li class="dropdown-item"><h4>
          CSS/CSS3
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/css/less.html" class="nav-link">
  CSS 预处理器 Less.js
</a></li><li class="dropdown-subitem"><a href="/css/flex-grid.html" class="nav-link">
  Flex与Grid布局
</a></li><li class="dropdown-subitem"><a href="/css/html5-css-1.html" class="nav-link">
  HTML5权威指南(CSS部分)笔记
</a></li></ul></li><li class="dropdown-item"><h4>
          HTML/HTML5
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/html5/html/1.html" class="nav-link">
  HTML5权威指南(HTML部分)笔记
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机基础" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机基础" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/base/js-data-struct.html" class="nav-link">
  学习JavaScript数据结构与算法(第三版)笔记
</a></li><li class="dropdown-item"><!----> <a href="/base/git.html" class="nav-link">
  Git 笔记
</a></li><li class="dropdown-item"><!----> <a href="/base/markdown.html" class="nav-link">
  Markdown 基础语法
</a></li><li class="dropdown-item"><!----> <a href="/base/dbtheory/1.html" class="nav-link">
  数据库系统原理笔记
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开源项目" class="dropdown-title"><span class="title">开源项目</span> <span class="arrow down"></span></button> <button type="button" aria-label="开源项目" class="mobile-dropdown-title"><span class="title">开源项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="http://vuechart.zuo11.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  @guoqzuo/vue-chart
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://zuoblog.zuo11.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  zuo-blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="http://www.zuo11.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/zuoxiaobai" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="指南" class="dropdown-title"><span class="title">指南</span> <span class="arrow down"></span></button> <button type="button" aria-label="指南" class="mobile-dropdown-title"><span class="title">指南</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">
  首页
</a></li><li class="dropdown-item"><!----> <a href="/nav.html" class="nav-link">
  前端网址导航
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端进阶" class="dropdown-title"><span class="title">前端进阶</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端进阶" class="mobile-dropdown-title"><span class="title">前端进阶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/daily/" class="nav-link">
  技术日常记录
</a></li><li class="dropdown-item"><!----> <a href="/server/docker.html" class="nav-link">
  Docker 基础
</a></li><li class="dropdown-item"><h4>
          Vue.js
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vue/base/1.html" class="nav-link">
  Vue.js 笔记
</a></li><li class="dropdown-subitem"><a href="/vue/vue-router.html" class="nav-link">
  Vue Router 笔记
</a></li><li class="dropdown-subitem"><a href="/vue/vuex.html" class="nav-link">
  Vuex 笔记
</a></li></ul></li><li class="dropdown-item"><h4>
          前端工程化
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/ts/base-1.html" class="nav-link">
  TypeScript 入门教程笔记
</a></li><li class="dropdown-subitem"><a href="/node/base/1.html" class="nav-link">
  Node.js 笔记
</a></li><li class="dropdown-subitem"><a href="/webpack/base.html" class="nav-link">
  webpack 基础
</a></li></ul></li><li class="dropdown-item"><h4>
          数据可视化
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/visual/echarts.html" class="nav-link">
  Echarts 笔记
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端基础" class="dropdown-title"><span class="title">前端基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端基础" class="mobile-dropdown-title"><span class="title">前端基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          JS/ES6
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/js/es6/es6-1.html" class="nav-link">
  ES6标准入门(第三版)笔记
</a></li><li class="dropdown-subitem"><a href="/js/ad3/js-ad3-1.html" class="nav-link">
  JavaScript高级程序设计(第四版)笔记
</a></li><li class="dropdown-subitem"><a href="/js/js-dom-art.html" class="nav-link">
  JavaScript DOM编程艺术(第二版)笔记
</a></li></ul></li><li class="dropdown-item"><h4>
          CSS/CSS3
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/css/less.html" class="nav-link">
  CSS 预处理器 Less.js
</a></li><li class="dropdown-subitem"><a href="/css/flex-grid.html" class="nav-link">
  Flex与Grid布局
</a></li><li class="dropdown-subitem"><a href="/css/html5-css-1.html" class="nav-link">
  HTML5权威指南(CSS部分)笔记
</a></li></ul></li><li class="dropdown-item"><h4>
          HTML/HTML5
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/html5/html/1.html" class="nav-link">
  HTML5权威指南(HTML部分)笔记
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机基础" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机基础" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/base/js-data-struct.html" class="nav-link">
  学习JavaScript数据结构与算法(第三版)笔记
</a></li><li class="dropdown-item"><!----> <a href="/base/git.html" class="nav-link">
  Git 笔记
</a></li><li class="dropdown-item"><!----> <a href="/base/markdown.html" class="nav-link">
  Markdown 基础语法
</a></li><li class="dropdown-item"><!----> <a href="/base/dbtheory/1.html" class="nav-link">
  数据库系统原理笔记
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开源项目" class="dropdown-title"><span class="title">开源项目</span> <span class="arrow down"></span></button> <button type="button" aria-label="开源项目" class="mobile-dropdown-title"><span class="title">开源项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="http://vuechart.zuo11.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  @guoqzuo/vue-chart
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://zuoblog.zuo11.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  zuo-blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="http://www.zuo11.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/zuoxiaobai" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>JS/ES6</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>ES6标准入门(第三版)笔记</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>JavaScript高级程序设计(第四版)笔记</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/js/ad3/js-ad4-diff.html" class="sidebar-link">第四版相比第三版有哪些更新 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-1.html" class="sidebar-link">1. 什么是JavaScript - JS高程4</a></li><li><a href="/js/ad3/js-ad3-2.html" class="sidebar-link">2. 在HTML中使用JavaScript - JS高程4</a></li><li><a href="/js/ad3/js-ad3-3.html" class="sidebar-link">3. ES基本概念(语言基础) - JS高程4</a></li><li><a href="/js/ad3/js-ad3-4.html" class="sidebar-link">4. 变量、作用域与内存 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-5.html" class="sidebar-link">5. 基本引用类型 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-6.html" class="sidebar-link">6. 集合引用类型 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-7.html" class="sidebar-link">7. 迭代器与生成器(Iterator 与 Generator) - JS高程4</a></li><li><a href="/js/ad3/js-ad3-8.html" class="sidebar-link">8. 对象、类与面向对象编程 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-9.html" class="sidebar-link">9. 代理与反射(Proxy与Reflect) - JS高程4</a></li><li><a href="/js/ad3/js-ad3-10.html" class="sidebar-link">10. 函数 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-11.html" class="sidebar-link">11. 期约与异步函数(Promise与async/await) - JS高程4</a></li><li><a href="/js/ad3/js-ad3-12.html" class="sidebar-link">12. BOM - JS高程4</a></li><li><a href="/js/ad3/js-ad3-13.html" class="sidebar-link">13. 客户端检测 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-14.html" class="sidebar-link">14. DOM - JS高程4</a></li><li><a href="/js/ad3/js-ad3-15.html" class="sidebar-link">15. DOM扩展 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-16.html" class="sidebar-link">16. DOM2 和 DOM3 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-17.html" class="sidebar-link">17. 事件 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-18.html" class="sidebar-link">18. 动画与 Canvas 图形 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-19.html" class="sidebar-link">19. 表单脚本 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-20.html" class="sidebar-link">20. JavaScript API - JS高程4</a></li><li><a href="/js/ad3/js-ad3-21.html" class="sidebar-link">21. 错误处理与调试 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-22.html" class="sidebar-link">22. 处理 XML - JS高程4</a></li><li><a href="/js/ad3/js-ad3-23.html" class="sidebar-link">23. JSON - JS高程4</a></li><li><a href="/js/ad3/js-ad3-24.html" class="sidebar-link">24. 网络请求与远程资源 - JS高程4</a></li><li><a href="/js/ad3/js-ad3-25.html" class="sidebar-link">25. 客户端存储</a></li><li><a href="/js/ad3/js-ad3-26.html" class="sidebar-link">26. 模块(Modules)</a></li><li><a href="/js/ad3/js-ad3-27.html" aria-current="page" class="active sidebar-link">27. 工作者线程(Web Workers) - JS高程4</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-27.html#工作者线程简介-worker" class="sidebar-link">工作者线程简介(Worker)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-27.html#工作者线程与线程" class="sidebar-link">工作者线程与线程</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-27.html#三种工作者线程类型" class="sidebar-link">三种工作者线程类型</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-27.html#workerglobalscope" class="sidebar-link">WorkerGlobalScope</a></li></ul></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-27.html#专用工作者线程-dedicated-workers" class="sidebar-link">专用工作者线程(Dedicated Workers）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-27.html#worker-对象" class="sidebar-link">worker 对象</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-27.html#dedicatedworkerglobalscope" class="sidebar-link">DedicatedWorkerGlobalScope</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-27.html#专用工作者线程的生命周期" class="sidebar-link">专用工作者线程的生命周期</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-27.html#new-worker-可选配置选项" class="sidebar-link">new Worker() 可选配置选项</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-27.html#不加载-js-文件创建-worker-的方法" class="sidebar-link">不加载 js 文件创建 worker 的方法</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-27.html#importscripts-动态执行-js" class="sidebar-link">importScripts() 动态执行 js</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-27.html#子工作者线程" class="sidebar-link">子工作者线程</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-27.html#处理工作者线程错误" class="sidebar-link">处理工作者线程错误</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-27.html#与专用工作者线程通信的三种方法" class="sidebar-link">与专用工作者线程通信的三种方法</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-27.html#工作者线程数据传输" class="sidebar-link">工作者线程数据传输</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-27.html#线程池" class="sidebar-link">线程池</a></li></ul></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-27.html#共享工作者线程-shared-workers" class="sidebar-link">共享工作者线程(Shared Workers)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-27.html#sharedworker-对象与-sharedworkerglobalscope" class="sidebar-link">sharedWorker 对象与 SharedWorkerGlobalScope</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-27.html#共享工作者线程的生命周期" class="sidebar-link">共享工作者线程的生命周期</a></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-27.html#连接到共享工作者线程" class="sidebar-link">连接到共享工作者线程</a></li></ul></li><li class="sidebar-sub-header"><a href="/js/ad3/js-ad3-27.html#服务工作者线程-service-workers" class="sidebar-link">服务工作者线程(Service Workers)</a></li></ul></li><li><a href="/js/ad3/js-ad3-28.html" class="sidebar-link">28. 最佳实践 - JS高程4</a></li></ul></section></li><li><a href="/js/js-dom-art.html" class="sidebar-link">JavaScript DOM 编程艺术(第二版)笔记</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_27-工作者线程-web-workers"><a href="#_27-工作者线程-web-workers" class="header-anchor">#</a> 27. 工作者线程(Web Workers)</h1> <blockquote><p>官方文档规范参考：<a href="https://html.spec.whatwg.org/multipage/workers.html" target="_blank" rel="noopener noreferrer">Web Workers - HTML Standard<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p>JavaScript 是单线程的，这样可以保证它与浏览器 API 兼容。如果 JavaScript 可以多线程执行并发更改，那么像 DOM 这样的 API 就会出现问题。因此 POSIX 线程与 Java 的 Thread 类等传统并发结构都不适合 JavaScript。</p> <p>单线程意味着不能把工作委托给独立的线程、进程去做。这就是 <strong>工作者线程（Web Workers）</strong> 存在的价值所在：允许把主线的工作转嫁给独立的实体，而不会改变现有的单线程模型。它的特点是独立于 JavaScript 主执行环境。</p> <h2 id="工作者线程简介-worker"><a href="#工作者线程简介-worker" class="header-anchor">#</a> 工作者线程简介(Worker)</h2> <p>JS 运行在虚拟环境，浏览器中，每打开一个页面，就会分配一个它自己的环境。每个页面都有自己的内存、事件循环、DOM，等等。每个页面相当于一个沙盒，不会干扰其他页面。对浏览器来说，这些环境都是并行执行的。</p> <p>使用 <strong>工作者线程</strong> 浏览器可以在环境之外再分配一个完全独立的二级子环境，这个子环境不能与依赖单线程交互的 API（如 DOM）互相操作，但可以与父环境并行执行代码。</p> <h3 id="工作者线程与线程"><a href="#工作者线程与线程" class="header-anchor">#</a> 工作者线程与线程</h3> <p>工作者线程与线程的比较：</p> <ul><li>工作者线程基于实际线程实现</li> <li>工作者线程并行执行</li> <li>工作者线程可以共享某些内容，不共享全部内存。</li> <li>工作者线程不一定在同一个进程里</li> <li>创建工作者线程的开销较大。它有自己独立的事件循环、全局对象、事件处理程序和其他 JS 环境必须的特性。</li></ul> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>工作者线程相对比较重，不建议大量使用。工作者线程应该是长期运行的，启动成本比较高、每个实例占用的内存比较大。</p></div> <h3 id="三种工作者线程类型"><a href="#三种工作者线程类型" class="header-anchor">#</a> 三种工作者线程类型</h3> <p>Web Workers 规范中定义了三种主要的工作者线程：</p> <ol><li><code>专用工作者线程（Dedicated Workers）</code>，通常简称 Web Worker 或 Worker，<strong>可以单独创建一个 JS 线程，这个线程只能被创建它的页面使用。</strong></li> <li><code>共享工作者线程（Shared Workers）</code>，与专用工作者线程类似，<strong>任何与创建共享工作者线程的 JS 同源的 JS，都可以向共享工作者线程发送、接收消息。</strong></li> <li><code>服务工作者线程（Service Workers）</code>，与专用共享工作者线程和共享工作者线程不同，<strong>它主要用于拦截、重定向和修改页面发出的请求，充当网络请求的仲裁者角色</strong>。</li></ol> <h3 id="workerglobalscope"><a href="#workerglobalscope" class="header-anchor">#</a> WorkerGlobalScope</h3> <p>在工作者线程内部全局对象为 WorkerGlobalScope  的实例，类似于 window。通过 self 关键字暴露出来。self 上可用的属性和方法是 window 上属性和方法的子集。这些属性会返回工作者线程的特定版本。方法与 window 的方法操作一样。</p> <ul><li><code>navigator</code> 返回工作者线程关联的 WorkerNavigator。</li> <li><code>self</code> 返回 WorkerGlobalScope 对象。</li> <li><code>location</code> 返回工作者线程关联的 WorkerLocation。</li> <li><code>performace</code> 返回 Performace 对象，只包含特定属性、方法。</li> <li><code>console</code></li> <li><code>caches</code> 返回 CacheStorage 对象。</li> <li><code>indexdDB</code> 返回 IDBFactory 对象。</li> <li><code>isSecureContext</code> 返回布尔值，表示工作者线程上下文是否安全。</li> <li><code>origin</code> 返回 WorkerGlobalScope 的源</li> <li><code>atob()</code></li> <li><code>btoa()</code></li> <li><code>clearInterval()</code></li> <li><code>clearTimeout()</code></li> <li><code>createImageBitmap()</code></li> <li><code>fetch()</code></li> <li><code>setInterval()</code></li> <li><code>setTimeout()</code></li> <li><code>importScripts()</code> 工作者线程新增的方法，只在工作者线程内可用</li></ul> <p><strong>WorkerGlobalScope 的子类</strong>，每种类型的工作者线程都使用了自己特定的全局对象，继承自 WorkerGlobalScope:</p> <ul><li>专用工作者线程 DedicatedWorkerGlobalScope</li> <li>共享工作者线程 SharedWorkerGlobalScope</li> <li>服务工作者线程 ServiceWorkerGlobalScope</li></ul> <h2 id="专用工作者线程-dedicated-workers"><a href="#专用工作者线程-dedicated-workers" class="header-anchor">#</a> 专用工作者线程(Dedicated Workers）</h2> <p>可以把专用工作者线程称为 <strong>后台脚本(background script)</strong>，这样的线程可以与父页面交换信息、发送网络请求、执行文件输入/输出、进行密集计算、处理大量数据，以及实现其他不适合在页面执行线程里做的任务（否则会导致页面响应迟钝）。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// index.html</span>
<span class="token comment">// &lt;script src=&quot;./main.js&quot;&gt;&lt;/script&gt;</span>

<span class="token comment">// main.js</span>
<span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'./worker.js'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>worker<span class="token punctuation">)</span> <span class="token comment">// Worker {}</span>

<span class="token comment">// worker.js</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'加载了 worker.js'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'self'</span><span class="token punctuation">,</span> self<span class="token punctuation">)</span> <span class="token comment">// DedicatedWorkerGlobalScope {}</span>
</code></pre></div><p><img src="/images/js/web_worker_1.png" alt="web_worker_1.png"></p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Web Worker 出于安全方面的考虑，不允许使用非同源 JS 创建工作者线程，否则会提示 DOMException: Failed to construct 'Worker'。
在工作者线程内部，使用 importScripts() 可以加载其他源的 JS</p></div> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// main.js</span>
<span class="token comment">// DOMException: Failed to construct 'Worker'</span>
<span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'http://www.zuo11.com/worker.js'</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="worker-对象"><a href="#worker-对象" class="header-anchor">#</a> worker 对象</h3> <p>worker 对象可以用来干什么？</p> <ul><li><code>onerror</code> 工作者线程抛出异常时触发，ErrorEvent类型错误</li> <li><code>onmessage</code> 工作者线程向父上下文发送消息时触发，MessageEvent 类型消息</li> <li><code>onmessageerror</code> 工作者线程收到无法反序列化的消息时发生，MessageEvent 类型的错误</li> <li><code>postMessage()</code> 向工作者线程发送消息</li> <li><code>terminate()</code> 立即终止工作者线程</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// main.js</span>
<span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'./worker.js'</span><span class="token punctuation">)</span>
worker<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>
worker<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span>
worker<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'messageerror'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>
worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'some info'</span><span class="token punctuation">)</span>
worker<span class="token punctuation">.</span><span class="token function">terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="dedicatedworkerglobalscope"><a href="#dedicatedworkerglobalscope" class="header-anchor">#</a> DedicatedWorkerGlobalScope</h3> <p>self 的类型，它相比 WorkerGlobalScope 增加了如下属性、方法：</p> <ul><li><code>name</code> 可以提供给 Worker 构造函数的一个可选的字符串标识符。</li> <li><code>postMessage()</code> 与 worker.postMessage() 对应的方法，用于从工作者线程内部向父上下文发送消息。</li> <li><code>close()</code> 与 worker.terminate() 对象的方法，用于立即终止工作者线程。</li> <li><code>importScripts()</code> 用于向工作者线程中导入任意数量的 JS。</li></ul> <h3 id="专用工作者线程的生命周期"><a href="#专用工作者线程的生命周期" class="header-anchor">#</a> 专用工作者线程的生命周期</h3> <p>一般分为下面 3 种状态：</p> <ul><li><code>初始化（initializing）</code> 调用 new Worker() 时会初始化对工作者线程 JS 的请求，并返回 Worker 对象。这个时候与之关联的工作者线程可能还没创建，因为 JS 文件加载有延时。这个时候可以使用 worker.postMessage() 向工作者线程发消息，会将消息先加入到队列。等状态变为活动时，再把消息添加到它的消息队列。</li> <li><code>活动（active）</code> 初始化成功之后会变为活动状态</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// initWorker.js</span>
self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// main.js</span>
<span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'./initWorker.js'</span><span class="token punctuation">)</span>
<span class="token comment">// 这里 worker 可能还处于初始化状态，但 postMessage() 数据可以正常处理</span>
worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span>
worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">)</span>
worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'baz'</span><span class="token punctuation">)</span>
<span class="token comment">// foo  bar  baz</span>
</code></pre></div><ul><li><code>终止（terminated）</code>，终止分为：工作者线程内部自我终止 self.close() 、外部终止 worker.terminate()。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// closeWorker.js</span>
self<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span>
self<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
self<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> self<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'baz'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token comment">// main.js </span>
<span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'./closeWorker.js'</span><span class="token punctuation">)</span>
worker<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token comment">// foo bar</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>注意：内部终止 self.close() ，并没有立即终止。close() 会通知工作者线程取消事件循环中的所有任务，并阻止添加新任务。<strong>当前事件循环中的事件还是会执行</strong>，而外部终止 worker.terminate() 是立即终止。</p></div> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// terminateWorker</span>
self<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>

<span class="token comment">// main.js</span>
<span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'./terminateWorker.js'</span><span class="token punctuation">)</span>

<span class="token comment">// 给 1000ms 时间，让工作者线程初始化</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span>
  worker<span class="token punctuation">.</span><span class="token function">terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 立即终止，工作者线程消息队列会被清理锁住，不会打印 bar</span>
  worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">)</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'baz'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token comment">// foo</span>
</code></pre></div><p>如果页面关闭，与其关联的工作者线程会被标记为终止，他们的执行也会立即停止。</p> <h3 id="new-worker-可选配置选项"><a href="#new-worker-可选配置选项" class="header-anchor">#</a> new Worker() 可选配置选项</h3> <p>Worker() 构造函数允许将可选的配置对象作为第二个参数。可配置属性如下：</p> <ul><li><code>name</code> 可以通过 self.name 读取的内容</li> <li><code>type</code> 加载脚本的运行方式
<ul><li><code>&quot;classic&quot;</code> 作为常规脚本来执行</li> <li><code>&quot;module&quot;</code> 作为模块来执行</li></ul></li> <li><code>credentials</code> 当脚本加载方式为 module 时，指定如何获取与传输凭证数据相关的模块 js。与 fetch() 的凭证选项相同。
<ul><li><code>&quot;omit&quot;</code> type 为 &quot;classic&quot; 时的默认值。</li> <li><code>&quot;same-orign&quot;</code></li> <li><code>&quot;include&quot;</code></li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// main.js</span>
<span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'./worker.js'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'testOptionsWorker'</span><span class="token punctuation">,</span>
  type<span class="token operator">:</span> <span class="token string">&quot;module&quot;</span><span class="token punctuation">,</span>
  credentials<span class="token operator">:</span> <span class="token string">&quot;omit&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// worker.js</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token comment">// testOptionsWorker</span>
</code></pre></div><h3 id="不加载-js-文件创建-worker-的方法"><a href="#不加载-js-文件创建-worker-的方法" class="header-anchor">#</a> 不加载 js 文件创建 worker 的方法</h3> <p>js 代码字符串转 Blob，Bolb 转对象 URL，使用该 URL 创建。这样可以快速的初始化工作者线程，没有网络延时。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 将 js 文件的内容存到字符串</span>
<span class="token keyword">let</span> scriptStr <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">self.onmessage = ({ data }) =&gt; console.log(data)</span><span class="token template-punctuation string">`</span></span>
<span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span>scriptStr<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'blob worker script'</span><span class="token punctuation">)</span>
<span class="token comment">// blob worker script</span>
</code></pre></div><p>来看一个实例，把比较耗时的斐波那契计算放到 worker 里执行。再将值传递回来。这里把 fiibonacci 函数转成字符串，使用立即执行函数（<strong>IIFE</strong>，Immediately Invoked Function Expression）方式来执行。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> n <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token number">0</span> 
         <span class="token operator">:</span> n <span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token operator">?</span> <span class="token number">1</span>
         <span class="token operator">:</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> scriptStr <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">self.postMessage((</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fibonacci<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)(9))</span><span class="token template-punctuation string">`</span></span>
<span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span>scriptStr<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
worker<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>data<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token comment">// 34</span>
</code></pre></div><h3 id="importscripts-动态执行-js"><a href="#importscripts-动态执行-js" class="header-anchor">#</a> importScripts() 动态执行 js</h3> <p>在工作者线程中使用 importScripts() 动态执行 js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// mian.js</span>
<span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'./worker.js'</span><span class="token punctuation">)</span>

<span class="token comment">// scriptA.js</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'scriptA executes'</span><span class="token punctuation">)</span>

<span class="token comment">// scriptB.js</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'scriptB executes'</span><span class="token punctuation">)</span>

<span class="token comment">// worker.js</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'start import scripts'</span><span class="token punctuation">)</span>
<span class="token function">importScripts</span><span class="token punctuation">(</span><span class="token string">'./scriptA.js'</span><span class="token punctuation">)</span>
<span class="token function">importScripts</span><span class="token punctuation">(</span><span class="token string">'./scriptB.js'</span><span class="token punctuation">)</span>
<span class="token comment">// 等价于 importScripts('./scriptA.js', './scriptB.js')</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'scripts imported'</span><span class="token punctuation">)</span>

<span class="token comment">// start import scripts</span>
<span class="token comment">// scriptA executes</span>
<span class="token comment">// scriptB executes</span>
<span class="token comment">// scripts imported</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <ul><li><strong>importScripts() 导入的 js 会严格按照顺序执行。</strong></li> <li><strong>new Worker() 时 js 有跨域限制，而 worker 内部使用 importScripts 没有跨域限制。</strong></li> <li><strong>importScripts() 导入的 js 与 worker 共享同一个作用域</strong></li></ul></div> <h3 id="子工作者线程"><a href="#子工作者线程" class="header-anchor">#</a> 子工作者线程</h3> <p>在工作者线程内部，可以再创建子工作者线程。在多个 CPU 核心的时候，使用多个子工作者线程可以实现并行计算。使用子工作者线程时需要考虑周全，确保并行计算确实有收益。<strong>注意 worker.js 与 subWorker.js 要与主页同域</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// mian.js</span>
<span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'./worker.js'</span><span class="token punctuation">)</span>

<span class="token comment">// worker.js</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'worker'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'./subWorker.js'</span><span class="token punctuation">)</span>

<span class="token comment">// subWorker.js</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'subWorker'</span><span class="token punctuation">)</span>

<span class="token comment">// worker</span>
<span class="token comment">// subWorker</span>
</code></pre></div><h3 id="处理工作者线程错误"><a href="#处理工作者线程错误" class="header-anchor">#</a> 处理工作者线程错误</h3> <p>如果工作者线程抛出了错误，工作者线程沙盒可以阻止它打断父线程的执行，在 main.js 中使用 try/catch 中不会捕获到错误。<strong>需要使用 worker.onerror 事件来接收处理错误。</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// worker.js</span>
<span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span>

<span class="token comment">// main.js</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'./worker.js'</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'no error'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'caught error'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// no error</span>
</code></pre></div><p>使用 worker.onerror 捕获错误</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'./worker.js'</span><span class="token punctuation">)</span>
worker<span class="token punctuation">.</span>onerror <span class="token operator">=</span> console<span class="token punctuation">.</span>log
<span class="token comment">// ErrorEvent { isTrusted: true, message: &quot;Uncaught Error: foo&quot; }</span>
</code></pre></div><h3 id="与专用工作者线程通信的三种方法"><a href="#与专用工作者线程通信的三种方法" class="header-anchor">#</a> 与专用工作者线程通信的三种方法</h3> <p>与工作者线程通信都是通过异步消息完成，这些消息分三种</p> <ol><li><strong>使用 postMessage()</strong>，在主线程与工作者线程之间传递消息。worker 和 self 都可以接收、发送消息。</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// worker.js</span>
<span class="token keyword">function</span> <span class="token function">factorial</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result <span class="token operator">*=</span> n<span class="token operator">--</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result
<span class="token punctuation">}</span>
self<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  self<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">! = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">factorial</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// main.js</span>
<span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'./worker.js'</span><span class="token punctuation">)</span>
worker<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>
worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>

<span class="token comment">// 5! = 120</span>
<span class="token comment">// 7! = 5040</span>
<span class="token comment">// 10! = 3628800</span>
</code></pre></div><ol start="2"><li><strong>使用 MessageChannel</strong>，本质上也是调用 onmessage 与 postMessage() 进行收发信息。但是使用 MessageChannel 会在两个上下文中明确建立信道（通信渠道）。MessageChannel 实例有两个 MessagePort 属性 port1、port2。分别代表两个通信端点。使用 port1、port2 调用 onmessage 与 postMessage() 可以进行收发消息。</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// mian.js</span>
<span class="token keyword">const</span> channel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// channel: MessageChannel {port1: MessagePort, port2: MessagePort}</span>

<span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'./worker.js'</span><span class="token punctuation">)</span>
<span class="token comment">// 把 channel 实例两个通信端口中的一个传递给工作者线程</span>
worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>channel<span class="token punctuation">.</span>port1<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">// 使用另一个端口与工作者线程通信</span>
channel<span class="token punctuation">.</span>port2<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
channel<span class="token punctuation">.</span>port2<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token comment">// main.js: you send data: 5</span>

<span class="token comment">// worker.js</span>
<span class="token keyword">let</span> messagePort <span class="token operator">=</span> <span class="token keyword">null</span>
self<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> ports <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 第一次接收消息时，主线程把 MessageChannel 其中一个 port 传进来</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>messagePort<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    messagePort <span class="token operator">=</span> ports<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment">// channel.port1</span>
    <span class="token comment">// 重置监听器</span>
    self<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token comment">// 拿到 channel.port1 后使用它通信</span>
    messagePort<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      messagePort<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">you send data: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用 MessageChannel 用于主线程与工作者线程通信很大程度是多余的，因为全局的 onmessage 和 postMessage() 就可以收发消息。MessageChannel 真正有用的地方是两个工作者线程之间通信。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// main.js</span>
<span class="token keyword">const</span> channel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> workerA <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'./workerA.js'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> workerB <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'./workerB.js'</span><span class="token punctuation">)</span>
<span class="token comment">// 建立 workerA 和 workerB 的通信渠道</span>
workerA<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>channel<span class="token punctuation">.</span>port1<span class="token punctuation">]</span><span class="token punctuation">)</span>
workerB<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>channel<span class="token punctuation">.</span>port2<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">// workerA 给 workerB 发消息，workerB 给 workerA 发消息</span>
workerA<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span>
<span class="token comment">// workerB receive data: a</span>
workerB<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">)</span>
<span class="token comment">// workerA receive data: b</span>

<span class="token comment">// workerA.js</span>
<span class="token keyword">let</span> messagePort <span class="token operator">=</span> <span class="token keyword">null</span>
self<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data<span class="token punctuation">,</span> ports <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>messagePort<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    messagePort <span class="token operator">=</span> ports<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    messagePort<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// workerB.js 只是把 workerA 改为了 workerB</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">workerA receive data: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    messagePort<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="3"><li><strong>使用 BroadcastChannel</strong>，相比 MessageChannel 来说，这个比较简单，只要初始化时 name 相同，就可以相互收发消息。另外，页面给 worker 发消息时，要先等 1 秒钟。因为初始化 worker 可能会有延时，消息可能在发送成功之后，worker 里面还没开始监听对应的信道。这里发送消息是广播的形式。不像 postMessage() 那样有等候的消息队列。</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// main.js</span>
<span class="token keyword">const</span> channel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastChannel</span><span class="token punctuation">(</span><span class="token string">'worker_channel'</span><span class="token punctuation">)</span>
<span class="token comment">// BroadcastChannel {name: &quot;worker_channel&quot;, onmessage: null }</span>
<span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'./worker.js'</span><span class="token punctuation">)</span>
channel<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">heard </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> on page</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> channel<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token comment">// heard foo in worker</span>
<span class="token comment">// heard bar on page</span>

<span class="token comment">// worker.js</span>
<span class="token keyword">const</span> channel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastChannel</span><span class="token punctuation">(</span><span class="token string">'worker_channel'</span><span class="token punctuation">)</span>
channel<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">heard </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> in worker</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  channel<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="工作者线程数据传输"><a href="#工作者线程数据传输" class="header-anchor">#</a> 工作者线程数据传输</h3> <p>主线程与工作者线程，一般通过 postMessage() 传递数据。工作者线程是独立的上下文，在上下文之间传输数据就会产生消耗。在传统的多线程模型语言中，可以使用 锁、互斥量、volatile变量（不稳定变量）。在 JavaScript 中，有 3 种在上下文中传输数据的方式：</p> <ol><li><strong>结构化克隆算法</strong>（structured clone algorithm）</li> <li><strong>可转移对象</strong>（transferable objects）</li> <li><strong>共享数组缓冲区</strong>（shared array buffers）</li></ol> <p><strong>结构化克隆算法</strong>，默认情况下，使用 postMessage() 发送对象数据时，使用的就是结构化克隆算法。浏览器会遍历该对象，并且在目标上下文中，生成它的一个副本。下列类型是结构化克隆算法支持的类型：</p> <ul><li>除 <code>Symbol</code> 外的所有原始类型</li> <li><code>Boolean 对象</code>、<code>String 对象</code>、<code>BDate</code>、<code>RegExp</code>、<code>Blob</code>、<code>File</code>、<code>FileList</code>、<code>ArrayBuffer</code>、<code>ArrayBufferView</code>、<code>ImageData</code>、<code>Array</code>、<code>Object</code>、<code>Map</code>、<code>Set</code></li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>结构化克隆算法需要注意的地方：</p> <ul><li>复制之后源上下文中该对象的修改，不会传播到目标上下文中的对象。它可以识别对象中包含的循环引用，不会无穷遍历对象。</li> <li>克隆 Error 对象、Function 对象或 DOM 节点会抛出错误。</li> <li>它并不总是创建完全一致的副本。原型链、对象属性描述符、get、set方法不会 clone，必要时会使用默认值。</li></ul></div> <p><strong>可转移对象</strong>（transferable objects）可以把所有权从一个上下文中转义到另一个上下文。在数据量很大时，特别有用。只有下面几种对象是可转移对象：<code>ArrayBuffer</code>、<code>MessagePort</code>、<code>ImageBitmap</code>、<code>OffscreenCanvas</code></p> <p>postMessage() 方法的第二个可选参数是数组，它指定应该将哪些对象转移到目标上下文。在遍历消息 payload 时，浏览器会根据转移对象数组检查对象引用，并对转移对象进行转移，而不是复制。来看个例子</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'./worker.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Create 32 byte buffer</span>
<span class="token keyword">const</span> arrayBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">page's buffer size: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>arrayBuffer<span class="token punctuation">.</span>byteLength<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 32</span>
worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>arrayBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">page's buffer size: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>arrayBuffer<span class="token punctuation">.</span>byteLength<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 32</span>

<span class="token comment">// worker.js</span>
self<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>data<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">worker's buffer size: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>byteLength<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 32</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>将 ArrayBuffer 指定为可转移对象</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'./worker.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Create 32 byte buffer</span>
<span class="token keyword">const</span> arrayBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">page's buffer size: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>arrayBuffer<span class="token punctuation">.</span>byteLength<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 32</span>
worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>arrayBuffer<span class="token punctuation">,</span> <span class="token punctuation">[</span>arrayBuffer<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">page's buffer size: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>arrayBuffer<span class="token punctuation">.</span>byteLength<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 0</span>

<span class="token comment">// worker.js</span>
self<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>data<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">worker's buffer size: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>byteLength<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 32</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>在其他类型的对象中，嵌套可转移对象也是可以的。包装对象会被复制，可转移对象会被转移。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 嵌套可转移对象</span>
worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token punctuation">{</span> bar<span class="token operator">:</span> arrayBuffer <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>arrayBuffer<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>SharedArrayBuffer</strong>（共享数组缓冲区），既不克隆，也不转移。SharedArrayBuffer 作为 ArrayBuffer 能够在不同的浏览器上下文中共享。postMessage() 发送 SharedArrayBuffer 时，浏览器只会传递原始缓冲区的引用，两个不同的 JS 上下文会分别维护同一个内存块的引用。每个上下文都可以任意修改这个缓冲区。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// main.js</span>
<span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'./worker.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Create 1 byte buffer</span>
<span class="token keyword">const</span> sharedArrayBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SharedArrayBuffer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Create view onto 1 byte buffer</span>
<span class="token keyword">const</span> view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>sharedArrayBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Parent context assigns value of 1</span>
view<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

worker<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">buffer value after worker modification: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>view<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Send reference to sharedArrayBuffer</span>
worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>sharedArrayBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// buffer value before worker modification: 1</span>
<span class="token comment">// buffer value after worker modification: 2</span>

<span class="token comment">// worker.js</span>
self<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>data<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">buffer value before worker modification: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>view<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Worker assigns new value to shared buffer</span>
  view<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token comment">// Send back empty postMessage to signal assignment is complete</span>
  self<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>当两个并行的线程中共享内存块，有资源争抢的风险。SharedArrayBuffer 实例实际上会被当成易变（Volatile）内存。来看一个例子</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// main.js</span>
<span class="token comment">// Create worker pool of size 4 创建包含 4 个线程的线程池</span>
<span class="token keyword">const</span> workers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  workers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'./worker.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Log the final value after the last worker completes</span>
<span class="token comment">// 在最后一个 worker 完成后打印最终值</span>
<span class="token keyword">let</span> responseCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> worker <span class="token keyword">of</span> workers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  worker<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>responseCount <span class="token operator">==</span> workers<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Final buffer value: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>view<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Initialize the SharedArrayBuffer</span>
<span class="token keyword">const</span> sharedArrayBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SharedArrayBuffer</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint32Array</span><span class="token punctuation">(</span>sharedArrayBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
view<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token comment">// Send the SharedArrayBuffer to each worker</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> worker <span class="token keyword">of</span> workers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>sharedArrayBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 理论上值应该是 4000001，但实际是不超过 400万的数，而且还是动态的。</span>
<span class="token comment">// (Expected result is 4000001. Actual output will be something like:)</span>
<span class="token comment">// Final buffer value: 3254012</span>

<span class="token comment">// worker.js</span>
self<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>data<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint32Array</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Perform 1000000 add operations 执行 100 万次加 1 操作</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1E6</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    view<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  self<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>上面的例子中，每个工作者线程都顺序执行了 100 万次加操作，每次都是读取共享数组的索引，执行一次加操作，然后再把值写回索引。在线程并发执行时，可能会发生资源争用。例如</p> <ol><li>线程 A 读取到值 1</li> <li>线程 B 读取到值 1</li> <li>线程 A 加 1 并 将 2 写回数组</li> <li>然后线程 A 用就的数据 1，同样把 2 写回数组</li></ol> <p>为了解决这个问题，可以使用 Atomics 对象，执行原子操作。类似于锁。在执行完全部操作后，再允许另一个线程执行操作。使用 Atomics.add() 可以得到正确的最终值。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 修改上面例子中的 worker.js</span>

self<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>data<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint32Array</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Perform 1000000 add operations 执行 100 万次加 1 操作</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1E6</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// view[0] += 1; </span>
    <span class="token comment">// 替换为线程安全加操作。原子操作</span>
    Atomics<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  self<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 这样得到最终正确的值</span>
<span class="token comment">// Final buffer value: 4000001</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>第 20 章 详细介绍了 SharedArrayBuffer 与 Atomics API</p></div> <h3 id="线程池"><a href="#线程池" class="header-anchor">#</a> 线程池</h3> <p>由于启用工作者线程的代价很大。所以某些情况可以考虑始终保持固定数量的线程活动，需要时就分派任务。工作这线程执行计算时标记为忙碌。空闲时才准备接收新任务。这些活动线程就称为 <strong>线程池</strong> 或者 <strong>工作者线程池</strong>。</p> <p>线程池中线程的数量，可以参考 CPU 核心数 navigator.hardwareConcurrency，不要超过这个数即可。下面来看一个线程池的实现示例</p> <p>TaskWorker</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">TaskWorker</span> <span class="token keyword">extends</span> <span class="token class-name">Worker</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">notifyAvailable<span class="token punctuation">,</span> <span class="token operator">...</span>workerArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token operator">...</span>workerArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Initialize as unavailable</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>available <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>resolve <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reject <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token comment">// Worker pool will pass a callback so that the</span>
    <span class="token comment">// worker can signal it needs another task</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>notifyAvailable <span class="token operator">=</span> notifyAvailable<span class="token punctuation">;</span>

    <span class="token comment">// Worker script will send a 'ready' postmessage </span>
    <span class="token comment">// once fully initialized</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Called by the worker pool to begin a new task</span>
  <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">,</span> postMessageArgs <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>available <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token operator">...</span>postMessageArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">setAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>available <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>resolve <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reject <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">notifyAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>WorkerPool</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">WorkerPool</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">poolSize<span class="token punctuation">,</span> <span class="token operator">...</span>workerArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>taskQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>workers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// Initialize the worker pool</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> poolSize<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>workers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> <span class="token class-name">TaskWorker</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dispatchIfAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">...</span>workerArgs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Pushes a task onto the queue</span>
  <span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>postMessageArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>taskQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">,</span> postMessageArgs <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dispatchIfAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Sends a task to the next available worker if there is one</span>
  <span class="token function">dispatchIfAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>taskQueue<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> worker <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>workers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>worker<span class="token punctuation">.</span>available<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>taskQueue<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        worker<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Kills all the workers</span>
  <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> worker <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>workers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      worker<span class="token punctuation">.</span><span class="token function">terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用上面的线程池，实现计算 1000 万个浮点数之和</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// worker.js</span>
self<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>data<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>arrayBuffer<span class="token punctuation">)</span>
  
  <span class="token comment">// Perform sum</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> data<span class="token punctuation">.</span>startIdx<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> data<span class="token punctuation">.</span>endIdx<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// No need for Atomics since only performing reads</span>
    sum <span class="token operator">+=</span> view<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Send the result to the worker</span>
  self<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Send messagemessate to TaskWorker to signal worker is</span>
<span class="token comment">// ready to receive tasks.</span>
self<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'ready'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>main.js 使用线程池</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// main.js</span>
Class TaskWorker <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">]</span>

Class WorkerPool <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> totalFloats <span class="token operator">=</span> <span class="token number">1E8</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> numTasks <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> floatsPerTask <span class="token operator">=</span> totalFloats <span class="token operator">/</span> numTasks<span class="token punctuation">;</span>
<span class="token keyword">const</span> numWorkers <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>

<span class="token comment">// Create pool</span>
<span class="token keyword">const</span> pool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WorkerPool</span><span class="token punctuation">(</span>numWorkers<span class="token punctuation">,</span> <span class="token string">'./worker.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Fill array of floats</span>
<span class="token keyword">let</span> arrayBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SharedArrayBuffer</span><span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> totalFloats<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span>arrayBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> totalFloats<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  view<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> partialSumPromises <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> totalFloats<span class="token punctuation">;</span> i <span class="token operator">+=</span> floatsPerTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  partialSumPromises<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
    pool<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      startIdx<span class="token operator">:</span> i<span class="token punctuation">,</span>
      endIdx<span class="token operator">:</span> i <span class="token operator">+</span> floatsPerTask<span class="token punctuation">,</span>
      arrayBuffer<span class="token operator">:</span> arrayBuffer
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Wait for all promises to complete, then sum</span>
Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>partialSumPromises<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">partialSums</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> partialSums<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> x <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// (In this example, sum should be roughly 1E8/2)</span>
<span class="token comment">// 49997075.47203197 </span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>草率的使用并行计算不一定是最好的方法。线程池的调优策略会因计算任务不同、系统硬件不同而不同。</p></div> <h2 id="共享工作者线程-shared-workers"><a href="#共享工作者线程-shared-workers" class="header-anchor">#</a> 共享工作者线程(Shared Workers)</h2> <p>由于 专用工作者线程 只能被创建它的页面使用。所以在同源的多个页面都需要使用同一个 worker 时，专用工作者线程就不好用了。这种场景就可以使用共享工作者线程了。</p> <p>共享工作者线程与专用工作者线程类似，但它可以被多个信任的可执行上下文访问。例如，同源的两个标签页可以访问同一个 shared Workers。SharedWorker 与 Worker 的消息接口稍有不同，包括外部和内部。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// main.js</span>
<span class="token keyword">const</span> sharedWorker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SharedWorker</span><span class="token punctuation">(</span><span class="token string">'./sharedWorker.js'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>sharedWorker<span class="token punctuation">)</span> <span class="token comment">// SharedWorker {port: MessagePort, onerror: null}</span>
</code></pre></div><p><strong>SharedWorker 标识与独占</strong>，与专用工作者线程的一个重要区别在于，Worker() 构造函数始终会创建新的实例，而 SharedWorker() 则只会在相同的标识不存在时，才创建新实例。如果已存在就不会创建新实例，而是新建对这个实例的连接并返回。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">SharedWorker</span><span class="token punctuation">(</span><span class="token string">'./sharedWorker.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">SharedWorker</span><span class="token punctuation">(</span><span class="token string">'./sharedWorker.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">SharedWorker</span><span class="token punctuation">(</span><span class="token string">'./sharedWorker.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">SharedWorker</span><span class="token punctuation">(</span><span class="token string">'sharedWorker.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">SharedWorker</span><span class="token punctuation">(</span><span class="token string">'https://www.example.com/sharedWorker.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre></div><p>上面的例子中执行了多次 new SharedWorker()，只会在第一次时创建 共享工作者线程，后面的只是返回对应的连接。</p> <p>注意：<strong>对于 name 不一样、或者 URL 不一样的情况，还是会创建多个 共享工作者线程</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 名称不同，创建两个线程</span>
<span class="token keyword">new</span> <span class="token class-name">SharedWorker</span><span class="token punctuation">(</span><span class="token string">'./sharedWorker.js'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>name<span class="token operator">:</span> <span class="token string">'foo'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">SharedWorker</span><span class="token punctuation">(</span><span class="token string">'./sharedWorker.js'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>name<span class="token operator">:</span> <span class="token string">'bar'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// URL不同，创建两个线程</span>
<span class="token keyword">new</span> <span class="token class-name">SharedWorker</span><span class="token punctuation">(</span><span class="token string">'./sharedWorker.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">new</span> <span class="token class-name">SharedWorker</span><span class="token punctuation">(</span><span class="token string">'./sharedWorker.js?'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre></div><h3 id="sharedworker-对象与-sharedworkerglobalscope"><a href="#sharedworker-对象与-sharedworkerglobalscope" class="header-anchor">#</a> sharedWorker 对象与 SharedWorkerGlobalScope</h3> <p>sharedWorker 对象支持以下属性：</p> <ul><li><code>onerror</code> 发生 ErrorEvent 类型的错误事件时</li> <li><code>port</code> 专门用来跟共享线程通信的 MessagePort</li></ul> <p><strong>注意sharedWorker实例并没有 terminate()、postMessage() 等方法</strong></p> <p>SharedWorkerGlobalScope 是共享线程内部全局作用域 self 的构造函数。 它也是继承 WorkerGlobalScope。它扩展了如下属性或方法：</p> <ul><li><code>name</code> 可选的字符串标识符，可以在初始化 SharedWorker 时传入。</li> <li><code>importScripts()</code> 向工作者线程中导入任意数量的 js。</li> <li><code>close()</code> 与 worker.terminate() 对应，立即终止工作者线程。</li> <li><code>onconnect</code> 与共享线程建立新连接时，应将其设置为处理程序。connect 事件包括 MessagePort 实例的 ports 数组，可用于把消息发送回父上下文。通过 worker.port.onmessage 或 worker.port.start() 与共享线程建立连接都会触发 connect 事件</li></ul> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>根据浏览器的实现，SharedWorker 中把日志打印到控制台不一定能在浏览器默认的控制台中看到。</p></div> <h3 id="共享工作者线程的生命周期"><a href="#共享工作者线程的生命周期" class="header-anchor">#</a> 共享工作者线程的生命周期</h3> <p>专用共享工作者线程只和一个页面绑定。而共享工作者线程只要还有一个上下文连接就会持续存在。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// main.js</span>
<span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">'./worker.js'</span><span class="token punctuation">)</span>
</code></pre></div><table><thead><tr><th>事件</th> <th>结果</th> <th>事件发生后线程数</th></tr></thead> <tbody><tr><td>标签页 1 执行 main.js</td> <td>创建专用线程 1</td> <td>1</td></tr> <tr><td>标签页 2 执行 main.js</td> <td>创建专用线程 2</td> <td>2</td></tr> <tr><td>标签页 3 执行 main.js</td> <td>创建专用线程 3</td> <td>3</td></tr> <tr><td>标签页 1 关闭</td> <td>专用线程 1 终止</td> <td>2</td></tr> <tr><td>标签页 2 关闭</td> <td>专用线程 2 终止</td> <td>1</td></tr> <tr><td>标签页 3 关闭</td> <td>专用线程 3 终止</td> <td>0</td></tr></tbody></table> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// main.js</span>
<span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SharedWorker</span><span class="token punctuation">(</span><span class="token string">'./sharedWorker.js'</span><span class="token punctuation">)</span>
</code></pre></div><table><thead><tr><th>事件</th> <th>结果</th> <th>事件发生后线程数</th></tr></thead> <tbody><tr><td>标签页 1 执行 main.js</td> <td>创建共享线程 1</td> <td>1</td></tr> <tr><td>标签页 2 执行 main.js</td> <td>连接共享线程 1</td> <td>1</td></tr> <tr><td>标签页 3 执行 main.js</td> <td>连接共享线程 1</td> <td>1</td></tr> <tr><td>标签页 1 关闭</td> <td>断开与共享线程 1 的连接</td> <td>1</td></tr> <tr><td>标签页 2 关闭</td> <td>断开与共享线程 1 的连接</td> <td>1</td></tr> <tr><td>标签页 3 关闭</td> <td>断开与共享线程 1 的连接，没有连接了，终止线程</td> <td>0</td></tr></tbody></table> <h3 id="连接到共享工作者线程"><a href="#连接到共享工作者线程" class="header-anchor">#</a> 连接到共享工作者线程</h3> <p>每次调用 SharedWorker() 构造函数，无论是否创建了工作者线程，都会在共享工作者线程内部处罚 connect 事件。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// sharedWorker.js</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token comment">// console 里面没有打印，-_-</span>
<span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
self<span class="token punctuation">.</span><span class="token function-variable function">onconnect</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">connected </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token operator">++</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> times</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// main.js</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">new</span> <span class="token class-name">SharedWorker</span><span class="token punctuation">(</span><span class="token string">'./sharedWorker.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 浏览器控制台中不一定能看到 -_-</span>
<span class="token comment">// connected 1 times</span>
<span class="token comment">// connected 2 times</span>
<span class="token comment">// connected 3 times</span>
<span class="token comment">// connected 4 times</span>
<span class="token comment">// connected 5 times</span>
</code></pre></div><p>发生 connect 事件时，SharedWorker 会隐式创建 MessageChannel 实例，并把 MessagePort 实例的所有权唯一的转移给该 SharedWorker 的实例。这个 MessagePort 实例会保存在 connect 事件对象的 ports 数组中。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// sharedWorker.js</span>
<span class="token keyword">const</span> connectedPorts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

self<span class="token punctuation">.</span><span class="token function-variable function">onconnect</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>ports<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  connectedPorts<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ports<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>connectedPorts<span class="token punctuation">.</span>size<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> unique connected ports</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// main.js</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">new</span> <span class="token class-name">SharedWorker</span><span class="token punctuation">(</span><span class="token string">'./sharedWorker.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 1 unique connected ports</span>
<span class="token comment">// 2 unique connected ports</span>
<span class="token comment">// 3 unique connected ports</span>
<span class="token comment">// 4 unique connected ports</span>
<span class="token comment">// 5 unique connected ports</span>
</code></pre></div><h2 id="服务工作者线程-service-workers"><a href="#服务工作者线程-service-workers" class="header-anchor">#</a> 服务工作者线程(Service Workers)</h2> <p>Service Worker 服务工作者线程，是一种类似浏览器中代理服务器的线程。<strong>可以拦截请求、缓存响应</strong>，可以让网页在没有网络连接的情况下正常使用。服务工作者线程也可以使用 Notifications API、Push API、Background Sync API 和 Channel Messaging API.</p> <p>与共享工作者线程类型，来自一个域的多个页面共享一个服务工作者线程。为了使用 Push API 等特性，服务工作者线程也<strong>可以在相关的标签页或浏览器关闭后继续等待到来的推送事件</strong>。</p> <p>对大多数开发者而言，<strong>Service Worker 在两个主要任务上最有用：充当网络请求的缓存层、启用推送通知</strong>。在这个意义上，Service Worker 就是用于把网页变成像原生应用程序一样的工具。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Service Worker 涉及内容非常广，几乎可以单独写一本书了。推荐 Udacity 的课程 &quot;Offline Web Applications&quot;。也可以参考 Mozilla 维护的 Service Worker Cookbook，其中包含了常见的服务工作者线程模式。</p></div> <p>服务工作者线程 与 专用工作者线程 和 共享工作者线程 的一个区别是：没有全局构造函数。由 navigator.serviceWorker 来管理。它的类型是 ServiceWorkerContainer。</p> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">)</span>
<span class="token comment">// ServiceWorkerContainer { controller: null, ready: Promise, oncontrollerchange: null, onmessage: null, onmessageerror: null}</span>
</code></pre></div><p>创建服务工作者线程</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 注册成功，走 console.log 逻辑</span>
navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'./serviceWorker.js'</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> console<span class="token punctuation">.</span>error<span class="token punctuation">)</span>
<span class="token comment">// ServiceWorkerRegistration { .. }</span>

<span class="token comment">// 注册失败，走 console.error 逻辑</span>
navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'./notExistWorker.js'</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> console<span class="token punctuation">.</span>error<span class="token punctuation">)</span>
<span class="token comment">// A bad HTTP response code (404) was received when fetching the script.</span>
<span class="token comment">// TypeError: Failed to register a ServiceWorker for scope ...</span>
</code></pre></div><p>一般服务工作者线程对于何时注册是比较灵活的，多次调用 register()，后面的实际什么都不会执行。一般如果之前没有注册过，一般在 load 事件里注册，这样不会影响页面的首次加载。除非该服务工作者线程负责管理缓存（这样的话就要尽早注册，比如使用后面要介绍的 clients.claim()）。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'serviceWorker'</span> <span class="token keyword">in</span> navigator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'./serviceWorker.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">12/6/2020, 11:29:42 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/js/ad3/js-ad3-26.html" class="prev">
        26. 模块(Modules)
      </a></span> <span class="next"><a href="/js/ad3/js-ad3-28.html">
        28. 最佳实践 - JS高程4
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.05304cd4.js" defer></script><script src="/assets/js/2.4b3539f1.js" defer></script><script src="/assets/js/85.8ea0a641.js" defer></script><script src="/assets/js/3.e6a4dd76.js" defer></script>
  </body>
</html>
